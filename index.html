<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼šæ•´åˆ Google ç™»å…¥</title>
<!-- Tailwind CSS for modern styling -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --bg:#0f1724; --panel:#111827; --muted:#9ca3af; --accent:#5865f2; --accent-2:#2ecc71; --danger:#ef4444;
    --card:#0b1020; --header-bg: #1e293b;
    --list-hover: rgba(255, 255, 255, 0.05);
    --selected-item: rgba(88, 101, 242, 0.15); /* Light accent background */
  }
  *{
    box-sizing:border-box;
    font-family:'Inter', 'Noto Sans TC', system-ui, -apple-system, sans-serif;
  }
  body{
    margin:0;
    background:linear-gradient(180deg,#071025 0%, #071223 100%);
    color:#e6eef8;
  }
  a{color:inherit}
  .center{
    display:flex;
    align-items:center;
    justify-content:center;
    height:100vh;
    width:100%;
  }

  /* Custom Scrollbar for Dark Theme */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--panel); }
  ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

  /* APP layout */
  #app-container{
    height:100vh; /* Full viewport height for centering content */
    display:flex;
    flex-direction:column;
    background:linear-gradient(180deg,#071025 0%, #071223 100%);
  }

  /* Chat Interface Styling */
  #app{
    max-width:1400px;
    margin:18px auto;
    height:calc(100vh - 36px);
    display:flex;
    flex-direction:column;
  }
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 18px;
    background: var(--header-bg);
    border-radius: 12px 12px 0 0;
  }
  .logo{font-weight:800;color:var(--accent);font-size:20px}

  .container{
    display:flex;
    flex: 1;
    gap:12px;
    padding:0 18px 18px 18px;
    background: var(--bg);
    border-radius: 0 0 12px 12px;
  }
  /* Sidebar styles */
  .sidebar{width:280px;background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);flex-shrink: 0;}
  .sidebar .me{padding:10px;background:rgba(255,255,255,0.06);border-radius:8px;margin-bottom:8px;border-left: 3px solid var(--accent);}
  .section-title{font-size:13px;color:var(--muted);margin:12px 0 6px 0; font-weight: 600;}
  .list{flex: 1; overflow-y: auto; padding:6px; border-radius:8px; background:rgba(255,255,255,0.02)}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:4px;cursor:pointer;transition: background-color 0.2s;}
  .item:hover{background:var(--list-hover)}
  .item.active{background:var(--selected-item); border-left: 2px solid var(--accent);}
  .chat-container{flex:1;display:flex;flex-direction:column;gap:12px;overflow: hidden;}
  .chat-window-wrapper {display: flex;flex: 1;overflow-x: auto;gap: 12px;padding-bottom: 5px;}
  .chat-window{min-width: 320px;width: 320px;max-width: 450px;height: 100%;background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);display:flex;flex-direction:column;overflow:hidden;flex-shrink: 0;}
  .chat-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:linear-gradient(90deg,var(--accent),#6d78ff);color:white;font-weight:700;flex-shrink: 0;}
  .chat-head.group-chat{background:linear-gradient(90deg,#8e44ad,#a075b8);}
  .chat-body{padding:12px;overflow-y:auto;flex:1;background:var(--bg);display: flex;flex-direction: column;}
  .msg-wrapper {display: flex;margin: 6px 0;}
  .msg{background:rgba(255,255,255,0.06);padding:8px 12px;border-radius:18px;max-width:85%;word-break:break-word;color:#e6eef8;position: relative;font-size: 14px;line-height: 1.4;}
  .msg .sender-name {font-size: 11px;font-weight: 600;color: #4a71d2;margin-bottom: 2px;display: block;}
  .msg.me{background:var(--accent-2);margin-left:auto;color: var(--card);border-radius: 18px 18px 2px 18px;}
  .msg.me .sender-name{color: var(--card);}
  .msg.other {margin-right: auto;border-radius: 18px 18px 18px 2px;background: #27303d;}
  .msg .timestamp {display: block;font-size: 10px;color: var(--muted);text-align: right;margin-top: 4px;}
  .msg.me .timestamp {color: #0b1020;}
  .chat-foot{display:flex;gap:8px;padding:12px;background:rgba(255,255,255,0.02);align-items:flex-end;flex-shrink: 0;}
  textarea{flex:1;min-height:64px;max-height:180px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:inherit;resize:vertical;transition: border-color 0.2s;}
  textarea:focus {outline: none;border-color: var(--accent);}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer;font-weight: 600;transition: background-color 0.2s, box-shadow 0.2s;}
  .btn:hover{background: #6c78ff;box-shadow: 0 2px 5px rgba(88, 101, 242, 0.4);}
  .btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#e6eef8;padding: 6px 10px;font-size: 13px;display: inline-flex;align-items: center;}
  .btn.alt:hover{background: rgba(255,255,255,0.05);border-color: rgba(255,255,255,0.2);box-shadow: none;}
  .btn.danger{background:var(--danger); border: none;}
  .btn.danger:hover{background: #ff5757;}
  .small{font-size:13px;color:var(--muted)}
  .custom-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.8);z-index:100;backdrop-filter: blur(5px);}
  .custom-modal .box{width:92%;max-width:400px;background:linear-gradient(180deg,#1e293b,#0f172a);border-radius:10px;padding:20px;box-shadow:0 12px 40px rgba(2,6,23,0.8);border: 1px solid rgba(255, 255, 255, 0.1);}
  @media(max-width:1024px){.container{flex-direction:column;padding:0 10px 10px 10px;gap: 10px;}#app{margin: 10px auto;height: calc(100vh - 20px);}.header{border-radius: 8px 8px 0 0;padding: 10px;}.sidebar{width:100%; height: 320px; flex-shrink: 0;}.chat-container{ order: 1; flex: 1; }.chat-window-wrapper { flex-wrap: wrap; justify-content: flex-start; }.chat-window { min-width: 95%; max-width: 95%; height: auto; }}
</style>
</head>
<body>

<div id="app-container">

  <!-- 1. ç™»å…¥ç•«é¢ (Login Screen) -->
  <div id="loginScreen" class="center flex-col p-4" style="display:none;">
    <div class="max-w-md w-full bg-gray-900/90 backdrop-blur-sm p-8 rounded-xl shadow-2xl border border-gray-700/50 text-center">
      <div class="logo mb-4 text-5xl">ğŸ”¥</div>
      <h1 class="text-3xl font-extrabold mb-2 text-white">æ­¡è¿å›åˆ°æ ¡åœ’èŠå¤©å®¤</h1>
      <p class="text-gray-400 mb-8">è«‹ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥ä»¥é–‹å§‹ç¾¤çµ„å’Œç§äººèŠå¤©ã€‚</p>
      
      <button id="googleSignInBtn" class="w-full py-3 px-4 bg-white text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition duration-150 flex items-center justify-center">
        <!-- Google Icon SVG -->
        <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M44.5 20H42V18H44.5C45.33 18 46 17.33 46 16.5V14.5C46 13.67 45.33 13 44.5 13H24V30H43C44.66 30 46 28.66 46 27V25C46 23.34 44.66 22 43 22H24V20H43.5C44.33 20 45 19.33 45 18.5V16.5C45 15.67 44.33 15 43.5 15H24C22.34 15 21 16.34 21 18V28C21 29.66 22.34 31 24 31H44.5C45.33 31 46 30.33 46 29.5V27.5C46 26.67 45.33 26 44.5 26H24V24H44.5C45.33 24 46 23.33 46 22.5V20.5C46 19.67 45.33 19 44.5 19Z" fill="#FFC107"/>
          <path d="M24 30H43C44.66 30 46 28.66 46 27V25C46 23.34 44.66 22 43 22H24V30Z" fill="#FF3D00"/>
          <path d="M41 11H24V30H41C42.66 30 44 28.66 44 27V13C44 11.34 42.66 10 41 10H24V11Z" fill="#4CAF50"/>
          <path d="M24 31V37.5C24 39.43 22.43 41 20.5 41H16V22H19V27H24V31Z" fill="#1976D2"/>
          <path d="M16 22V17C16 15.34 17.34 14 19 14H22V17H19V22Z" fill="#4CAF50"/>
          <path d="M19 14V11H22V14H19Z" fill="#1976D2"/>
          <path d="M24 17V19H19V17H24Z" fill="#FFC107"/>
          <path d="M19 19V22H24V19H19Z" fill="#FF3D00"/>
          <path d="M24 37.5C24 39.43 22.43 41 20.5 41H16V30H24V37.5Z" fill="#1976D2"/>
          <path d="M16 30V27H19V30H16Z" fill="#4CAF50"/>
          <path d="M16 27V22H19V27H16Z" fill="#FFC107"/>
          <path d="M16 17V14H19V17H16Z" fill="#FF3D00"/>
          <path d="M24 11V14H19V11H24Z" fill="#4CAF50"/>
        </svg>
        ä½¿ç”¨ Google ç™»å…¥
      </button>
      <p class="text-xs text-gray-500 mt-4">æ‚¨å¿…é ˆä½¿ç”¨ Google å¸³è™Ÿæˆæ¬Šä»¥ç¢ºä¿èº«ä»½é©—è­‰ã€‚</p>
    </div>
  </div>

  <!-- 2. æ‡‰ç”¨ç¨‹å¼ç•«é¢ (Chat App) -->
  <div id="app" style="display:none">
    <div class="header">
      <div class="logo">ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</div>
      <div class="top-controls flex items-center gap-3">
        <div class="small" id="meInfo"></div>
        <div id="roleBadge" class="px-3 py-1 text-xs font-semibold rounded-full hidden" style="background:var(--accent-2); color: var(--card);"></div>
        <button id="logoutBtn" class="btn alt">ç™»å‡º</button>
      </div>
    </div>

    <div class="container">
      <!-- Sidebar: User Lists and Controls -->
      <div class="sidebar">
        <div class="me">
          <p class="font-bold text-sm truncate" id="myEmail">Email:</p>
          <p class="text-xs text-gray-400">ID: <span id="myUserId"></span></p>
        </div>

        <!-- Controls -->
        <div class="flex gap-2 mb-3 flex-wrap">
          <button id="addFriendBtn" class="btn alt flex-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" y1="8" x2="19" y2="14"></line><line x1="16" y1="11" x2="22" y2="11"></line></svg>
            <span class="ml-1">åŠ å¥½å‹</span>
          </button>
          <button id="monitorBtn" class="btn alt flex-1 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span class="ml-1">ç›£çœ‹</span>
          </button>
          <button id="createGroupBtn" class="btn alt flex-1 hidden" style="background: rgba(142, 68, 173, 0.2); border-color: rgba(142, 68, 173, 0.4);">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span class="ml-1">å»ºç¾¤çµ„</span>
          </button>
        </div>
        
        <!-- Groups List (New Feature) -->
        <div class="section-title">ç¾¤çµ„é »é“</div>
        <div id="groupsList" class="list">
          <p class="small text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</p>
        </div>

        <!-- Friends List -->
        <div class="section-title">ç§äººè¨Šæ¯ / å¥½å‹</div>
        <div id="friendsList" class="list">
          <p class="small text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</p>
        </div>

        <!-- Users List -->
        <div class="section-title">æ‰€æœ‰ä½¿ç”¨è€…</div>
        <div id="usersList" class="list">
          <p class="small text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</p>
        </div>
      </div>

      <!-- Chat Area: Active Chat Windows -->
      <div class="chat-container">
        <div class="chat-window-wrapper" id="chatWindows">
          <div class="center text-gray-500 text-lg font-semibold w-full h-full">
            é»æ“Šå·¦å´ä½¿ç”¨è€…æˆ–ç¾¤çµ„é–‹å§‹èŠå¤©
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading" class="center">
    <div class="flex flex-col items-center">
      <div class="w-10 h-10 border-4 border-l-transparent rounded-full animate-spin border-blue-500 mb-3"></div>
      <p class="text-gray-300">æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–ä¸­...</p>
    </div>
  </div>
</div>

<!-- Custom Modal for Alerts/Confirms/Prompts -->
<div id="customModal" class="custom-modal">
  <div class="box">
    <h3 id="modalTitle" class="text-xl font-bold mb-3">è¨Šæ¯</h3>
    <div id="modalBody" class="text-sm text-gray-300 mb-4"></div>
    <div id="modalFooter" class="flex justify-end gap-2">
      <!-- Buttons injected here -->
    </div>
  </div>
</div>

<script type="module">
  // Modern Firebase V11 Modular Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // setLogLevel('debug'); // Open debug log for Firestore in console

  /* ================= Global Variables & Environment ================= */
  // The API key is expected to be part of __firebase_config, which is MANDATORY in this environment.
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  
  let ME_EMAIL = '';
  let ME_UID = '';
  let ME_NAME = '';
  let ME_ROLE = 'user'; 
  let FRIENDS = {};
  let USERS = {};
  let GROUPS = {}; 

  const openChats = {}; 
  const unsubs = []; 

  const appEl = document.getElementById('app');
  const loginScreenEl = document.getElementById('loginScreen');
  const loadingEl = document.getElementById('loading');
  const googleSignInBtn = document.getElementById('googleSignInBtn');

  // UI Elements (chat screen)
  const myEmailEl = document.getElementById('myEmail');
  const myUserIdEl = document.getElementById('myUserId');
  const roleBadgeEl = document.getElementById('roleBadge');
  const monitorBtn = document.getElementById('monitorBtn');
  const createGroupBtn = document.getElementById('createGroupBtn');
  const groupsListEl = document.getElementById('groupsList');
  const friendsListEl = document.getElementById('friendsList');
  const usersListEl = document.getElementById('usersList');
  const chatWindowsEl = document.getElementById('chatWindows');
  const logoutBtn = document.getElementById('logoutBtn');
  
  // Modal Elements
  const customModal = document.getElementById('customModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalFooter = document.getElementById('modalFooter');

  /* ================= Custom Modal (replaces alert/confirm) ================= */

  function showCustomModal(title, message, type = 'alert', placeholder = '') {
    return new Promise(resolve => {
      modalTitle.textContent = title;
      modalBody.innerHTML = message; 
      modalFooter.innerHTML = '';

      let inputEl = null;
      if (type === 'prompt') {
        modalBody.innerHTML = `<p class="mb-4">${message}</p>`;
        inputEl = document.createElement('input');
        inputEl.type = 'text';
        inputEl.placeholder = placeholder;
        inputEl.className = 'w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:outline-none focus:border-blue-500';
        modalBody.appendChild(inputEl);
      }

      if (type === 'prompt' || type === 'confirm') {
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn alt';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.onclick = () => { customModal.style.display = 'none'; resolve(type === 'prompt' ? null : false); };
        modalFooter.appendChild(cancelBtn);

        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn ml-2';
        confirmBtn.textContent = type === 'prompt' ? 'ç¢ºèª' : 'ç¢ºå®š';
        confirmBtn.onclick = () => {
          customModal.style.display = 'none';
          if (type === 'prompt') {
            resolve(inputEl.value.trim());
          } else {
            resolve(true);
          }
        };
        modalFooter.appendChild(confirmBtn);

      } else { // type === 'alert'
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn';
        closeBtn.textContent = 'é—œé–‰';
        closeBtn.onclick = () => { customModal.style.display = 'none'; resolve(true); };
        modalFooter.appendChild(closeBtn);
      }
      customModal.style.display = 'flex';
      if (inputEl) inputEl.focus();
    });
  }

  /* ================= Firebase Initialization & Auth ================= */

  let app, db, auth;

  // Check config validity before initializing
  if (!firebaseConfig || !firebaseConfig.apiKey) {
    // This is the correct way to handle missing environment config
    loadingEl.innerHTML = '<p class="text-red-500 p-4">éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚è«‹ç¢ºèªç’°å¢ƒè®Šæ•¸ `__firebase_config` å·²è¨­ç½®ä¸”åŒ…å« `apiKey`ã€‚æ‡‰ç”¨ç¨‹å¼ç„¡æ³•å•Ÿå‹•ã€‚</p>';
    throw new Error("Firebase config missing. Please check if __firebase_config is correctly injected.");
  } else {
    // Initialize Firebase services
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // Helper to construct secure Firestore collection paths
    const getPrivateCollectionPath = (collectionName) => {
      return `artifacts/${appId}/users/${ME_UID}/${collectionName}`;
    };
    const getPublicCollectionPath = (collectionName) => {
      return `artifacts/${appId}/public/data/${collectionName}`;
    };
    const getPrivateRoomId = (email1, email2) => {
      // Use sorted emails as room ID for consistency
      return [email1, email2].sort().join('_');
    };

    /**
     * è™•ç† Google ç™»å…¥
     */
    async function signInWithGoogle() {
      try {
        loadingEl.style.display = 'flex';
        loginScreenEl.style.display = 'none';
        
        await signInWithPopup(auth, googleProvider);
        // onAuthStateChanged will handle the rest.
        
      } catch (error) {
        loadingEl.style.display = 'none';
        loginScreenEl.style.display = 'flex';
        
        if (error.code === 'auth/popup-closed-by-user') {
            console.log("Popup closed by user.");
        } else {
            console.error("Google Sign-In Error:", error);
            showCustomModal('ç™»å…¥å¤±æ•—', `ç„¡æ³•ä½¿ç”¨ Google ç™»å…¥: ${error.message}`, 'alert');
        }
      }
    }

    /**
     * è™•ç†è‡ªè¨‚ Token æˆ–åŒ¿åç™»å…¥ (ç”¨æ–¼æ¸¬è©¦æˆ– Canvas ç’°å¢ƒ)
     */
    async function handleCanvasAuth() {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          // Fallback to anonymous sign-in if no token is provided
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Canvas Auth Error:", error);
        showCustomModal('ç’°å¢ƒèº«ä»½é©—è­‰å¤±æ•—', 'å˜—è©¦è‡ªå‹•ç™»å…¥å¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨ Google ç™»å…¥ã€‚', 'alert');
        loadingEl.style.display = 'none';
        loginScreenEl.style.display = 'flex';
      }
    }

    /**
     * è¨»å†Šæˆ–æ›´æ–°ä½¿ç”¨è€…å…¬é–‹è³‡è¨Š
     * @param {object} user Firebase User object
     */
    async function registerUser(user) {
      ME_UID = user.uid;
      const email = user.email ? user.email.toLowerCase() : null; 

      if (!email) {
        // Handle anonymous or missing email (shouldn't happen with Google Sign-in)
        ME_EMAIL = `anonymous_${ME_UID}@anon.chat`;
        ME_NAME = 'åŒ¿åä½¿ç”¨è€…';
        ME_ROLE = 'user';
        return; 
      }
      
      ME_EMAIL = email;
      ME_NAME = user.displayName || email.split('@')[0];

      const userRef = doc(db, getPublicCollectionPath('users'), ME_EMAIL);
      const userDoc = await getDoc(userRef);
      
      if (!userDoc.exists()) {
        await setDoc(userRef, {
          uid: ME_UID, 
          email: ME_EMAIL,
          name: ME_NAME,
          lastActive: serverTimestamp(),
          role: 'user', // Default role for new Google users
        });
        ME_ROLE = 'user';
      } else {
        await updateDoc(userRef, { lastActive: serverTimestamp(), uid: ME_UID });
        ME_ROLE = userDoc.data().role || 'user';
      }
    }


    /* ================= Auth State Listener ================= */
    onAuthStateChanged(auth, async (user) => {
      // 1. è™•ç†è®€å–ç‹€æ…‹
      loadingEl.style.display = 'flex';
      appEl.style.display = 'none';
      loginScreenEl.style.display = 'none';

      if (user) {
        // 2. è™•ç†å·²ç™»å…¥ç‹€æ…‹
        await registerUser(user);
        
        // Update UI display
        myEmailEl.textContent = ME_EMAIL;
        myUserIdEl.textContent = ME_UID; 
        
        // Display role badge and admin controls
        const adminRoles = ['superadmin', 'admin'];
        if (adminRoles.includes(ME_ROLE)) {
          roleBadgeEl.classList.remove('hidden');
          roleBadgeEl.textContent = ME_ROLE === 'superadmin' ? 'ç®¡ç†å“¡' : 'å°ç·¨';
          createGroupBtn.classList.remove('hidden');
          if (ME_ROLE === 'superadmin') {
              monitorBtn.classList.remove('hidden');
          } else {
              monitorBtn.classList.add('hidden');
          }
        } else {
          roleBadgeEl.classList.add('hidden');
          monitorBtn.classList.add('hidden');
          createGroupBtn.classList.add('hidden');
        }

        // Start all Firestore listeners only once
        if (unsubs.length === 0) {
          startListeners();
        }

        // Show the application
        loadingEl.style.display = 'none';
        appEl.style.display = 'flex';

      } else {
        // 3. è™•ç†æœªç™»å…¥ç‹€æ…‹
        // Clear old data and listeners
        Object.values(openChats).forEach(o => o.unsub && o.unsub());
        unsubs.forEach(u => u && u());
        unsubs.length = 0; 
        
        // Decide whether to show login or attempt environment auth
        if (initialAuthToken) {
            await handleCanvasAuth();
        } else {
            // Show the Google login screen
            loadingEl.style.display = 'none';
            loginScreenEl.style.display = 'flex';
        }
      }
    });


    /* ================= Event Listeners (Chat Screen) ================= */
    
    googleSignInBtn.onclick = signInWithGoogle;
    logoutBtn.onclick = async () => {
      const confirmed = await showCustomModal('ç¢ºèªç™»å‡º', 'æ‚¨ç¢ºå®šè¦ç™»å‡ºèŠå¤©å®¤å—ï¼Ÿ', 'confirm');
      if (confirmed) {
        // Clear environment token flag just in case, then sign out
        // Note: For actual Canvas environment, this step might be slightly different 
        // but standard signOut is the correct client-side action.
        await signOut(auth);
      }
    };

    /* ================= Core Chat/Firestore Logic (Mostly Unchanged) ================= */

    function startListeners() {
      // 1. ç›£è½æ‰€æœ‰å…¬å…±ä½¿ç”¨è€… (Public/data/users)
      const usersQ = query(collection(db, getPublicCollectionPath('users')));
      const unsubUsers = onSnapshot(usersQ, (snapshot) => {
        usersListEl.innerHTML = '';
        USERS = {};
        let userHtml = '';

        snapshot.forEach(doc => {
          const userData = doc.data();
          const email = userData.email;
          const name = userData.name;
          const uid = userData.uid; 
          USERS[email] = { name, email, uid };

          if (email !== ME_EMAIL && ME_EMAIL.includes('@')) { // åƒ…å°éåŒ¿åç”¨æˆ¶é¡¯ç¤ºå…¶ä»–ç”¨æˆ¶
            const isFriend = FRIENDS[email] && FRIENDS[email].status === 'friend';
            const buttonText = isFriend ? 'è¨Šæ¯' : 'åŠ å¥½å‹';
            const buttonClass = isFriend ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-700';
            
            userHtml += `
              <div class="item flex items-center" data-email="${email}">
                <div class="flex-1 truncate" onclick="window.openPrivateChat('${email}')">
                  <span class="font-bold">${name}</span> 
                  <span class="small ml-1 text-gray-400">(${email.split('@')[0]})</span>
                  <span class="text-xs text-blue-400 ml-1">UID: ${uid.substring(0, 4)}...</span>
                </div>
                <button class="btn alt text-xs ${buttonClass} py-1 px-2 ml-2" onclick="window.handleUserAction('${email}', '${isFriend ? 'chat' : 'request'}')">${buttonText}</button>
              </div>
            `;
          }
        });
        usersListEl.innerHTML = userHtml || '<p class="small text-center py-2 text-gray-500">ç›®å‰æ²’æœ‰å…¶ä»–ä½¿ç”¨è€…æˆ–æ‚¨æ˜¯åŒ¿åç”¨æˆ¶ã€‚</p>';
      }, console.error);
      unsubs.push(unsubUsers);
      
      // 2. ç›£è½å¥½å‹é—œä¿‚ (Friendships) - Private data
      const friendRef = collection(db, getPrivateCollectionPath('friends'));
      const unsubFriends = onSnapshot(friendRef, (snapshot) => {
        friendsListEl.innerHTML = '';
        FRIENDS = {};
        let friendHtml = '';

        snapshot.forEach(doc => {
          const data = doc.data();
          const otherEmail = doc.id; 
          const status = data.status;
          const name = data.name || otherEmail.split('@')[0];
          
          FRIENDS[otherEmail] = { ...data, email: otherEmail };

          let statusBadge = '';
          let buttonAction = '';
          let itemClass = '';

          if (status === 'pending') {
            if (data.to === ME_EMAIL) {
              statusBadge = `<span class="text-xs bg-yellow-600 text-white rounded-full px-2 py-0.5 ml-2">å¾…ç¢ºèª</span>`;
              buttonAction = `<button class="btn text-xs py-1 px-2 ml-2" onclick="window.acceptFriend('${otherEmail}')">æ¥å—</button>`;
            } else {
              statusBadge = `<span class="text-xs bg-gray-600 text-white rounded-full px-2 py-0.5 ml-2">ç­‰å¾…ä¸­</span>`;
              buttonAction = '';
            }
          } else if (status === 'friend') {
            statusBadge = `<span class="text-xs bg-green-600 text-white rounded-full px-2 py-0.5 ml-2">å¥½å‹</span>`;
            buttonAction = `<button class="btn alt text-xs py-1 px-2 ml-2" onclick="window.openPrivateChat('${otherEmail}')">èŠå¤©</button>`;
            itemClass = 'font-semibold';
          }

          friendHtml += `
            <div class="item flex items-center ${itemClass}">
              <div class="flex-1 truncate">
                <span class="font-bold">${name}</span> 
                <span class="small ml-1 text-gray-400">(${otherEmail.split('@')[0]})</span>
                ${statusBadge}
              </div>
              ${buttonAction}
            </div>
          `;
        });
        friendsListEl.innerHTML = friendHtml || '<p class="small text-center py-4 text-gray-500">æ²’æœ‰å¥½å‹æˆ–è«‹æ±‚ã€‚</p>';
        
      }, console.error);
      unsubs.push(unsubFriends);

      // 3. ç›£è½ç¾¤çµ„ (Groups) - Public data
      const groupRef = collection(db, getPublicCollectionPath('groups'));
      const unsubGroups = onSnapshot(groupRef, (snapshot) => {
          groupsListEl.innerHTML = '';
          GROUPS = {};
          let groupHtml = '';

          snapshot.forEach(doc => {
              const data = doc.data();
              const groupName = doc.id;
              
              // Only show groups that the user is a member of
              if (data.members.includes(ME_EMAIL)) {
                  GROUPS[groupName] = data;
                  const isAdmin = data.admins.includes(ME_EMAIL);
                  
                  groupHtml += `
                      <div class="item flex items-center" onclick="window.openGroupChat('${groupName}')">
                          <div class="flex-1 truncate">
                              <span class="font-bold text-blue-300"># ${data.displayName}</span>
                              <span class="small ml-1 text-gray-400">(${data.members.length} ä½æˆå“¡)</span>
                          </div>
                          ${isAdmin ? '<span class="text-xs bg-red-600 text-white rounded-full px-2 py-0.5 ml-2">ç®¡ç†</span>' : ''}
                      </div>
                  `;
              }
          });
          groupsListEl.innerHTML = groupHtml || '<p class="small text-center py-4 text-gray-500">æ²’æœ‰åŠ å…¥çš„ç¾¤çµ„ã€‚</p>';
      }, console.error);
      unsubs.push(unsubGroups);
    } // End of startListeners

    // --- Functions below are window-exposed for use in inline event handlers ---
    
    window.openChatWindow = (roomId, title, type) => {
      if (openChats[roomId]) {
        openChats[roomId].element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        return;
      }
      
      if (chatWindowsEl.querySelector('.center')) {
        chatWindowsEl.querySelector('.center').remove();
      }

      const isGroup = type === 'group';
      const isMonitor = type === 'monitor';
      let roomPath = roomId;

      const chatWindow = document.createElement('div');
      chatWindow.id = `chat-${roomId}`;
      chatWindow.className = 'chat-window';
      chatWindow.innerHTML = `
        <div class="chat-head ${isGroup || isMonitor ? 'group-chat' : ''}">
          <div class="truncate">
              ${isGroup ? '<span style="font-size: 1.2em; margin-right: 5px;">#</span>' : ''}
              ${title} ${isMonitor ? '(ç›£çœ‹)' : ''}
          </div>
          <button class="text-white hover:text-gray-200 ml-2" onclick="window.closeChatWindow('${roomId}')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <div id="messages-${roomId}" class="chat-body">
          <p class="small text-center text-gray-500">è¼‰å…¥è¨Šæ¯ä¸­...</p>
        </div>
        <div class="chat-foot">
          <textarea id="input-${roomId}" placeholder="${isMonitor ? 'ç›£çœ‹æ¨¡å¼ç„¡æ³•ç™¼é€' : 'è¼¸å…¥è¨Šæ¯ (Enter ç™¼é€, Shift+Enter æ›è¡Œ)'}" rows="2" ${isMonitor ? 'disabled' : ''}></textarea>
          <button id="send-${roomId}" class="btn" ${isMonitor ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
      `;
      
      chatWindowsEl.appendChild(chatWindow);
      chatWindow.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

      const messagesEl = document.getElementById(`messages-${roomId}`);
      const messageQ = query(
        collection(db, getPublicCollectionPath('messages'), roomPath, 'chats')
        // orderBy is omitted here to avoid index errors, messages will be sorted client-side
      );

      const unsubMessages = onSnapshot(messageQ, (snapshot) => {
        // Sort messages client-side if needed, but Firestore's onSnapshot often returns them ordered by time if time is sequential
        const sortedDocs = snapshot.docs.sort((a, b) => {
            const timeA = a.data().time ? a.data().time.toMillis() : 0;
            const timeB = b.data().time ? b.data().time.toMillis() : 0;
            return timeA - timeB;
        });
        renderMessages(messagesEl, sortedDocs);
      }, console.error);

      const sendBtn = document.getElementById(`send-${roomId}`);
      const inputEl = document.getElementById(`input-${roomId}`);
      
      if (!isMonitor) {
        const isPrivate = !isGroup && !isMonitor;
        sendBtn.onclick = () => sendMessage(roomPath, inputEl, isPrivate ? roomId.split('_').find(e => e !== ME_EMAIL) : null, isPrivate);
        inputEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {