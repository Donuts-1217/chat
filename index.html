<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>🔥 簡易聊天室</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: "Noto Sans TC", sans-serif; background: #f5f5f5; margin: 0; }
#container { display: flex; width: 95%; max-width: 1000px; margin: 40px auto; background: white;
border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); overflow: hidden; }

.sidebar, .rightbar { width: 25%; background: #f9f9f9; padding: 15px; border-right: 1px solid #ddd; box-sizing: border-box; }
.rightbar { border-right: none; border-left: 1px solid #ddd; }
.chat { flex: 1; padding: 15px; display: flex; flex-direction: column; }

h2 { margin-top: 0; }

button, input, select { padding: 8px; margin: 4px 0; border-radius: 5px; border: 1px solid #ccc; }
#sendBtn { background: #4CAF50; color: white; border: none; cursor: pointer; }
#loginBtn { padding: 10px 20px; background: #4285F4; color: white; border: none; border-radius: 5px; cursor: pointer; }
#logoutBtn { background: #f44336; color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer; float:right; }

#messages { flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 8px; background: #fafafa; margin-bottom: 10px; }
.msg { margin: 4px 0; padding: 5px 8px; background: #e6f0ff; border-radius: 6px; }

#msgInput { flex: none; width: 70%; }
.input-area { display: flex; }
</style>
</head>
<body>

<div id="container">
  <!-- 左側好友/群聊 -->
  <div class="sidebar">
    <h3>好友清單</h3>
    <ul id="friendList"></ul>
    <h3>群聊清單</h3>
    <ul id="groupList"></ul>
    <button id="createGroupBtn">建立群聊</button>
  </div>

  <!-- 中間聊天區 -->
  <div class="chat">
    <div>
      <button id="loginBtn">使用 Google 登入</button>
      <button id="logoutBtn" style="display:none;">登出</button>
    </div>
    <p>👋 歡迎，<span id="user"></span></p>

    <div>
      <select id="mode">
        <option value="group">群聊</option>
        <option value="private">私聊</option>
      </select>
      <input id="targetEmail" placeholder="私聊對象 Gmail（群聊可留空）">
    </div>

    <div id="messages"></div>

    <div class="input-area">
      <input id="msgInput" placeholder="輸入訊息...">
      <button id="sendBtn">送出</button>
    </div>
  </div>

  <!-- 右側新增好友 -->
  <div class="rightbar">
    <h3>新增好友</h3>
    <input id="addFriendEmail" placeholder="輸入 Gmail">
    <button id="addFriendBtn">新增好友</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
    authDomain: "chat-52c0d.firebaseapp.com",
    projectId: "chat-52c0d",
    storageBucket: "chat-52c0d.firebasestorage.app",
    messagingSenderId: "449329325475",
    appId: "1:449329325475:web:75f255c4055360dc9e6616",
    measurementId: "G-8R8648H53V"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const chatDiv = document.querySelector(".chat");
  const userSpan = document.getElementById("user");
  const msgDiv = document.getElementById("messages");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const modeSel = document.getElementById("mode");
  const targetInput = document.getElementById("targetEmail");

  let userEmail = "";
  let unsub = null;

  loginBtn.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  };

  logoutBtn.onclick = async () => {
    await auth.signOut();
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    chatDiv.style.display = "none";
    msgDiv.innerHTML = "";
  };

  auth.onAuthStateChanged(user => {
    if (user) {
      userEmail = user.email;
      userSpan.textContent = `${user.displayName} (${userEmail})`;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      chatDiv.style.display = "flex";
      loadMessages();
    }
  });

  function getRoomId() {
    if (modeSel.value === "group") return "group_chat";
    const target = targetInput.value.trim();
    if (!target) return null;
    return [userEmail, target].sort().join("_");
  }

  function loadMessages() {
    if (unsub) unsub();
    const roomId = getRoomId() || "group_chat";
    unsub = db.collection("messages").doc(roomId).collection("chats")
      .orderBy("time")
      .onSnapshot(snap => {
        msgDiv.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = "msg";
          div.textContent = `${d.from}: ${d.text}`;
          msgDiv.appendChild(div);
        });
        msgDiv.scrollTop = msgDiv.scrollHeight;
      });
  }

  sendBtn.onclick = async () => {
    const text = msgInput.value.trim();
    if (!text) return;
    const roomId = getRoomId() || "group_chat";
    await db.collection("messages").doc(roomId).collection("chats").add({
      from: userEmail,
      text,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgInput.value = "";
  };

  modeSel.onchange = loadMessages;
  targetInput.oninput = loadMessages;
</script>
</body>
</html>
