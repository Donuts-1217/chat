<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ æ ¡åœ’å³æ™‚èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* å…¨å±€æ¨£å¼ */
body { margin:0; font-family:"Noto Sans TC",sans-serif; background:#f2f5fa; }
button { cursor:pointer; border:none; border-radius:5px; }
input { padding:6px; border-radius:5px; border:1px solid #ccc; }

/* ç™»å…¥é é¢ */
#loginPage { display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; }
#loginPage button { padding:10px 20px; font-size:16px; background:#4285F4; color:#fff; }

/* èŠå¤©é é¢ */
#chatPage { display:none; height:100vh; width:100vw; box-sizing:border-box; }

#container { display:flex; width:100%; height:100%; }

/* å·¦å´å¥½å‹ç¾¤çµ„ */
.sidebar { width:250px; background:#f7f9fc; padding:15px; display:flex; flex-direction:column; border-right:1px solid #ddd; }
.sidebar h3 { margin:10px 0 5px 0; font-size:16px; color:#333; }
ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; background:#fff; border-radius:8px; border:1px solid #ddd; }
li { padding:8px; cursor:pointer; border-bottom:1px solid #eee; transition:0.2s; }
li:hover { background:#e0f0ff; font-weight:500; }

/* ä¸­é–“èŠå¤©å€ */
.chat-area { flex:1; display:flex; flex-wrap:wrap; gap:12px; padding:10px; overflow-x:auto; background:#f1f5f9; }
.chat-window { width:320px; min-width:320px; max-height:80vh; background:#fff; border-radius:10px; display:flex; flex-direction:column; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden; }
.chat-header { background:#2d8cf0; color:#fff; padding:8px; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
.chat-header button { background:#f44336; font-size:12px; padding:2px 6px; border-radius:4px; }
.chat-messages { flex:1; overflow-y:auto; padding:8px; background:#f7f9fc; }
.msg { margin:4px 0; padding:6px 10px; border-radius:8px; background:#e0f0ff; font-size:13px; word-break:break-word; }
.chat-input { display:flex; border-top:1px solid #ddd; }
.chat-input input { flex:1; padding:6px 10px; border:none; outline:none; font-size:13px; }
.chat-input button { padding:6px 12px; background:#2ecc71; color:white; font-weight:500; }

/* å³å´æ“ä½œå€ */
.rightbar { width:250px; padding:10px; background:#f7f9fc; border-left:1px solid #ddd; display:flex; flex-direction:column; }
.rightbar h3 { margin:10px 0 5px 0; font-size:16px; color:#333; }
.request-btn { padding:4px 6px; margin-left:4px; border-radius:4px; font-size:12px; }

/* å…¬å‘Š */
#announcement { background:#ffeaa7; padding:5px; border-radius:5px; margin-bottom:8px; font-size:13px; }
</style>
</head>
<body>

<!-- ç™»å…¥é é¢ -->
<div id="loginPage">
  <h1>æ­¡è¿ä½¿ç”¨æ ¡åœ’å³æ™‚èŠå¤©å®¤</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<!-- èŠå¤©é é¢ -->
<div id="chatPage">
<div id="container">
  <!-- å·¦å´ -->
  <div class="sidebar">
    <p>ğŸ‘‹ æ­¡è¿ï¼Œ<span id="user"></span></p>
    <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    <h3>å¥½å‹æ¸…å–®</h3>
    <ul id="friendList"></ul>
    <input id="addFriendEmail" placeholder="è¼¸å…¥ Gmail">
    <button id="addFriendBtn">é€å‡ºå¥½å‹è«‹æ±‚</button>
    <h3>ç¾¤çµ„æ¸…å–®</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="æ–°ç¾¤çµ„åç¨±">
    <button id="createGroupBtn">å‰µå»ºç¾¤çµ„</button>
  </div>

  <!-- ä¸­é–“èŠå¤© -->
  <div class="chat-area" id="chatArea"></div>

  <!-- å³å´æ“ä½œ -->
  <div class="rightbar">
    <h3>å¥½å‹è«‹æ±‚</h3>
    <ul id="requestList"></ul>
    <h3>å…¨åŸŸå…¬å‘Š</h3>
    <div id="announcement"></div>
    <input id="announcementInput" placeholder="è¼¸å…¥å…¬å‘Š">
    <button id="announcementBtn">ç™¼é€å…¬å‘Š</button>
    <h3>ç›£çœ‹ç§èŠ (é«˜éšç®¡ç†å“¡)</h3>
    <input id="watchInput" placeholder="è¼¸å…¥ A_email_B_email">
    <button id="watchBtn">ç›£çœ‹</button>
  </div>
</div>
</div>

<script>
// Firebase åˆå§‹åŒ–
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginPage = document.getElementById("loginPage");
const chatPage = document.getElementById("chatPage");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userSpan = document.getElementById("user");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupName = document.getElementById("newGroupName");
const chatArea = document.getElementById("chatArea");
const requestList = document.getElementById("requestList");
const announcementDiv = document.getElementById("announcement");
const announcementInput = document.getElementById("announcementInput");
const announcementBtn = document.getElementById("announcementBtn");
const watchInput = document.getElementById("watchInput");
const watchBtn = document.getElementById("watchBtn");

let userEmail="", userName="", userRole="user"; // userRole: user/low/high
let chatWindows = {};

// ç™»å…¥
loginBtn.onclick = async ()=>{
  const result = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  location.reload();
};

// ç›£è½ç™»å…¥ç‹€æ…‹
auth.onAuthStateChanged(async user=>{
  if(!user) return;
  userEmail = user.email;
  userName = user.displayName;
  loginPage.style.display="none";
  chatPage.style.display="block";
  userSpan.textContent = `${userName} (${userEmail})`;

  // æœ€é«˜ç®¡ç†å“¡
  if(userEmail==="chianghansen0302@gmail.com") userRole="high";

  // è¨˜éŒ„ç”¨æˆ¶
  await db.collection("users").doc(userEmail).set({name:userName,email:userEmail,role:userRole},{merge:true});

  loadFriends();
  loadGroups();
  loadRequests();
  loadAnnouncement();
});

// å¥½å‹æ¸…å–®
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const data=doc.data();
      const li=document.createElement("li");
      li.textContent=data.email;
      li.onclick=()=>openChatWindow([userEmail,data.email].sort().join("_"),data.email);
      friendList.appendChild(li);
    });
  });
}

// ç¾¤çµ„æ¸…å–®
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.id;
      li.onclick=()=>openChatWindow(doc.id,doc.id);
      groupList.appendChild(li);
    });
  });
}

// å¥½å‹è«‹æ±‚
addFriendBtn.onclick=async ()=>{
  const email=addFriendEmail.value.trim();
  if(!email) return alert("è«‹è¼¸å…¥å¥½å‹ Gmail");
  if(email===userEmail) return alert("ä¸èƒ½åŠ è‡ªå·±");
  try{
    await db.collection("users").doc(email).set({email},{merge:true});
    await db.collection("users").doc(email).collection("requests").add({
      from:userEmail,
      status:"pending",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("å¥½å‹è«‹æ±‚å·²é€å‡ºï¼");
    addFriendEmail.value="";
  }catch(err){ alert("é€å‡ºå¥½å‹è«‹æ±‚å¤±æ•—ï¼š"+err.message); }
};

// åŠ è¼‰å¥½å‹è«‹æ±‚
function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests")
    .where("status","==","pending")
    .onSnapshot(snap=>{
      requestList.innerHTML="";
      snap.forEach(doc=>{
        const data=doc.data();
        const li=document.createElement("li");
        li.textContent=`${data.from} æƒ³åŠ ä½ ç‚ºå¥½å‹`;

        const acceptBtn=document.createElement("button");
        acceptBtn.textContent="åŒæ„";
        acceptBtn.className="request-btn";
        acceptBtn.onclick=async ()=>{
          await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
          await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
          await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
        };
        const rejectBtn=document.createElement("button");
        rejectBtn.textContent="æ‹’çµ•";
        rejectBtn.className="request-btn";
        rejectBtn.onclick=async ()=>{
          await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"rejected"});
        };
        li.appendChild(acceptBtn); li.appendChild(rejectBtn);
        requestList.appendChild(li);
      });
    });
}

// å»ºç«‹ç¾¤çµ„
createGroupBtn.onclick=async ()=>{
  if(userRole==="user") return alert("åªæœ‰ç®¡ç†å“¡å¯å‰µå»ºç¾¤çµ„");
  const name=newGroupName.value.trim();
  if(!name) return alert("è«‹è¼¸å…¥ç¾¤çµ„åç¨±");
  await db.collection("groups").doc(name).set({createdBy:userEmail});
  newGroupName.value="";
};

// å…¬å‘Š
announcementBtn.onclick=async ()=>{
  if(userRole!=="high") return alert("åªæœ‰é«˜éšç®¡ç†å“¡å¯ç™¼å…¬å‘Š");
  const text=announcementInput.value.trim();
  if(!text) return;
  await db.collection("announcement").doc("global").set({text,time:firebase.firestore.FieldValue.serverTimestamp()});
  announcementInput.value="";
};
function loadAnnouncement(){
  db.collection("announcement").doc("global").onSnapshot(doc=>{
    if(doc.exists) announcementDiv.textContent=doc.data().text;
  });
}

// é–‹å•ŸèŠå¤©çª—
function openChatWindow(roomId,title,watch=false){
  if(chatWindows[roomId]) return;
  const win=document.createElement("div");
  win.className="chat-window"; win.id="win_"+roomId;

  const header=document.createElement("div");
  header.className="chat-header";
  header.innerHTML=`<span>${title}</span><button>X</button>`;
  win.appendChild(header);

  const msgDiv=document.createElement("div"); msgDiv.className="chat-messages"; win.appendChild(msgDiv);

  const inputDiv=document.createElement("div"); inputDiv.className="chat-input";
  const input=document.createElement("input"); input.placeholder="è¼¸å…¥è¨Šæ¯...";
  const btn=document.createElement("button"); btn.textContent="é€å‡º";
  inputDiv.appendChild(input); inputDiv.appendChild(btn); win.appendChild(inputDiv);

  chatArea.appendChild(win);

  header.querySelector("button").onclick=()=>{
    if(chatWindows[roomId]) chatWindows[roomId]();
    chatArea.removeChild(win);
    delete chatWindows[roomId];
  }

  // ç›£è½è¨Šæ¯
  const unsub=db.collection("messages").doc(roomId).collection("chats")
    .orderBy("time","desc").limit(100)
    .onSnapshot(snap=>{
      msgDiv.innerHTML="";
      const arr=snap.docs.slice().reverse();
      arr.forEach(doc=>{
        const d=doc.data();
        msgDiv.innerHTML+=`<div class="msg">${d.from}: ${d.text}</div>`;
      });
      msgDiv.scrollTop=msgDiv.scrollHeight;
    });
  chatWindows[roomId]=unsub;

  // ç™¼è¨Šæ¯
  if(userRole==="high" && watch) inputDiv.style.display="none"; // ç›£çœ‹åªè®€
  btn.onclick=async ()=>{
    const text=input.value.trim();
    if(!text) return;
    await db.collection("messages").doc(roomId).collection("chats").add({
      from:userEmail, text, time:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value="";
  };

  // Enterç™¼é€, Shiftæ›è¡Œ
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); btn.click(); }
  });
}

// ç›£çœ‹ç§èŠ
watchBtn.onclick=()=>{
  if(userRole!=="high") return alert("åªæœ‰é«˜éšç®¡ç†å“¡å¯ç›£çœ‹ç§èŠ");
  const val=watchInput.value.trim();
  if(!val.includes("_")) return alert("æ ¼å¼: emailA_emailB");
  openChatWindow(val,val,true);
};
</script>
</body>
</html>
