<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ v5 (å½ˆçª—ç©©å®šä¿®æ­£ç‰ˆ)</title>

<!-- Load Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --bg:#0f1724; --panel:#111827; --muted:#9ca3af; --accent:#5865f2; --accent-2:#2ecc71; --danger:#ef4444;
  --card:#0b1020; --hover:#1f2937;
}
*{box-sizing:border-box;font-family:Inter, "Noto Sans TC", "å¾®è»Ÿæ­£é»‘é«”", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
body{margin:0;background:linear-gradient(180deg,#071025 0%, #071223 100%);color:#e6eef8; height: 100vh; overflow: hidden;}
a{color:inherit}
.center{display:flex;justify-content:center;align-items:center} /* ä¿æŒé€™å€‹é¡åˆ¥ä¾›å…¶ä»–çµ„ä»¶ä½¿ç”¨ */

/* App Layout */
#app-container{
  display:flex;
  height:100vh;
  max-width:1400px;
  margin:0 auto;
}

/* Sidebar (Left Panel) */
#sidebar{
  width:300px; /* Wider sidebar for more controls */
  min-width:300px;
  background-color:var(--panel);
  padding:16px 12px;
  border-right:1px solid #1f2937;
  display:flex;
  flex-direction:column;
}
.sidebar-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  transition:background-color 0.2s, transform 0.1s;
  margin-bottom:4px;
}
.sidebar-item:hover{
  background-color:var(--hover);
  transform: translateY(-1px);
}
.sidebar-item.active{
  background-color:var(--accent);
  box-shadow: 0 2px 5px rgba(88, 101, 242, 0.3);
}
.sidebar-item.active:hover{
  background-color:var(--accent);
}
.message-avatar{
  width:36px;
  height:36px;
  border-radius:9999px;
  background-color:var(--accent);
  flex-shrink:0;
  font-weight:700;
  font-size:0.9rem;
}
.chat-avatar-lg { width: 50px; height: 50px; font-size: 1.5rem; }

/* Chat Area (Right Panel) */
#chat-area{
  flex-grow:1;
  background-color:var(--bg);
  display:flex;
  flex-direction:column;
}

/* Chat Header */
.chat-header{
  padding:12px 16px;
  background-color:var(--panel);
  border-bottom:1px solid #1f2937;
  font-size:1.25rem;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.chat-header button{
  padding:6px 12px;
  border-radius:6px;
  font-size:0.875rem;
  transition:background-color 0.2s;
}

/* Message List */
.message-list{
  flex-grow:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.message-list::-webkit-scrollbar { width: 8px; }
.message-list::-webkit-scrollbar-thumb { background-color: #374151; border-radius: 4px; }
.message-list::-webkit-scrollbar-track { background-color: #1f2937; }

/* Message Item */
.message-item{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.message-content{
  flex-grow:1;
}
.message-meta{
  display:flex;
  align-items:baseline;
  gap:8px;
  font-size:0.875rem;
  color:var(--muted);
  margin-bottom:2px;
}
.message-meta .username{
  color:#e6eef8;
  font-weight:600;
  font-size:1rem;
}
.message-text{
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.5;
}

/* Chat Input */
.chat-input-container{
  padding:16px;
  background-color:var(--panel);
  border-top:1px solid #1f2937;
}
.chat-input-box{
  background-color:var(--card);
  border-radius:12px;
  display:flex;
  align-items:flex-end;
  overflow:hidden;
}
.chat-input-box textarea{
  flex-grow:1;
  background:transparent;
  border:none;
  outline:none;
  padding:12px 16px;
  resize:none;
  color:inherit;
  min-height:48px;
  max-height:150px;
}
.chat-input-box button{
  padding:12px 16px;
  background-color:var(--accent);
  color:white;
  font-weight:600;
  border:none;
  outline:none;
  cursor:pointer;
  transition:background-color 0.2s;
  min-height:48px;
}
.chat-input-box button:hover{
  background-color:#4752c4;
}

/* Tab Controls */
.tab-btn {
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s;
  font-weight: 600;
  color: var(--muted);
}
.tab-btn.active {
  background-color: var(--accent);
  color: white;
}
.tab-btn:not(.active):hover {
  background-color: var(--hover);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #sidebar {
    width: 100%;
    min-width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid #1f2937;
  }
  #app-container {
    flex-direction: column;
  }
  #chat-area {
    height: calc(100vh - 200px); /* Adjust based on collapsed sidebar height */
  }
}
</style>
</head>
<body class="center">

<!-- Message Box Modal (for errors/alerts/confirmations) -->
<div id="message-box" class="center fixed inset-0 bg-black/70 z-[2000] hidden">
  <div class="message-box-content bg-panel p-6 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300 transform scale-100">
    <div id="message-box-header" class="text-xl font-bold mb-2 text-accent">æ¨™é¡Œ</div>
    <div id="message-box-body" class="text-white mb-6">å…§å®¹</div>
    <div class="message-box-footer flex justify-end gap-3">
      <button id="message-box-cancel-btn" class="hidden bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition duration-150">å–æ¶ˆ</button>
      <button id="message-box-ok-btn" class="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-150">ç¢ºå®š</button>
    </div>
  </div>
</div>

<!-- Login Screen (Page 1) -->
<div id="login-screen" class="fixed inset-0 bg-bg z-[3000] flex items-center justify-center hidden">
  <div class="login-card bg-panel p-10 rounded-2xl text-center shadow-2xl max-w-md w-11/12">
    <h1 class="text-3xl font-extrabold mb-2 text-accent-2">æ ¡åœ’èŠå¤©å®¤ ğŸ”¥</h1>
    <p class="text-gray-400 mb-6">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥é–‹å§‹èˆ‡æœ‹å‹èŠå¤©ã€‚</p>
    <button id="googleLoginBtn" class="bg-white text-gray-900 px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition duration-200 flex items-center justify-center mx-auto transform hover:scale-[1.02]">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" class="mr-3"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,7.917-11.303,7.917c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238c-2.053,1.383-4.524,2.19-7.219,2.19c-5.202,0-9.619-3.317-11.283-7.746l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.08,5.55l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
      ä½¿ç”¨ Google ç™»å…¥
    </button>
  </div>
</div>

<!-- Main Application Container (Page 2) -->
<div id="app-container" class="hidden">
  
  <!-- Sidebar (Left Panel) -->
  <div id="sidebar">
    <h2 class="text-2xl font-bold mb-4 text-white">ğŸ”¥ èŠå¤©å®¤</h2>
    
    <!-- Tab Controls -->
    <div class="flex gap-1 mb-4 border-b border-gray-700 pb-2">
      <div id="tab-dm" class="tab-btn active" data-tab="dm">ç§èŠ</div>
      <div id="tab-group" class="tab-btn" data-tab="group">ç¾¤çµ„</div>
      <div id="tab-request" class="tab-btn" data-tab="request">è«‹æ±‚ (<span id="request-count">0</span>)</div>
    </div>
    
    <!-- Friend Search Section (Always visible) -->
    <div class="mb-4">
      <input id="friendSearchInput" type="email" placeholder="æœå°‹æˆ–ç™¼é€å¥½å‹è«‹æ±‚ (Email)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm text-white focus:ring-accent focus:border-accent" />
      <button id="sendRequestBtn" class="w-full mt-2 bg-accent hover:bg-blue-600 text-white text-sm font-semibold px-3 py-2 rounded-lg transition duration-150">ç™¼é€è«‹æ±‚</button>
    </div>

    <!-- Content List Container -->
    <div id="content-list-container" class="flex flex-col gap-2 flex-grow overflow-y-auto mb-4">
      <!-- DM List (Active by default) -->
      <div id="dm-list" class="tab-content">
        <p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰é€²è¡Œä¸­çš„ç§èŠ...</p>
      </div>

      <!-- Group List (Hidden by default) -->
      <div id="group-list" class="tab-content hidden">
        <p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰åŠ å…¥ä»»ä½•ç¾¤çµ„...</p>
      </div>

      <!-- Request List (Hidden by default) -->
      <div id="request-list" class="tab-content hidden">
        <p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰å¾…è™•ç†çš„å¥½å‹è«‹æ±‚...</p>
      </div>
    </div>
    
    <!-- Admin & Monitor Controls (Visible only to Admin) -->
    <div id="admin-controls" class="p-3 border border-gray-700 rounded-xl mb-4 bg-gray-800/50 hidden">
      <h3 class="text-sm font-semibold mb-2 text-red-400">ğŸš¨ ç®¡ç†å“¡å°ˆå€</h3>
      <button id="createGroupBtn" class="w-full bg-accent-2 hover:bg-green-600 text-white text-sm px-3 py-2 rounded-lg transition duration-150 mb-2">å»ºç«‹æ–°ç¾¤çµ„</button>
      <div class="flex gap-2 items-center">
        <input id="monitorInput" type="text" placeholder="emailA_emailB ç›£çœ‹" class="flex-grow bg-gray-700 border border-gray-600 rounded-md p-2 text-xs text-white" />
        <button id="monitorBtn" class="bg-red-600 hover:bg-red-500 text-white text-xs font-semibold px-3 py-2 rounded-lg transition duration-150">ç›£çœ‹</button>
      </div>
    </div>

    <!-- User Info Footer -->
    <div id="user-info" class="p-3 bg-gray-800 rounded-xl shadow-inner">
      <div class="flex items-center gap-3">
        <div id="me-avatar" class="center message-avatar bg-accent-2"></div>
        <div class="flex-grow min-w-0">
          <div id="me-email" class="text-sm font-medium truncate">loading...</div>
          <div id="me-role" class="text-xs text-green-400 font-semibold">user</div>
        </div>
        <button id="logoutBtn" class="text-red-400 hover:text-red-300 transition duration-150 p-2 rounded-lg hover:bg-gray-700" title="ç™»å‡º">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Area (Right Panel) -->
  <div id="chat-area">
    <div id="current-chat-header" class="chat-header">
      <div class="flex items-center gap-3">
        <div id="chat-avatar" class="center chat-avatar-lg bg-gray-600">?</div>
        <span id="chat-title">é¸æ“‡ä¸€å€‹èŠå¤©ä¾†é–‹å§‹</span>
      </div>
      <div id="chat-actions" class="flex gap-2">
        <!-- Action buttons (Block/Delete/Group Management) will be inserted here -->
      </div>
    </div>
    
    <!-- Main Chat Content -->
    <div id="current-chat-content" class="flex flex-col flex-grow">
      
      <div id="default-message" class="center flex-col flex-grow text-gray-500 text-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-dots mb-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M10 8h.01"/><path d="M14 8h.01"/><path d="M18 8h.01"/></svg>
        <p>é»æ“Šå·¦å´åˆ—è¡¨ä¸­çš„å¥½å‹æˆ–ç¾¤çµ„å³å¯é–‹å§‹èŠå¤©</p>
      </div>

      <!-- Live Chat Window (Hidden by default) -->
      <div id="live-chat-window" class="flex-col flex-grow hidden">
        <div class="flex-grow flex overflow-hidden">
          
          <!-- Message List -->
          <div id="message-list" class="message-list flex-grow">
            <!-- Messages inserted here -->
          </div>
          
          <!-- Group Member List (Visible only for group chats) -->
          <div id="group-member-list" class="w-1/4 min-w-[200px] border-l border-gray-700 p-4 bg-gray-800/50 hidden overflow-y-auto">
            <h4 class="text-sm font-bold mb-3 text-white">ç¾¤çµ„æˆå“¡ (<span id="member-count">0</span>)</h4>
            <div id="member-list-content" class="flex flex-col gap-2">
              <!-- Members inserted here -->
            </div>
            <div id="group-management-admin" class="mt-4 pt-4 border-t border-gray-700 hidden">
              <h5 class="text-sm font-bold mb-2 text-red-400">ç®¡ç†æˆå“¡</h5>
              <input id="manageMemberEmail" type="email" placeholder="æˆå“¡ Email" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-xs text-white mb-2" />
              <button id="addMemberBtn" class="w-full bg-accent hover:bg-blue-600 text-white text-xs font-semibold px-3 py-2 rounded-lg transition duration-150 mb-1">åŠ å…¥æˆå“¡</button>
              <button id="removeMemberBtn" class="w-full bg-danger hover:bg-red-600 text-white text-xs font-semibold px-3 py-2 rounded-lg transition duration-150">è¸¢å‡ºæˆå“¡</button>
            </div>
          </div>
        </div>

        <div id="chat-input-container" class="chat-input-container">
          <div id="block-info" class="text-sm text-red-400 mb-2 p-2 rounded-lg bg-red-900/30 hidden">
              æ‚¨å·²è¢«å°æ–¹å°é–ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚
          </div>
          <div class="chat-input-box">
            <textarea id="chat-input-textarea" placeholder="è¼¸å…¥è¨Šæ¯... (Enter é€å‡º, Shift+Enter æ›è¡Œ)" rows="1"></textarea>
            <button id="chat-send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
// å°å…¥ Firebase æ¨¡çµ„åŒ– SDK (v11.6.1)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    signInWithCustomToken, 
    onAuthStateChanged, 
    signOut, 
    GoogleAuthProvider, 
    signInWithPopup 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc, 
    addDoc, 
    deleteDoc, 
    onSnapshot, 
    collection, 
    query, 
    where, 
    orderBy, 
    limit,
    serverTimestamp,
    increment,
    setLogLevel
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


// Global Variables for Firebase configuration provided by the environment
const ADMIN_EMAIL = 'chianghansen0302@gmail.com';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Firebase Configuration (å¾ç”¨æˆ¶æä¾›çš„é…ç½®ä¸­è¤‡è£½)
const firebaseConfig = {
    apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
    authDomain: "chat-52c0d.firebaseapp.com",
    projectId: "chat-52c0d",
    storageBucket: "chat-52c0d.firebase-storage.app",
    messagingSenderId: "449329325475",
    appId: "1:449329325475:web:75f255c4055360dc9e6616",
    measurementId: "G-8R8648H53V"
};

const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebase App Initialization
let app, db, auth;

// Global state variables
let ME_EMAIL = null;
let ME_ID = null;
let ME_ROLE = 'user';
const unsubs = []; // Array to store firestore unsubscribe functions
let currentRoomId = null;
let currentChatType = null; // 'dm', 'group', or 'monitor'
let currentOtherEmail = null;
let currentMessageResolve = null; // Used for single-instance message box resolution

// DOM Elements (ä¿æŒä¸è®Š)
const loginScreen = document.getElementById('login-screen');
const appContainer = document.getElementById('app-container');
const googleLoginBtn = document.getElementById('googleLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');

// Sidebar Elements
const tabBtns = { dm: document.getElementById('tab-dm'), group: document.getElementById('tab-group'), request: document.getElementById('tab-request') };
const tabContents = { dm: document.getElementById('dm-list'), group: document.getElementById('group-list'), request: document.getElementById('request-list') };
const requestCountEl = document.getElementById('request-count');
const friendSearchInput = document.getElementById('friendSearchInput');
const sendRequestBtn = document.getElementById('sendRequestBtn');
const adminControls = document.getElementById('admin-controls');
const monitorInput = document.getElementById('monitorInput');
const monitorBtn = document.getElementById('monitorBtn');
const createGroupBtn = document.getElementById('createGroupBtn');

// Chat Area Elements
const chatHeader = document.getElementById('chat-title');
const chatAvatar = document.getElementById('chat-avatar');
const chatActions = document.getElementById('chat-actions');
const messageList = document.getElementById('message-list');
const liveChatWindow = document.getElementById('live-chat-window');
const defaultMessage = document.getElementById('default-message');
const chatInputContainer = document.getElementById('chat-input-container');
const chatInputTextarea = document.getElementById('chat-input-textarea');
const chatSendBtn = document.getElementById('chat-send-btn');
const blockInfo = document.getElementById('block-info');
const groupMemberList = document.getElementById('group-member-list');
const memberListContent = document.getElementById('member-list-content');
const memberCountEl = document.getElementById('member-count');
const groupManagementAdmin = document.getElementById('group-management-admin');
const manageMemberEmail = document.getElementById('manageMemberEmail');
const addMemberBtn = document.getElementById('addMemberBtn');
const removeMemberBtn = document.getElementById('removeMemberBtn');

/* ==================== Utility Functions ==================== */

/**
 * Custom function to display error/success messages instead of alert() and confirm().
 * NOTE: The button click handlers are set up ONCE in setupMessageBoxHandlers().
 */
function showMessage(title, body, type = 'info') {
    return new Promise(resolve => {
        const box = document.getElementById('message-box');
        const header = document.getElementById('message-box-header');
        const bodyEl = document.getElementById('message-box-body');
        const cancelBtn = document.getElementById('message-box-cancel-btn');
        const okBtn = document.getElementById('message-box-ok-btn');
        
        currentMessageResolve = resolve; // Store the resolve function for the permanent handlers

        header.textContent = title;
        bodyEl.textContent = body;

        // Apply color based on type
        header.style.color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--accent-2)' : 'var(--accent)';

        // Setup button visibility only (handlers are permanent)
        if (type === 'confirm') {
            cancelBtn.classList.remove('hidden');
            okBtn.textContent = 'ç¢ºå®š';
        } else {
            cancelBtn.classList.add('hidden');
            okBtn.textContent = 'ç¢ºå®š';
        }

        box.classList.remove('hidden');
    });
}

/**
 * Sets up permanent click handlers for the message box buttons.
 */
function setupMessageBoxHandlers() {
    const box = document.getElementById('message-box');
    const okBtn = document.getElementById('message-box-ok-btn');
    const cancelBtn = document.getElementById('message-box-cancel-btn');

    const handleResolve = (result) => {
        if (currentMessageResolve) {
            box.classList.add('hidden');
            currentMessageResolve(result);
            currentMessageResolve = null; // Clear the resolver after use
        }
    };

    // Attach permanent listeners
    okBtn.onclick = () => handleResolve(true);
    cancelBtn.onclick = () => handleResolve(false);
}

/**
 * Helper to generate a consistent DM room ID regardless of user order.
 */
function getDmRoomId(emailA, emailB) {
    const emails = [emailA.toLowerCase(), emailB.toLowerCase()].sort();
    return emails[0] + "_" + emails[1];
}

/**
 * Creates the HTML for a message item.
 */
function createMessageHtml(message) {
    const fromEmail = message.from || message.sender; // Handle both DM (from) and Group (sender) fields
    const isMe = fromEmail === ME_EMAIL;
    const initial = fromEmail ? fromEmail.charAt(0).toUpperCase() : '?';
    const timestamp = message.time ? new Date(message.time.seconds * 1000).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : 'ç™¼é€ä¸­...';
    
    // Check if I am blocked (Only relevant for DM chats, but keep the check generic)
    const isBlockedMessage = message.isBlocked === true; 
    
    return `
        <div class="message-item ${isMe ? 'self-end flex-row-reverse' : ''} ${isBlockedMessage ? 'opacity-50' : ''}">
            <div class="center message-avatar ${isMe ? 'bg-blue-500' : 'bg-green-500'}">
                ${initial}
            </div>
            <div class="message-content ${isMe ? 'text-right' : 'text-left'}">
                <div class="message-meta ${isMe ? 'flex-row-reverse' : ''}">
                    <span class="username">${isMe ? 'æˆ‘' : fromEmail}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-text p-2 rounded-xl max-w-lg ${isMe ? 'bg-blue-600' : 'bg-gray-700'} inline-block shadow-md">
                    ${message.text}
                </div>
            </div>
        </div>
    `;
}

// Global function to clear all active listeners
function clearUnsubs() {
    unsubs.forEach(u => u && u());
    unsubs.length = 0;
}

/* ==================== UI / Tab Management ==================== */

function switchTab(targetTab) {
    ['dm', 'group', 'request'].forEach(tab => {
        const isActive = tab === targetTab;
        tabBtns[tab].classList.toggle('active', isActive);
        tabContents[tab].classList.toggle('hidden', !isActive);
    });
}

// Tab button click listeners
Object.keys(tabBtns).forEach(tab => {
    tabBtns[tab].onclick = () => switchTab(tab);
});

/* ==================== Chat Actions (Block/Delete/Group Management) ==================== */

/**
 * Renders the action buttons (Block/Delete) in the chat header for DMs.
 */
function renderDmActions(otherEmail) {
    chatActions.innerHTML = `
        <button id="blockBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white transition duration-150">å°é–</button>
        <button id="deleteFriendBtn" class="bg-red-600 hover:bg-red-700 text-white transition duration-150">åˆªé™¤å¥½å‹</button>
    `;

    document.getElementById('blockBtn').onclick = () => handleBlockUser(otherEmail);
    document.getElementById('deleteFriendBtn').onclick = () => handleDeleteFriend(otherEmail);
}

/**
 * Renders the group info (currently none) for group chats.
 */
function renderGroupActions() {
    chatActions.innerHTML = ''; // Groups don't need Block/Delete Friend buttons here
}

async function handleBlockUser(otherEmail) {
    const confirmed = await showMessage('ç¢ºèªå°é–', `æ‚¨ç¢ºå®šè¦å°é–ç”¨æˆ¶ ${otherEmail} å—ï¼Ÿå°é–å¾Œæ‚¨å°‡ç„¡æ³•æ”¶åˆ°ä»–çš„è¨Šæ¯ï¼Œä»–ä¹Ÿç„¡æ³•å°æ‚¨ç™¼é€è¨Šæ¯ã€‚`, 'confirm');
    if (!confirmed) return;

    try {
        // Create a document in my block list
        const blockDocRef = doc(collection(db, 'blocks', ME_EMAIL, 'locked'), otherEmail);
        await setDoc(blockDocRef, {
            blockedAt: serverTimestamp() // Modular call
        });
        showMessage('å°é–æˆåŠŸ', `${otherEmail} å·²è¢«æ‚¨å°é–ã€‚`, 'success');
        
        if (currentOtherEmail === otherEmail) {
            closeChatWindow();
        }

    } catch (e) {
        showMessage('æ“ä½œå¤±æ•—', 'å°é–ç”¨æˆ¶å¤±æ•—ã€‚', 'error');
        console.error("Block user error: ", e);
    }
}

async function handleDeleteFriend(otherEmail) {
    const confirmed = await showMessage('ç¢ºèªåˆªé™¤', `æ‚¨ç¢ºå®šè¦åˆªé™¤å¥½å‹ ${otherEmail} å—ï¼Ÿæ‚¨å°‡ç„¡æ³•å†ç§èŠã€‚`, 'confirm');
    if (!confirmed) return;

    try {
        // 1. Delete friend status from my list
        await deleteDoc(doc(collection(db, 'friends', ME_EMAIL, 'list'), otherEmail));
        // 2. Delete friend status from their list (Assuming symmetric friendship)
        await deleteDoc(doc(collection(db, 'friends', otherEmail, 'list'), ME_EMAIL));

        showMessage('åˆªé™¤æˆåŠŸ', `${otherEmail} å·²å¾æ‚¨çš„å¥½å‹åˆ—è¡¨ä¸­åˆªé™¤ã€‚`, 'success');
        
        if (currentOtherEmail === otherEmail) {
            closeChatWindow();
        }
    } catch (e) {
        showMessage('æ“ä½œå¤±æ•—', 'åˆªé™¤å¥½å‹å¤±æ•—ã€‚', 'error');
        console.error("Delete friend error: ", e);
    }
}

/* ==================== Core Chat Window Logic ==================== */

/**
 * Closes the currently open chat window and clears its state.
 */
function closeChatWindow() {
    clearUnsubs(); // Ensure all Firestore listeners are stopped
    
    currentRoomId = null;
    currentChatType = null;
    currentOtherEmail = null;

    // Reset UI
    chatHeader.textContent = 'é¸æ“‡ä¸€å€‹èŠå¤©ä¾†é–‹å§‹';
    chatAvatar.textContent = '?';
    chatAvatar.className = 'center chat-avatar-lg bg-gray-600';
    chatActions.innerHTML = '';
    liveChatWindow.classList.add('hidden');
    defaultMessage.classList.remove('hidden');
    groupMemberList.classList.add('hidden');
    Array.from(document.querySelectorAll('.sidebar-item')).forEach(el => el.classList.remove('active'));
}

/**
 * Opens a specific chat window and sets up the listener.
 */
function openChatWindow(id, title, type, otherEmail = null) {
    closeChatWindow(); // Close existing chat first
    
    currentRoomId = id;
    currentChatType = type;
    currentOtherEmail = otherEmail;

    // 1. Update Header
    chatHeader.textContent = title;
    chatAvatar.textContent = (title.charAt(0) || '?').toUpperCase();
    chatAvatar.className = `center chat-avatar-lg ${type === 'group' ? 'bg-indigo-600' : type === 'monitor' ? 'bg-red-700' : 'bg-accent'}`;
    
    // 2. Show/Hide Windows
    liveChatWindow.classList.remove('hidden');
    defaultMessage.classList.add('hidden');
    
    // 3. Highlight active item in sidebar
    const activeEl = document.getElementById(`chat-item-${id}`);
    if (activeEl) activeEl.classList.add('active');

    // 4. Setup Chat Actions & Member List
    groupMemberList.classList.add('hidden');
    if (type === 'dm') {
        renderDmActions(otherEmail);
    } else if (type === 'group') {
        renderGroupActions();
        groupMemberList.classList.remove('hidden');
        setupGroupMemberList(id);
    } else if (type === 'monitor') {
        chatActions.innerHTML = `<span class="text-sm font-bold text-red-400">ç®¡ç†å“¡ç›£çœ‹æ¨¡å¼</span>`;
    }

    // 5. Setup chat input area (handles enable/disable based on type/block)
    setupChatInput(otherEmail, id, type);

    // 6. Setup new listener for the chat
    const chatsRef = collection(db, 'chats', id, 'messages');
    let q = query(chatsRef, orderBy('time'), limit(type === 'monitor' ? 100 : 50)); // Modular call

    const unsub = onSnapshot(q, snapshot => { // Modular call
        messageList.innerHTML = '';
        const fragment = document.createDocumentFragment();
        
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            const message = {
                from: data.from,
                sender: data.sender, // For groups
                text: data.text,
                time: data.time || { seconds: Date.now() / 1000 }
            };

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = createMessageHtml(message);
            fragment.appendChild(tempDiv.firstChild);
        });

        messageList.appendChild(fragment);
        // Scroll to bottom
        messageList.scrollTop = messageList.scrollHeight;
    }, error => {
        console.error("Error listening to messages: ", error);
        showMessage('èŠå¤©éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥è¨Šæ¯ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚', 'error');
    });

    unsubs.push(unsub);
}

/**
 * Sets up the input box and send logic for the current chat.
 */
function setupChatInput(otherEmail, roomId, type) {
    const ta = chatInputTextarea;
    const send = chatSendBtn;

    // Reset Input
    ta.value = '';
    ta.style.height = 'auto';

    // Disable input for monitor
    if (type === 'monitor') {
        ta.disabled = true;
        send.disabled = true;
        chatInputContainer.style.opacity = 0.5;
        blockInfo.classList.add('hidden');
        ta.placeholder = 'ç›£çœ‹æ¨¡å¼ç„¡æ³•ç™¼é€è¨Šæ¯';
        return;
    } else {
        ta.disabled = false;
        send.disabled = false;
        chatInputContainer.style.opacity = 1.0;
        blockInfo.classList.add('hidden'); // Ensure block info is hidden by default
        ta.placeholder = 'è¼¸å…¥è¨Šæ¯... (Enter é€å‡º, Shift+Enter æ›è¡Œ)';
    }

    send.onclick = async () => {
        const text = ta.value.trim();
        if (!text) return;

        let payload = {
            text,
            time: serverTimestamp(), // Modular call
        };

        if (type === 'dm') {
            // DM: Check if I am blocked by the other user
            const blockDocRef = doc(collection(db, 'blocks', otherEmail, 'locked'), ME_EMAIL); // Modular call
            const iAmBlocked = await getDoc(blockDocRef); // Modular call
            
            if (iAmBlocked.exists()) { // Modular call: use exists()
                blockInfo.classList.remove('hidden');
                showMessage('ç„¡æ³•ç™¼é€', 'æ‚¨å·²è¢«å°æ–¹å°é–ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚', 'error');
                return;
            } else {
                blockInfo.classList.add('hidden');
            }
            payload.from = ME_EMAIL;

        } else if (type === 'group') {
            // Group: Check if I am a member
            const memberDocRef = doc(collection(db, 'groups', roomId, 'members'), ME_EMAIL);
            const memberDoc = await getDoc(memberDocRef); // Modular call
            if (!memberDoc.exists()) {
                showMessage('éŒ¯èª¤', 'æ‚¨ä¸æ˜¯æ­¤ç¾¤çµ„çš„æˆå“¡ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚', 'error');
                return;
            }
            payload.sender = ME_EMAIL;
        }

        try {
            // Send the message
            const chatColRef = collection(db, 'chats', roomId, 'messages');
            await addDoc(chatColRef, payload); // Modular call
            
            // Update lastChat time for DM list/Group list sorting
            if (type === 'dm') {
                const myFriendRef = doc(collection(db, 'friends', ME_EMAIL, 'list'), otherEmail);
                const otherFriendRef = doc(collection(db, 'friends', otherEmail, 'list'), ME_EMAIL);
                
                await setDoc(myFriendRef, { lastChat: serverTimestamp() }, { merge: true }); // Modular call
                await setDoc(otherFriendRef, { lastChat: serverTimestamp() }, { merge: true }); // Modular call
            } else if (type === 'group') {
                // Update the group last activity time
                const groupRef = doc(db, 'groups', roomId);
                await setDoc(groupRef, { lastChat: serverTimestamp() }, { merge: true }); // Modular call
            }

            ta.value = '';
            ta.style.height = 'auto'; // Reset height after sending
        } catch (e) {
            showMessage('ç™¼é€å¤±æ•—', 'è¨Šæ¯ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            console.error("Send message error: ", e);
        }
    };

    // Enter send, Shift+Enter newline
    ta.onkeydown = e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send.click();
        }
    };
    // Auto-resize textarea
    ta.oninput = () => {
        ta.style.height = 'auto';
        ta.style.height = (ta.scrollHeight) + 'px';
    };
}

/* ==================== Friend System Logic ==================== */

sendRequestBtn.onclick = async () => {
    const targetEmail = friendSearchInput.value.trim().toLowerCase();
    if (!targetEmail || targetEmail === ME_EMAIL) {
        return showMessage('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€ã€‚', 'error');
    }

    try {
        // 1. Check if the target user exists (optional but good practice)
        const targetUserDoc = await getDoc(doc(db, 'users', targetEmail)); // Modular call
        if (!targetUserDoc.exists()) {
            return showMessage('éŒ¯èª¤', `ç”¨æˆ¶ ${targetEmail} ä¸å­˜åœ¨æˆ–å°šæœªè¨»å†Šã€‚`, 'error');
        }

        // 2. Check if already friends
        const friendDoc = await getDoc(doc(collection(db, 'friends', ME_EMAIL, 'list'), targetEmail)); // Modular call
        if (friendDoc.exists()) {
            return showMessage('æç¤º', `${targetEmail} å·²ç¶“æ˜¯æ‚¨çš„å¥½å‹ã€‚`, 'info');
        }

        // 3. Send Request: Create a document in the target's incoming requests
        const targetRequestRef = doc(collection(db, 'friends', targetEmail, 'requests'), ME_EMAIL);
        await setDoc(targetRequestRef, {
            senderEmail: ME_EMAIL,
            sentAt: serverTimestamp() // Modular call
        });
        
        // 4. Record outgoing request (for tracking)
        const mySentRef = doc(collection(db, 'friends', ME_EMAIL, 'sent_requests'), targetEmail);
        await setDoc(mySentRef, {
            recipientEmail: targetEmail,
            sentAt: serverTimestamp() // Modular call
        });

        showMessage('è«‹æ±‚å·²ç™¼é€', `å¥½å‹è«‹æ±‚å·²æˆåŠŸç™¼é€çµ¦ ${targetEmail}ã€‚`, 'success');
        friendSearchInput.value = '';

    } catch (e) {
        showMessage('ç™¼é€å¤±æ•—', 'ç™¼é€å¥½å‹è«‹æ±‚å¤±æ•—ã€‚', 'error');
        console.error("Send friend request error: ", e);
    }
};

/**
 * Renders the list of friend requests.
 */
function renderRequestList(requests) {
    const listEl = tabContents.request;
    listEl.innerHTML = '';
    requestCountEl.textContent = requests.length;

    if (requests.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰å¾…è™•ç†çš„å¥½å‹è«‹æ±‚...</p>';
        return;
    }

    requests.forEach(req => {
        const item = document.createElement('div');
        item.className = 'sidebar-item flex justify-between items-center bg-gray-700/50 hover:bg-gray-700';
        item.innerHTML = `
            <div class="flex items-center gap-2 min-w-0">
                <div class="center message-avatar bg-red-400">${req.senderEmail.charAt(0).toUpperCase()}</div>
                <span class="truncate">${req.senderEmail}</span>
            </div>
            <div class="flex gap-1">
                <button data-action="accept" data-email="${req.senderEmail}" class="bg-accent-2 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs transition duration-150">æ¥å—</button>
                <button data-action="reject" data-email="${req.senderEmail}" class="bg-danger hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs transition duration-150">æ‹’çµ•</button>
            </div>
        `;
        listEl.appendChild(item);
    });

    // Event listeners attached to dynamically created buttons
    listEl.querySelectorAll('button').forEach(btn => {
        btn.onclick = (e) => handleFriendRequestAction(e.target.dataset.action, e.target.dataset.email);
    });
}

/**
 * Handles accepting or rejecting a friend request.
 */
async function handleFriendRequestAction(action, senderEmail) {
    const requestDocRef = doc(collection(db, 'friends', ME_EMAIL, 'requests'), senderEmail);
    const myFriendListRef = doc(collection(db, 'friends', ME_EMAIL, 'list'), senderEmail);
    const senderFriendListRef = doc(collection(db, 'friends', senderEmail, 'list'), ME_EMAIL);
    const senderSentRequestRef = doc(collection(db, 'friends', senderEmail, 'sent_requests'), ME_EMAIL);

    try {
        if (action === 'accept') {
            // 1. Add to my friend list
            await setDoc(myFriendListRef, {
                email: senderEmail,
                addedAt: serverTimestamp(), // Modular call
                roomId: getDmRoomId(ME_EMAIL, senderEmail)
            });
            // 2. Add to sender's friend list (symmetric friendship)
            await setDoc(senderFriendListRef, {
                email: ME_EMAIL,
                addedAt: serverTimestamp(), // Modular call
                roomId: getDmRoomId(ME_EMAIL, senderEmail)
            });
            // 3. Delete the request
            await deleteDoc(requestDocRef); // Modular call
            // 4. Delete the sender's outgoing request
            await deleteDoc(senderSentRequestRef); // Modular call

            showMessage('å¥½å‹æˆåŠŸ', `${senderEmail} å·²æˆç‚ºæ‚¨çš„å¥½å‹ï¼`, 'success');
        } else if (action === 'reject') {
            // 1. Delete the request
            await deleteDoc(requestDocRef); // Modular call
            // 2. Delete the sender's outgoing request
            await deleteDoc(senderSentRequestRef); // Modular call
            showMessage('è«‹æ±‚å·²æ‹’çµ•', `å·²æ‹’çµ• ${senderEmail} çš„å¥½å‹è«‹æ±‚ã€‚`, 'info');
        }
    } catch (e) {
        showMessage('æ“ä½œå¤±æ•—', `${action === 'accept' ? 'è™•ç†' : 'æ‹’çµ•'}å¥½å‹è«‹æ±‚å¤±æ•—ã€‚`, 'error');
        console.error(`Handle request ${action} error: `, e);
    }
}

/**
 * Renders the list of accepted DM friends.
 */
function renderDmList(friends) {
    const listEl = tabContents.dm;
    listEl.innerHTML = '';

    if (friends.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰é€²è¡Œä¸­çš„ç§èŠ...</p>';
        return;
    }

    friends.forEach(friend => {
        const otherEmail = friend.email;
        const roomId = friend.roomId;
        const initial = otherEmail.charAt(0).toUpperCase();

        const item = document.createElement('div');
        item.id = `chat-item-${roomId}`;
        item.className = 'sidebar-item';
        // Event listener attached to dynamically created DM item
        item.onclick = () => openChatWindow(roomId, `@ ${otherEmail}`, 'dm', otherEmail);
        
        item.innerHTML = `
            <div class="center message-avatar bg-gray-600">${initial}</div>
            <div class="flex flex-col min-w-0 flex-grow">
                <span class="truncate">${otherEmail}</span>
                <span class="text-xs text-gray-400 truncate">${friend.lastChat ? new Date(friend.lastChat.seconds * 1000).toLocaleTimeString('zh-TW') : 'æ–°å¥½å‹'}</span>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/* ==================== Group System Logic ==================== */

createGroupBtn.onclick = async () => {
    const groupName = prompt('è«‹è¼¸å…¥ç¾¤çµ„åç¨±:');
    
    if (typeof groupName !== 'string' || groupName.trim().length < 2) {
        return showMessage('å»ºç«‹å¤±æ•—', 'ç¾¤çµ„åç¨±ç„¡æ•ˆã€‚', 'error');
    }

    try {
        const groupsColRef = collection(db, 'groups');
        const newGroupRef = await addDoc(groupsColRef, { // Modular call
            name: groupName.trim(),
            admin: ME_EMAIL,
            createdAt: serverTimestamp(), // Modular call
            lastChat: serverTimestamp(), // Modular call
            memberCount: 1
        });

        // Add admin as the first member
        const memberDocRef = doc(collection(db, 'groups', newGroupRef.id, 'members'), ME_EMAIL);
        await setDoc(memberDocRef, { // Modular call
            email: ME_EMAIL,
            role: 'admin',
            joinedAt: serverTimestamp() // Modular call
        });
        
        showMessage('å»ºç«‹æˆåŠŸ', `ç¾¤çµ„ "${groupName}" å·²å»ºç«‹ï¼`, 'success');
        openChatWindow(newGroupRef.id, `# ${groupName.trim()}`, 'group');

    } catch (e) {
        showMessage('å»ºç«‹å¤±æ•—', 'å»ºç«‹ç¾¤çµ„æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
        console.error("Create group error: ", e);
    }
};

/**
 * Renders the list of joined groups.
 */
function renderGroupList(groups) {
    const listEl = tabContents.group;
    listEl.innerHTML = '';

    if (groups.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰åŠ å…¥ä»»ä½•ç¾¤çµ„...</p>';
        return;
    }

    groups.forEach(group => {
        const groupId = group.id;
        const groupName = group.name;
        const initial = groupName.charAt(0).toUpperCase();

        const item = document.createElement('div');
        item.id = `chat-item-${groupId}`;
        item.className = 'sidebar-item';
        item.onclick = () => openChatWindow(groupId, `# ${groupName}`, 'group', null);
        
        item.innerHTML = `
            <div class="center message-avatar bg-indigo-500">#</div>
            <div class="flex flex-col min-w-0 flex-grow">
                <span class="truncate font-semibold">${groupName}</span>
                <span class="text-xs text-gray-400 truncate">${group.lastChat ? new Date(group.lastChat.seconds * 1000).toLocaleTimeString('zh-TW') : 'æ–°ç¾¤çµ„'}</span>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * Sets up the group member list listener and rendering.
 */
function setupGroupMemberList(groupId) {
    memberListContent.innerHTML = ''; // Clear existing list
    groupManagementAdmin.classList.add('hidden'); // Hide admin controls by default

    // Check if I am the admin for management controls
    const myMemberDocRef = doc(collection(db, 'groups', groupId, 'members'), ME_EMAIL);
    getDoc(myMemberDocRef) // Modular call
        .then(docSnap => {
            const memberRole = docSnap.exists() && docSnap.data().role === 'admin'; // Modular call
            if (memberRole) {
                groupManagementAdmin.classList.remove('hidden');
                setupGroupMemberManagement(groupId);
            }
        });

    const membersRef = collection(db, 'groups', groupId, 'members');
    const q = query(membersRef, orderBy('joinedAt')); // Modular call
    const unsub = onSnapshot(q, snapshot => { // Modular call
        memberListContent.innerHTML = '';
        const members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        memberCountEl.textContent = members.length;

        members.forEach(member => {
            const isMe = member.email === ME_EMAIL;
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2 p-1 rounded-md bg-gray-700/50';
            item.innerHTML = `
                <div class="center message-avatar w-6 h-6 text-xs ${member.role === 'admin' ? 'bg-red-500' : 'bg-gray-500'}">${member.email.charAt(0).toUpperCase()}</div>
                <span class="text-sm truncate">${member.email}${isMe ? ' (æˆ‘)' : ''}</span>
                ${member.role === 'admin' ? '<span class="text-xs text-red-400 ml-auto">Admin</span>' : ''}
            `;
            memberListContent.appendChild(item);
        });
    }, error => {
        console.error("Error listening to group members: ", error);
    });

    unsubs.push(unsub);
}

/**
 * Sets up member add/remove functionality (Admin only).
 */
function setupGroupMemberManagement(groupId) {
    addMemberBtn.onclick = async () => {
        const email = manageMemberEmail.value.trim().toLowerCase();
        if (!email || email === ME_EMAIL) return showMessage('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆå“¡ Emailã€‚', 'error');

        const confirmed = await showMessage('ç¢ºèªåŠ å…¥', `ç¢ºå®šè¦å°‡ ${email} åŠ å…¥ç¾¤çµ„å—ï¼Ÿ`, 'confirm');
        if (!confirmed) return;

        try {
            const memberDocRef = doc(collection(db, 'groups', groupId, 'members'), email);
            await setDoc(memberDocRef, { // Modular call
                email: email,
                role: 'member',
                joinedAt: serverTimestamp() // Modular call
            });

            // Update member count on the main group document
            const groupDocRef = doc(db, 'groups', groupId);
            await setDoc(groupDocRef, { memberCount: increment(1) }, { merge: true }); // Modular call
            
            showMessage('åŠ å…¥æˆåŠŸ', `${email} å·²åŠ å…¥ç¾¤çµ„ã€‚`, 'success');
            manageMemberEmail.value = '';
        } catch (e) {
            showMessage('æ“ä½œå¤±æ•—', 'åŠ å…¥æˆå“¡å¤±æ•—ã€‚', 'error');
            console.error("Add member error: ", e);
        }
    };

    removeMemberBtn.onclick = async () => {
        const email = manageMemberEmail.value.trim().toLowerCase();
        if (!email || email === ME_EMAIL) return showMessage('éŒ¯èª¤', 'ä¸èƒ½è¸¢å‡ºè‡ªå·±ã€‚', 'error');

        const confirmed = await showMessage('ç¢ºèªè¸¢å‡º', `ç¢ºå®šè¦å°‡ ${email} å¾ç¾¤çµ„ä¸­è¸¢å‡ºå—ï¼Ÿ`, 'confirm');
        if (!confirmed) return;

        try {
            const memberDocRef = doc(collection(db, 'groups', groupId, 'members'), email);
            await deleteDoc(memberDocRef); // Modular call
             // Update member count on the main group document
            const groupDocRef = doc(db, 'groups', groupId);
            await setDoc(groupDocRef, { memberCount: increment(-1) }, { merge: true }); // Modular call
            
            showMessage('è¸¢å‡ºæˆåŠŸ', `${email} å·²è¢«è¸¢å‡ºç¾¤çµ„ã€‚`, 'success');
            manageMemberEmail.value = '';
        } catch (e) {
            showMessage('æ“ä½œå¤±æ•—', 'è¸¢å‡ºæˆå“¡å¤±æ•—ã€‚', 'error');
            console.error("Remove member error: ", e);
        }
    };
}


/* ==================== Monitor System Logic (Admin Only) ==================== */

monitorBtn.onclick = async () => {
    const v = (monitorInput.value || '').trim().toLowerCase();
    if (!v || v.indexOf('_') === -1) {
        return showMessage('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ç›£çœ‹æ ¼å¼: emailA_emailB', 'error');
    }
    
    // æª¢æŸ¥å…¨å±€çš„ ME_ROLE è®Šæ•¸
    if (ME_ROLE !== 'superadmin') { 
        return showMessage('æ¬Šé™ä¸è¶³', 'åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹èŠå¤©è¨˜éŒ„ã€‚', 'error');
    }
    
    const [emailA, emailB] = v.split('_');
    const roomId = getDmRoomId(emailA, emailB);

    try {
        // ç°¡å–®æ¸¬è©¦èŠå¤©å®¤æ˜¯å¦å­˜åœ¨
        const messagesRef = collection(db, 'chats', roomId, 'messages');
        const q = query(messagesRef, limit(1)); // Modular call
        const roomTest = await getDocs(q); // Modular call

        if (roomTest.empty) {
            return showMessage('ç›£çœ‹å¤±æ•—', 'æ­¤å…©äººä¹‹é–“å°šæœªæœ‰èŠå¤©è¨˜éŒ„ã€‚', 'error');
        }
    } catch (e) {
        return showMessage('ç›£çœ‹éŒ¯èª¤', 'ç„¡æ³•å­˜å–èŠå¤©ç´€éŒ„ã€‚', 'error');
    }

    openChatWindow(roomId, `ğŸš¨ ç›£çœ‹ä¸­: ${v} (é™100ç­†)`, 'monitor', v);
};


/* ==================== Auth and Initialization ==================== */

/**
 * Initializes Firebase, sets up state, and handles authentication.
 */
function initFirebase(token) {
    try {
        app = initializeApp(firebaseConfig); // Modular call
        db = getFirestore(app); // Modular call
        auth = getAuth(app); // Modular call
        setLogLevel('debug'); // Modular call
        console.log("Firebase initialized successfully. App, DB, Auth objects created.");

    } catch (e) {
        console.error("Firebase Init Error: ", e);
        showMessage('åˆå§‹åŒ–å¤±æ•—', 'Firebase æœå‹™ç„¡æ³•åˆå§‹åŒ–ã€‚è«‹æª¢æŸ¥ç¶²é æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯ã€‚', 'error');
        return;
    }
    
    // Attempt custom token sign-in if available (provided by canvas environment)
    if (token) {
        signInWithCustomToken(auth, token) // Modular call
            .catch(async (error) => {
                console.error("Custom token sign-in failed, falling back to Google login:", error);
                // ç™»å…¥å¤±æ•—å¾Œä¸ç™»å‡ºï¼Œç­‰å¾… Google ç™»å…¥æŒ‰éˆ•é»æ“Š
            });
    }

    // Main Auth State Listener (Controls Page 1 / Page 2 switch)
    onAuthStateChanged(auth, async user => { // Modular call
        if (user && user.email) {
            // User is signed in (Google)
            ME_EMAIL = user.email.toLowerCase();
            ME_ID = user.uid;
            console.log(`User authenticated: ${ME_EMAIL}`);

            // 1. Check/Set User Role and Profile
            const userDocRef = doc(db, 'users', ME_EMAIL); // Modular call
            const userDoc = await getDoc(userDocRef); // Modular call
            
            // Check for admin/superadmin role (Hardcoded check)
            ME_ROLE = (ME_EMAIL === ADMIN_EMAIL) ? 'superadmin' : (userDoc.exists() && userDoc.data().role) ? userDoc.data().role : 'user'; // Modular call

            // Update Firestore profile
            await setDoc(userDocRef, { // Modular call
                email: ME_EMAIL,
                role: ME_ROLE,
                lastSeen: serverTimestamp(), // Modular call
            }, { merge: true });
            
            // 2. Update UI
            document.getElementById('me-email').textContent = ME_EMAIL;
            document.getElementById('me-avatar').textContent = ME_EMAIL.charAt(0).toUpperCase();
            document.getElementById('me-role').textContent = ME_ROLE;
            
            // Show admin controls if superadmin
            adminControls.classList.toggle('hidden', ME_ROLE !== 'superadmin');
            
            // ** Show app, hide login (Switch to Page 2) **
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');

            // 3. Setup Sidebar Listeners
            setupSidebarListeners();

        } else {
            // User is signed out or only anonymous
            ME_EMAIL = null;
            ME_ID = null;
            ME_ROLE = 'user';
            
            clearUnsubs(); // Clear all listeners
            closeChatWindow(); // Close any open chat
            adminControls.classList.add('hidden');
            
            // ** Show login, hide app (Switch to Page 1) **
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    });
}

function setupSidebarListeners() {
    clearUnsubs();

    // 1. Friend Requests Listener
    const reqColRef = collection(db, 'friends', ME_EMAIL, 'requests');
    const reqQ = query(reqColRef, orderBy('sentAt', 'desc')); // Modular call
    unsubs.push(onSnapshot(reqQ, snapshot => { // Modular call
        const requests = snapshot.docs.map(doc => doc.data());
        renderRequestList(requests);
    }, error => console.error("Request listener error:", error)));

    // 2. DM Friends Listener
    const dmColRef = collection(db, 'friends', ME_EMAIL, 'list');
    const dmQ = query(dmColRef, orderBy('lastChat', 'desc')); // Modular call
    unsubs.push(onSnapshot(dmQ, snapshot => { // Modular call
        const friends = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        renderDmList(friends);
    }, error => console.error("DM friend list error:", error)));

    // 3. Group List Listener (Only groups I am a member of)
    // NOTE: This remains an expensive, client-side check to work around Firestore's lack of array/membership queries.
    const groupsRef = collection(db, 'groups');
    unsubs.push(onSnapshot(groupsRef, async (groupsSnapshot) => { // Modular call
        
        const myGroupIds = [];
        
        for (const docSnap of groupsSnapshot.docs) {
            // Check subcollection membership
            const memberDocRef = doc(collection(db, 'groups', docSnap.id, 'members'), ME_EMAIL);
            const memberCheck = await getDoc(memberDocRef); // Modular call
            if (memberCheck.exists()) { // Modular call
                 myGroupIds.push({ id: docSnap.id, ...docSnap.data() });
            }
        }
        
        // Final list includes only groups the user is a member of
        renderGroupList(myGroupIds.sort((a, b) => (b.lastChat?.seconds || 0) - (a.lastChat?.seconds || 0)));

    }, error => console.error("Group list error:", error)));
}

/* ============== Google Login Implementation ============== */
googleLoginBtn.onclick = async () => {
    // æª¢æŸ¥ Firebase Auth ç‰©ä»¶æ˜¯å¦å·²å®šç¾© (æ‡‰åœ¨ window.onload æœŸé–“å®Œæˆ)
    if (!auth) {
        showMessage('åˆå§‹åŒ–å¤±æ•—', 'Firebase æœå‹™å°šæœªæº–å‚™å¥½æˆ–åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦ã€‚', 'error');
        console.error("Auth object is not defined. Firebase initialization likely failed.");
        return;
    }
    
    try {
        const provider = new GoogleAuthProvider(); // Modular call
        await signInWithPopup(auth, provider); // Modular call
        showMessage('ç™»å…¥æˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å…¥ï¼Œæ­¡è¿å›ä¾†ï¼', 'success');
    } catch (error) {
        if (error.code !== 'auth/popup-closed-by-user') {
             showMessage('ç™»å…¥å¤±æ•—', 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
             console.error("Google Sign-in Error: ", error);
        }
    }
};

/* ============== Logout ============== */
logoutBtn.onclick = () => {
    signOut(auth).then(() => { // Modular call
        showMessage('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²å®‰å…¨ç™»å‡ºã€‚', 'info');
    }).catch(error => {
        showMessage('ç™»å‡ºå¤±æ•—', 'ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
        console.error("Logout error: ", error);
    });
};

/* ============== initial: start firebase ============== */
window.onload = function() {
    setupMessageBoxHandlers(); // <--- ä¿®æ­£: å–®æ¬¡è¨»å†ŠæŒ‰éˆ•äº‹ä»¶
    initFirebase(initialAuthToken);
}
</script>
</body>
</html>