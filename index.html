<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆDiscord é¢¨æ ¼ï¼‰</title>

<!-- Firebase compatibility SDKs for single-file use -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- Load Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --bg:#0f1724; --panel:#111827; --muted:#9ca3af; --accent:#5865f2; --accent-2:#2ecc71; --danger:#ef4444;
  --card:#0b1020;
}
*{box-sizing:border-box;font-family:Inter, "Noto Sans TC", "å¾®è»Ÿæ­£é»‘é«”", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
body{margin:0;background:linear-gradient(180deg,#071025 0%, #071223 100%);color:#e6eef8; height: 100vh;}
a{color:inherit}
.center{display:flex;justify-content:center;align-items:center}

/* App Layout */
#app-container{
  display:flex;
  height:100vh;
  max-width:1400px;
  margin:0 auto;
}

/* Sidebar (Left Panel) */
#sidebar{
  width:280px;
  min-width:280px;
  background-color:var(--panel);
  padding:16px;
  border-right:1px solid #1f2937;
  display:flex;
  flex-direction:column;
}

/* Chat Area (Right Panel) */
#chat-area{
  flex-grow:1;
  background-color:var(--bg);
  display:flex;
  flex-direction:column;
}

/* Chat Header */
.chat-header{
  padding:12px 16px;
  background-color:var(--panel);
  border-bottom:1px solid #1f2937;
  font-size:1.25rem;
  font-weight:600;
  display:flex;
  align-items:center;
}

/* Message List */
.message-list{
  flex-grow:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.message-list::-webkit-scrollbar { width: 8px; }
.message-list::-webkit-scrollbar-thumb { background-color: #374151; border-radius: 4px; }
.message-list::-webkit-scrollbar-track { background-color: #1f2937; }

/* Message Item */
.message-item{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.message-avatar{
  width:40px;
  height:40px;
  border-radius:9999px;
  background-color:var(--accent);
  flex-shrink:0;
  font-weight:700;
  font-size:1rem;
}
.message-content{
  flex-grow:1;
}
.message-meta{
  display:flex;
  align-items:baseline;
  gap:8px;
  font-size:0.875rem;
  color:var(--muted);
  margin-bottom:2px;
}
.message-meta .username{
  color:#e6eef8;
  font-weight:600;
  font-size:1rem;
}
.message-text{
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.5;
}

/* Chat Input */
.chat-input-container{
  padding:16px;
  background-color:var(--panel);
  border-top:1px solid #1f2937;
}
.chat-input-box{
  background-color:var(--card);
  border-radius:12px;
  display:flex;
  align-items:flex-end;
  overflow:hidden;
}
.chat-input-box textarea{
  flex-grow:1;
  background:transparent;
  border:none;
  outline:none;
  padding:12px 16px;
  resize:none;
  color:inherit;
  min-height:48px;
  max-height:150px;
}
.chat-input-box button{
  padding:12px 16px;
  background-color:var(--accent);
  color:white;
  font-weight:600;
  border:none;
  outline:none;
  cursor:pointer;
  transition:background-color 0.2s;
  min-height:48px;
}
.chat-input-box button:hover{
  background-color:#4752c4;
}

/* Sidebar List Item */
.sidebar-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  transition:background-color 0.2s;
}
.sidebar-item:hover{
  background-color:#1f2937;
}
.sidebar-item.active{
  background-color:var(--accent);
}
.sidebar-item.active:hover{
  background-color:var(--accent);
}

/* User Info Footer */
#user-info{
  margin-top:auto;
  padding-top:16px;
  border-top:1px solid #1f2937;
}

/* Message Box (Modal) */
#message-box{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.7);
  z-index:1000;
}
.message-box-content{
  background-color:var(--panel);
  padding:24px;
  border-radius:12px;
  max-width:400px;
  width:90%;
  box-shadow:0 10px 25px rgba(0,0,0,0.5);
}
.message-box-header{
  font-size:1.5rem;
  font-weight:700;
  margin-bottom:8px;
  color:var(--accent);
}
.message-box-body{
  color:#e6eef8;
  margin-bottom:20px;
}
.message-box-footer button{
  background-color:var(--accent);
  color:white;
  padding:8px 16px;
  border-radius:8px;
  transition:background-color 0.2s;
}
.message-box-footer button:hover{
  background-color:#4752c4;
}

/* Login Screen (Page 1) */
#login-screen{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color:var(--bg);
  z-index:2000;
}
.login-card{
  background-color:var(--panel);
  padding:40px;
  border-radius:16px;
  text-align:center;
  box-shadow:0 15px 30px rgba(0,0,0,0.5);
  max-width:450px;
  width:90%;
}
.login-card h1{
  font-size:2.25rem;
  font-weight:800;
  margin-bottom:10px;
  color:var(--accent-2);
}
.login-card p{
  color:var(--muted);
  margin-bottom:30px;
}
#googleLoginBtn{
  display:inline-flex;
  align-items:center;
  background-color:white;
  color:#111827;
  padding:12px 24px;
  border-radius:10px;
  font-weight:600;
  transition:all 0.2s;
  box-shadow:0 4px 6px rgba(0,0,0,0.1);
}
#googleLoginBtn:hover{
  box-shadow:0 6px 10px rgba(0,0,0,0.2);
  transform:translateY(-2px);
}
#googleLoginBtn svg{
  margin-right:10px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #sidebar {
    width: 100%;
    min-width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid #1f2937;
  }
  #app-container {
    flex-direction: column;
  }
  #chat-area {
    height: calc(100vh - 200px); /* Adjust based on collapsed sidebar height */
  }
}
</style>
</head>
<body class="center">

<!-- Message Box Modal (for errors/alerts) -->
<div id="message-box" class="center hidden">
  <div class="message-box-content">
    <div id="message-box-header" class="message-box-header">æ¨™é¡Œ</div>
    <div id="message-box-body" class="message-box-body">å…§å®¹</div>
    <div class="message-box-footer flex justify-end">
      <button id="message-box-ok-btn">ç¢ºå®š</button>
    </div>
  </div>
</div>

<!-- Login Screen (Page 1) -->
<div id="login-screen" class="center hidden">
  <div class="login-card">
    <h1>æ­¡è¿ä¾†åˆ°æ ¡åœ’èŠå¤©å®¤ ğŸ”¥</h1>
    <p>è«‹ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥ä»¥é–‹å§‹èˆ‡æœ‹å‹èŠå¤©ã€‚</p>
    <button id="googleLoginBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,7.917-11.303,7.917c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238c-2.053,1.383-4.524,2.19-7.219,2.19c-5.202,0-9.619-3.317-11.283-7.746l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.08,5.55l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
      ä½¿ç”¨ Google ç™»å…¥
    </button>
  </div>
</div>

<!-- Main Application Container (Page 2) -->
<div id="app-container" class="hidden">
  
  <!-- Sidebar (Left Panel) -->
  <div id="sidebar">
    <h2 class="text-xl font-bold mb-4 text-white">å¥½å‹èˆ‡èŠå¤©</h2>
    
    <!-- Direct Message List -->
    <div id="dm-list" class="flex flex-col gap-2 flex-grow overflow-y-auto mb-4">
      <!-- DM Items will be dynamically inserted here -->
      <p class="text-sm text-gray-500 p-2">æ²’æœ‰é€²è¡Œä¸­çš„ç§äººèŠå¤©...</p>
    </div>
    
    <!-- Monitor/Superadmin Section -->
    <div class="p-2 border border-gray-700 rounded-lg mb-4">
      <h3 class="text-base font-semibold mb-2">ç®¡ç†å“¡ç›£çœ‹</h3>
      <div class="flex gap-2">
        <input id="monitorInput" type="text" placeholder="emailA_emailB" class="flex-grow bg-gray-700 border border-gray-600 rounded-md p-2 text-sm text-white focus:ring-blue-500 focus:border-blue-500" />
        <button id="monitorBtn" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded-md transition duration-150">ç›£çœ‹</button>
      </div>
      <p class="text-xs text-gray-500 mt-1">æ ¼å¼: emailA_emailB (åƒ…é™è¶…ç´šç®¡ç†å“¡)</p>
    </div>

    <!-- User Info Footer -->
    <div id="user-info" class="p-3 bg-gray-800 rounded-lg shadow-inner">
      <div class="flex items-center gap-3">
        <div id="me-avatar" class="center message-avatar bg-accent-2"></div>
        <div class="flex-grow">
          <div id="me-email" class="text-sm font-medium truncate">loading...</div>
          <div id="me-role" class="text-xs text-green-400 font-semibold">user</div>
        </div>
        <button id="logoutBtn" class="text-red-400 hover:text-red-300 transition duration-150" title="ç™»å‡º">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Area (Right Panel) -->
  <div id="chat-area">
    <div id="current-chat-header" class="chat-header">
      é¸æ“‡ä¸€å€‹èŠå¤©ä¾†é–‹å§‹
    </div>
    
    <!-- Main Chat Content -->
    <div id="current-chat-content" class="flex flex-col flex-grow">
      <!-- Messages will be displayed here -->
      <div id="default-message" class="center flex-col flex-grow text-gray-500 text-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-dots mb-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M10 8h.01"/><path d="M14 8h.01"/><path d="M18 8h.01"/></svg>
        <p>é»æ“Šå·¦å´åˆ—è¡¨ä¸­çš„å¥½å‹å³å¯é–‹å§‹èŠå¤©</p>
      </div>

      <!-- Live Chat Window (Hidden by default) -->
      <div id="live-chat-window" class="flex-col flex-grow hidden">
        <div id="message-list" class="message-list">
          <!-- Messages inserted here -->
        </div>
        
        <div id="chat-input-container" class="chat-input-container">
          <div id="block-info" class="text-sm text-red-400 mb-2 p-2 rounded-lg bg-red-900/30 hidden">
              æ‚¨å·²è¢«å°æ–¹å°é–ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚
          </div>
          <div class="chat-input-box">
            <textarea id="chat-input-textarea" placeholder="è¼¸å…¥è¨Šæ¯... (Enter ç™¼é€, Shift+Enter æ›è¡Œ)" rows="1"></textarea>
            <button id="chat-send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
// Global Variables for Firebase configuration provided by the environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebase App Initialization
let app, db, auth;

// Global state variables
let ME_EMAIL = null;
let ME_ID = null;
let ME_ROLE = 'user';
const unsubs = []; // Array to store firestore unsubscribe functions
const openChats = {}; // Store {roomId: {unsub: fn, otherEmail: string}}
let currentRoomId = null;

// DOM Elements
const loginScreen = document.getElementById('login-screen');
const appContainer = document.getElementById('app-container');
const googleLoginBtn = document.getElementById('googleLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const dmList = document.getElementById('dm-list');
const chatHeader = document.getElementById('current-chat-header');
const messageList = document.getElementById('message-list');
const liveChatWindow = document.getElementById('live-chat-window');
const defaultMessage = document.getElementById('default-message');
const monitorBtn = document.getElementById('monitorBtn');
const monitorInput = document.getElementById('monitorInput');

/**
 * Custom function to display error/success messages instead of alert().
 * @param {string} title - The title of the message box.
 * @param {string} body - The content of the message.
 * @param {string} type - 'success', 'error', or 'info'.
 */
function showMessage(title, body, type = 'info') {
    const box = document.getElementById('message-box');
    const header = document.getElementById('message-box-header');
    const bodyEl = document.getElementById('message-box-body');
    const okBtn = document.getElementById('message-box-ok-btn');

    header.textContent = title;
    bodyEl.textContent = body;

    // Apply color based on type
    header.style.color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--accent-2)' : 'var(--accent)';

    box.classList.remove('hidden');

    okBtn.onclick = () => {
        box.classList.add('hidden');
    };
}

/**
 * Helper to generate a consistent room ID regardless of user order.
 * @param {string} emailA
 * @param {string} emailB
 * @returns {string} The canonical room ID (email_sorted_A + "_" + email_sorted_B)
 */
function getRoomId(emailA, emailB) {
    const emails = [emailA.toLowerCase(), emailB.toLowerCase()].sort();
    return emails[0] + "_" + emails[1];
}

/**
 * Creates the HTML for a message item.
 * @param {object} message
 * @param {string} message.from
 * @param {string} message.text
 * @param {firebase.firestore.Timestamp | null} message.time
 * @returns {string} HTML string
 */
function createMessageHtml(message) {
    const isMe = message.from === ME_EMAIL;
    const initial = message.from ? message.from.charAt(0).toUpperCase() : '?';
    const timestamp = message.time ? new Date(message.time.seconds * 1000).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : 'ç™¼é€ä¸­...';
    
    // Check if a user is blocked (This is a simplified check for display, actual block check happens on send)
    const isBlocked = ME_ID && message.from in (openChats[currentRoomId]?.isBlockedBy || {});
    
    return `
        <div class="message-item ${isMe ? 'self-end flex-row-reverse' : ''} ${isBlocked ? 'opacity-50' : ''}">
            <div class="center message-avatar ${isMe ? 'bg-blue-500' : 'bg-green-500'}">
                ${initial}
            </div>
            <div class="message-content ${isMe ? 'text-right' : 'text-left'}">
                <div class="message-meta ${isMe ? 'flex-row-reverse' : ''}">
                    <span class="username">${message.from}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-text p-2 rounded-lg max-w-lg ${isMe ? 'bg-blue-600' : 'bg-gray-700'} inline-block shadow-md">
                    ${message.text}
                </div>
                ${isBlocked && !isMe ? `<div class="text-xs text-red-400 mt-1">æ‚¨å·²å°é–æ­¤ç”¨æˆ¶çš„è¨Šæ¯</div>` : ''}
            </div>
        </div>
    `;
}

/**
 * Opens a specific chat window and sets up the listener.
 * @param {string} otherEmail - The email of the other user.
 * @param {string} title - The title to display in the chat header.
 * @param {boolean} isMonitor - Is this a superadmin monitoring session?
 */
function openChatWindow(otherEmail, title, isMonitor = false) {
    // 1. Clear previous listener if any
    if (currentRoomId && openChats[currentRoomId]?.unsub) {
        openChats[currentRoomId].unsub();
    }
    
    // 2. Determine new room ID and update UI state
    const newRoomId = isMonitor ? otherEmail : getRoomId(ME_EMAIL, otherEmail);
    currentRoomId = newRoomId;
    
    // 3. Update Header
    chatHeader.textContent = title;
    
    // 4. Show/Hide Windows
    defaultMessage.classList.add('hidden');
    liveChatWindow.classList.remove('hidden');
    
    // 5. Clear messages
    messageList.innerHTML = '';
    
    // 6. Highlight active item in sidebar (Not implemented fully, but conceptual placeholder)
    Array.from(dmList.children).forEach(el => el.classList.remove('active'));
    const activeEl = document.getElementById(`dm-item-${newRoomId}`);
    if (activeEl) activeEl.classList.add('active');

    // 7. Setup chat input area
    setupChatInput(otherEmail, newRoomId, isMonitor);

    // 8. Setup new listener for the chat
    // Query chats by timestamp, limit to 50 for performance
    const q = firebase.firestore().collection('messages').doc(newRoomId).collection('chats').orderBy('time').limit(50);
    
    const unsub = q.onSnapshot(snapshot => {
        let fragment = document.createDocumentFragment();
        snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            // Assign a temporary time object for pending messages
            const message = {
                from: data.from,
                text: data.text,
                time: data.time || { seconds: Date.now() / 1000 }
            };

            if (change.type === "added") {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = createMessageHtml(message);
                fragment.appendChild(tempDiv.firstChild);
            }
            // For simplicity, we only handle 'added' type to append new messages.
            // A more robust app would handle 'modified' and 'removed'.
        });

        messageList.appendChild(fragment);
        // Scroll to bottom
        messageList.scrollTop = messageList.scrollHeight;
    }, error => {
        console.error("Error listening to messages: ", error);
        showMessage('èŠå¤©éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥è¨Šæ¯ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚', 'error');
    });

    // 9. Store unsubscribe function and context
    openChats[newRoomId] = { unsub, otherEmail, isMonitor };
}

/**
 * Sets up the input box and send logic for the current chat.
 * @param {string} other - The email of the other user.
 * @param {string} roomId - The room ID.
 * @param {boolean} isMonitor - Is this a monitoring session?
 */
function setupChatInput(other, roomId, isMonitor) {
    const ta = document.getElementById('chat-input-textarea');
    const send = document.getElementById('chat-send-btn');
    const container = document.getElementById('chat-input-container');
    const blockInfo = document.getElementById('block-info');

    // Disable input for monitoring
    if (isMonitor) {
        ta.disabled = true;
        send.disabled = true;
        container.style.opacity = 0.5;
        blockInfo.classList.add('hidden');
        ta.placeholder = 'ç›£çœ‹æ¨¡å¼ç„¡æ³•ç™¼é€è¨Šæ¯';
        return;
    } else {
        ta.disabled = false;
        send.disabled = false;
        container.style.opacity = 1.0;
        ta.placeholder = 'è¼¸å…¥è¨Šæ¯... (Enter ç™¼é€, Shift+Enter æ›è¡Œ)';
    }

    send.onclick = async () => {
        const text = ta.value.trim();
        if (!text) return;

        // Check if the current user is blocked by the other user
        const blockDocRef = firebase.firestore().collection('blocked').doc(other).collection('locked').doc(ME_EMAIL);
        const iAmBlocked = await blockDocRef.get();
        
        if (iAmBlocked.exists) {
            blockInfo.classList.remove('hidden');
            send.disabled = true;
            ta.disabled = true;
            showMessage('ç„¡æ³•ç™¼é€', 'æ‚¨å·²è¢«å°æ–¹å°é–ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚', 'error');
            return;
        } else {
            blockInfo.classList.add('hidden');
            send.disabled = false;
            ta.disabled = false;
        }

        // Check if the current user has blocked the other user (optional feature, not fully implemented)
        // const iBlockDocRef = firebase.firestore().collection('blocked').doc(ME_EMAIL).collection('locked').doc(other);
        // const iBlock = await iBlockDocRef.get();
        // if (iBlock.exists) return showMessage('è­¦å‘Š', 'æ‚¨å·²å°é–å°æ–¹ï¼Œä»å¯ç™¼é€è¨Šæ¯ï¼Œä½†å°æ–¹å¯èƒ½çœ‹ä¸åˆ°ã€‚');

        try {
            await firebase.firestore().collection('messages').doc(roomId).collection('chats').add({
                from: ME_EMAIL,
                text,
                time: firebase.firestore.FieldValue.serverTimestamp()
            });
            ta.value = '';
            ta.style.height = 'auto'; // Reset height after sending
        } catch (e) {
            showMessage('ç™¼é€å¤±æ•—', 'è¨Šæ¯ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            console.error("Send message error: ", e);
        }
    };

    // Enter send, Shift+Enter newline
    ta.onkeydown = e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send.click();
        }
    };
    // Auto-resize textarea
    ta.oninput = () => {
        ta.style.height = 'auto';
        ta.style.height = (ta.scrollHeight) + 'px';
    };
    ta.style.height = 'auto';
}

/**
 * Renders the sidebar with DM list.
 * @param {object[]} dmListEntries - Array of {email: string} objects.
 */
function renderDmList(dmListEntries) {
    dmList.innerHTML = ''; // Clear existing list
    if (dmListEntries.length === 0) {
        dmList.innerHTML = '<p class="text-sm text-gray-500 p-2">æ²’æœ‰é€²è¡Œä¸­çš„ç§äººèŠå¤©...</p>';
        return;
    }

    const fragment = document.createDocumentFragment();
    dmListEntries.forEach(entry => {
        const otherEmail = entry.email;
        const roomId = getRoomId(ME_EMAIL, otherEmail);
        const initial = otherEmail.charAt(0).toUpperCase();

        const item = document.createElement('div');
        item.id = `dm-item-${roomId}`;
        item.className = 'sidebar-item';
        item.onclick = () => openChatWindow(otherEmail, `@ ${otherEmail}`);
        
        item.innerHTML = `
            <div class="center message-avatar bg-gray-600">${initial}</div>
            <span class="truncate">${otherEmail}</span>
        `;
        fragment.appendChild(item);
    });
    dmList.appendChild(fragment);
}

/* ============== Monitor (superadmin) ============== */
monitorBtn.onclick = async () => {
    const v = (monitorInput.value || '').trim();
    if (!v || v.indexOf('_') === -1) {
        return showMessage('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ç›£çœ‹æ ¼å¼: emailA_emailB', 'error');
    }
    
    // Check user role
    const meDoc = await firebase.firestore().collection('users').doc(ME_EMAIL).get();
    ME_ROLE = meDoc.exists && meDoc.data().role === 'superadmin' ? meDoc.data().role : 'user';
    
    if (ME_ROLE !== 'superadmin') {
        return showMessage('æ¬Šé™ä¸è¶³', 'åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹èŠå¤©è¨˜éŒ„ã€‚', 'error');
    }
    
    // The room ID for monitoring is the input string itself (e.g., "a@a.com_b@b.com")
    openChatWindow(v, `âš ï¸ ç›£çœ‹ä¸­: ${v}`, true);
};


/* ==================== Auth and Initialization ==================== */

/**
 * Initializes Firebase, sets up state, and handles authentication.
 */
function initFirebase(token) {
    try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        db.settings({ merge: true }); // Enable merge for setDoc

        // Log level for debugging
        firebase.firestore.setLogLevel('debug');
    } catch (e) {
        console.error("Firebase Init Error: ", e);
        showMessage('åˆå§‹åŒ–å¤±æ•—', 'Firebase æœå‹™ç„¡æ³•åˆå§‹åŒ–ã€‚', 'error');
        return;
    }

    // Attempt custom token sign-in if available (provided by canvas environment)
    auth.signInWithCustomToken(token)
        .catch(async (error) => {
            console.error("Custom token sign-in failed, trying anonymous or showing login:", error);
            // Fallback to anonymous sign-in if custom token fails or is not provided
            if (!token) {
                 await auth.signInAnonymously();
            } else {
                 // If token exists but fails, show error and login
                 showMessage('ç™»å…¥å¤±æ•—', 'åˆå§‹é©—è­‰å¤±æ•—ï¼Œè«‹æ‰‹å‹•ç™»å…¥ã€‚', 'error');
                 loginScreen.classList.remove('hidden');
                 appContainer.classList.add('hidden');
            }
        });
}

/**
 * Main function to handle user state changes. This controls the 2-page switch.
 */
firebase.auth().onAuthStateChanged(async user => {
    if (user && (user.email || user.isAnonymous)) {
        // User is signed in (either Google or Anonymous)
        ME_EMAIL = user.email || user.uid + '@anon.com'; // Use email if available (Google), otherwise use UID
        ME_ID = user.uid;

        // 1. Update user info on screen
        document.getElementById('me-email').textContent = ME_EMAIL;
        document.getElementById('me-avatar').textContent = ME_EMAIL.charAt(0).toUpperCase();

        // 2. Set/Update user document in Firestore for profile/role tracking
        const userDocRef = firebase.firestore().collection('users').doc(ME_EMAIL);
        
        // Fetch current role or default to 'user'
        const userDoc = await userDocRef.get();
        ME_ROLE = userDoc.exists && userDoc.data().role ? userDoc.data().role : 'user';
        
        // Update Firestore with latest sign-in info (non-destructive set)
        await userDocRef.set({
            email: ME_EMAIL,
            role: ME_ROLE,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            // Ensure role persists if it was previously set, unless this is a new anonymous user
        }, { merge: true });
        
        document.getElementById('me-role').textContent = ME_ROLE;
        
        // ** Show app, hide login (Switch to Page 2) **
        loginScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');

        // 3. Setup DM list listener (only for non-anonymous users to track friends)
        if (user.email) {
            const dmListRef = firebase.firestore().collection('users').doc(ME_EMAIL).collection('dm_friends').orderBy('lastChat', 'desc');
            const dmUnsub = dmListRef.onSnapshot(snapshot => {
                const dmListEntries = snapshot.docs.map(doc => ({ email: doc.id }));
                renderDmList(dmListEntries);
            }, error => {
                console.error("Error listening to DM list: ", error);
            });
            unsubs.push(dmUnsub);
        }

    } else {
        // User is signed out
        ME_EMAIL = null;
        ME_ID = null;
        
        // Unsubscribe all listeners
        unsubs.forEach(u => u && u());
        unsubs.length = 0;
        Object.values(openChats).forEach(o => o.unsub && o.unsub());
        
        // ** Show login, hide app (Switch to Page 1) **
        loginScreen.classList.remove('hidden');
        appContainer.classList.add('hidden');
    }
});

/* ============== Google Login Implementation (The Main Fix) ============== */
googleLoginBtn.onclick = async () => {
    try {
        // 1. Create a Google Auth Provider instance
        const provider = new firebase.auth.GoogleAuthProvider();
        
        // 2. Sign in with popup - this triggers the external Google login page
        await firebase.auth().signInWithPopup(provider);
        // onAuthStateChanged listener handles the success after the popup closes.
        showMessage('ç™»å…¥æˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å…¥ï¼Œæ­¡è¿å›ä¾†ï¼', 'success');

    } catch (error) {
        // Handle popup closed by user or other auth errors gracefully
        if (error.code === 'auth/popup-closed-by-user') {
             console.log("Google Sign-in: Popup closed by user.");
        } else if (error.code === 'auth/cancelled-popup-request') {
             showMessage('ç™»å…¥éŒ¯èª¤', 'ç™»å…¥è¦–çª—å·²è¢«å¦ä¸€å€‹è«‹æ±‚å–ä»£ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚', 'error');
        } else {
             showMessage('ç™»å…¥å¤±æ•—', 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
             console.error("Google Sign-in Error: ", error);
        }
    }
};

/* ============== Logout ============== */
logoutBtn.onclick = () => {
    firebase.auth().signOut().then(() => {
        showMessage('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²å®‰å…¨ç™»å‡ºã€‚', 'info');
    }).catch(error => {
        showMessage('ç™»å‡ºå¤±æ•—', 'ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
        console.error("Logout error: ", error);
    });
};

/* ============== initial: start firebase ============== */
window.onload = function() {
    initFirebase(initialAuthToken);
}

</script>
</body>
</html>