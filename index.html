<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ å³æ™‚èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family:"Noto Sans TC",sans-serif; margin:0; background:#edf2f7; }
#container { display:flex; width:95%; max-width:1200px; margin:30px auto; height:600px; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.1); }
.sidebar { width:25%; background:#f7f9fc; padding:15px; display:flex; flex-direction:column; border-right:1px solid #e0e0e0; }
.sidebar h3 { margin:10px 0 5px 0; font-size:16px; color:#333; }
ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; background:#fff; border-radius:8px; border:1px solid #ddd; }
li { padding:10px; cursor:pointer; border-bottom:1px solid #eee; transition:0.2s; }
li:hover { background:#e0f0ff; font-weight:500; }
button { padding:8px; margin:5px 0; border-radius:6px; border:none; cursor:pointer; font-size:14px; }
#loginBtn { background:#4285F4; color:white; font-weight:500; }
#logoutBtn { background:#f44336; color:white; font-weight:500; }
.chat-area { flex:1; padding:15px; display:flex; flex-wrap:wrap; gap:12px; overflow-x:auto; background:#f1f5f9; }
.chat-window { width:300px; min-width:300px; max-height:550px; background:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); display:flex; flex-direction:column; overflow:hidden; }
.chat-header { background:#2d8cf0; color:white; padding:8px; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
.chat-header button { background:#f44336; font-size:12px; padding:2px 6px; border-radius:4px; margin-left:4px; }
.chat-messages { flex:1; overflow-y:auto; padding:8px; background:#f7f9fc; }
.msg { margin:4px 0; padding:6px 10px; border-radius:8px; background:#e0f0ff; font-size:13px; word-break:break-word; }
.chat-input { display:flex; border-top:1px solid #ddd; }
.chat-input textarea { flex:1; padding:6px 10px; border:none; outline:none; font-size:13px; resize:none; }
.chat-input button { padding:6px 12px; background:#2ecc71; color:white; border:none; cursor:pointer; font-weight:500; border-radius:0 0 10px 0; }
.rightbar { width:25%; padding:15px; background:#f7f9fc; display:flex; flex-direction:column; border-left:1px solid #e0e0e0; }
.rightbar h3 { margin:10px 0 5px 0; font-size:16px; color:#333; }
input { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:13px; margin-bottom:5px; }
.member-list li { display:flex; justify-content:space-between; padding:4px 0; }
.member-btn { padding:2px 4px; font-size:11px; margin-left:3px; }
</style>
</head>
<body>
<div id="container">
  <div class="sidebar">
    <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
    <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    <p>ğŸ‘‹ æ­¡è¿ï¼Œ<span id="user"></span></p>
    <h3>å¥½å‹æ¸…å–®</h3>
    <ul id="friendList"></ul>
    <h3>ç¾¤èŠæ¸…å–®</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="ç¾¤èŠåç¨±">
    <button id="createGroupBtn">å»ºç«‹ç¾¤èŠ</button>
  </div>

  <div class="chat-area" id="chatArea"></div>

  <div class="rightbar">
    <h3>æ–°å¢å¥½å‹</h3>
    <input id="addFriendEmail" placeholder="è¼¸å…¥ Gmail">
    <button id="addFriendBtn">é€å‡ºå¥½å‹è«‹æ±‚</button>
    <h3>å¥½å‹è«‹æ±‚</h3>
    <ul id="requestList"></ul>
  </div>
</div>

<script>
// Firebase åˆå§‹åŒ–
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userSpan = document.getElementById("user");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupName = document.getElementById("newGroupName");
const chatArea = document.getElementById("chatArea");
const requestList = document.getElementById("requestList");

let userEmail="";
let userRole="user"; // é è¨­
let chatWindows={};

// ç™»å…¥ç™»å‡º
loginBtn.onclick = async ()=>{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  chatWindows={};
  chatArea.innerHTML="";
  friendList.innerHTML="";
  groupList.innerHTML="";
  requestList.innerHTML="";
}

auth.onAuthStateChanged(async user=>{
  if(user){
    userEmail = user.email;
    userSpan.textContent = `${user.displayName} (${userEmail})`;
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    await db.collection("users").doc(userEmail).set({name:user.displayName,email:userEmail},{merge:true});
    const roleSnap = await db.collection("roles").doc(userEmail).get();
    if(roleSnap.exists) userRole = roleSnap.data().role;
    else userRole="user";
    loadFriends();
    loadGroups();
    loadRequests();
  }
});

// å¥½å‹æ¸…å–®
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.data().email;
      li.onclick=()=>openChatWindow([userEmail,doc.data().email].sort().join("_"), doc.data().email, "private");
      friendList.appendChild(li);
    });
  });
}

// ç¾¤çµ„æ¸…å–®
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.id;
      li.onclick=()=>openChatWindow(doc.id, doc.id, "group");
      groupList.appendChild(li);
    });
  });
}

// é€å‡ºå¥½å‹è«‹æ±‚
addFriendBtn.onclick = async ()=>{
  const email = addFriendEmail.value.trim();
  if(!email) return alert("è«‹è¼¸å…¥å¥½å‹ Gmail");
  if(email===userEmail) return alert("ä¸èƒ½åŠ è‡ªå·±");
  try{
    await db.collection("users").doc(email).set({email},{merge:true});
    await db.collection("users").doc(email).collection("requests").add({
      from: userEmail,
      status: "pending",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("å¥½å‹è«‹æ±‚å·²é€å‡ºï¼");
    addFriendEmail.value="";
  }catch(err){ alert("é€å‡ºå¥½å‹è«‹æ±‚å¤±æ•—ï¼š"+err.message); console.error(err); }
}

// åŠ è¼‰å¥½å‹è«‹æ±‚
function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests").where("status","==","pending").onSnapshot(snap=>{
    requestList.innerHTML="";
    snap.forEach(doc=>{
      const data=doc.data();
      const li=document.createElement("li");
      li.textContent=`${data.from} æƒ³åŠ ä½ ç‚ºå¥½å‹`;
      const acceptBtn=document.createElement("button");
      acceptBtn.textContent="åŒæ„";
      acceptBtn.className="request-btn";
      acceptBtn.onclick=async ()=>{
        await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
        await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
        await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
      }
      const rejectBtn=document.createElement("button");
      rejectBtn.textContent="æ‹’çµ•";
      rejectBtn.className="request-btn";
      rejectBtn.onclick=async ()=>{
        await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"rejected"});
      }
      li.appendChild(acceptBtn);
      li.appendChild(rejectBtn);
      requestList.appendChild(li);
    });
  });
}

// å»ºç«‹ç¾¤çµ„
createGroupBtn.onclick=async ()=>{
  if(userRole==="user") return alert("ä½ æ²’æœ‰æ¬Šé™å»ºç«‹ç¾¤çµ„");
  const name=newGroupName.value.trim();
  if(!name) return alert("è«‹è¼¸å…¥ç¾¤çµ„åç¨±");
  await db.collection("groups").doc(name).set({createdBy:userEmail});
  await db.collection("groups").doc(name).collection("members").doc(userEmail).set({addedBy:userEmail});
  newGroupName.value="";
}

// é–‹å•ŸèŠå¤©çª—
function openChatWindow(roomId,title,type){
  if(chatWindows[roomId]) return;
  const win=document.createElement("div");
  win.className="chat-window"; win.id="win_"+roomId;

  const header=document.createElement("div");
  header.className="chat-header";
  header.innerHTML=`<span>${title}</span><div><button>X</button>${type==="group"?"<button id='memberBtn'>æˆå“¡</button>":""}</div>`;
  win.appendChild(header);

  const memberDiv=document.createElement("div");
  memberDiv.style.display="none";
  win.appendChild(memberDiv);

  const msgDiv=document.createElement("div");
  msgDiv.className="chat-messages";
  win.appendChild(msgDiv);

  const inputDiv=document.createElement("div");
  inputDiv.className="chat-input";
  const input=document.createElement("textarea");
  input.placeholder="è¼¸å…¥è¨Šæ¯...";
  const btn=document.createElement("button"); btn.textContent="é€å‡º";
  inputDiv.appendChild(input); inputDiv.appendChild(btn); win.appendChild(inputDiv);

  chatArea.appendChild(win);

  // æˆå“¡æŒ‰éˆ•
  if(type==="group"){
    const memberBtn=header.querySelector("#memberBtn");
    memberBtn.onclick=async ()=>{
      if(memberDiv.style.display==="block"){ memberDiv.style.display="none"; return; }
      memberDiv.innerHTML="";
      const snap=await db.collection("groups").doc(roomId).collection("members").get();
      snap.forEach(d=>{
        const m=d.id;
        const li=document.createElement("li");
        li.textContent=m;
        if(userRole!=="user" && m!==userEmail){
          const removeBtn=document.createElement("button"); removeBtn.className="member-btn"; removeBtn.textContent="è¸¢å‡º";
          removeBtn.onclick=async ()=>{
            if(confirm(`ç¢ºå®šè¦å°‡ ${m} è¸¢å‡ºç¾¤çµ„?`)){
              await db.collection("groups").doc(roomId).collection("members").doc(m).delete();
              li.remove();
            }
          }
          li.appendChild(removeBtn);
        }
        if(userRole==="highAdmin" && m!==userEmail){
          const roleBtn=document.createElement("button"); roleBtn.className="member-btn"; roleBtn.textContent="èª¿æ•´æ¬Šé™";
          roleBtn.onclick=async ()=>{
            const newRole=prompt(`è¨­å®š ${m} çš„è§’è‰²(user / lowAdmin):`);
            if(newRole==="user" || newRole==="lowAdmin"){
              await db.collection("roles").doc(m).set({role:newRole},{merge:true});
              alert(`${m} çš„è§’è‰²å·²è¨­å®šç‚º ${newRole}`);
            } else alert("è§’è‰²éŒ¯èª¤");
          }
          li.appendChild(roleBtn);
        }
        memberDiv.appendChild(li);
      });

      // åŠ å…¥æ–°æˆå“¡
      if(userRole!=="user"){
        const addDiv=document.createElement("div"); addDiv.style.display="flex"; addDiv.style.marginTop="5px";
        const addInput=document.createElement("input"); addInput.placeholder="è¼¸å…¥ Gmail åŠ å…¥"; addInput.style.flex="1"; addInput.style.padding="4px";
        const addBtn=document.createElement("button"); addBtn.textContent="åŠ å…¥";
        addBtn.onclick=async ()=>{
          const newEmail=addInput.value.trim(); if(!newEmail) return alert("è«‹è¼¸å…¥ Gmail");
          await db.collection("groups").doc(roomId).collection("members").doc(newEmail).set({addedBy:userEmail});
          const li=document.createElement("li"); li.textContent=newEmail; memberDiv.insertBefore(li,addDiv);
          addInput.value="";
        }
        addDiv.appendChild(addInput); addDiv.appendChild(addBtn); memberDiv.appendChild(addDiv);
      }
      memberDiv.style.display="block";
    }
  }

  header.querySelector("button").onclick=()=>{ chatArea.removeChild(win); delete chatWindows[roomId]; }

  // è¨Šæ¯ç›£è½
  const unsub=db.collection("messages").doc(roomId).collection("chats").orderBy("time")
  .onSnapshot(snap=>{
    msgDiv.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      const div=document.createElement("div"); div.className="msg"; div.textContent=`${d.from}: ${d.text}`;
      msgDiv.appendChild(div);
    });
    msgDiv.scrollTop=msgDiv.scrollHeight;
  });

  chatWindows[roomId]=unsub;

  // é€è¨Šæ¯
  btn.onclick=sendMsg;
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
  });

  async function sendMsg(){
    const text=input.value.trim();
    if(!text) return;
    await db.collection("messages").doc(roomId).collection("chats").add({
      from:userEmail, text, time:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value="";
  }
}
</script>
</body>
</html>
