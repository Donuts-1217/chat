<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>🔥 校園聊天室</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { margin:0; font-family:"Noto Sans TC",sans-serif; background:#f0f2f5; }
#loginPage,#chatPage{width:100%;height:100vh;display:flex;justify-content:center;align-items:center;}
#loginPage{flex-direction:column; background:#e2e8f0;}
#loginPage h1{font-size:36px;margin-bottom:30px;}
#loginPage button{padding:12px 20px;font-size:16px;background:#4285f4;color:white;border:none;border-radius:6px;cursor:pointer;}
#chatPage{display:none;flex-direction:column;}
#topBar{background:#2d8cf0;color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;}
#topBar button{background:#f44336;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;}
#container{display:flex;flex:1;height:calc(100vh-50px);}
.sidebar{width:20%;background:#f7f9fc;padding:15px;display:flex;flex-direction:column;border-right:1px solid #ddd;}
.sidebar h3{margin:10px 0 5px 0;}
.sidebar ul{list-style:none;padding:0;margin:0;flex:1;overflow-y:auto;border:1px solid #ccc;border-radius:6px;background:#fff;}
.sidebar li{padding:8px;cursor:pointer;border-bottom:1px solid #eee;transition:0.2s;}
.sidebar li:hover{background:#e0f0ff;}
.sidebar input{margin:5px 0;padding:6px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box;}
.sidebar button.actionBtn{margin:3px 0;padding:5px;border-radius:4px;border:none;background:#2ecc71;color:white;cursor:pointer;font-size:13px;}
.chat-area{flex:1;padding:10px;display:flex;flex-wrap:wrap;gap:10px;overflow-x:auto;background:#f1f5f9;}
.chat-window{width:280px;min-width:280px;max-height:500px;background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.08);display:flex;flex-direction:column;overflow:hidden;}
.chat-header{background:#2d8cf0;color:white;padding:8px;font-size:14px;display:flex;justify-content:space-between;align-items:center;}
.chat-header button{background:#f44336;font-size:12px;padding:2px 6px;border-radius:4px;}
.chat-messages{flex:1;overflow-y:auto;padding:8px;background:#f7f9fc;}
.msg{margin:4px 0;padding:6px 10px;border-radius:8px;background:#e0f0ff;font-size:13px;word-break:break-word;}
.chat-input{display:flex;border-top:1px solid #ddd;}
.chat-input input{flex:1;padding:6px 10px;border:none;outline:none;font-size:13px;}
.chat-input button{padding:6px 12px;background:#2ecc71;color:white;border:none;cursor:pointer;font-weight:500;border-radius:0 0 8px 0;}
.rightbar{width:20%;padding:10px;background:#f7f9fc;display:flex;flex-direction:column;border-left:1px solid #ddd;}
.rightbar h3{margin:10px 0 5px 0;}
.rightbar ul{list-style:none;padding:0;margin:0;flex:1;overflow-y:auto;border:1px solid #ccc;border-radius:6px;background:#fff;}
.rightbar li{padding:6px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;}
.rightbar button.requestBtn{padding:3px 6px;margin-left:4px;border-radius:4px;font-size:12px;background:#2ecc71;color:white;border:none;cursor:pointer;}
</style>
</head>
<body>

<div id="loginPage">
  <h1>🔥 校園聊天室</h1>
  <button id="loginBtn">使用 Google 登入</button>
</div>

<div id="chatPage">
  <div id="topBar">
    <span id="welcome"></span>
    <div>
      <button id="broadcastBtn" style="display:none;">發送全域公告</button>
      <button id="logoutBtn">登出</button>
    </div>
  </div>
  <div id="container">
    <div class="sidebar">
      <p>👋 <span id="userName"></span></p>
      <h3>好友清單</h3>
      <ul id="friendList"></ul>
      <input id="addFriendEmail" placeholder="輸入 Gmail">
      <button class="actionBtn" id="addFriendBtn">送出好友請求</button>
      <h3>群組清單</h3>
      <ul id="groupList"></ul>
      <input id="newGroupName" placeholder="群組名稱">
      <button class="actionBtn" id="createGroupBtn">建立群組</button>
    </div>
    <div class="chat-area" id="chatArea"></div>
    <div class="rightbar">
      <h3>好友請求</h3>
      <ul id="requestList"></ul>
      <h3>監看私聊（僅高階管理員）</h3>
      <ul id="watchList"></ul>
    </div>
  </div>
</div>

<script>
// Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const welcome = document.getElementById("welcome");
const chatPage = document.getElementById("chatPage");
const loginPage = document.getElementById("loginPage");
const userName = document.getElementById("userName");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupName = document.getElementById("newGroupName");
const chatArea = document.getElementById("chatArea");
const requestList = document.getElementById("requestList");
const watchList = document.getElementById("watchList");
const broadcastBtn = document.getElementById("broadcastBtn");

let userEmail = "";
let userRole = "user"; // user / admin / super
let chatWindows = {};

// 登入
loginBtn.onclick = async ()=>{
  await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  chatWindows={};
  chatArea.innerHTML="";
  friendList.innerHTML="";
  groupList.innerHTML="";
  requestList.innerHTML="";
  watchList.innerHTML="";
  chatPage.style.display="none";
  loginPage.style.display="flex";
};

// 監聽登入狀態
auth.onAuthStateChanged(async user=>{
  if(user){
    userEmail = user.email;
    chatPage.style.display="flex";
    loginPage.style.display="none";
    userName.textContent = user.displayName;
    welcome.textContent = `歡迎 ${user.displayName}`;
    // 權限設定
    if(userEmail==="chianghansen0302@gmail.com") userRole="super";
    else userRole = await db.collection("users").doc(userEmail).get().then(d=>d.exists?d.data().role||"user":"user");
    if(userRole==="super") broadcastBtn.style.display="inline-block";
    await db.collection("users").doc(userEmail).set({name:user.displayName,email:userEmail,role:userRole},{merge:true});
    loadFriends();
    loadGroups();
    loadRequests();
    if(userRole==="super") loadWatchList();
  }
});

// 好友清單
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.data().email;
      li.onclick = ()=> openChatWindow([userEmail,doc.data().email].sort().join("_"), doc.data().email,false);
      friendList.appendChild(li);
    });
  });
}

// 群組清單
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.id;
      li.onclick = ()=> openChatWindow(doc.id, doc.id,false);
      groupList.appendChild(li);
    });
  });
}

// 送出好友請求
addFriendBtn.onclick=async ()=>{
  const email = addFriendEmail.value.trim();
  if(!email) return alert("請輸入好友 Gmail");
  if(email===userEmail) return alert("不能加自己");
  try{
    await db.collection("users").doc(email).set({email},{merge:true});
    await db.collection("users").doc(email).collection("requests").add({from:userEmail,status:"pending",timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    alert("好友請求已送出！");
    addFriendEmail.value="";
  }catch(err){alert("送出好友請求失敗："+err.message);}
};

// 好友請求
function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests").where("status","==","pending")
    .onSnapshot(snap=>{
      requestList.innerHTML="";
      snap.forEach(doc=>{
        const data=doc.data();
        const li=document.createElement("li");
        li.textContent=`${data.from} 想加你為好友`;
        const acceptBtn=document.createElement("button");
        acceptBtn.textContent="同意";
        acceptBtn.className="requestBtn";
        acceptBtn.onclick=async ()=>{
          await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
          await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
          await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
        };
        const rejectBtn=document.createElement("button");
        rejectBtn.textContent="拒絕";
        rejectBtn.className="requestBtn";
        rejectBtn.onclick=async ()=>{await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"rejected"});};
        li.appendChild(acceptBtn);li.appendChild(rejectBtn);
        requestList.appendChild(li);
      });
    });
}

// 創建群組
createGroupBtn.onclick=async ()=>{
  if(userRole==="user"){alert("你沒有權限創建群組"); return;}
  const name=newGroupName.value.trim();
  if(!name) return alert("請輸入群組名稱");
  await db.collection("groups").doc(name).set({createdBy:userEmail,members:[userEmail]});
  newGroupName.value="";
};

// 開啟聊天窗
function openChatWindow(roomId,title,isWatch){
  if(chatWindows[roomId]) return;
  const win=document.createElement("div");win.className="chat-window";win.id="win_"+roomId;
  const header=document.createElement("div");header.className="chat-header";header.innerHTML=`<span>${title}</span><button>X</button>`;
  win.appendChild(header);
  const msgDiv=document.createElement("div");msgDiv.className="chat-messages";win.appendChild(msgDiv);
  const inputDiv=document.createElement("div");inputDiv.className="chat-input";
  const input=document.createElement("input");input.placeholder="輸入訊息...";
  const btn=document.createElement("button");btn.textContent="送出";inputDiv.appendChild(input);inputDiv.appendChild(btn);
  win.appendChild(inputDiv);
  chatArea.appendChild(win);
  if(isWatch) btn.disabled=true; // 監看不可發言
  header.querySelector("button").onclick=()=>{if(chatWindows[roomId]) chatWindows[roomId]();chatArea.removeChild(win);delete chatWindows[roomId];};
  const unsub=db.collection("messages").doc(roomId).collection("chats").orderBy("time").onSnapshot(snap=>{
    msgDiv.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();const div=document.createElement("div");div.className="msg";
      div.textContent=`${d.from}: ${d.text}`;msgDiv.appendChild(div);
    });msgDiv.scrollTop=msgDiv.scrollHeight;
  });
  chatWindows[roomId]=unsub;
  btn.onclick=async ()=>{
    const text=input.value.trim();if(!text) return;
    await db.collection("messages").doc(roomId).collection("chats").add({from:userEmail,text,time:firebase.firestore.FieldValue.serverTimestamp()});
    input.value="";
  };
}

// 高階管理員監看私聊
function loadWatchList(){
  db.collection("users").get().then(snap=>{
    watchList.innerHTML="";
    snap.forEach(doc=>{
      const email=doc.id;
      if(email===userEmail) return;
      const li=document.createElement("li");
      li.textContent=email;
      const btn=document.createElement("button");
      btn.textContent="監看";
      btn.className="requestBtn";
      btn.onclick=()=> openChatWindow([userEmail,email].sort().join("_"),email,true);
      li.appendChild(btn);watchList.appendChild(li);
    });
  });
}

// 全域公告
broadcastBtn.onclick=async ()=>{
  const msg=prompt("輸入全域公告訊息");
  if(!msg) return;
  await db.collection("global").add({from:userEmail,text:msg,time:firebase.firestore.FieldValue.serverTimestamp()});
  alert("公告已送出！");
};
</script>
</body>
</html>
