<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Chat Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: "微軟正黑體"; margin: 0; padding: 0; background: #f2f5fa; }
  #login { display:flex; justify-content:center; align-items:center; height:100vh; }
  #main { display:none; height:100vh; }
  #sidebar { width:250px; background:#fff; height:100%; float:left; border-right:1px solid #ccc; padding:10px; }
  #chat { margin-left:250px; height:100%; display:flex; flex-direction:column; }
  #messages { flex:1; overflow-y:auto; padding:10px; }
  #chatInput { width:100%; height:50px; padding:5px; }
  .friend { padding:5px; cursor:pointer; border-bottom:1px solid #eee; }
  .friend:hover { background:#f0f0f0; }
  .adminPanel { margin-top:20px; padding:10px; background:#f8f9fa; border:1px solid #ccc; }
  .pro { background: linear-gradient(to bottom, #000000, #0000ff); color:white; padding:5px; border-radius:5px; }
</style>
</head>
<body>

<div id="login">
  <button id="googleSignIn">使用 Google 登入</button>
</div>

<div id="main">
  <div id="sidebar">
    <h3>好友列表</h3>
    <div id="friendList"></div>
    <button id="addFriendBtn">加好友</button>
    <button id="logoutBtn">登出</button>
    <div id="adminPanel" class="adminPanel" style="display:none;">
      <h4>管理員面板</h4>
      <input type="email" id="setProEmail" placeholder="輸入Email設定Pro">
      <button id="setProBtn">設定Pro</button>
    </div>
  </div>

  <div id="chat">
    <div id="messages"></div>
    <textarea id="chatInput" placeholder="輸入訊息…"></textarea>
    <button id="sendBtn">送出</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const provider = new GoogleAuthProvider();

const loginDiv = document.getElementById("login");
const mainDiv = document.getElementById("main");
const friendListDiv = document.getElementById("friendList");
const chatInput = document.getElementById("chatInput");
const messagesDiv = document.getElementById("messages");
const addFriendBtn = document.getElementById("addFriendBtn");
const logoutBtn = document.getElementById("logoutBtn");
const sendBtn = document.getElementById("sendBtn");
const adminPanel = document.getElementById("adminPanel");
const setProEmail = document.getElementById("setProEmail");
const setProBtn = document.getElementById("setProBtn");

let currentUser = null;
let currentChatFriend = null;

// 登入
document.getElementById("googleSignIn").onclick = async () => {
  const result = await signInWithPopup(auth, provider);
  const user = result.user;
  currentUser = user;
  // 新增到Firestore users collection
  const userDoc = doc(db, "Users", user.uid);
  const docSnap = await getDoc(userDoc);
  if(!docSnap.exists()){
    await setDoc(userDoc, {
      email: user.email,
      name: user.displayName,
      nickname: user.displayName,
      role: "general",
      friends: []
    });
  }
  showMain();
};

// 登出
logoutBtn.onclick = async () => {
  await signOut(auth);
  location.reload();
};

// 顯示主頁
function showMain(){
  loginDiv.style.display = "none";
  mainDiv.style.display = "flex";
  loadFriends();
  checkRole();
}

// 取得好友列表
async function loadFriends(){
  friendListDiv.innerHTML = "";
  const userDoc = await getDoc(doc(db, "Users", currentUser.uid));
  const userData = userDoc.data();
  const friends = userData.friends || [];
  for(let fid of friends){
    const fDoc = await getDoc(doc(db, "Users", fid));
    const fData = fDoc.data();
    const div = document.createElement("div");
    div.className = "friend";
    div.textContent = fData.nickname;
    div.onclick = () => openChat(fid, fData.nickname);
    friendListDiv.appendChild(div);
  }
}

// 開啟聊天
function openChat(friendId, friendName){
  currentChatFriend = friendId;
  messagesDiv.innerHTML = "";
  const chatId = [currentUser.uid, friendId].sort().join("-");
  const chatRef = collection(db, "Messages", chatId, "msgs");
  onSnapshot(chatRef, (snapshot)=>{
    messagesDiv.innerHTML = "";
    snapshot.docs.forEach(doc=>{
      const msg = doc.data();
      const div = document.createElement("div");
      div.textContent = msg.senderName + ": " + msg.content;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// 發送訊息
async function sendMessage(){
  if(!currentChatFriend) return;
  const content = chatInput.value.trim();
  if(content==="") return;
  const chatId = [currentUser.uid, currentChatFriend].sort().join("-");
  const msgRef = doc(collection(db, "Messages", chatId, "msgs"));
  await setDoc(msgRef, {
    sender: currentUser.uid,
    senderName: currentUser.displayName,
    content: content,
    timestamp: Date.now()
  });
  chatInput.value = "";
}

// Enter送出, Shift+Enter換行
chatInput.addEventListener("keydown", function(e){
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// 加好友
addFriendBtn.onclick = async () => {
  const email = prompt("輸入好友Email");
  if(!email) return;
  const qSnap = await getDocs(collection(db,"Users"));
  let friendId = null;
  qSnap.forEach(doc=>{
    if(doc.data().email === email) friendId = doc.id;
  });
  if(!friendId){
    alert("找不到該用戶");
    return;
  }
  // 更新雙方friends
  await updateDoc(doc(db,"Users",currentUser.uid), { friends: arrayUnion(friendId) });
  await updateDoc(doc(db,"Users",friendId), { friends: arrayUnion(currentUser.uid) });
  loadFriends();
}

// 檢查身分
async function checkRole(){
  const userDoc = await getDoc(doc(db, "Users", currentUser.uid));
  const role = userDoc.data().role;
  if(role==="admin") adminPanel.style.display="block";
  if(role==="pro") chatInput.classList.add("pro");
}

// 設定Pro (管理員)
setProBtn.onclick = async () => {
  const email = setProEmail.value.trim();
  if(!email) return;
  const qSnap = await getDocs(collection(db,"Users"));
  let uid = null;
  qSnap.forEach(doc=>{
    if(doc.data().email===email) uid = doc.id;
  });
  if(!uid){
    alert("找不到該用戶");
    return;
  }
  await updateDoc(doc(db,"Users",uid), { role: "pro" });
  alert("設定完成！");
}
</script>

</body>
</html>
