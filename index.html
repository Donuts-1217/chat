<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>èŠå¤©å®¤ï¼ˆæœ€çµ‚å®Œæ•´ç‰ˆï¼ŒRWD + å‹•ç•«ï¼‰</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ===== å¸¸ç”¨è‰²å½© & é‡ç½® ===== */
:root{
  --bg:#0f1113; --panel:#1f2023; --muted:#94a3b8; --accent:#7289da;
  --card:#161618; --ok:#43b581; --danger:#f04747; --glass:rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans TC", "Segoe UI", Roboto, sans-serif;background:linear-gradient(180deg,#0b0c0d 0%, #0f1113 100%);color:#e6edf3;}

/* ===== header ===== */
.header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:transparent}
.header h1{margin:0;font-size:18px}
.header .controls{display:flex;gap:8px}

/* ===== login page (animated) ===== */
#loginPage{height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center}
.cardLogin{background:var(--panel);padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);transform:translateY(20px);opacity:0;animation:fadeUp .6s forwards}
@keyframes fadeUp{to{transform:none;opacity:1}}
.logo{font-size:28px;margin-bottom:12px}
.loginBtn{background:var(--accent);border:none;padding:12px 18px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:transform .12s}
.loginBtn:hover{transform:translateY(-3px)}
.loginNote{margin-top:8px;color:var(--muted);font-size:13px}

/* ===== app container ===== */
#app{display:none;padding:18px}
.container{max-width:1400px;margin:0 auto;display:flex;gap:12px;height:78vh}

/* ===== left (friends + groups) ===== */
.left{width:280px;background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
.sectionTitle{color:var(--muted);font-size:13px;margin-bottom:6px}
.list{flex:1;background:#111315;border-radius:10px;padding:8px;overflow:auto}
.listItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;color:#fff;margin-bottom:8px;cursor:pointer}
.listItem:hover{background:rgba(114,137,218,0.06)}
.smallBtn{padding:6px 8px;border-radius:8px;border:none;background:transparent;color:#fff;cursor:pointer}
.smallBtn.primary{background:var(--accent)}
.smallInput{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#0b0c0d;color:#fff}

/* ===== center (chat grid) ===== */
.center{flex:1;display:flex;flex-direction:column;gap:12px}
.chatGrid{display:flex;flex-wrap:wrap;gap:12px;align-content:flex-start;overflow:auto;padding:6px;height:100%}
.chatCard{width:360px;min-width:260px;background:var(--card);border-radius:10px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.chatHead{background:linear-gradient(90deg,var(--accent),#5f74c6);padding:8px 10px;color:#fff;display:flex;justify-content:space-between;align-items:center}
.chatBody{flex:1;padding:10px;overflow:auto;background:linear-gradient(180deg,#0f1113,#0b0c0d)}
.chatMsg{background:var(--glass);padding:8px;border-radius:8px;margin-bottom:8px;word-break:break-word;color:#e6edf3}
.chatInputBar{display:flex;padding:8px;border-top:1px solid rgba(255,255,255,0.02);background:#0b0c0d}
.chatInput{flex:1;padding:8px;border-radius:8px;border:none;background:#0b0c0d;color:#fff;resize:none;height:64px}
.sendBtn{padding:8px 12px;border-radius:8px;border:none;background:var(--ok);color:#fff;cursor:pointer;margin-left:8px}

/* ===== right (requests, blocks, announcement, watch) ===== */
.right{width:320px;background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
.right .panel{background:#111315;padding:8px;border-radius:10px;max-height:40vh;overflow:auto}
.note{color:var(--muted);font-size:13px}

/* ===== modal ===== */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:80}
.modal .box{background:#0f1720;padding:16px;border-radius:10px;width:100%;max-width:720px;color:#fff;max-height:80vh;overflow:auto}
.modal .row{display:flex;gap:8px;align-items:center}

/* ===== responsive (mobile) ===== */
@media (max-width:900px){
  .container{flex-direction:column;height:calc(100vh - 64px)}
  .left{width:100%;display:none} /* hide left by default on mobile, use tabs */
  .right{width:100%;display:none}
  .chatGrid{flex-wrap:nowrap;flex-direction:column}
  .chatCard{width:100%}
  /* bottom navbar */
  #mobileNav{display:flex;position:fixed;left:0;right:0;bottom:10px;justify-content:center;gap:8px;padding:6px;z-index:70}
  .mobileTab{background:#111315;padding:8px 12px;border-radius:10px;color:#fff}
}
@media (min-width:901px){
  #mobileNav{display:none}
}
</style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆæœ€çµ‚ï¼‰</h1>
    <div class="controls">
      <button id="btnLogin" class="smallBtn primary">ä½¿ç”¨ Google ç™»å…¥</button>
      <button id="btnLogout" class="smallBtn danger" style="display:none">ç™»å‡º</button>
    </div>
  </div>

  <!-- login page -->
  <div id="loginPage" style="height:calc(100vh - 64px)">
    <div class="cardLogin">
      <div class="logo">æ­¡è¿å›ä¾†</div>
      <div style="max-width:420px">
        <p class="note">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ï¼ˆå·²å°‡ <strong>chianghansen0302@gmail.com</strong> è¨­ç‚ºæœ€é«˜ç®¡ç†å“¡ï¼‰</p>
        <button id="loginMain" class="loginBtn">ä»¥ Google ç™»å…¥</button>
        <div class="loginNote">ç™»å…¥å¾Œå¯ä½¿ç”¨å®Œæ•´èŠå¤©å®¤åŠŸèƒ½ï¼ˆæ‰‹æ©Ÿè¦–åœ–æœƒè‡ªå‹•èª¿æ•´ï¼‰</div>
      </div>
    </div>
  </div>

  <!-- app -->
  <div id="app" class="" style="display:none">
    <div class="container">
      <!-- left -->
      <div class="left" id="leftPanel">
        <div>
          <div class="sectionTitle">ä½¿ç”¨è€…</div>
          <div id="meDisplay" style="font-weight:700"></div>
          <div id="meEmail" class="note"></div>
        </div>

        <div>
          <div class="sectionTitle">å¥½å‹</div>
          <div class="list" id="friendList"></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <input id="inputFriend" class="smallInput" placeholder="è¼¸å…¥ Gmail" />
            <button id="btnSendReq" class="smallBtn primary">é€å‡º</button>
          </div>
        </div>

        <div>
          <div class="sectionTitle">ç¾¤çµ„</div>
          <div class="list" id="groupList"></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <input id="inputGroup" class="smallInput" placeholder="ç¾¤çµ„åç¨±ï¼ˆç®¡ç†å“¡å¯å‰µï¼‰" />
            <button id="btnCreateGroup" class="smallBtn primary">å»ºç«‹</button>
          </div>
          <div class="note" style="margin-top:6px">ç¾¤çµ„ç”±ç®¡ç†å“¡å‰µå»ºï¼›æˆå“¡åå–®å…§å¯åŠ äºº/è¸¢äºº</div>
        </div>
      </div>

      <!-- center -->
      <div class="center">
        <div class="chatGrid" id="chatGrid"></div>
      </div>

      <!-- right -->
      <div class="right" id="rightPanel">
        <div>
          <div class="sectionTitle">å¥½å‹è«‹æ±‚</div>
          <div class="panel" id="requestPanel"></div>
        </div>

        <div>
          <div class="sectionTitle">å°é–æ¸…å–®</div>
          <div class="panel" id="blockPanel"></div>
        </div>

        <div>
          <div class="sectionTitle">å…¨åŸŸå…¬å‘Š</div>
          <div class="panel note" id="announcementPanel"></div>
          <textarea id="announcementInput" placeholder="åªæœ‰æœ€é«˜ç®¡ç†å“¡å¯ç™¼å…¬å‘Š" style="width:100%;min-height:64px;background:#0b0c0d;color:#fff;border-radius:8px;padding:8px;border:none"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnAnnouncement" class="smallBtn primary">ç™¼å…¬å‘Š</button>
            <button id="btnRefresh" class="smallBtn">é‡æ–°æ•´ç†</button>
          </div>
        </div>

        <div>
          <div class="sectionTitle">ç›£çœ‹ç§èŠ (æœ€é«˜ç®¡ç†å“¡)</div>
          <input id="inputWatch" class="smallInput" placeholder="æ ¼å¼: emailA_emailB" />
          <button id="btnWatch" class="smallBtn primary" style="margin-top:6px;display:none">ç›£çœ‹ (åªè®€)</button>
          <div class="note" style="margin-top:6px">ç›£çœ‹åªæœ‰æœ€é«˜ç®¡ç†å“¡å¯è¦‹</div>
        </div>
      </div>
    </div>
  </div>

  <!-- mobile nav -->
  <div id="mobileNav" style="display:none;position:fixed;left:12px;right:12px;bottom:12px;justify-content:space-around;gap:6px;">
    <button class="mobileTab" id="tabFriends">å¥½å‹</button>
    <button class="mobileTab" id="tabChats">èŠå¤©</button>
    <button class="mobileTab" id="tabGroups">ç¾¤çµ„</button>
  </div>

  <!-- modal members -->
  <div id="modalMembers" class="modal">
    <div class="box">
      <h3>æˆå“¡åå–®ï¼š<span id="modalGroupTitle"></span></h3>
      <div id="modalMemberList" style="margin-top:8px"></div>
      <div class="row" style="margin-top:12px">
        <input id="modalAddEmail" class="smallInput" placeholder="è¼¸å…¥ Gmail åŠ å…¥"/>
        <button id="modalAddBtn" class="smallBtn primary">åŠ å…¥</button>
        <button id="modalCloseBtn" class="smallBtn">é—œé–‰</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Firebase initialization
   è«‹ä¿æŒä½ å°ˆæ¡ˆçš„ configï¼ˆä¸‹åˆ—ç‚ºç¤ºç¯„ï¼‰
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===========================
   App state
   ============================ */
let CURRENT = {
  user: null,
  role: 'user', // 'user' | 'admin' | 'high'
  blocks: [], // emails blocked by me
  openRooms: {} // roomId -> { unsub }
};

/* ===== DOM refs ===== */
const loginPage = document.getElementById('loginPage');
const btnLoginMain = document.getElementById('loginMain');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const appDiv = document.getElementById('app');
const meDisplay = document.getElementById('meDisplay');
const meEmailDiv = document.getElementById('meEmail');

const friendListEl = document.getElementById('friendList');
const groupListEl = document.getElementById('groupList');
const chatGrid = document.getElementById('chatGrid');

const inputFriend = document.getElementById('inputFriend');
const btnSendReq = document.getElementById('btnSendReq');
const requestPanel = document.getElementById('requestPanel');
const blockPanel = document.getElementById('blockPanel');

const inputGroup = document.getElementById('inputGroup');
const btnCreateGroup = document.getElementById('btnCreateGroup');

const announcementPanel = document.getElementById('announcementPanel');
const announcementInput = document.getElementById('announcementInput');
const btnAnnouncement = document.getElementById('btnAnnouncement');

const inputWatch = document.getElementById('inputWatch');
const btnWatch = document.getElementById('btnWatch');

const btnRefresh = document.getElementById('btnRefresh');

const modalMembers = document.getElementById('modalMembers');
const modalGroupTitle = document.getElementById('modalGroupTitle');
const modalMemberList = document.getElementById('modalMemberList');
const modalAddEmail = document.getElementById('modalAddEmail');
const modalAddBtn = document.getElementById('modalAddBtn');
const modalCloseBtn = document.getElementById('modalCloseBtn');

/* ===========================
   Auth & UI initialization
   ============================ */
btnLoginMain.onclick = async ()=> signIn();
btnLogin.onclick = async ()=> signIn();
btnLogout.onclick = async ()=> {
  await auth.signOut();
  location.reload();
};

async function signIn(){
  try{
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }catch(e){
    alert('ç™»å…¥éŒ¯èª¤ï¼š' + e.message);
  }
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    loginPage.style.display = 'flex';
    appDiv.style.display = 'none';
    btnLogout.style.display = 'none';
    btnLogin.style.display = 'inline-block';
    return;
  }
  CURRENT.user = user;
  loginPage.style.display = 'none';
  appDiv.style.display = 'block';
  btnLogout.style.display = 'inline-block';
  btnLogin.style.display = 'none';
  meDisplay.textContent = user.displayName || '';
  meEmailDiv.textContent = user.email || '';
  // role logic
  if(user.email === 'chianghansen0302@gmail.com') CURRENT.role = 'high';
  else {
    // check admins collection
    const ad = await db.collection('admins').doc(user.email).get().catch(()=>null);
    if(ad && ad.exists) CURRENT.role = 'admin';
    else CURRENT.role = 'user';
  }
  // show watch only for high
  if(CURRENT.role === 'high'){
    btnWatch.style.display = 'inline-block';
  } else { btnWatch.style.display = 'none'; }
  if(CURRENT.role === 'high') btnAnnouncement.style.display = 'inline-block'; else btnAnnouncement.style.display = 'none';

  // create user doc
  await db.collection('users').doc(user.email).set({name:user.displayName,email:user.email,role:CURRENT.role},{merge:true});
  // load UI lists
  loadBlocks();
  loadFriends();
  loadGroups();
  loadRequests();
  loadAnnouncement();
});

/* ===========================
   Blocks (å°é–) - users/{me}/blocks/{blockedEmail: true}
   ============================ */
function loadBlocks(){
  if(!CURRENT.user) return;
  db.collection('users').doc(CURRENT.user.email).collection('blocks').onSnapshot(snap=>{
    blockPanel.innerHTML = '';
    CURRENT.blocks = [];
    snap.forEach(doc=>{
      CURRENT.blocks.push(doc.id);
      const div = document.createElement('div'); div.className='member-row';
      div.innerHTML = `<div>${doc.id}</div><div><button class="smallBtn" data-email="${doc.id}">è§£é™¤</button></div>`;
      div.querySelector('button').onclick = async ()=> await db.collection('users').doc(CURRENT.user.email).collection('blocks').doc(doc.id).delete();
      blockPanel.appendChild(div);
    });
  });
}

/* ===========================
   Friends: load friends, send request, delete, block
   users/{me}/friends/{friendEmail}
   users/{target}/requests/ -> add request doc
   ============================ */
function loadFriends(){
  if(!CURRENT.user) return;
  db.collection('users').doc(CURRENT.user.email).collection('friends').onSnapshot(snapshot=>{
    friendListEl.innerHTML = '';
    snapshot.forEach(doc=>{
      const f = doc.id;
      const item = document.createElement('div'); item.className='listItem';
      item.innerHTML = `<div>${f}</div>
        <div style="display:flex;gap:6px">
          <button class="smallBtn" data-f="${f}" data-act="chat">èŠå¤©</button>
          <button class="smallBtn" data-f="${f}" data-act="block">å°é–</button>
          <button class="smallBtn" data-f="${f}" data-act="del" style="background:${'var(--danger)'}">åˆªé™¤</button>
        </div>`;
      item.querySelector('[data-act="chat"]').onclick = ()=> openPrivate([CURRENT.user.email,f].sort().join('_'), f);
      item.querySelector('[data-act="block"]').onclick = async ()=> {
        await db.collection('users').doc(CURRENT.user.email).collection('blocks').doc(f).set({time:firebase.firestore.FieldValue.serverTimestamp()});
        alert('å·²å°é– ' + f);
      };
      item.querySelector('[data-act="del"]').onclick = async ()=> {
        if(!confirm('ç¢ºå®šåˆªé™¤å¥½å‹ï¼Ÿ')) return;
        await db.collection('users').doc(CURRENT.user.email).collection('friends').doc(f).delete().catch(()=>null);
        await db.collection('users').doc(f).collection('friends').doc(CURRENT.user.email).delete().catch(()=>null);
        alert('å·²åˆªé™¤å¥½å‹');
      };
      friendListEl.appendChild(item);
    });
  });
}

btnSendReq.onclick = async ()=>{
  const email = inputFriend.value.trim();
  if(!email) return alert('è«‹è¼¸å…¥ Gmail');
  if(!CURRENT.user) return alert('è«‹å…ˆç™»å…¥');
  if(email === CURRENT.user.email) return alert('ä¸èƒ½åŠ è‡ªå·±');
  // create target user doc if not exist, then add request
  await db.collection('users').doc(email).set({email},{merge:true});
  await db.collection('users').doc(email).collection('requests').add({
    from: CURRENT.user.email, status: 'pending', time: firebase.firestore.FieldValue.serverTimestamp()
  });
  inputFriend.value = '';
  alert('å¥½å‹è«‹æ±‚å·²é€å‡º');
};

/* ===========================
   Requests (receive / accept / reject)
   users/{me}/requests/{id}
   ============================ */
function loadRequests(){
  if(!CURRENT.user) return;
  db.collection('users').doc(CURRENT.user.email).collection('requests').where('status','==','pending')
    .onSnapshot(snap=>{
      requestPanel.innerHTML = '';
      snap.forEach(doc=>{
        const d = doc.data();
        const el = document.createElement('div'); el.className='request';
        el.innerHTML = `<div>${d.from}</div><div style="display:flex;gap:6px">
          <button class="smallBtn primary">åŒæ„</button><button class="smallBtn">æ‹’çµ•</button></div>`;
        el.querySelector('.primary').onclick = async ()=>{
          await db.collection('users').doc(CURRENT.user.email).collection('friends').doc(d.from).set({email:d.from});
          await db.collection('users').doc(d.from).collection('friends').doc(CURRENT.user.email).set({email:CURRENT.user.email});
          await db.collection('users').doc(CURRENT.user.email).collection('requests').doc(doc.id).update({status:'accepted'});
        };
        el.querySelectorAll('button')[1].onclick = async ()=> await db.collection('users').doc(CURRENT.user.email).collection('requests').doc(doc.id).update({status:'rejected'});
        requestPanel.appendChild(el);
      });
    });
}

/* ===========================
   Groups: load list, create (admin/high), open group chat, open members modal
   groups/{groupName} -> {createdBy, members:[], admins:[]}
   ============================ */
function loadGroups(){
  db.collection('groups').onSnapshot(snap=>{
    groupListEl.innerHTML = '';
    snap.forEach(doc=>{
      const name = doc.id;
      const el = document.createElement('div'); el.className='listItem';
      el.innerHTML = `<div>${name}</div><div style="display:flex;gap:6px">
        <button class="smallBtn" data-name="${name}" data-act="open">é–‹å•Ÿ</button>
        <button class="smallBtn" data-name="${name}" data-act="members">æˆå“¡</button>
      </div>`;
      el.querySelector('[data-act="open"]').onclick = ()=> openGroup(name);
      el.querySelector('[data-act="members"]').onclick = ()=> openMembersModal(name);
      groupListEl.appendChild(el);
    });
  });
}

btnCreateGroup.onclick = async ()=>{
  if(CURRENT.role === 'user') return alert('åªæœ‰ç®¡ç†å“¡å¯å»ºç«‹ç¾¤çµ„');
  const name = inputGroup.value.trim();
  if(!name) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
  await db.collection('groups').doc(name).set({createdBy: CURRENT.user.email, members: [CURRENT.user.email], admins: [CURRENT.user.email]});
  inputGroup.value = '';
  alert('ç¾¤çµ„å·²å»ºç«‹ï¼š' + name);
};

/* modal: members list with add/kick/exit */
let activeGroup = null;
async function openMembersModal(groupName){
  activeGroup = groupName;
  modalGroupTitle.textContent = groupName;
  modalMemberList.innerHTML = '';
  modalMembers.style.display = 'flex';
  const g = await db.collection('groups').doc(groupName).get();
  if(!g.exists){ modalMemberList.innerHTML = '<div class="note">æ‰¾ä¸åˆ°æ­¤ç¾¤çµ„</div>'; return; }
  const data = g.data(); const members = data.members || []; const admins = data.admins || [];
  members.forEach(m=>{
    const row = document.createElement('div'); row.className='member-row';
    row.innerHTML = `<div>${m} ${admins.includes(m)?'(ç®¡ç†å“¡)':''}</div><div></div>`;
    const right = row.querySelector('div:last-child');
    if(m === CURRENT.user.email){
      const btnExit = document.createElement('button'); btnExit.className='smallBtn'; btnExit.textContent='é€€å‡º';
      btnExit.onclick = async ()=>{ if(!confirm('ç¢ºå®šé€€å‡ºç¾¤çµ„ï¼Ÿ')) return; await db.collection('groups').doc(groupName).update({members: firebase.firestore.FieldValue.arrayRemove(CURRENT.user.email)}); modalMembers.style.display='none'; };
      right.appendChild(btnExit);
    }
    // kick: only group admin or high
    if((admins.includes(CURRENT.user.email) || CURRENT.role === 'high') && m !== CURRENT.user.email){
      const btnKick = document.createElement('button'); btnKick.className='smallBtn'; btnKick.style.background = 'var(--danger)'; btnKick.textContent='è¸¢å‡º';
      btnKick.onclick = async ()=>{ if(!confirm('ç¢ºå®šè¸¢å‡ºï¼Ÿ')) return; await db.collection('groups').doc(groupName).update({members: firebase.firestore.FieldValue.arrayRemove(m)}); await db.collection('messages').doc(groupName).collection('chats').add({from:'ç³»çµ±',text:`${m} è¢«è¸¢å‡ºç¾¤çµ„ ${groupName}`,time:firebase.firestore.FieldValue.serverTimestamp()}); };
      right.appendChild(btnKick);
    }
    modalMemberList.appendChild(row);
  });
}
modalCloseBtn.onclick = ()=>{ modalMembers.style.display='none'; activeGroup = null; };
modalAddBtn.onclick = async ()=>{
  const email = modalAddEmail.value.trim(); if(!email) return alert('è¼¸å…¥ Gmail');
  const gDoc = await db.collection('groups').doc(activeGroup).get();
  if(!gDoc.exists) return alert('æ‰¾ä¸åˆ°ç¾¤çµ„');
  const admins = gDoc.data().admins || [];
  if(!(admins.includes(CURRENT.user.email) || CURRENT.role === 'high')) return alert('ä½ æ²’æœ‰æ¬Šé™åŠ å…¥æˆå“¡');
  await db.collection('groups').doc(activeGroup).update({members: firebase.firestore.FieldValue.arrayUnion(email)});
  await db.collection('messages').doc(activeGroup).collection('chats').add({from:'ç³»çµ±',text:`${email} è¢«åŠ å…¥ç¾¤çµ„ ${activeGroup}`,time:firebase.firestore.FieldValue.serverTimestamp()});
  modalAddEmail.value=''; alert('å·²åŠ å…¥');
};

/* ===========================
   Chat open / display / send
   roomId: private -> emailA_emailB (sorted with _)
           group -> groupName (no underscore rule forced)
   messages: messages/{roomId}/chats
   only load last 100 messages: orderBy(time, desc).limit(100) then reverse
   ============================ */
function openGroup(groupName){
  openRoom(groupName, groupName, false);
}
function openPrivateRoomWith(otherEmail){
  const room = [CURRENT.user.email, otherEmail].sort().join('_');
  openRoom(room, otherEmail, false);
}
function openPrivate(roomId, display){
  openRoom(roomId, display, false);
}

function openRoom(roomId, title, monitorOnly=false){
  if(OPEN[roomId]) {
    // already open, scroll to it
    return;
  }
  // create card
  const card = document.createElement('div'); card.className = 'chatCard';
  const head = document.createElement('div'); head.className='chatHead'; head.innerHTML = `<div style="font-weight:700">${title}</div><div></div>`;
  const body = document.createElement('div'); body.className='chatBody';
  const inputbar = document.createElement('div'); inputbar.className='chatInputBar';
  const textarea = document.createElement('textarea'); textarea.className='chatInput';
  const sendBtn = document.createElement('button'); sendBtn.className='sendBtn'; sendBtn.textContent='é€å‡º';
  inputbar.appendChild(textarea); inputbar.appendChild(sendBtn);

  card.appendChild(head); card.appendChild(body); card.appendChild(inputbar);
  chatGrid.prepend(card); // show newest on left/top

  // header actions
  const hdrRight = head.querySelector('div:last-child');
  if(roomId.indexOf('_') === -1){ // group -> show æˆå“¡æŒ‰éˆ•
    const membersBtn = document.createElement('button'); membersBtn.className='smallBtn'; membersBtn.textContent='æˆå“¡åå–®';
    membersBtn.onclick = ()=> openMembersModal(roomId);
    hdrRight.appendChild(membersBtn);
  } else { // private -> show block / delete
    const other = roomId.split('_').find(e=>e !== CURRENT.user.email);
    const blockBtn = document.createElement('button'); blockBtn.className='smallBtn'; blockBtn.textContent='å°é–';
    blockBtn.onclick = async ()=>{ await db.collection('users').doc(CURRENT.user.email).collection('blocks').doc(other).set({time:firebase.firestore.FieldValue.serverTimestamp()}); alert('å·²å°é– ' + other); };
    const delBtn = document.createElement('button'); delBtn.className='smallBtn'; delBtn.style.background='var(--danger)'; delBtn.textContent='åˆªé™¤å¥½å‹';
    delBtn.onclick = async ()=>{ if(!confirm('ç¢ºå®šåˆªé™¤å¥½å‹?')) return; await db.collection('users').doc(CURRENT.user.email).collection('friends').doc(other).delete().catch(()=>null); await db.collection('users').doc(other).collection('friends').doc(CURRENT.user.email).delete().catch(()=>null); alert('å·²åˆªé™¤'); };
    hdrRight.appendChild(blockBtn); hdrRight.appendChild(delBtn);
  }

  // monitorOnly => hide inputbar
  if(monitorOnly) inputbar.style.display = 'none';

  // snapshot (last 100)
  const ref = db.collection('messages').doc(roomId).collection('chats').orderBy('time','desc').limit(100);
  const unsub = ref.onSnapshot(async snap=>{
    // reverse order
    const docs = snap.docs.slice().reverse();
    body.innerHTML = '';
    // we need to check blocks for each message's sender (skip show if sender is in my blocks)
    const blocksSnap = await db.collection('users').doc(CURRENT.user.email).collection('blocks').get().catch(()=>null);
    const blocked = [];
    if(blocksSnap) blocksSnap.forEach(d=>blocked.push(d.id));
    docs.forEach(d=>{
      const data = d.data();
      if(blocked.includes(data.from)) return; // skip showing messages from blocked users
      const m = document.createElement('div'); m.className='chatMsg'; m.textContent = `${data.from}: ${data.text}`;
      body.appendChild(m);
    });
    body.scrollTop = body.scrollHeight;
  });

  // send
  sendBtn.onclick = async ()=>{
    if(!CURRENT.user) return alert('è«‹å…ˆç™»å…¥');
    const text = textarea.value.trim(); if(!text) return;
    // private send block-check: if other has blocked me, prevent sending
    if(roomId.indexOf('_') !== -1){
      const parts = roomId.split('_'); const other = parts[0] === CURRENT.user.email ? parts[1] : parts[0];
      const blockedByOther = await db.collection('users').doc(other).collection('blocks').doc(CURRENT.user.email).get().then(x=>x.exists).catch(()=>false);
      if(blockedByOther) return alert('å°æ–¹å·²å°é–ä½ ï¼Œç„¡æ³•ç™¼é€ç§è¨Š');
    }
    await db.collection('messages').doc(roomId).collection('chats').add({from:CURRENT.user.email,text, time:firebase.firestore.FieldValue.serverTimestamp()});
    textarea.value = '';
    // NOTE: trimming older messages to keep only 100 should be done by Cloud Function in production
  };

  // Enter send, Shift+Enter newline
  textarea.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
  });

  OPEN[roomId] = {unsub, card};
}

/* watch function (only highest admin) */
btnWatch.onclick = ()=>{
  if(CURRENT.role !== 'high') return alert('åªæœ‰æœ€é«˜ç®¡ç†å“¡å¯ä½¿ç”¨ç›£çœ‹');
  const v = inputWatch.value.trim();
  if(!v.includes('_')) return alert('æ ¼å¼ emailA_emailB');
  // open as monitor (read-only)
  openRoom(v, v + ' (ç›£çœ‹)', true);
};

/* announcement */
btnAnnouncement.onclick = async ()=>{
  if(CURRENT.role !== 'high') return alert('åªæœ‰æœ€é«˜ç®¡ç†å“¡å¯ç™¼å…¬å‘Š');
  const txt = announcementInput.value.trim(); if(!txt) return alert('è«‹è¼¸å…¥å…¬å‘Šå…§å®¹');
  await db.collection('announcements').add({from:CURRENT.user.email,text:txt,time:firebase.firestore.FieldValue.serverTimestamp()});
  announcementInput.value = '';
  alert('å…¬å‘Šå·²ç™¼å‡º');
};
function loadAnnouncement(){
  db.collection('announcements').orderBy('time','desc').limit(1).onSnapshot(snap=>{
    snap.forEach(d=>announcementPanel.textContent = d.data().text || '');
  });
}

/* helper loads triggered on auth */
function loadFriends(){ if(CURRENT.user) loadFriends(); }
function loadGroups(){ if(CURRENT.user) loadGroups(); }
function loadRequests(){ if(CURRENT.user) loadRequests(); }
function loadAnnouncement(){ loadAnnouncement(); }

/* bind refresh */
btnRefresh.onclick = ()=>{ loadBlocks(); loadFriends(); loadGroups(); loadRequests(); loadAnnouncement(); };

/* Also support mobile tab toggles */
document.getElementById('tabFriends')?.addEventListener('click', ()=>{ document.getElementById('leftPanel').style.display='block'; document.getElementById('rightPanel').style.display='none'; });
document.getElementById('tabGroups')?.addEventListener('click', ()=>{ document.getElementById('leftPanel').style.display='block'; document.getElementById('rightPanel').style.display='none'; });
document.getElementById('tabChats')?.addEventListener('click', ()=>{ document.getElementById('leftPanel').style.display='none'; document.getElementById('rightPanel').style.display='none'; });

/* Clean-up on unload: close snapshot listeners */
window.addEventListener('beforeunload', ()=>{
  for(const k in OPEN) try{ OPEN[k].unsub && OPEN[k].unsub(); }catch(e){}
});
</script>
</body>
</html>
