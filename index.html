<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>完整聊天系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 220px;
  background: #f2f2f2;
  padding: 10px;
  border-right: 1px solid #ccc;
  overflow-y: auto;
}

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-window {
  flex: 1;
  border: 2px solid black;
  margin: 20px;
  padding: 10px;
  overflow-y: auto;
}

.top-bar {
  height: 50px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #ccc;
}

input, button {
  padding: 6px;
  margin: 4px;
}
</style>
</head>
<body>

<!-- 左側：好友清單 / 群聊清單 -->
<div class="sidebar">
  <h3>好友清單</h3>
  <ul id="friendList"></ul>

  <h3>群聊清單</h3>
  <ul id="groupList"></ul>
</div>

<!-- 中間：聊天視窗 -->
<div class="main">
  <div class="top-bar">
    <button id="createGroupBtn">建立群聊</button>
    <span id="currentChatName">未選擇聊天室</span>
  </div>

  <div id="chatWindow" class="chat-window"></div>

  <div style="padding: 10px; border-top: 1px solid #ccc;">
    <input id="messageInput" placeholder="輸入訊息...">
    <button id="sendBtn">送出</button>
  </div>
</div>

<!-- 右側：新增好友 -->
<div class="sidebar">
  <h3>新增好友 (Gmail)</h3>
  <input id="addFriendEmail" placeholder="輸入 Gmail">
  <button id="addFriendBtn">送出邀請</button>
  <h3>邀請列表</h3>
  <ul id="inviteList"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

// Firebase 設定
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 登入（自動）
const provider = new GoogleAuthProvider();

signInWithPopup(auth, provider);

let currentUser = null;
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  currentUser = user;

  // 建立使用者資料
  await setDoc(doc(db, "users", user.uid), {
    email: user.email,
    friends: [],
    invites: []
  }, { merge: true });

  loadFriendList();
  loadInvites();
  loadGroups();
});

/* --------------------------- 新增好友 ---------------------------- */
document.getElementById("addFriendBtn").onclick = async () => {
  const email = document.getElementById("addFriendEmail").value;
  if (!email) return;

  const q = query(collection(db, "users"), where("email", "==", email));
  let target = null;
  onSnapshot(q, async (snapshot) => {
    snapshot.forEach((d) => (target = d));

    if (!target) return alert("找不到此使用者");

    await updateDoc(doc(db, "users", target.id), {
      invites: [...(target.data().invites || []), currentUser.uid]
    });

    alert("邀請已送出！");
  });
};

/* ------------------------ 讀取邀請 ------------------------- */
function loadInvites() {
  onSnapshot(doc(db, "users", currentUser.uid), (snap) => {
    const data = snap.data();
    const list = document.getElementById("inviteList");

    list.innerHTML = "";
    (data.invites || []).forEach((uid) => {
      const li = document.createElement("li");
      li.innerHTML = `${uid} <button onclick="acceptInvite('${uid}')">接受</button>`;
      list.appendChild(li);
    });
  });
}

window.acceptInvite = async (uid) => {
  const ref = doc(db, "users", currentUser.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  await updateDoc(ref, {
    friends: [...data.friends, uid],
    invites: data.invites.filter((x) => x !== uid)
  });

  alert("好友已加入！");
  loadFriendList();
};

/* ------------------------ 好友清單 ------------------------ */
function loadFriendList() {
  onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
    const listUI = document.getElementById("friendList");
    listUI.innerHTML = "";
    const data = snap.data();

    for (const uid of data.friends || []) {
      const u = await getDoc(doc(db, "users", uid));
      const li = document.createElement("li");
      li.textContent = u.data().email;
      li.onclick = () => openChat(uid);
      listUI.appendChild(li);
    }
  });
}

/* ------------------------ 聊天功能 ------------------------ */
let currentChat = null;

async function openChat(uid) {
  currentChat = uid;
  document.getElementById("currentChatName").textContent = "聊天：「" + uid + "」";

  const q = query(collection(db, "messages"), where("between", "==", getChatID(uid)));
  onSnapshot(q, (snap) => {
    const chat = document.getElementById("chatWindow");
    chat.innerHTML = "";
    snap.forEach((d) => {
      const div = document.createElement("div");
      div.textContent = `${d.data().sender}: ${d.data().text}`;
      chat.appendChild(div);
    });
  });
}

function getChatID(uid) {
  return [uid, currentUser.uid].sort().join("_");
}

document.getElementById("sendBtn").onclick = async () => {
  const msg = document.getElementById("messageInput").value;
  if (!msg || !currentChat) return;

  await addDoc(collection(db, "messages"), {
    between: getChatID(currentChat),
    sender: currentUser.email,
    text: msg,
    time: Date.now()
  });

  document.getElementById("messageInput").value = "";
};

// --- 群聊功能加入 ---
async function createGroup() {
  if (currentUser.email !== "chianghansen0302@gmail.com") {
    alert("只有管理員能建立群組！");
    return;
  }
  const name = prompt("群組名稱：");
  if (!name) return;

  const g = await addDoc(collection(db, "groups"), {
    name,
    owner: currentUser.uid,
    members: [currentUser.uid]
  });

  alert("群組建立成功");
  loadGroups();
}

document.getElementById("createGroupBtn").onclick = createGroup;

function loadGroups() {
  onSnapshot(collection(db, "groups"), (snap) => {
    const list = document.getElementById("groupList");
    list.innerHTML = "";
    snap.forEach((g) => {
      const li = document.createElement("li");
      li.textContent = g.data().name;
      li.onclick = () => openGroup(g.id);
      list.appendChild(li);
    });
  });
}

let currentGroup = null;
function openGroup(gid) {
  currentGroup = gid;
  currentChat = null;
  document.getElementById("currentChatName").textContent = "群聊：" + gid;

  const msgRef = collection(db, "groups", gid, "messages");
  const q = query(msgRef, where("time", ">", 0));
  onSnapshot(q, (snap) => {
    const chat = document.getElementById("chatWindow");
    chat.innerHTML = "";

    const msgs = [];
    snap.forEach((d) => msgs.push(d.data()));
    msgs.sort((a,b)=>a.time - b.time);

    msgs.forEach((d) => {
      const div = document.createElement("div");
      div.textContent = `${d.sender}: ${d.text}`;
      chat.appendChild(div);
    });
  });
}

// 修正訊息排序 + 送出
const sendBtn = document.getElementById("sendBtn");
sendBtn.onclick = async () => {
  const msg = document.getElementById("messageInput").value;
  if (!msg) return;

  if (currentGroup) {
    await addDoc(collection(db, "groups", currentGroup, "messages"), {
      sender: currentUser.email,
      text: msg,
      time: Date.now()
    });
  } else if (currentChat) {
    await addDoc(collection(db, "messages"), {
      between: getChatID(currentChat),
      sender: currentUser.email,
      text: msg,
      time: Date.now()
    });
  }

  document.getElementById("messageInput").value = "";
};

</script>
</body>
</html>
