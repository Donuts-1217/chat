<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>🔥 即時聊天室</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:"Noto Sans TC",sans-serif; margin:0; background:#2f3136; color:#dcddde; }
#container { display:flex; width:95%; max-width:1400px; margin:20px auto; height:80vh; background:#36393f; border-radius:8px; overflow:hidden; }
.sidebar, .rightbar { width:250px; padding:10px; background:#2f3136; display:flex; flex-direction:column; border-right:1px solid #202225; }
.rightbar { border-left:1px solid #202225; }
.sidebar h3, .rightbar h3 { margin:10px 0 5px 0; font-size:14px; color:#b9bbbe; }
ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; background:#202225; border-radius:6px; }
li { padding:8px; cursor:pointer; border-bottom:1px solid #292b2f; transition:0.2s; color:#dcddde; }
li:hover { background:#40444b; font-weight:500; }
button { padding:6px; margin:4px 0; border-radius:6px; border:none; cursor:pointer; font-size:13px; }
#loginBtn { background:#7289da; color:white; font-weight:500; }
#logoutBtn { background:#f04747; color:white; font-weight:500; }
.chat-area { flex:1; padding:10px; display:flex; flex-wrap:wrap; gap:10px; overflow-x:auto; background:#36393f; }
.chat-window { width:300px; min-width:300px; max-height:90%; background:#40444b; border-radius:6px; display:flex; flex-direction:column; overflow:hidden; }
.chat-header { background:#5865f2; color:white; padding:6px 8px; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
.chat-header button { background:#f04747; font-size:12px; padding:2px 6px; border-radius:4px; }
.chat-messages { flex:1; overflow-y:auto; padding:6px; background:#2f3136; }
.msg { margin:3px 0; padding:4px 8px; border-radius:6px; background:#5865f2; font-size:12px; word-break:break-word; }
.chat-input { display:flex; border-top:1px solid #292b2f; }
.chat-input input { flex:1; padding:4px 6px; border:none; outline:none; font-size:12px; background:#40444b; color:#dcddde; border-radius:0; }
.chat-input button { padding:4px 10px; background:#43b581; color:white; border:none; cursor:pointer; font-weight:500; }
.request-btn { padding:2px 4px; margin-left:4px; border-radius:4px; font-size:11px; }
#watchBtn { position:fixed; bottom:20px; right:20px; background:#faa61a; color:black; font-weight:600; padding:8px 10px; border-radius:6px; cursor:pointer; display:none; }
</style>
</head>
<body>

<div id="container">
  <div class="sidebar">
    <button id="loginBtn">使用 Google 登入</button>
    <button id="logoutBtn" style="display:none;">登出</button>
    <p>👋 歡迎，<span id="user"></span></p>
    <h3>好友清單</h3>
    <ul id="friendList"></ul>
    <h3>群組清單</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="群聊名稱">
    <button id="createGroupBtn">建立群組</button>
  </div>

  <div class="chat-area" id="chatArea"></div>

  <div class="rightbar">
    <h3>新增好友</h3>
    <input id="addFriendEmail" placeholder="輸入 Gmail">
    <button id="addFriendBtn">送出好友請求</button>
    <h3>好友請求</h3>
    <ul id="requestList"></ul>
  </div>
</div>

<button id="watchBtn">監看私聊</button>

<script>
// Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userSpan = document.getElementById("user");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupName = document.getElementById("newGroupName");
const chatArea = document.getElementById("chatArea");
const requestList = document.getElementById("requestList");
const watchBtn = document.getElementById("watchBtn");

let userEmail = "";
let userRole = "user"; // user, lowAdmin, highAdmin
let chatWindows = {};

// 權限判斷
function setRole(email){
  if(email==="chianghansen0302@gmail.com") userRole="highAdmin";
  else db.collection("admins").doc(email).get().then(doc=>{
    userRole = doc.exists && doc.data().level==="low" ? "lowAdmin" : "user";
    if(userRole==="highAdmin") watchBtn.style.display="block";
  });
  if(email==="chianghansen0302@gmail.com") watchBtn.style.display="block";
}

// 登入登出
loginBtn.onclick = async ()=>{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  chatWindows={};
  chatArea.innerHTML="";
  friendList.innerHTML="";
  groupList.innerHTML="";
  requestList.innerHTML="";
  watchBtn.style.display="none";
}

auth.onAuthStateChanged(async user=>{
  if(user){
    userEmail = user.email;
    userSpan.textContent = `${user.displayName} (${userEmail})`;
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    await db.collection("users").doc(userEmail).set({name:user.displayName,email:userEmail},{merge:true});
    setRole(userEmail);
    loadFriends();
    loadGroups();
    loadRequests();
  }
});

// 好友清單
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.data().email;
      li.onclick = ()=>openChatWindow([userEmail,doc.data().email].sort().join("_"), doc.data().email, false);
      friendList.appendChild(li);
    });
  });
}

// 群組清單
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.id;
      li.onclick = ()=>openChatWindow(doc.id, doc.id, true);
      groupList.appendChild(li);
    });
  });
}

// 送出好友請求
addFriendBtn.onclick = async ()=>{
  const email = addFriendEmail.value.trim();
  if(!email) return alert("請輸入好友 Gmail");
  if(email === userEmail) return alert("不能加自己");
  try{
    await db.collection("users").doc(email).set({email},{merge:true});
    await db.collection("users").doc(email).collection("requests").add({
      from: userEmail,
      status: "pending",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("好友請求已送出！");
    addFriendEmail.value="";
  }catch(err){
    alert("送出好友請求失敗："+err.message);
  }
};

// 加載好友請求
function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests")
    .where("status","==","pending")
    .onSnapshot(snap=>{
      requestList.innerHTML="";
      snap.forEach(doc=>{
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.from} 想加你為好友`;
        const acceptBtn = document.createElement("button");
        acceptBtn.textContent="同意";
        acceptBtn.className="request-btn";
        acceptBtn.onclick = async ()=>{
          await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
          await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
          await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
        };
        const rejectBtn = document.createElement("button");
        rejectBtn.textContent="拒絕";
        rejectBtn.className="request-btn";
        rejectBtn.onclick = async ()=>{
          await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"rejected"});
        };
        li.appendChild(acceptBtn);
        li.appendChild(rejectBtn);
        requestList.appendChild(li);
      });
    });
}

// 建立群組
createGroupBtn.onclick=async ()=>{
  if(userRole==="user") return alert("權限不足");
  const name=newGroupName.value.trim();
  if(!name)return alert("請輸入群聊名稱");
  await db.collection("groups").doc(name).set({createdBy:userEmail});
  newGroupName.value="";
}

// 開啟聊天窗
function openChatWindow(roomId, title, isGroup){
  if(chatWindows[roomId]) return;
  const win = document.createElement("div");
  win.className="chat-window";
  win.id="win_"+roomId;

  const header = document.createElement("div");
  header.className="chat-header";
  header.innerHTML = `<span>${title}</span><button>X</button>`;
  win.appendChild(header);

  const msgDiv = document.createElement("div");
  msgDiv.className="chat-messages";
  win.appendChild(msgDiv);

  const inputDiv = document.createElement("div");
  inputDiv.className="chat-input";
  const input = document.createElement("input");
  input.placeholder="輸入訊息...";
  const btn = document.createElement("button");
  btn.textContent="送出";
  inputDiv.appendChild(input);
  inputDiv.appendChild(btn);
  win.appendChild(inputDiv);

  chatArea.appendChild(win);

  header.querySelector("button").onclick=()=>{
    if(chatWindows[roomId]) chatWindows[roomId]();
    chatArea.removeChild(win);
    delete chatWindows[roomId];
  }

  const unsub=db.collection("messages").doc(roomId).collection("chats").orderBy("time")
    .onSnapshot(snap=>{
      msgDiv.innerHTML="";
      snap.forEach(doc=>{
        const d=doc.data();
        const div=document.createElement("div");
        div.className="msg";
        div.textContent=`${d.from}: ${d.text}`;
        msgDiv.appendChild(div);
      });
      msgDiv.scrollTop=msgDiv.scrollHeight;
    });

  chatWindows[roomId]=unsub;

  // Enter 發送, Shift+Enter 換行
  input.addEventListener("keydown", async (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      btn.click();
    }
  });

  btn.onclick=async ()=>{
    const text=input.value.trim();
    if(!text) return;
    // 私聊雙方可讀
    if(!isGroup){
      const chatId = [userEmail,title].sort().join("_");
      await db.collection("messages").doc(chatId).collection("chats").add({
        from:userEmail,
        text,
        time:firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      await db.collection("messages").doc(roomId).collection("chats").add({
        from:userEmail,
        text,
        time:firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    input.value="";
  }
}

// 最高管理員監看私聊
watchBtn.onclick=()=>{
  const target = prompt("輸入想監看的私聊對象 Gmail:");
  if(!target) return;
  const chatId = [userEmail,target].sort().join("_");
  openChatWindow(chatId, `監看 ${target}`, false);
}
</script>
</body>
</html>
