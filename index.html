<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat App</title>
<style>
body { margin:0; font-family:Arial; display:flex; height:100vh; }
#sidebar { width:250px; background:#1e1f22; color:white; padding:10px; }
#chat { flex:1; background:#f2f2f2; display:flex; flex-direction:column; }
#messages { flex:1; overflow-y:auto; padding:10px; }
#inputBar { display:flex; }
#inputBar input { flex:1; padding:10px; }
#inputBar button { padding:10px; }
.friend { padding:5px; cursor:pointer; background:#2d2f32; margin-bottom:5px; }
.friend:hover { background:#3b3d40; }
.chatroom { padding:5px; cursor:pointer; background:#292a2d; margin-bottom:5px; }
.chatroom:hover { background:#35363a; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <h3>聊天室</h3>
  <button id="googleLogin">Google 登入</button>
  <hr />

  <h4>群組</h4>
  <div id="groupList"></div>

  <h4>好友 / 私訊</h4>
  <div id="friendList"></div>

  <button id="addFriendBtn">➕ 新增好友</button>
</div>

<!-- CHAT AREA -->
<div id="chat">
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="輸入訊息..." />
    <button id="sendBtn">送出</button>
  </div>
</div>

<script type="module">
// ----------------------
// Firebase 初始化
// ----------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, addDoc, collection, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentRoomId = null;

// -----------------
// Google 登入
// -----------------
document.getElementById("googleLogin").onclick = async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  currentUser = user;

  // create user doc if not exists
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    await setDoc(ref, {
      email: user.email,
      friends: [],
      friendRequests: [],
    });
  }

  loadGroups();
  loadFriends();
});

// -----------------
// 群組（只有管理員能建立）
// -----------------
async function loadGroups() {
  const groupList = document.getElementById("groupList");
  groupList.innerHTML = "";

  const q = query(collection(db, "groups"));
  onSnapshot(q, (snap) => {
    groupList.innerHTML = "";
    snap.forEach((docu) => {
      const div = document.createElement("div");
      div.className = "chatroom";
      div.innerText = docu.data().name;
      div.onclick = () => openRoom(docu.id);
      groupList.appendChild(div);
    });
  });
}

// -----------------
// 好友系統：發送申請 + 同意
// -----------------
document.getElementById("addFriendBtn").onclick = async () => {
  const email = prompt("輸入好友 Email:");
  if (!email) return;

  // 找 email
  const q = query(collection(db, "users"), where("email", "==", email));
  const snap = await getDocs(q);
  if (snap.empty) return alert("找不到此用戶");

  const friendId = snap.docs[0].id;

  await updateDoc(doc(db, "users", friendId), {
    friendRequests: arrayUnion(currentUser.uid)
  });

  alert("已送出好友邀請");
};

async function loadFriends() {
  const ref = doc(db, "users", currentUser.uid);
  onSnapshot(ref, (snap) => {
    const data = snap.data();
    const friendList = document.getElementById("friendList");
    friendList.innerHTML = "";

    data.friends.forEach(friendId => {
      const div = document.createElement("div");
      div.className = "friend";
      div.innerText = friendId;
      div.onclick = () => openDM(friendId);
      friendList.appendChild(div);
    });
  });
}

// -----------------
// 開啟房間 / 私訊
// -----------------
function openDM(friendId) {
  const roomId = [currentUser.uid, friendId].sort().join("_");
  openRoom(roomId);
}

function openRoom(roomId) {
  currentRoomId = roomId;
  listenMessages();
}

// -----------------
// 訊息系統
// -----------------
function listenMessages() {
  const msgBox = document.getElementById("messages");
  msgBox.innerHTML = "";

  const q = query(collection(db, "rooms", currentRoomId, "messages"), orderBy("time"));
  onSnapshot(q, (snap) => {
    msgBox.innerHTML = "";
    snap.forEach((m) => {
      const div = document.createElement("div");
      div.innerText = m.data().user + ": " + m.data().text;
      msgBox.appendChild(div);
    });
  });
}

document.getElementById("sendBtn").onclick = async () => {
  if (!currentRoomId) return;
  const text = document.getElementById("msgInput").value;
  document.getElementById("msgInput").value = "";

  await addDoc(collection(db, "rooms", currentRoomId, "messages"), {
    user: currentUser.email,
    text,
    time: Date.now(),
  });
};

</script>
</body>
</html>