<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Chat Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:"微軟正黑體"; display:flex; justify-content:center; align-items:center; height:100vh; background:#f2f5fa; }
button { padding:10px 20px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>

<button id="googleSignIn">使用 Google 登入</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// 檢查是否已登入
onAuthStateChanged(auth,user=>{
  if(user) window.location.href="chat.html";
});

// 登入
document.getElementById("googleSignIn").onclick = async () => {
  const result = await signInWithPopup(auth, provider);
  const user = result.user;

  // 新增或更新 Firestore Users
  const userRef = doc(db,"Users",user.uid);
  const userSnap = await getDoc(userRef);
  if(!userSnap.exists()){
    await setDoc(userRef,{
      email: user.email,
      name: user.displayName,
      nickname: user.displayName,
      role:"general",
      friends:[],
      groups:[],
      stickyNote:""
    });
  }

  // 登入成功跳轉聊天頁
  window.location.href = "chat.html";
};
</script>

</body>
</html>
