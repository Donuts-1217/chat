<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ”¥ å®Œæ•´èŠå¤©å®¤ (å¥½å‹/å°é–/ç¾¤çµ„/ç›£çœ‹)</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  /* åŸºæœ¬æ¨£å¼ï¼ˆDiscord-likeï¼‰*/
  :root{--bg:#2f3136;--panel:#36393f;--accent:#5865F2;--muted:#99aab5;--card:#fff}
  *{box-sizing:border-box;font-family:"Noto Sans TC",sans-serif}
  body{margin:0;background:linear-gradient(180deg,#f0f2f5,#eef3fb);color:#222}
  /* Login */
  #loginPage{height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column}
  #loginPage h1{margin-bottom:12px}
  #loginBtn{padding:10px 18px;background:#4285F4;color:white;border:none;border-radius:8px;cursor:pointer}

  /* App container */
  #app{display:none;max-width:1400px;margin:18px auto;height:86vh;background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
  header{height:64px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid #e6eef9}
  header h2{margin:0}
  .main{display:flex;height:calc(100% - 64px)}

  /* å·¦å´ */
  .left{width:300px;background:#f7fafc;padding:12px;border-right:1px solid #e6eef9;display:flex;flex-direction:column}
  .left .me{margin-bottom:8px}
  .left h4{margin:8px 0 6px 0}
  .list{flex:1;background:#fff;border-radius:8px;border:1px solid #e6eef9;overflow:auto;padding:6px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer}
  .item:hover{background:#e8f2ff}

  /* ä¸­é–“ */
  .center{flex:1;padding:12px;display:flex;flex-wrap:wrap;gap:12px;overflow:auto;background:#f1f5f9}
  .chat{width:360px;min-width:280px;background:#fff;border-radius:10px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .chat .head{background:var(--accent);color:white;padding:10px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center}
  .chat .messages{padding:12px;flex:1;overflow:auto;background:#fbfdff}
  .bubble{background:#e6f0ff;padding:8px;border-radius:8px;margin-bottom:8px}
  .chat .input{display:flex;padding:8px;border-top:1px solid #eee}
  .chat .input textarea{flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;resize:none;height:64px}
  .chat .input button{margin-left:8px;padding:8px 12px;background:#2ecc71;color:#fff;border:none;border-radius:6px;cursor:pointer}

  /* å³å´ */
  .right{width:300px;background:#f7fafc;padding:12px;border-left:1px solid #e6eef9;display:flex;flex-direction:column}
  .section{margin-bottom:12px}
  .member-btn{padding:6px 8px;border-radius:6px;border:none;background:#5865F2;color:#fff;cursor:pointer;margin-left:6px}
  .danger{background:#f44336}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
  .modal .box{width:90%;max-width:720px;background:#fff;padding:16px;border-radius:8px}

  /* responsive */
  @media(max-width:980px){
    .left,.right{display:none}
    .center{padding:8px}
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <h1>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
  <p style="margin-top:8px;color:#666">è«‹ç¢ºä¿ Firestore è¦å‰‡å·²è²¼ä¸Šï¼ˆåŠ©æ‰‹çµ¦çš„é‚£æ®µï¼‰</p>
</div>

<!-- APP -->
<div id="app">
  <header>
    <h2>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</h2>
    <div>
      <span id="meName"></span>
      <button id="logoutBtn" style="margin-left:12px;padding:8px 10px;background:#f44336;color:#fff;border:none;border-radius:6px;cursor:pointer">ç™»å‡º</button>
    </div>
  </header>

  <div class="main">
    <!-- left -->
    <div class="left">
      <div class="me">
        <div style="font-weight:700" id="meDisplay"></div>
        <div style="color:#666;font-size:13px" id="meEmail"></div>
      </div>

      <div class="section">
        <h4>å¥½å‹</h4>
        <div class="list" id="friendList"></div>
        <div style="display:flex;margin-top:8px;gap:8px">
          <input id="friendEmail" placeholder="è¼¸å…¥ Gmail" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd">
          <button id="sendReqBtn" style="padding:8px 10px;background:#4285F4;color:#fff;border:none;border-radius:6px">é€å‡º</button>
        </div>
      </div>

      <div class="section">
        <h4>ç¾¤çµ„</h4>
        <div class="list" id="groupList"></div>
        <div style="display:flex;margin-top:8px;gap:8px">
          <input id="groupName" placeholder="ç¾¤çµ„åç¨±" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd">
          <button id="createGroupBtn" style="padding:8px;background:#5865F2;color:white;border:none;border-radius:6px">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- center -->
    <div class="center" id="center"></div>

    <!-- right -->
    <div class="right">
      <div class="section">
        <h4>å¥½å‹è«‹æ±‚</h4>
        <div class="list" id="requestList"></div>
      </div>

      <div class="section">
        <h4>å°é–æ¸…å–®</h4>
        <div class="list" id="blockedList"></div>
      </div>

      <div class="section">
        <h4>ç›£çœ‹ï¼ˆæœ€é«˜ç®¡ç†å“¡ï¼‰</h4>
        <input id="watchInput" placeholder="emailA_emailB" style="padding:8px;border-radius:6px;border:1px solid #ddd">
        <button id="watchBtn" style="padding:8px;margin-top:6px;background:#ff9800;color:#fff;border:none;border-radius:6px">ç›£çœ‹</button>
      </div>
    </div>
  </div>
</div>

<!-- modal: members -->
<div id="modal" class="modal"><div class="box">
  <h3 id="modalTitle">æˆå“¡</h3>
  <div id="modalBody" style="max-height:300px;overflow:auto;margin-top:8px"></div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <input id="modalAddEmail" placeholder="è¼¸å…¥ Gmail åŠ å…¥" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px">
    <button id="modalAddBtn" class="member-btn">åŠ å…¥</button>
    <button id="modalClose" style="padding:8px;border-radius:6px">é—œé–‰</button>
  </div>
</div></div>

<script>
/* ========== CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========== STATE ========== */
let ME = null;
let ME_EMAIL = "";
let ME_NAME = "";
let isSuperAdmin = false;
let unsubscribers = {}; // keep unsub functions to avoid duplicate listeners
let blockedSet = new Set();

/* ========== DOM ========== */
const loginPage = document.getElementById('loginPage');
const appDiv = document.getElementById('app');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const meNameEl = document.getElementById('meDisplay');
const meEmailEl = document.getElementById('meEmail');
const friendListEl = document.getElementById('friendList');
const groupListEl = document.getElementById('groupList');
const centerEl = document.getElementById('center');
const requestListEl = document.getElementById('requestList');
const blockedListEl = document.getElementById('blockedList');

const friendEmailInput = document.getElementById('friendEmail');
const sendReqBtn = document.getElementById('sendReqBtn');
const groupNameInput = document.getElementById('groupName');
const createGroupBtn = document.getElementById('createGroupBtn');

const watchInput = document.getElementById('watchInput');
const watchBtn = document.getElementById('watchBtn');

/* modal */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalAddEmail = document.getElementById('modalAddEmail');
const modalAddBtn = document.getElementById('modalAddBtn');
const modalClose = document.getElementById('modalClose');

/* ========== AUTH ========== */
loginBtn.onclick = async () => {
  try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  catch(e){ alert('ç™»å…¥éŒ¯èª¤ï¼š'+e.message); console.error(e); }
};
logoutBtn.onclick = async () => {
  await auth.signOut();
  // clear local
  ME = null;
  ME_EMAIL = "";
  ME_NAME = "";
  blockedSet.clear();
  // detach listeners
  Object.values(unsubscribers).forEach(u=>u && u());
  unsubscribers = {};
  // UI
  centerEl.innerHTML = '';
  friendListEl.innerHTML = '';
  groupListEl.innerHTML = '';
  requestListEl.innerHTML = '';
  blockedListEl.innerHTML = '';
  loginPage.style.display = 'block';
  appDiv.style.display = 'none';
};

auth.onAuthStateChanged(async user => {
  if(!user){ loginPage.style.display='block'; appDiv.style.display='none'; return; }
  ME = user;
  ME_EMAIL = user.email;
  ME_NAME = user.displayName || user.email.split('@')[0];
  meNameEl.textContent = ME_NAME;
  meEmailEl.textContent = ME_EMAIL;
  isSuperAdmin = (ME_EMAIL === 'chianghansen0302@gmail.com');

  // ensure user doc
  await db.collection('users').doc(ME_EMAIL).set({name:ME_NAME,email:ME_EMAIL},{merge:true});

  // UI
  loginPage.style.display = 'none';
  appDiv.style.display = 'block';

  // load data (set up snapshot listeners, but ensure only one listener per collection)
  setupListeners();
});

/* ========== LISTENERS SETUP ========== */
function setupListeners(){
  // friends
  if(!unsubscribers.friends){
    unsubscribers.friends = db.collection('users').doc(ME_EMAIL).collection('friends')
      .onSnapshot(snap => renderFriends(snap));
  }

  // incoming requests (as recipient)
  if(!unsubscribers.requestsIn){
    unsubscribers.requestsIn = db.collection('users').doc(ME_EMAIL).collection('requests')
      .where('status','==','pending')
      .onSnapshot(snap => renderRequestsIn(snap));
  }

  // outgoing requests (as sender) - to detect accepted and then create friend entry locally
  if(!unsubscribers.requestsOut){
    unsubscribers.requestsOut = db.collectionGroup('requests')
      .where('from','==', ME_EMAIL)
      .onSnapshot(snap => handleOutgoingRequests(snap));
  }

  // blocked list
  if(!unsubscribers.blocked){
    unsubscribers.blocked = db.collection('users').doc(ME_EMAIL).collection('blocked')
      .onSnapshot(snap => renderBlocked(snap));
  }

  // groups
  if(!unsubscribers.groups){
    unsubscribers.groups = db.collection('groups').onSnapshot(snap => renderGroups(snap));
  }
}

/* ========== FRIENDS ========== */
function renderFriends(snap){
  friendListEl.innerHTML = '';
  snap.forEach(doc=>{
    const fEmail = doc.id; // we store doc.id == friend's email
    const fData = doc.data();
    const div = document.createElement('div'); div.className='item';
    const left = document.createElement('div'); left.textContent = fEmail;
    const right = document.createElement('div');

    // Chat button
    const chatBtn = document.createElement('button'); chatBtn.textContent='èŠå¤©'; chatBtn.className='member-btn';
    chatBtn.onclick = (e)=>{ e.stopPropagation(); openChatWindow([ME_EMAIL,fEmail].sort().join('_'), fEmail); };

    // Delete friend
    const delBtn = document.createElement('button'); delBtn.textContent='åˆªé™¤'; delBtn.className='member-btn danger';
    delBtn.onclick = async (e)=>{ e.stopPropagation();
      if(!confirm('ç¢ºå®šåˆªé™¤å¥½å‹ï¼Ÿ')) return;
      await db.collection('users').doc(ME_EMAIL).collection('friends').doc(fEmail).delete().catch(()=>null);
      // we do NOT force-delete other's friend doc; their client may remove or keep
    };

    // Block friend
    const blockBtn = document.createElement('button'); blockBtn.textContent='å°é–'; blockBtn.className='member-btn';
    blockBtn.onclick = async (e)=>{ e.stopPropagation();
      await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(fEmail).set({email:fEmail, time: firebase.firestore.FieldValue.serverTimestamp()});
      alert('å·²å°é– '+fEmail);
    };

    right.appendChild(chatBtn); right.appendChild(delBtn); right.appendChild(blockBtn);

    div.appendChild(left); div.appendChild(right);
    div.onclick = ()=> openChatWindow([ME_EMAIL,fEmail].sort().join('_'), fEmail);
    friendListEl.appendChild(div);
  });
}

/* ========== REQUESTS ========== */
sendReqBtn && sendReqBtn.onclick && (sendReqBtn.onclick = async ()=>{
  const email = friendEmailInput.value.trim() || document.getElementById('friendEmail').value.trim();
  const inputVal = document.getElementById('friendEmail').value.trim();
  const target = inputVal;
  if(!target) return alert('è«‹è¼¸å…¥å°æ–¹ Gmail');
  if(target === ME_EMAIL) return alert('ä¸èƒ½åŠ è‡ªå·±');
  try{
    // ensure user doc exists
    await db.collection('users').doc(target).set({email:target},{merge:true});
    // create request inside target's requests
    await db.collection('users').doc(target).collection('requests').add({
      from: ME_EMAIL,
      status: 'pending',
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('friendEmail').value = '';
    alert('å¥½å‹è«‹æ±‚å·²é€å‡º');
  }catch(e){ alert('é€å‡ºå¤±æ•—: '+e.message); console.error(e); }
});

function renderRequestsIn(snap){
  requestListEl.innerHTML = '';
  snap.forEach(doc=>{
    const data = doc.data();
    const id = doc.id;
    const div = document.createElement('div'); div.className='item';
    div.textContent = data.from;
    const right = document.createElement('div');

    const accept = document.createElement('button'); accept.textContent='åŒæ„'; accept.className='member-btn';
    accept.onclick = async (e)=>{ e.stopPropagation();
      // add to my friends
      await db.collection('users').doc(ME_EMAIL).collection('friends').doc(data.from).set({email:data.from});
      // update request status
      await db.collection('users').doc(ME_EMAIL).collection('requests').doc(id).update({status:'accepted', acceptedAt: firebase.firestore.FieldValue.serverTimestamp()});
      alert('å·²æ¥å—ï¼Œå°æ–¹è‹¥åœ¨ç·šæœƒè‡ªå‹•æ–°å¢å¥½å‹');
    };

    const reject = document.createElement('button'); reject.textContent='æ‹’çµ•'; reject.className='member-btn danger';
    reject.onclick = async (e)=>{ e.stopPropagation();
      await db.collection('users').doc(ME_EMAIL).collection('requests').doc(id).update({status:'rejected'});
    };

    right.appendChild(accept); right.appendChild(reject);
    div.appendChild(right);
    requestListEl.appendChild(div);
  });
}

/* handle outgoing requests changes: when recipient accepted, this user (as sender) will see status update and auto-add friend entry for self */
function handleOutgoingRequests(snap){
  snap.forEach(async doc=>{
    const data = doc.data();
    // doc.path like users/{recipient}/requests/{id}. We want to add friend for the original sender (ME) if status became 'accepted'
    if(data.from === ME_EMAIL && data.status === 'accepted'){
      const recipient = doc.ref.path.split('/')[1]; // users/{recipient}
      // add recipient to my friends
      await db.collection('users').doc(ME_EMAIL).collection('friends').doc(recipient).set({email:recipient}).catch(()=>null);
      // optionally delete the request doc or leave it
      // doc.ref.delete().catch(()=>null);
      console.log('å¥½å‹è«‹æ±‚å·²è¢«æ¥å—ï¼Œå·²åŠ å…¥:', recipient);
    }
  });
}

/* ========== BLOCKED ========== */
function renderBlocked(snap){
  blockedListEl.innerHTML = '';
  blockedSet.clear();
  snap.forEach(doc=>{
    const bEmail = doc.data().email || doc.id;
    blockedSet.add(bEmail);
    const div = document.createElement('div'); div.className='item';
    div.textContent = bEmail;
    const unb = document.createElement('button'); unb.textContent='è§£é™¤å°é–'; unb.className='member-btn';
    unb.onclick = async (e)=>{ e.stopPropagation();
      await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(bEmail).delete().catch(()=>null);
    };
    div.appendChild(unb);
    blockedListEl.appendChild(div);
  });
}

/* ========== GROUPS ========== */
function renderGroups(snap){
  groupListEl.innerHTML = '';
  snap.forEach(doc=>{
    const name = doc.id;
    const div = document.createElement('div'); div.className='item';
    const left = document.createElement('div'); left.textContent = name;
    const right = document.createElement('div');
    const openBtn = document.createElement('button'); openBtn.textContent='é–‹å•Ÿ'; openBtn.className='member-btn';
    openBtn.onclick = (e)=>{ e.stopPropagation(); openChatWindow(name, name); };
    const membersBtn = document.createElement('button'); membersBtn.textContent='æˆå“¡'; membersBtn.className='member-btn';
    membersBtn.onclick = (e)=>{ e.stopPropagation(); openMembersModal(name); };
    right.appendChild(openBtn); right.appendChild(membersBtn);
    div.appendChild(left); div.appendChild(right);
    groupListEl.appendChild(div);
  });
}

createGroupBtn && (createGroupBtn.onclick = async ()=>{
  const name = groupNameInput ? groupNameInput.value.trim() : groupName.value.trim();
  const groupNameVal = document.getElementById('groupName') ? document.getElementById('groupName').value.trim() : groupName;
  const gname = groupNameVal || '';
  if(!gname) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
  // create group doc with members and admins arrays
  await db.collection('groups').doc(gname).set({createdBy: ME_EMAIL, members:[ME_EMAIL], admins:[ME_EMAIL], createdAt: firebase.firestore.FieldValue.serverTimestamp()});
  document.getElementById('groupName').value = '';
  alert('å·²å»ºç«‹ç¾¤çµ„ï¼š'+gname);
});

/* modal for group members */
let currentModalGroup = null;
function openMembersModal(groupId){
  currentModalGroup = groupId;
  modal.style.display = 'flex';
  modalTitle.textContent = 'ç¾¤çµ„æˆå“¡: '+groupId;
  modalBody.innerHTML = '<div class="small" style="color:#666">è¼‰å…¥ä¸­...</div>';
  // load group doc
  db.collection('groups').doc(groupId).get().then(doc=>{
    if(!doc.exists){ modalBody.innerHTML = '<div>æ‰¾ä¸åˆ°è©²ç¾¤çµ„</div>'; return; }
    const data = doc.data();
    const members = data.members || [];
    const admins = data.admins || [];
    modalBody.innerHTML = '';
    members.forEach(m=>{
      const row = document.createElement('div'); row.className='item';
      const left = document.createElement('div'); left.textContent = m + (admins.includes(m)?' (ç®¡ç†å“¡)':'');
      const right = document.createElement('div');
      // if I am admin or super admin, show kick/add
      const amIAdmin = (admins.includes(ME_EMAIL) || isSuperAdmin || data.createdBy === ME_EMAIL);
      if(amIAdmin && m !== ME_EMAIL){
        const kick = document.createElement('button'); kick.textContent='è¸¢å‡º'; kick.className='member-btn danger';
        kick.onclick = async ()=> {
          if(!confirm('ç¢ºå®šè¸¢å‡º '+m+'ï¼Ÿ')) return;
          await db.collection('groups').doc(groupId).update({members: firebase.firestore.FieldValue.arrayRemove(m)});
          alert('å·²è¸¢å‡º '+m);
          openMembersModal(groupId); // refresh
        };
        right.appendChild(kick);
      }
      // allow member to leave
      if(m === ME_EMAIL){
        const leave = document.createElement('button'); leave.textContent='é€€å‡º'; leave.className='member-btn';
        leave.onclick = async ()=> {
          if(!confirm('ç¢ºå®šé€€å‡ºç¾¤çµ„ï¼Ÿ')) return;
          await db.collection('groups').doc(groupId).update({members: firebase.firestore.FieldValue.arrayRemove(ME_EMAIL)});
          modal.style.display='none';
        };
        right.appendChild(leave);
      }
      row.appendChild(left); row.appendChild(right);
      modalBody.appendChild(row);
    });
  }).catch(e=>{ modalBody.innerHTML = '<div>è¼‰å…¥å¤±æ•—</div>'; console.error(e); });
}

modalClose.onclick = ()=>{ modal.style.display='none'; currentModalGroup = null; };
modalAddBtn.onclick = async ()=>{
  const email = modalAddEmail.value.trim();
  if(!email) return alert('è«‹è¼¸å…¥ Gmail');
  if(!currentModalGroup) return alert('ç„¡é¸æ“‡ç¾¤çµ„');
  const gdoc = await db.collection('groups').doc(currentModalGroup).get();
  if(!gdoc.exists) return alert('æ‰¾ä¸åˆ°ç¾¤çµ„');
  const data = gdoc.data();
  const admins = data.admins || [];
  const canAdd = admins.includes(ME_EMAIL) || isSuperAdmin || data.createdBy === ME_EMAIL;
  if(!canAdd) return alert('æ‚¨æ²’æœ‰æ¬Šé™åŠ å…¥æˆå“¡ï¼ˆç¾¤çµ„ç®¡ç†å“¡å¯åŠ å…¥ï¼‰');
  await db.collection('groups').doc(currentModalGroup).update({members: firebase.firestore.FieldValue.arrayUnion(email)});
  modalAddEmail.value = '';
  openMembersModal(currentModalGroup); // refresh
  alert('å·²åŠ å…¥ '+email);
};

/* ========== CHAT WINDOW ========== */
const openChats = {}; // roomId -> {unsub, el}

function openChatWindow(roomId, title, readonly=false){
  if(openChats[roomId]) return;
  // create DOM
  const chat = document.createElement('div'); chat.className='chat';
  const head = document.createElement('div'); head.className='head'; head.innerHTML = `<div>${title}</div><div><button class="member-btn">é—œé–‰</button></div>`;
  const msgs = document.createElement('div'); msgs.className='messages';
  const inputWrap = document.createElement('div'); inputWrap.className='input';
  const ta = document.createElement('textarea'); ta.placeholder='è¼¸å…¥è¨Šæ¯...';
  const send = document.createElement('button'); send.textContent='é€å‡º';
  inputWrap.appendChild(ta); inputWrap.appendChild(send);
  chat.appendChild(head); chat.appendChild(msgs); chat.appendChild(inputWrap);
  centerEl.prepend(chat);

  head.querySelector('button').onclick = ()=>{ chat.remove(); if(openChats[roomId] && openChats[roomId].unsub) openChats[roomId].unsub(); delete openChats[roomId]; };

  // read last 100 (order desc then reverse)
  const ref = db.collection('messages').doc(roomId).collection('chats').orderBy('time','desc').limit(100);
  const unsub = ref.onSnapshot(snap=>{
    msgs.innerHTML = '';
    const docs = snap.docs.slice().reverse();
    docs.forEach(d=>{
      const v = d.data();
      // skip messages from blocked users for me
      if(blockedSet.has(v.from)) return;
      const b = document.createElement('div'); b.className='bubble'; b.textContent = `${v.from}: ${v.text}`;
      msgs.appendChild(b);
    });
    msgs.scrollTop = msgs.scrollHeight;
  }, err=>{
    console.error('snapshot err', err);
    const errDiv = document.createElement('div'); errDiv.textContent = 'è¼‰å…¥èŠå¤©å¤±æ•—ï¼ˆæ¬Šé™æˆ–ç¶²è·¯ï¼‰';
    msgs.innerHTML = ''; msgs.appendChild(errDiv);
  });

  openChats[roomId] = {unsub, el:chat};

  // sending
  send.onclick = async ()=>{
    const text = ta.value.trim();
    if(!text) return;
    // if private chat ensure not blocked by me/from me: we prevent sending if recipient in my blocked list
    if(roomId.includes('_')){
      const parts = roomId.split('_');
      const other = parts[0] === ME_EMAIL ? parts[1] : parts[0];
      // check if other is blocked by me (we allow sending to someone we blocked? spec wants cannot send to blocked)
      if(blockedSet.has(other)) return alert('ä½ å·²å°é–å°æ–¹ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯');
      // attempt to check if other has blocked me (read other's blocked doc) - our rules allow reading blocked
      try{
        const blockedDoc = await db.collection('users').doc(other).collection('blocked').doc(ME_EMAIL).get();
        if(blockedDoc.exists) return alert('å°æ–¹å·²å°é–ä½ ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯');
      }catch(e){ console.warn('check other blocked failed', e); /* continue to attempt send */ }
    }
    await db.collection('messages').doc(roomId).collection('chats').add({
      from: ME_EMAIL,
      text,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
    ta.value = '';
  };

  // Enter / Shift+Enter
  ta.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      send.click();
    }
  });

  // if readonly (monitor), hide input
  if(readonly || (isSuperAdmin && head.innerText.includes('ç›£çœ‹'))){
    inputWrap.style.display = 'none';
  }
}

/* ========== WATCH (super admin) ========== */
watchBtn.onclick = ()=>{
  if(!isSuperAdmin) return alert('åªé™æœ€é«˜ç®¡ç†å“¡ä½¿ç”¨');
  const v = watchInput.value.trim();
  if(!v.includes('_')) return alert('æ ¼å¼: emailA_emailB');
  openChatWindow(v, 'ç›£çœ‹: '+v, true);
}

/* ========== CLEANUP ON LEAVE ========== */
window.addEventListener('beforeunload', ()=>{
  Object.values(unsubscribers).forEach(u=>u && u());
  Object.values(openChats).forEach(c=>c.unsub && c.unsub());
});
</script>
</body>
</html>
