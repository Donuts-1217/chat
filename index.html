<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ å®Œæ•´èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: "Noto Sans TC", sans-serif; background: #f0f2f5; margin: 0; }
#container { display: flex; width: 95%; max-width: 1200px; margin: 20px auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
.sidebar, .rightbar { width: 25%; background: #f9f9f9; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
.chat { flex: 1; display: flex; flex-direction: column; padding: 15px; }
h3 { margin: 5px 0; }
ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; border: 1px solid #ddd; border-radius: 5px; background: #fff; }
li { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
li:hover { background: #e6f0ff; }
button { padding: 8px; margin: 5px 0; border-radius: 5px; border: none; cursor: pointer; }
#sendBtn { background: #4CAF50; color: white; }
#loginBtn { background: #4285F4; color: white; margin-bottom: 10px; }
#logoutBtn { background: #f44336; color: white; float: right; }
#messages { flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 8px; background: #fafafa; margin-bottom: 10px; }
.msg { margin: 4px 0; padding: 5px 8px; border-radius: 6px; background: #e6f0ff; }
.input-area { display: flex; }
.input-area input { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
</style>
</head>
<body>

<div id="container">
  <!-- å·¦å´å¥½å‹/ç¾¤èŠ -->
  <div class="sidebar">
    <h3>å¥½å‹æ¸…å–®</h3>
    <ul id="friendList"></ul>
    <h3>ç¾¤èŠæ¸…å–®</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="ç¾¤èŠåç¨±">
    <button id="createGroupBtn">å»ºç«‹ç¾¤èŠ</button>
  </div>

  <!-- ä¸­é–“èŠå¤©å€ -->
  <div class="chat">
    <div>
      <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
      <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    </div>
    <p>ğŸ‘‹ æ­¡è¿ï¼Œ<span id="user"></span></p>

    <div id="messages"></div>

    <div class="input-area">
      <input id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯...">
      <button id="sendBtn">é€å‡º</button>
    </div>
  </div>

  <!-- å³å´æ–°å¢å¥½å‹ -->
  <div class="rightbar">
    <h3>æ–°å¢å¥½å‹</h3>
    <input id="addFriendEmail" placeholder="è¼¸å…¥ Gmail">
    <button id="addFriendBtn">æ–°å¢å¥½å‹</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userSpan = document.getElementById("user");
const msgDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupName = document.getElementById("newGroupName");

let userEmail = "";
let currentRoom = "group_chat";
let unsub = null;

// ç™»å…¥/ç™»å‡º
loginBtn.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
};
logoutBtn.onclick = async () => {
  await auth.signOut();
  loginBtn.style.display = "inline-block";
  logoutBtn.style.display = "none";
  msgDiv.innerHTML = "";
  friendList.innerHTML = "";
  groupList.innerHTML = "";
};

// ç›£è½ç™»å…¥ç‹€æ…‹
auth.onAuthStateChanged(user => {
  if (user) {
    userEmail = user.email;
    userSpan.textContent = `${user.displayName} (${userEmail})`;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    loadFriends();
    loadGroups();
    joinRoom("group_chat");
  }
});

// è¼‰å…¥å¥½å‹åˆ—è¡¨
function loadFriends() {
  friendList.innerHTML = "";
  db.collection("users").doc(userEmail).collection("friends")
    .onSnapshot(snap => {
      friendList.innerHTML = "";
      snap.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = doc.data().email;
        li.onclick = () => joinRoom([userEmail, doc.data().email].sort().join("_"));
        friendList.appendChild(li);
      });
    });
}

// è¼‰å…¥ç¾¤èŠåˆ—è¡¨
function loadGroups() {
  groupList.innerHTML = "";
  db.collection("groups")
    .onSnapshot(snap => {
      groupList.innerHTML = "";
      snap.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = doc.id;
        li.onclick = () => joinRoom(doc.id);
        groupList.appendChild(li);
      });
    });
}

// å»ºç«‹ç¾¤èŠ
createGroupBtn.onclick = async () => {
  const name = newGroupName.value.trim();
  if (!name) return alert("è«‹è¼¸å…¥ç¾¤èŠåç¨±");
  await db.collection("groups").doc(name).set({createdBy: userEmail});
  newGroupName.value = "";
};

// æ–°å¢å¥½å‹
addFriendBtn.onclick = async () => {
  const email = addFriendEmail.value.trim();
  if (!email) return alert("è«‹è¼¸å…¥å¥½å‹ Gmail");
  await db.collection("users").doc(userEmail).collection("friends").doc(email).set({email});
  addFriendEmail.value = "";
};

// åŠ å…¥èŠå¤©å®¤
function joinRoom(roomId) {
  if (unsub) unsub();
  currentRoom = roomId;
  unsub = db.collection("messages").doc(currentRoom).collection("chats")
    .orderBy("time")
    .onSnapshot(snap => {
      msgDiv.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "msg";
        div.textContent = `${d.from}: ${d.text}`;
        msgDiv.appendChild(div);
      });
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

// ç™¼é€è¨Šæ¯
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if (!text) return;
  await db.collection("messages").doc(currentRoom).collection("chats").add({
    from: userEmail,
    text,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value = "";
};
</script>
</body>
</html>
