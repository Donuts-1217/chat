<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ æ ¡åœ’å³æ™‚èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family:"Noto Sans TC",sans-serif; margin:0; background:#2f3136; color:white; }
#loginPage, #chatPage { width:100%; height:100vh; display:flex; justify-content:center; align-items:center; }
#chatPage { display:none; flex-direction:column; }
#container { display:flex; width:95%; max-width:1400px; height:80vh; background:#36393f; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
.sidebar, .rightbar { width:20%; padding:15px; display:flex; flex-direction:column; background:#2f3136; }
.sidebar h3, .rightbar h3 { color:#b9bbbe; margin:5px 0; font-size:14px; }
ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; border-radius:6px; border:1px solid #202225; background:#202225; }
li { padding:8px; cursor:pointer; border-bottom:1px solid #202225; transition:0.2s; }
li:hover { background:#4f545c; font-weight:500; }
button { padding:6px; margin:2px 0; border-radius:6px; border:none; cursor:pointer; font-size:12px; }
#loginBtn { background:#7289da; color:white; font-weight:500; }
#logoutBtn { background:#f04747; color:white; font-weight:500; }
.chat-area { flex:1; display:flex; flex-wrap:wrap; gap:10px; padding:10px; overflow-x:auto; background:#36393f; }
.chat-window { width:300px; min-width:300px; max-height:500px; background:#40444b; border-radius:8px; display:flex; flex-direction:column; overflow:hidden; }
.chat-header { background:#2f3136; color:white; padding:6px; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
.chat-messages { flex:1; overflow-y:auto; padding:6px; background:#2f3136; }
.msg { margin:4px 0; padding:4px 8px; border-radius:6px; background:#5865f2; font-size:13px; word-break:break-word; }
.chat-input { display:flex; border-top:1px solid #202225; }
.chat-input input { flex:1; padding:6px 8px; border:none; outline:none; font-size:13px; background:#40444b; color:white; }
.chat-input button { padding:6px 10px; background:#43b581; color:white; border-radius:0 0 6px 0; font-weight:500; }
.rightbar input { padding:6px; border-radius:4px; border:1px solid #202225; font-size:13px; margin-bottom:5px; background:#40444b; color:white; }
.request-btn { padding:2px 4px; margin-left:4px; border-radius:4px; font-size:11px; }
#announcementInput { width:100%; margin-top:5px; }
#announceBtn { width:100%; background:#faa61a; color:black; font-weight:500; margin-top:2px; }
</style>
</head>
<body>

<!-- ç™»å…¥é  -->
<div id="loginPage">
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<!-- èŠå¤©é  -->
<div id="chatPage">
  <div style="width:95%; max-width:1400px; display:flex; justify-content:space-between; align-items:center;">
    <span>ğŸ‘‹ æ­¡è¿ï¼Œ<span id="user"></span></span>
    <button id="logoutBtn">ç™»å‡º</button>
  </div>
  <div id="container">
    <!-- å·¦å´å¥½å‹ç¾¤èŠ -->
    <div class="sidebar">
      <h3>å¥½å‹æ¸…å–®</h3>
      <ul id="friendList"></ul>
      <input id="addFriendEmail" placeholder="è¼¸å…¥ Gmail">
      <button id="addFriendBtn">é€å‡ºå¥½å‹è«‹æ±‚</button>
      <h3>å¥½å‹è«‹æ±‚</h3>
      <ul id="requestList"></ul>
      <h3>ç¾¤çµ„æ¸…å–®</h3>
      <ul id="groupList"></ul>
      <input id="newGroupName" placeholder="ç¾¤èŠåç¨±">
      <button id="createGroupBtn">å»ºç«‹ç¾¤èŠ</button>
    </div>

    <!-- ä¸­é–“èŠå¤©å€ -->
    <div class="chat-area" id="chatArea"></div>

    <!-- å³å´ç®¡ç† / ç›£çœ‹ / å…¬å‘Š -->
    <div class="rightbar">
      <div id="monitorArea" style="display:none;">
        <h3>ç›£çœ‹ç”¨æˆ¶ç§èŠ</h3>
        <select id="monitorSelect"></select>
        <button id="monitorBtn">é–‹å•Ÿç›£çœ‹</button>
      </div>
      <div id="announcementArea" style="display:none;">
        <h3>ç™¼ä½ˆå…¬å‘Š</h3>
        <input id="announcementInput" placeholder="è¼¸å…¥å…¬å‘Šè¨Šæ¯">
        <button id="announceBtn">ç™¼ä½ˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
// Firebase åˆå§‹åŒ–
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginPage = document.getElementById("loginPage");
const chatPage = document.getElementById("chatPage");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userSpan = document.getElementById("user");

const friendList = document.getElementById("friendList");
const requestList = document.getElementById("requestList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const groupList = document.getElementById("groupList");
const newGroupName = document.getElementById("newGroupName");
const createGroupBtn = document.getElementById("createGroupBtn");
const chatArea = document.getElementById("chatArea");
const monitorArea = document.getElementById("monitorArea");
const monitorSelect = document.getElementById("monitorSelect");
const monitorBtn = document.getElementById("monitorBtn");
const announcementArea = document.getElementById("announcementArea");
const announcementInput = document.getElementById("announcementInput");
const announceBtn = document.getElementById("announceBtn");

let userEmail = "";
let userName = "";
let userRole = "user"; // user / admin / super
let chatWindows = {};
let monitorWindow = null;

// ç™»å…¥ç™»å‡º
loginBtn.onclick = async () => {
  const result = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};
logoutBtn.onclick = async () => {
  await auth.signOut();
  location.reload();
};

// ç›£è½ç™»å…¥ç‹€æ…‹
auth.onAuthStateChanged(async user => {
  if(user){
    loginPage.style.display = "none";
    chatPage.style.display = "flex";
    userEmail = user.email;
    userName = user.displayName;
    userSpan.textContent = `${userName} (${userEmail})`;
    // è¨­å®šä½¿ç”¨è€…
    await db.collection("users").doc(userEmail).set({name:userName,email:userEmail},{merge:true});
    // å–å¾—èº«åˆ†
    const doc = await db.collection("users").doc(userEmail).get();
    userRole = doc.data()?.role || (userEmail === "chianghansen0302@gmail.com" ? "super" : "user");
    // é«˜éšç®¡ç†å“¡åŠŸèƒ½é¡¯ç¤º
    if(userRole==="super"){
      monitorArea.style.display="block";
      announcementArea.style.display="block";
    }
    if(userRole==="admin" || userRole==="super"){
      createGroupBtn.style.display="inline-block";
    } else {
      createGroupBtn.style.display="none";
    }

    loadFriends();
    loadGroups();
    loadRequests();
    loadAnnouncements();
    if(userRole==="super") loadMonitorList();
  }
});

// å¥½å‹æ¸…å–®
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.data().email;
      li.onclick = ()=>openChatWindow([userEmail,doc.data().email].sort().join("_"), doc.data().email);
      friendList.appendChild(li);
    });
  });
}

// ç¾¤çµ„æ¸…å–®
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.id;
      li.onclick = ()=>openChatWindow(doc.id, doc.id, true);
      groupList.appendChild(li);
    });
  });
}

// å¥½å‹è«‹æ±‚
addFriendBtn.onclick = async ()=>{
  const email = addFriendEmail.value.trim();
  if(!email) return alert("è«‹è¼¸å…¥å¥½å‹ Gmail");
  if(email === userEmail) return alert("ä¸èƒ½åŠ è‡ªå·±");
  try{
    await db.collection("users").doc(email).set({email},{merge:true});
    await db.collection("users").doc(email).collection("requests").add({
      from:userEmail,
      status:"pending",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    addFriendEmail.value="";
  }catch(err){
    alert("é€å‡ºå¥½å‹è«‹æ±‚å¤±æ•—ï¼š"+err.message);
  }
};

function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests")
  .where("status","==","pending")
  .onSnapshot(snap=>{
    requestList.innerHTML="";
    snap.forEach(doc=>{
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${data.from} æƒ³åŠ ä½ ç‚ºå¥½å‹`;
      const acceptBtn = document.createElement("button");
      acceptBtn.textContent="åŒæ„";
      acceptBtn.className="request-btn";
      acceptBtn.onclick = async ()=>{
        await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
        await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
        await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
      };
      const rejectBtn = document.createElement("button");
      rejectBtn.textContent="æ‹’çµ•";
      rejectBtn.className="request-btn";
      rejectBtn.onclick = async ()=>{
        await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"rejected"});
      };
      li.appendChild(acceptBtn);
      li.appendChild(rejectBtn);
      requestList.appendChild(li);
    });
  });
}

// å»ºç«‹ç¾¤èŠ
createGroupBtn.onclick = async ()=>{
  if(userRole==="user") return alert("æ¬Šé™ä¸è¶³");
  const name = newGroupName.value.trim();
  if(!name) return;
  await db.collection("groups").doc(name).set({createdBy:userEmail});
  newGroupName.value="";
}

// é–‹å•ŸèŠå¤©çª—
function openChatWindow(roomId, title, isGroup=false){
  if(chatWindows[roomId]) return;
  const win = document.createElement("div");
  win.className="chat-window";
  const header = document.createElement("div");
  header.className="chat-header";
  header.innerHTML = `<span>${title}</span><button>X</button>`;
  win.appendChild(header);
  const msgDiv = document.createElement("div");
  msgDiv.className="chat-messages";
  win.appendChild(msgDiv);
  const inputDiv = document.createElement("div");
  inputDiv.className="chat-input";
  const input = document.createElement("input");
  input.placeholder="è¼¸å…¥è¨Šæ¯...";
  const btn = document.createElement("button");
  btn.textContent="é€å‡º";
  inputDiv.appendChild(input);
  inputDiv.appendChild(btn);
  win.appendChild(inputDiv);
  chatArea.appendChild(win);

  header.querySelector("button").onclick = ()=>{
    chatArea.removeChild(win);
    if(chatWindows[roomId]) chatWindows[roomId]();
    delete chatWindows[roomId];
  }

  const unsub = db.collection("messages").doc(roomId).collection("chats").orderBy("time")
    .onSnapshot(snap=>{
      msgDiv.innerHTML="";
      snap.forEach(doc=>{
        const d = doc.data();
        const div = document.createElement("div");
        div.className="msg";
        div.textContent = `${d.from}: ${d.text}`;
        msgDiv.appendChild(div);
      });
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });
  chatWindows[roomId] = unsub;

  // Enter ç™¼é€ / Shift+Enter æ›è¡Œ
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      btn.click();
    }
  });

  btn.onclick = async ()=>{
    const text = input.value.trim();
    if(!text) return;
    await db.collection("messages").doc(roomId).collection("chats").add({
      from:userEmail,
      text,
      time:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value="";
  }
}

// ç›£çœ‹åŠŸèƒ½
function loadMonitorList(){
  db.collection("users").get().then(snap=>{
    monitorSelect.innerHTML="";
    snap.forEach(doc=>{
      if(doc.id !== userEmail){
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.id;
        monitorSelect.appendChild(opt);
      }
    });
  });
}

monitorBtn.onclick = ()=>{
  const target = monitorSelect.value;
  if(!target) return;
  openChatWindow("monitor_"+target, "ç›£çœ‹: "+target);
}

// å…¨åŸŸå…¬å‘Š
announceBtn.onclick = async ()=>{
  if(userRole!=="super") return;
  const text = announcementInput.value.trim();
  if(!text) return;
  await db.collection("announcements").add({text, from:userEmail, time:firebase.firestore.FieldValue.serverTimestamp()});
  announcementInput.value="";
};

function loadAnnouncements(){
  db.collection("announcements").orderBy("time","desc").onSnapshot(snap=>{
    snap.forEach(doc=>{
      alert("å…¬å‘Š: "+doc.data().text); // å¯æ›æˆç•«é¢é¡¯ç¤º
    });
  });
}
</script>
</body>
</html>
