<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’å³æ™‚èŠå¤©å®¤ï¼ˆæœ€çµ‚ç‰ˆï¼‰</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Simple modern style -->
<style>
  :root{
    --bg:#f3f7fb; --card:#ffffff; --muted:#6b7280; --accent:#4f46e5; --accent-2:#10b981; --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:"Noto Sans TC","å¾®è»Ÿæ­£é»‘é«”",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#0f172a}
  .centered{display:flex;align-items:center;justify-content:center;height:100vh}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .btn.alt{background:#fff;color:var(--accent);border:1px solid #e6e9f2}
  .btn.danger{background:var(--danger)}
  /* layout */
  #app{display:none;max-width:1200px;margin:18px auto;height:88vh;background:transparent}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px}
  .title{font-size:20px;font-weight:700;color:var(--accent)}
  .top-actions{display:flex;gap:8px;align-items:center}
  .top-actions .me{font-size:14px;color:var(--muted)}
  /* main */
  .main{display:flex;height:calc(100% - 64px);gap:12px;padding:0 18px 18px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);overflow:hidden}
  .left{width:260px;display:flex;flex-direction:column}
  .left .section{padding:12px}
  .list{height:100%;overflow:auto;background:transparent;padding:8px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;cursor:pointer}
  .item:hover{background:#f0f6ff}
  .controls{display:flex;gap:8px;margin-top:10px}
  .search{padding:8px;border-radius:8px;border:1px solid #e6e9f2;width:100%}
  /* center chat area */
  .center{flex:1;display:flex;flex-direction:column}
  .chat-list{display:flex;gap:12px;padding:12px;overflow:auto;height:100%}
  .chat-card{min-width:360px;max-width:760px;flex:1;display:flex;flex-direction:column}
  .chat-head{display:flex;align-items:center;justify-content:space-between;padding:12px;background:linear-gradient(90deg,var(--accent),#6366f1);color:#fff;border-radius:10px 10px 0 0}
  .chat-body{flex:1;padding:12px;overflow:auto;background:#f8fbff}
  .msg{background:#eaf2ff;padding:8px 10px;border-radius:10px;margin:8px 0;max-width:80%;word-break:break-word}
  .msg.me{background:#dcfce7;margin-left:auto}
  .chat-foot{display:flex;gap:8px;padding:12px;background:#fff;border-top:1px solid #eef3fb}
  textarea{flex:1;min-height:64px;resize:none;padding:10px;border-radius:8px;border:1px solid #e6e9f2}
  .small{font-size:13px;color:var(--muted)}
  /* right */
  .right{width:320px;display:flex;flex-direction:column}
  .right .section{padding:12px;flex:1;overflow:auto}
  .chip{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f5f9;margin-right:6px;font-size:13px}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:40}
  .modal .box{width:90%;max-width:720px;background:#fff;border-radius:10px;padding:16px}
  /* mobile */
  @media(max-width:980px){.main{flex-direction:column}.left,.right{width:100%}.chat-card{min-width:unset}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="centered">
  <div style="text-align:center">
    <h1 style="margin:0 0 8px 0;color:var(--accent)">ğŸ”¥ æ ¡åœ’å³æ™‚èŠå¤©å®¤</h1>
    <p style="color:var(--muted);margin:0 0 16px 0">è«‹ä½¿ç”¨ Google ç™»å…¥ä¾†æ¸¬è©¦ï¼ˆè¨˜å¾—åœ¨ Firebase Console é–‹å•Ÿ Google Sign-Inï¼‰</p>
    <button id="loginBtn" class="btn">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="title">ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</div>
    <div class="top-actions">
      <div class="me">
        <span id="meName" style="font-weight:700"></span><br>
        <span id="meEmail" class="small"></span>
      </div>
      <div id="roleBadge" class="chip" style="display:none"></div>
      <button id="logoutBtn" class="btn alt">ç™»å‡º</button>
    </div>
  </header>

  <div class="main">
    <!-- left -->
    <div class="left panel">
      <div class="section">
        <div style="display:flex;gap:8px">
          <input id="friendSearch" class="search" placeholder="æœå°‹å¥½å‹æˆ– email">
        </div>
        <div style="margin-top:10px;font-weight:700">å¥½å‹</div>
        <div id="friends" class="list" style="height:210px"></div>

        <div style="margin-top:10px;font-weight:700">å¥½å‹è«‹æ±‚</div>
        <div id="requests" class="list" style="height:110px"></div>

        <div style="margin-top:10px;font-weight:700">æ–°å¢å¥½å‹</div>
        <div class="controls">
          <input id="addFriendEmail" class="search" placeholder="è¼¸å…¥ Gmail">
          <button id="sendFriendReqBtn" class="btn">é€å‡º</button>
        </div>
      </div>

      <div style="border-top:1px solid #eef3fb;padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">ç¾¤çµ„</div>
          <div class="small">åªé¡¯ç¤ºä½ å·²è¢«åŠ å…¥çš„ç¾¤çµ„</div>
        </div>
        <div id="groups" class="list" style="height:220px;margin-top:10px"></div>

        <!-- å»ºç¾¤ (admin only) -->
        <div id="createGroupWrap" style="margin-top:10px;display:none">
          <input id="newGroupName" class="search" placeholder="è¼¸å…¥ç¾¤çµ„åç¨±">
          <div style="display:flex;margin-top:8px;gap:8px">
            <button id="createGroupBtn" class="btn">å»ºç«‹ç¾¤çµ„</button>
          </div>
          <div class="small" style="margin-top:6px;color:var(--muted)">å»ºç«‹å¾Œ**ä¸æœƒè‡ªå‹•æŠŠä»»ä½•äººåŠ å…¥**ï¼Œéœ€ç”±ç®¡ç†å“¡æ‰‹å‹•åŠ å…¥ã€‚</div>
        </div>
      </div>
    </div>

    <!-- center (èŠå¤©å€) -->
    <div class="center">
      <div id="chatBoxes" class="chat-list"></div>
      <div style="display:flex;justify-content:center;margin-top:8px;color:var(--muted)">æŒ‰èŠå¤©é …ç›®é–‹å•ŸèŠå¤©å®¤ï¼ˆç§èŠæˆ–ç¾¤èŠï¼‰ï¼ŒèŠå¤©è¦–çª—æœƒå‡ºç¾åœ¨ä¸Šæ–¹åˆ—è¡¨ä¸­</div>
    </div>

    <!-- right -->
    <div class="right panel">
      <div class="section">
        <div style="font-weight:700">å°é–æ¸…å–®</div>
        <div id="blocked" class="list" style="height:120px;margin-top:8px"></div>
      </div>

      <div class="section">
        <div style="font-weight:700">ç¾¤çµ„ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰</div>
        <div class="small" style="margin-bottom:8px">ç®¡ç†å“¡å¯è¼¸å…¥ ç¾¤çµ„åç¨± + email ä¾†åŠ å…¥ / è¸¢å‡ºï¼ˆä¸€èˆ¬ä½¿ç”¨è€…çœ‹ä¸åˆ°ï¼‰</div>
        <input id="adminGroupName" class="search" placeholder="ç¾¤çµ„åç¨±">
        <input id="adminGroupEmail" class="search" placeholder="è¦åŠ å…¥/è¸¢å‡ºçš„ email" style="margin-top:8px">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="adminAddBtn" class="btn">åŠ å…¥æˆå“¡</button>
          <button id="adminKickBtn" class="btn danger">è¸¢å‡ºæˆå“¡</button>
        </div>
      </div>

      <div class="section" style="margin-top:auto">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">ç›£çœ‹ç§èŠï¼ˆæœ€é«˜ç®¡ç†å“¡ï¼‰</div>
          <div class="small">åªè®€</div>
        </div>
        <input id="monitorInput" class="search" placeholder="æ ¼å¼ï¼šemailA_emailB" style="margin-top:8px">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="monitorBtn" class="btn">ç›£çœ‹</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- members modal -->
<div id="modal" class="modal">
  <div class="box">
    <h3 id="modalTitle">ç¾¤çµ„æˆå“¡</h3>
    <div id="modalBody" style="margin-top:12px"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="modalClose" class="btn alt">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- SCRIPT -->
<script>
/* ========== Firebase config (replace if needed) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========== UI refs ========== */
const loginScreen = document.getElementById('loginScreen');
const app = document.getElementById('app');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const meName = document.getElementById('meName');
const meEmail = document.getElementById('meEmail');
const roleBadge = document.getElementById('roleBadge');

const friendsPanel = document.getElementById('friends');
const requestsPanel = document.getElementById('requests');
const blockedPanel = document.getElementById('blocked');
const groupsPanel = document.getElementById('groups');

const sendFriendReqBtn = document.getElementById('sendFriendReqBtn');
const addFriendEmail = document.getElementById('addFriendEmail');

const createGroupWrap = document.getElementById('createGroupWrap');
const createGroupBtn = document.getElementById('createGroupBtn');
const newGroupName = document.getElementById('newGroupName');

const chatBoxes = document.getElementById('chatBoxes');

const adminAddBtn = document.getElementById('adminAddBtn');
const adminKickBtn = document.getElementById('adminKickBtn');
const adminGroupName = document.getElementById('adminGroupName');
const adminGroupEmail = document.getElementById('adminGroupEmail');

const monitorInput = document.getElementById('monitorInput');
const monitorBtn = document.getElementById('monitorBtn');

const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const modalClose = document.getElementById('modalClose');

/* ========== State ========== */
let ME = null;
let ME_EMAIL = '';
let ME_NAME = '';
let ME_ROLE = 'user';
const SUPER_ADMIN = 'chianghansen0302@gmail.com';
const openChats = {}; // roomId -> {el, unsub}

/* ========== AUTH ========== */
loginBtn.onclick = async () => {
  try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  catch (e) { alert('ç™»å…¥å¤±æ•—ï¼š' + e.message); console.error(e); }
};
logoutBtn.onclick = async () => {
  await auth.signOut();
  location.reload();
};

auth.onAuthStateChanged(async (user) => {
  if (!user) {
    loginScreen.style.display = 'flex';
    app.style.display = 'none';
    return;
  }
  ME = user;
  ME_EMAIL = user.email;
  ME_NAME = user.displayName || ME_EMAIL.split('@')[0];

  // ensure users doc exists and has a role
  const ud = db.collection('users').doc(ME_EMAIL);
  const snap = await ud.get();
  if (!snap.exists) {
    const initRole = (ME_EMAIL === SUPER_ADMIN) ? 'superadmin' : 'user';
    await ud.set({ name: ME_NAME, email: ME_EMAIL, role: initRole, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    ME_ROLE = initRole;
  } else {
    ME_ROLE = snap.data().role || 'user';
  }

  // update UI
  loginScreen.style.display = 'none';
  app.style.display = 'block';
  meName.textContent = ME_NAME;
  meEmail.textContent = ME_EMAIL;
  roleBadge.style.display = (ME_ROLE === 'admin' || ME_ROLE === 'superadmin') ? 'inline-block' : 'none';
  roleBadge.textContent = (ME_ROLE === 'superadmin') ? 'æœ€é«˜ç®¡ç†å“¡' : (ME_ROLE === 'admin' ? 'ç®¡ç†å“¡' : '');

  // show create group UI only for admin/superadmin
  createGroupWrap.style.display = (ME_ROLE === 'admin' || ME_ROLE === 'superadmin') ? 'block' : 'none';

  // setup live listeners
  setupListeners();
});

/* ========== LISTENERS ========== */
let unsubs = [];
function setupListeners() {
  // clear previous
  unsubs.forEach(u => u && u());
  unsubs = [];

  // friends list
  const uFriendsRef = db.collection('users').doc(ME_EMAIL).collection('friends');
  unsubs.push(uFriendsRef.onSnapshot(snap => {
    friendsPanel.innerHTML = '';
    snap.forEach(doc => {
      const email = doc.id;
      const data = doc.data() || {};
      const item = document.createElement('div'); item.className = 'item';
      const left = document.createElement('div'); left.textContent = data.name || email;
      const right = document.createElement('div');
      const chatBtn = document.createElement('button'); chatBtn.className='btn alt'; chatBtn.textContent='ç§èŠ';
      chatBtn.onclick = (e) => { e.stopPropagation(); openPrivateChat(email); };
      const more = document.createElement('button'); more.className='btn alt'; more.textContent='â‹¯';
      more.onclick = (e) => { e.stopPropagation(); openFriendContext(email); };
      right.appendChild(chatBtn); right.appendChild(more);
      item.appendChild(left); item.appendChild(right);
      friendsPanel.appendChild(item);
    });
  }, err => console.error(err)));

  // friend requests incoming
  const reqRef = db.collection('users').doc(ME_EMAIL).collection('requests').where('status','==','pending').orderBy('timestamp','desc');
  unsubs.push(reqRef.onSnapshot(snap => {
    requestsPanel.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const item = document.createElement('div'); item.className='item';
      const left = document.createElement('div'); left.textContent = d.from;
      const right = document.createElement('div');
      const accept = document.createElement('button'); accept.className='btn'; accept.textContent='åŒæ„';
      accept.onclick = async () => {
        await db.collection('users').doc(ME_EMAIL).collection('friends').doc(d.from).set({email:d.from});
        await db.collection('users').doc(d.from).collection('friends').doc(ME_EMAIL).set({email:ME_EMAIL});
        await db.collection('users').doc(ME_EMAIL).collection('requests').doc(doc.id).update({status:'accepted'});
      };
      const reject = document.createElement('button'); reject.className='btn alt'; reject.textContent='æ‹’çµ•';
      reject.onclick = async () => { await db.collection('users').doc(ME_EMAIL).collection('requests').doc(doc.id).update({status:'rejected'}); };
      right.appendChild(accept); right.appendChild(reject);
      item.appendChild(left); item.appendChild(right);
      requestsPanel.appendChild(item);
    });
  }, err => console.error(err)));

  // blocked list
  const blockedRef = db.collection('users').doc(ME_EMAIL).collection('blocked');
  unsubs.push(blockedRef.onSnapshot(snap => {
    blockedPanel.innerHTML = '';
    snap.forEach(doc => {
      const email = doc.id;
      const item = document.createElement('div'); item.className='item';
      const left = document.createElement('div'); left.textContent = email;
      const right = document.createElement('div');
      const unb = document.createElement('button'); unb.className='btn alt'; unb.textContent='è§£é™¤';
      unb.onclick = async () => { await blockedRef.doc(email).delete(); };
      right.appendChild(unb);
      item.appendChild(left); item.appendChild(right);
      blockedPanel.appendChild(item);
    });
  }, err => console.error(err)));

  // groups: only show groups where you are a member
  unsubs.push(db.collection('groups').onSnapshot(snap => {
    groupsPanel.innerHTML = '';
    snap.forEach(doc => {
      const name = doc.id;
      const data = doc.data() || {};
      const members = data.members || [];
      if (!Array.isArray(members)) return;
      if (!members.includes(ME_EMAIL)) return; // only show if you're a member
      const item = document.createElement('div'); item.className='item';
      const left = document.createElement('div'); left.textContent = name;
      const right = document.createElement('div');
      const open = document.createElement('button'); open.className='btn alt'; open.textContent='é–‹å•Ÿ';
      open.onclick = () => openGroupChat(name);
      const membersBtn = document.createElement('button'); membersBtn.className='btn alt'; membersBtn.textContent='æˆå“¡';
      membersBtn.onclick = () => showGroupMembers(name);
      right.appendChild(open); right.appendChild(membersBtn);
      item.appendChild(left); item.appendChild(right);
      groupsPanel.appendChild(item);
    });
  }, err => console.error(err)));
}

/* ========== FRIEND REQUEST / BLOCK / DELETE ========== */
sendFriendReqBtn.onclick = async () => {
  const to = (addFriendEmail.value || '').trim().toLowerCase();
  if (!to) return alert('è«‹è¼¸å…¥å°æ–¹ Gmail');
  if (to === ME_EMAIL) return alert('ä¸èƒ½åŠ è‡ªå·±');
  try {
    await db.collection('users').doc(to).set({email:to},{merge:true});
    await db.collection('users').doc(to).collection('requests').add({from:ME_EMAIL,status:'pending',timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    addFriendEmail.value = '';
    alert('å¥½å‹è«‹æ±‚å·²é€å‡º');
  } catch (e) { alert('é€å‡ºå¤±æ•—ï¼š' + e.message); console.error(e); }
};

/* friend context: delete / block (shown when pressing â‹¯) */
function openFriendContext(email) {
  const yes = confirm(`å° ${email}ï¼šæŒ‰ç¢ºå®šåˆªé™¤å¥½å‹ï¼›æŒ‰å–æ¶ˆé¡¯ç¤ºå°é–é¸é …ã€‚`);
  if (yes) {
    // delete friend both sides
    db.collection('users').doc(ME_EMAIL).collection('friends').doc(email).delete().catch(()=>null);
    db.collection('users').doc(email).collection('friends').doc(ME_EMAIL).delete().catch(()=>null);
    alert('å¥½å‹å·²åˆªé™¤');
    return;
  }
  const blk = confirm('è¦å°é–æ­¤ç”¨æˆ¶å—ï¼Ÿï¼ˆå°é–å¾Œä½ ä¸æœƒçœ‹åˆ°å°æ–¹è¨Šæ¯ï¼‰');
  if (blk) {
    db.collection('users').doc(ME_EMAIL).collection('blocked').doc(email).set({email,at:firebase.firestore.FieldValue.serverTimestamp()});
    alert('å·²å°é– ' + email);
  }
}

/* ========== GROUP create/admin actions ========== */
createGroupBtn.onclick = async () => {
  // only admin or superadmin
  const doc = await db.collection('users').doc(ME_EMAIL).get();
  const role = (doc.exists && doc.data().role) ? doc.data().role : 'user';
  if (!(role === 'admin' || role === 'superadmin')) return alert('åªæœ‰ç®¡ç†å“¡å¯å»ºç«‹ç¾¤çµ„');
  const name = (newGroupName.value || '').trim();
  if (!name) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
  // create with empty members array; admins array includes creator
  await db.collection('groups').doc(name).set({
    createdBy: ME_EMAIL,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    members: [], // NO automatic join
    admins: [ME_EMAIL]
  });
  newGroupName.value = '';
  alert('ç¾¤çµ„å·²å»ºç«‹ï¼ˆæœªè‡ªå‹•åŠ å…¥ä»»ä½•äººï¼‰');
};

/* admin add/kick by email */
adminAddBtn.onclick = async () => {
  const g = (adminGroupName.value || '').trim();
  const email = (adminGroupEmail.value || '').trim().toLowerCase();
  if (!g || !email) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±èˆ‡ email');
  const myRoleDoc = await db.collection('users').doc(ME_EMAIL).get();
  const myRole = (myRoleDoc.exists && myRoleDoc.data().role) ? myRoleDoc.data().role : 'user';
  if (!(myRole === 'admin' || myRole === 'superadmin')) return alert('åƒ…ç®¡ç†å“¡å¯åŠ å…¥æˆå“¡');
  const gdoc = await db.collection('groups').doc(g).get();
  if (!gdoc.exists) return alert('æ‰¾ä¸åˆ°è©²ç¾¤çµ„');
  await db.collection('groups').doc(g).update({members: firebase.firestore.FieldValue.arrayUnion(email)});
  adminGroupEmail.value = '';
  alert('å·²åŠ å…¥ ' + email + ' è‡³ ' + g);
};

adminKickBtn.onclick = async () => {
  const g = (adminGroupName.value || '').trim();
  const email = (adminGroupEmail.value || '').trim().toLowerCase();
  if (!g || !email) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±èˆ‡ email');
  const myRoleDoc = await db.collection('users').doc(ME_EMAIL).get();
  const myRole = (myRoleDoc.exists && myRoleDoc.data().role) ? myRoleDoc.data().role : 'user';
  if (!(myRole === 'admin' || myRole === 'superadmin')) return alert('åƒ…ç®¡ç†å“¡å¯è¸¢å‡ºæˆå“¡');
  const gdoc = await db.collection('groups').doc(g).get();
  if (!gdoc.exists) return alert('æ‰¾ä¸åˆ°è©²ç¾¤çµ„');
  await db.collection('groups').doc(g).update({members: firebase.firestore.FieldValue.arrayRemove(email)});
  adminGroupEmail.value = '';
  alert('å·²å¾ ' + g + ' è¸¢å‡º ' + email);
};

/* show group members modal */
async function showGroupMembers(groupName) {
  const doc = await db.collection('groups').doc(groupName).get();
  if (!doc.exists) return alert('æ‰¾ä¸åˆ°ç¾¤çµ„');
  const data = doc.data();
  const members = data.members || [];
  const admins = data.admins || [];
  modalTitle.textContent = 'æˆå“¡ â€” ' + groupName;
  modalBody.innerHTML = '';
  members.forEach(m => {
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
    const left = document.createElement('div'); left.textContent = m + (admins.includes(m) ? ' (ç®¡ç†å“¡)' : '');
    const right = document.createElement('div');
    // if I am admin, show kick
    db.collection('users').doc(ME_EMAIL).get().then(meDoc => {
      const role = (meDoc.exists && meDoc.data().role) ? meDoc.data().role : 'user';
      if (role === 'admin' || role === 'superadmin') {
        if (m !== ME_EMAIL) {
          const kick = document.createElement('button'); kick.className='btn danger'; kick.textContent='è¸¢å‡º';
          kick.onclick = async () => {
            if (!confirm('ç¢ºå®šè¸¢å‡º ' + m + ' ?')) return;
            await db.collection('groups').doc(groupName).update({members: firebase.firestore.FieldValue.arrayRemove(m)});
            showGroupMembers(groupName);
          };
          right.appendChild(kick);
        }
      }
    });
    // everyone can leave if it's themselves
    if (m === ME_EMAIL) {
      const leave = document.createElement('button'); leave.className='btn alt'; leave.textContent='é€€å‡º';
      leave.onclick = async () => {
        if (!confirm('ç¢ºå®šé€€å‡º ' + groupName + ' ?')) return;
        await db.collection('groups').doc(groupName).update({members: firebase.firestore.FieldValue.arrayRemove(ME_EMAIL)});
        modal.style.display='none';
      };
      right.appendChild(leave);
    }
    row.appendChild(left); row.appendChild(right);
    modalBody.appendChild(row);
  });
  modal.style.display='flex';
}
modalClose.onclick = ()=> modal.style.display='none';

/* ========== CHAT: open private / group / monitor ========== */
/* open private chat (two-party) */
async function openPrivateChat(otherEmail) {
  const roomId = [ME_EMAIL, otherEmail].sort().join('_');
  const title = otherEmail;
  openChat(roomId, title, false);
}

/* open group chat */
function openGroupChat(groupName) {
  openChat(groupName, groupName, false);
}

/* monitor read-only chat (superadmin) */
monitorBtn.onclick = async () => {
  const monitorRoom = (monitorInput.value || '').trim();
  if (!monitorRoom || monitorRoom.indexOf('_') === -1) return alert('è«‹è¼¸å…¥ emailA_emailB');
  const r = await db.collection('users').doc(ME_EMAIL).get();
  const role = (r.exists && r.data().role) ? r.data().role : 'user';
  if (role !== 'superadmin') return alert('åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹');
  openChat(monitorRoom, 'ç›£çœ‹: ' + monitorRoom, true);
};

/* openChat: core function. readonly=true hides input */
function openChat(roomId, title, readonly) {
  if (openChats[roomId]) {
    // focus existing: move to front
    chatBoxes.prepend(openChats[roomId].el);
    return;
  }

  // create elements
  const card = document.createElement('div'); card.className='chat-card panel';
  const head = document.createElement('div'); head.className='chat-head';
  head.innerHTML = `<div style="font-weight:700">${title}</div><div><button class="btn alt">é—œé–‰</button></div>`;
  card.appendChild(head);

  const body = document.createElement('div'); body.className='chat-body';
  card.appendChild(body);

  const foot = document.createElement('div'); foot.className='chat-foot';
  const ta = document.createElement('textarea'); ta.placeholder='è¼¸å…¥è¨Šæ¯ï¼ˆShift+Enter æ›è¡Œï¼ŒEnter é€å‡ºï¼‰';
  const send = document.createElement('button'); send.className='btn'; send.textContent='é€å‡º';
  foot.appendChild(ta); foot.appendChild(send);
  if (readonly) foot.style.display = 'none';
  card.appendChild(foot);

  // add controls inside head for private chats: delete friend / block (if it's a private chat)
  if (!readonly && roomId.indexOf('_') !== -1) {
    const parts = roomId.split('_');
    const other = (parts[0] === ME_EMAIL) ? parts[1] : parts[0];
    // add quick actions container
    const actDiv = document.createElement('div');
    actDiv.style.display='flex'; actDiv.style.gap='8px';
    const delFriendBtn = document.createElement('button'); delFriendBtn.className='btn alt'; delFriendBtn.textContent='åˆªé™¤å¥½å‹';
    delFriendBtn.onclick = async () => {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å¥½å‹ï¼Ÿ')) return;
      await db.collection('users').doc(ME_EMAIL).collection('friends').doc(other).delete().catch(()=>null);
      await db.collection('users').doc(other).collection('friends').doc(ME_EMAIL).delete().catch(()=>null);
      alert('å·²åˆªé™¤å¥½å‹');
    };
    const blockBtn = document.createElement('button'); blockBtn.className='btn alt'; blockBtn.textContent='å°é–';
    blockBtn.onclick = async () => {
      if (!confirm('ç¢ºå®šå°é–æ­¤ç”¨æˆ¶ï¼Ÿ')) return;
      await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(other).set({email:other,at:firebase.firestore.FieldValue.serverTimestamp()});
      alert('å·²å°é– ' + other);
    };
    actDiv.appendChild(delFriendBtn); actDiv.appendChild(blockBtn);
    head.querySelector('div').appendChild(actDiv);
  }

  // close button
  head.querySelector('button').onclick = () => {
    card.remove();
    const o = openChats[roomId];
    if (o && o.unsub) o.unsub();
    delete openChats[roomId];
  };

  // mount
  chatBoxes.prepend(card);

  // listen messages: last 100
  const msgsRef = db.collection('messages').doc(roomId).collection('chats').orderBy('time','desc').limit(100);
  const unsub = msgsRef.onSnapshot(async snap => {
    body.innerHTML = '';
    // fetch blocked list once
    const blockedSnap = await db.collection('users').doc(ME_EMAIL).collection('blocked').get();
    const blockedSet = new Set(blockedSnap.docs.map(d=>d.id));

    const docs = snap.docs.slice().reverse(); // oldest -> newest
    for (const d of docs) {
      const v = d.data();
      if (blockedSet.has(v.from)) continue; // skip messages from blocked
      const mdiv = document.createElement('div');
      mdiv.className = 'msg' + (v.from === ME_EMAIL ? ' me' : '');
      mdiv.textContent = `${v.from}: ${v.text}`;
      // if superadmin show nothing special (monitor)
      // admin delete action on each message
      const meRoleDoc = await db.collection('users').doc(ME_EMAIL).get();
      const meRole = (meRoleDoc.exists && meRoleDoc.data().role) ? meRoleDoc.data().role : 'user';
      if (meRole === 'superadmin') {
        const del = document.createElement('button'); del.className='btn alt'; del.textContent='åˆªé™¤';
        del.style.marginLeft='8px';
        del.onclick = async (e) => { e.stopPropagation(); if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨Šæ¯ï¼Ÿ')) return; await d.ref.delete().catch(err=>alert('åˆªé™¤å¤±æ•—ï¼š'+err.message)); };
        mdiv.appendChild(del);
      }
      body.appendChild(mdiv);
    }
    body.scrollTop = body.scrollHeight;
  }, err => console.error(err));

  openChats[roomId] = { el: card, unsub };

  // send handler with block checks
  send.onclick = async () => {
    const text = (ta.value || '').trim();
    if (!text) return;
    // check block: if private chat, check if other blocked you or you blocked other
    if (roomId.indexOf('_') !== -1) {
      const parts = roomId.split('_');
      const other = (parts[0] === ME_EMAIL) ? parts[1] : parts[0];
      const otherBlockedMe = await db.collection('users').doc(other).collection('blocked').doc(ME_EMAIL).get();
      if (otherBlockedMe.exists) return alert('å°æ–¹å·²å°é–ä½ ï¼Œç„¡æ³•å‚³é€');
      const iBlockedOther = await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(other).get();
      if (iBlockedOther.exists) return alert('æ‚¨å·²å°é–å°æ–¹ï¼Œç„¡æ³•å‚³é€');
    }
    await db.collection('messages').doc(roomId).collection('chats').add({
      from: ME_EMAIL, text, time: firebase.firestore.FieldValue.serverTimestamp()
    });
    ta.value = '';
  };

  // Enter send, Shift+Enter newline
  ta.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send.click();
    }
  });
}

/* ========== helper: check admin role quickly ========== */
async function isAdmin(email) {
  const d = await db.collection('users').doc(email).get();
  if (!d.exists) return false;
  const r = d.data().role || 'user';
  return r === 'admin' || r === 'superadmin';
}

/* ========== show members modal function ========== */
async function showGroupMembersModal(groupName) {
  const doc = await db.collection('groups').doc(groupName).get();
  if (!doc.exists) return alert('æ‰¾ä¸åˆ°ç¾¤çµ„');
  const data = doc.data(); const members = data.members || []; const admins = data.admins || [];
  modalTitle.textContent = 'ç¾¤çµ„æˆå“¡ â€” ' + groupName;
  modalBody.innerHTML = '';
  for (const m of members) {
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
    const left = document.createElement('div'); left.textContent = m + (admins.includes(m) ? ' (ç®¡ç†å“¡)' : '');
    const right = document.createElement('div');
    // if I'm admin show kick
    const myRoleDoc = await db.collection('users').doc(ME_EMAIL).get();
    const myRole = (myRoleDoc.exists && myRoleDoc.data().role) ? myRoleDoc.data().role : 'user';
    if ((myRole === 'admin' || myRole === 'superadmin') && m !== ME_EMAIL) {
      const kick = document.createElement('button'); kick.className='btn danger'; kick.textContent='è¸¢å‡º';
      kick.onclick = async () => {
        if (!confirm('ç¢ºå®šè¸¢å‡º ' + m + ' ?')) return;
        await db.collection('groups').doc(groupName).update({ members: firebase.firestore.FieldValue.arrayRemove(m) });
        showGroupMembersModal(groupName);
      };
      right.appendChild(kick);
    }
    if (m === ME_EMAIL) {
      const leave = document.createElement('button'); leave.className='btn alt'; leave.textContent='é€€å‡º';
      leave.onclick = async () => {
        if (!confirm('ç¢ºå®šé€€å‡ºï¼Ÿ')) return;
        await db.collection('groups').doc(groupName).update({ members: firebase.firestore.FieldValue.arrayRemove(ME_EMAIL) });
        modal.style.display='none';
      };
      right.appendChild(leave);
    }
    row.appendChild(left); row.appendChild(right);
    modalBody.appendChild(row);
  }
  modal.style.display = 'flex';
}
modalClose.onclick = ()=> modal.style.display='none';

/* ========== initial logic: show/hide create group area depending role ========== */
(async function initRoleUI(){
  // reactive: whenever auth state changes we set createGroupWrap visibility in onAuthStateChanged above
})();

/* cleanup listeners on unload */
window.addEventListener('beforeunload', () => {
  Object.values(openChats).forEach(o => o.unsub && o.unsub());
  unsubs.forEach(u => u && u());
});
</script>
</body>
</html>
