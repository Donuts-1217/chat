<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ - ç™»å…¥</title>
<!-- Tailwind CSS for modern styling -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root {
    --bg: #0f1724;
    --panel: #111827;
    --muted: #9ca3af;
    --accent: #5865f2; /* Discord Blue */
  }
  body {
    margin: 0;
    background: linear-gradient(180deg, #071025 0%, #071223 100%);
    color: #e6eef8;
    font-family: 'Inter', 'Noto Sans TC', system-ui, -apple-system, sans-serif;
  }
  .center {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }
</style>
</head>
<body>

<div id="loginScreen" class="center">
  <div class="p-8 rounded-xl shadow-2xl bg-gray-900 border border-gray-800 text-center max-w-sm">
    <h1 class="text-4xl font-extrabold text-[color:var(--accent)] mb-3">ğŸ”¥ æ ¡åœ’å³æ™‚èŠå¤©å®¤</h1>
    <p class="text-[color:var(--muted)] mb-6 text-sm">è«‹ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥</p>
    <!-- åˆå§‹ç¦ç”¨æŒ‰éˆ•ï¼Œç›´åˆ° Firebase åˆå§‹åŒ–å®Œæˆ -->
    <button id="loginBtn" class="w-full py-3 px-4 text-white font-semibold rounded-lg transition duration-200 hover:opacity-90 bg-[color:var(--accent)] shadow-lg shadow-[color:var(--accent)]/30" disabled>
      ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
    <p id="errorMsg" class="text-red-400 mt-4 text-sm hidden"></p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  
  // å–å¾— Canvas æä¾›çš„å…¨åŸŸè®Šæ•¸
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const loginBtn = document.getElementById('loginBtn');
  const errorMsg = document.getElementById('errorMsg');

  // Firebase åˆå§‹åŒ–
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  /**
   * è™•ç†åˆå§‹èº«ä»½é©—è­‰
   */
  async function authenticate() {
    if (initialAuthToken) {
      await signInWithCustomToken(auth, initialAuthToken).catch(e => {
        console.error("Custom token sign-in failed, falling back to anonymous.", e);
        signInAnonymously(auth);
      });
    } else {
      await signInAnonymously(auth);
    }
    // ç¢ºä¿åœ¨å˜—è©¦ç™»å…¥ä¹‹å‰ Firebase æœå‹™å·²åˆå§‹åŒ–å®Œæˆ
    loginBtn.disabled = false;
  }

  // ç™»å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶
  loginBtn.onclick = () => {
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider)
      .then((result) => {
        // æˆåŠŸç™»å…¥ï¼ŒonAuthStateChanged æœƒè™•ç†è½‰å€
      })
      .catch((error) => {
        console.error("Google Sign-In Failed:", error.message);
        
        let displayMessage = `ç™»å…¥å¤±æ•—: ${error.message}`;
        if (error.code === 'auth/unauthorized-domain') {
          // æä¾›å…·é«”æç¤ºï¼Œå› ç‚ºé€™æ˜¯å¤–éƒ¨é…ç½®å•é¡Œ
          displayMessage = "ç™»å…¥å¤±æ•—ï¼šç•¶å‰ç¶²åŸŸæœªè¢«æˆæ¬Šã€‚è«‹ç¢ºä¿æ‚¨çš„ Firebase å°ˆæ¡ˆä¸­å·²å°‡æ­¤æ‡‰ç”¨ç¨‹å¼çš„ç¶²åŸŸåŠ å…¥æˆæ¬Šæ¸…å–®ã€‚";
        }
        
        errorMsg.textContent = displayMessage;
        errorMsg.classList.remove('hidden');
      });
  };

  // èº«ä»½ç‹€æ…‹ç›£è½
  onAuthStateChanged(auth, (user) => {
    if (user && user.email) {
      // æª¢æŸ¥æ˜¯å¦ç‚º Google ç™»å…¥ (æœ‰ email)ï¼Œå¦‚æœæ˜¯å‰‡è½‰å€åˆ° chat.html
      // åŒ¿åç™»å…¥ (initialAuthToken) ä¸æœƒç›´æ¥è½‰å€ï¼Œä»éœ€é»æ“Š Google ç™»å…¥æŒ‰éˆ•
      window.location.href = 'chat.html';
    }
  });
  
  // åˆå§‹åŒ–æ™‚åŸ·è¡Œä¸€æ¬¡åŒ¿åç™»å…¥æˆ–è‡ªå®šç¾© token ç™»å…¥
  authenticate();
</script>
</body>
</html>