<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>🔥 Discord 風格聊天室</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* Reset */
body, html { margin:0; padding:0; height:100%; font-family:"Noto Sans TC",sans-serif; background:#2f3136; color:#dcddde; }
button { cursor:pointer; }
input { outline:none; }

/* 登入頁 */
#loginPage { display:flex; justify-content:center; align-items:center; height:100%; flex-direction:column; }
#loginPage button { padding:12px 24px; font-size:16px; background:#5865F2; color:white; border:none; border-radius:6px; }

/* 主頁面 */
#mainPage { display:none; height:100%; }
#container { display:flex; height:100%; }
.sidebar, .rightbar { width:250px; padding:15px; background:#36393f; display:flex; flex-direction:column; }
.chat-area { flex:1; display:flex; flex-wrap:wrap; padding:10px; overflow-x:auto; background:#2f3136; }
ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
li { padding:6px; margin-bottom:2px; background:#40444b; border-radius:4px; cursor:pointer; }
li:hover { background:#5865F2; color:white; }
.chat-window { width:300px; max-height:500px; background:#36393f; border-radius:8px; display:flex; flex-direction:column; margin-right:10px; margin-bottom:10px; }
.chat-header { background:#7289da; color:white; padding:6px; display:flex; justify-content:space-between; align-items:center; font-size:14px; }
.chat-messages { flex:1; overflow-y:auto; padding:6px; }
.msg { margin-bottom:4px; padding:4px 8px; border-radius:6px; background:#40444b; word-break:break-word; }
.chat-input { display:flex; border-top:1px solid #5865F2; }
.chat-input input { flex:1; padding:6px; border:none; background:#40444b; color:white; }
.chat-input button { padding:6px 12px; background:#5865F2; color:white; border:none; }
</style>
</head>
<body>

<div id="loginPage">
  <h2>歡迎來到聊天室</h2>
  <button id="loginBtn">使用 Google 登入</button>
</div>

<div id="mainPage">
<div id="container">
  <div class="sidebar">
    <p>👋 <span id="userName"></span></p>
    <h3>好友清單</h3>
    <ul id="friendList"></ul>
    <input id="addFriendEmail" placeholder="輸入 Gmail" style="margin-top:6px; padding:6px; border-radius:4px; border:none;">
    <button id="addFriendBtn" style="margin-top:6px;">送出好友請求</button>

    <h3>群組清單</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="群組名稱" style="margin-top:6px; padding:6px; border-radius:4px; border:none;">
    <button id="createGroupBtn" style="margin-top:6px;">建立群組</button>
  </div>

  <div class="chat-area" id="chatArea"></div>

  <div class="rightbar">
    <h3>好友請求</h3>
    <ul id="requestList"></ul>

    <h3>封鎖名單</h3>
    <ul id="blockList"></ul>

    <h3>全域公告 (高階管理員)</h3>
    <input id="globalMsg" placeholder="輸入公告" style="margin-top:6px; padding:6px; border-radius:4px; border:none;">
    <button id="sendGlobal" style="margin-top:6px;">發送公告</button>
  </div>
</div>
</div>

<script>
// Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginBtn = document.getElementById("loginBtn");
const loginPage = document.getElementById("loginPage");
const mainPage = document.getElementById("mainPage");
const userName = document.getElementById("userName");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const newGroupName = document.getElementById("newGroupName");
const createGroupBtn = document.getElementById("createGroupBtn");
const chatArea = document.getElementById("chatArea");
const requestList = document.getElementById("requestList");
const blockList = document.getElementById("blockList");
const globalMsg = document.getElementById("globalMsg");
const sendGlobal = document.getElementById("sendGlobal");

let userEmail = "";
let role = "user"; // user, admin, superadmin
let chatWindows = {};
let blocked = [];

// 登入
loginBtn.onclick = async ()=>{
  const userCred = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  userEmail = userCred.user.email;
  role = (userEmail === "chianghansen0302@gmail.com") ? 'superadmin' : 'user';
};

auth.onAuthStateChanged(async user=>{
  if(user){
    loginPage.style.display='none';
    mainPage.style.display='flex';
    userEmail = user.email;
    userName.textContent = `${user.displayName} (${userEmail})`;
    await db.collection("users").doc(userEmail).set({name:user.displayName,email:userEmail,role:role},{merge:true});
    loadFriends();
    loadGroups();
    loadRequests();
    loadBlocks();
  }
});

// 好友清單
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML='';
    snap.forEach(doc=>{
      const f = doc.data();
      if(blocked.includes(f.email)) return;
      const li = document.createElement("li");
      li.textContent = f.email;
      li.onclick=()=>openChat([userEmail,f.email].sort().join("_"), f.email);
      friendList.appendChild(li);
    });
  });
}

// 封鎖清單
function loadBlocks(){
  db.collection("users").doc(userEmail).collection("blocks").onSnapshot(snap=>{
    blockList.innerHTML='';
    blocked=[];
    snap.forEach(doc=>{
      const b=doc.id;
      blocked.push(b);
      const li=document.createElement("li");
      li.textContent=b;
      blockList.appendChild(li);
    });
  });
}

// 好友請求
function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests").where("status","==","pending")
    .onSnapshot(snap=>{
      requestList.innerHTML='';
      snap.forEach(doc=>{
        const data = doc.data();
        const li=document.createElement("li");
        li.textContent=`${data.from} 想加你為好友`;
        const accept=document.createElement("button");
        accept.textContent="同意";
        accept.onclick=async ()=>{
          await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
          await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
          await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
        };
        li.appendChild(accept);
        requestList.appendChild(li);
      });
    });
}

// 新增好友
addFriendBtn.onclick=async ()=>{
  const email=addFriendEmail.value.trim();
  if(!email || email===userEmail) return;
  await db.collection("users").doc(email).set({email},{merge:true});
  await db.collection("users").doc(email).collection("requests").add({from:userEmail,status:"pending",timestamp:firebase.firestore.FieldValue.serverTimestamp()});
}

// 群組清單
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML='';
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.id;
      li.onclick=()=>openChat(doc.id, doc.id);
      groupList.appendChild(li);
    });
  });
}

// 建立群組
createGroupBtn.onclick=async ()=>{
  if(role==='user') return alert('一般使用者無法創建群組');
  const name=newGroupName.value.trim();
  if(!name) return;
  await db.collection("groups").doc(name).set({createdBy:userEmail});
  newGroupName.value='';
}

// 開啟聊天窗
function openChat(roomId, title){
  if(chatWindows[roomId]) return;
  const win=document.createElement("div");
  win.className="chat-window";
  const header=document.createElement("div");
  header.className="chat-header";
  header.innerHTML=`<span>${title}</span>`;
  win.appendChild(header);
  const msgDiv=document.createElement("div");
  msgDiv.className="chat-messages";
  win.appendChild(msgDiv);
  const inputDiv=document.createElement("div");
  inputDiv.className="chat-input";
  const input=document.createElement("input");
  input.placeholder="輸入訊息...";
  const btn=document.createElement("button");
  btn.textContent="送出";
  inputDiv.appendChild(input);
  inputDiv.appendChild(btn);
  win.appendChild(inputDiv);
  chatArea.appendChild(win);

  btn.onclick=async ()=>{
    const text=input.value.trim();
    if(!text) return;
    await db.collection("messages").doc(roomId).collection("chats").add({from:userEmail,text,time:firebase.firestore.FieldValue.serverTimestamp()});
    input.value='';
  };

  db.collection("messages").doc(roomId).collection("chats").orderBy("time")
    .onSnapshot(snap=>{
      msgDiv.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data();
        if(blocked.includes(d.from)) return;
        const div=document.createElement("div");
        div.className="msg";
        div.textContent=`${d.from}: ${d.text}`;
        msgDiv.appendChild(div);
      });
      msgDiv.scrollTop=msgDiv.scrollHeight;
    });

  chatWindows[roomId]=true;
}

// 全域公告
sendGlobal.onclick=async ()=>{
  if(role!=='superadmin') return;
  const text=globalMsg.value.trim();
  if(!text) return;
  await db.collection("global").add({from:userEmail,text,time:firebase.firestore.FieldValue.serverTimestamp()});
  globalMsg.value='';
}
</script>

</body>
</html>
