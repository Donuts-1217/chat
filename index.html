<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ”¥ æœ€çµ‚ç‰ˆèŠå¤©å®¤ï¼ˆç®¡ç†å“¡ã€å°é–ã€ç¾¤çµ„ã€ç›£çœ‹ï¼‰</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  *{box-sizing:border-box;font-family:"Noto Sans TC","å¾®è»Ÿæ­£é»‘é«”",sans-serif}
  body{margin:0;background:#eef3fb;color:#111}
  /* Login */
  #loginPage{height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column}
  #loginBtn{padding:10px 16px;border:none;background:#4285f4;color:#fff;border-radius:8px;cursor:pointer}

  /* App container */
  #app{display:none;max-width:1200px;margin:18px auto;height:86vh;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
  header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #e7eefb;background:#fff}
  header .title{font-size:18px;font-weight:700}
  header .me{display:flex;align-items:center;gap:12px}

  .main{display:flex;height:calc(100% - 64px);}

  /* Left */
  .left{width:260px;background:#f7fafc;padding:10px;border-right:1px solid #e7eefb;display:flex;flex-direction:column}
  .meBox{padding:8px;background:#fff;border-radius:8px;border:1px solid #edf3fb;margin-bottom:8px}
  .listTitle{font-size:13px;margin:8px 0 6px 0;color:#333}
  .list{flex:1;background:#fff;border-radius:8px;border:1px solid #edf3fb;overflow:auto;padding:6px}
  .listItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer}
  .listItem:hover{background:#f0f6ff}
  .controls{display:flex;gap:8px;margin-top:8px}

  /* Center */
  .center{flex:1;padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto;background:linear-gradient(180deg,#fbfdff,#f7fbff)}
  .chatWindow{background:#fff;border-radius:10px;display:flex;flex-direction:column;min-height:140px;max-height:78vh;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .chatHead{background:#5865f2;color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  .chatMessages{padding:12px;overflow:auto;flex:1;background:linear-gradient(180deg,#fff,#f8fbff)}
  .bubble{background:#eaf2ff;padding:8px 10px;border-radius:8px;margin-bottom:8px;max-width:80%;word-break:break-word}
  .chatInput{display:flex;gap:8px;padding:10px;border-top:1px solid #eef3fb;background:#fff}
  .chatInput textarea{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef9;min-height:64px;max-height:160px;resize:none}
  .chatInput button{padding:8px 12px;border-radius:8px;border:none;background:#2ecc71;color:#fff;cursor:pointer}

  /* Right */
  .right{width:300px;background:#f7fafc;padding:10px;border-left:1px solid #e7eefb;display:flex;flex-direction:column}
  .smallList{background:#fff;border-radius:8px;border:1px solid #edf3fb;padding:8px;overflow:auto;flex:1}
  .requestItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px}
  .memberBtn{padding:6px 8px;border-radius:6px;border:none;background:#5865f2;color:#fff;cursor:pointer}
  .danger{background:#f44336 !important}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999}
  .modal .box{width:90%;max-width:720px;background:#fff;padding:16px;border-radius:8px;max-height:80vh;overflow:auto}
  .modal .row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5fa}

  @media(max-width:980px){
    .left,.right{display:none}
    .center{padding:8px}
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <h1>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆæœ€çµ‚ç‰ˆï¼‰</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
  <p style="color:#666;margin-top:8px">è«‹å…ˆæ–¼ Firebase Console å•Ÿç”¨ Google Sign-in ä¸¦è²¼ä¸Š Firestore è¦å‰‡</p>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="title">ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</div>
    <div class="me">
      <div style="text-align:right">
        <div id="meName" style="font-weight:700"></div>
        <div id="meEmail" style="font-size:13px;color:#666"></div>
      </div>
      <div id="adminBadge" style="display:none;background:#ffb300;color:#111;padding:6px;border-radius:6px;font-weight:700;margin-left:12px">ç®¡ç†å“¡</div>
      <button id="logoutBtn" style="margin-left:12px;padding:8px;border-radius:8px;border:none;background:#f44336;color:#fff;cursor:pointer">ç™»å‡º</button>
    </div>
  </header>

  <div class="main">
    <!-- left -->
    <div class="left">
      <div class="meBox">
        <div id="leftMeName" style="font-weight:700"></div>
        <div id="leftMeEmail" style="font-size:13px;color:#666"></div>
      </div>

      <div class="listTitle">å¥½å‹</div>
      <div class="list" id="friendList" aria-label="å¥½å‹æ¸…å–®"></div>

      <div class="controls">
        <input id="addFriendInput" placeholder="è¼¸å…¥ Gmail åŠ å¥½å‹" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef9">
        <button id="sendReqBtn" class="memberBtn">é€å‡º</button>
      </div>

      <div style="margin-top:12px" class="listTitle">ç¾¤çµ„</div>
      <div class="list" id="groupList"></div>

      <!-- å»ºç«‹ç¾¤çµ„æŒ‰éˆ•åªå°ç®¡ç†å“¡é¡¯ç¤º -->
      <div style="margin-top:8px" id="createGroupArea">
        <input id="newGroupInput" placeholder="è¼¸å…¥ç¾¤çµ„åç¨±" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9">
        <div style="display:flex;margin-top:8px;gap:8px">
          <button id="createGroupBtn" class="memberBtn">å»ºç«‹ç¾¤çµ„</button>
        </div>
      </div>
    </div>

    <!-- center -->
    <div class="center" id="center"></div>

    <!-- right -->
    <div class="right">
      <div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h4 style="margin:0">å¥½å‹è«‹æ±‚</h4>
        </div>
        <div class="smallList" id="requestList"></div>
      </div>

      <div style="margin-top:8px">
        <h4 style="margin:0">å°é–æ¸…å–®</h4>
        <div class="smallList" id="blockedList"></div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0">ç›£çœ‹ï¼ˆæœ€é«˜ç®¡ç†å“¡ï¼‰</h4>
        <input id="watchInput" placeholder="æ ¼å¼ï¼šemailA_emailB" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9;margin-top:8px">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="watchBtn" class="memberBtn">ç›£çœ‹</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Members Modal -->
<div id="modalMembers" class="modal"><div class="box">
  <h3 id="modalTitle">ç¾¤çµ„æˆå“¡</h3>
  <div id="modalMembersBody" style="margin-top:8px"></div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <input id="modalAddInput" placeholder="è¼¸å…¥ Gmail åŠ å…¥æˆå“¡" style="flex:1;padding:8px;border:1px solid #e6eef9;border-radius:8px">
    <button id="modalAddBtn" class="memberBtn">åŠ å…¥</button>
    <button id="modalCloseBtn" style="padding:8px;border-radius:8px">é—œé–‰</button>
  </div>
</div></div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= STATE ================= */
let ME = null;
let ME_EMAIL = "";
let ME_NAME = "";
const SUPER_ADMIN = "chianghansen0032@gmail.com";
let isAdmin = false;
const unsub = {};
const openChats = {};
const blockedSet = new Set();

/* ================= DOM ================= */
const loginPage = document.getElementById('loginPage');
const loginBtn = document.getElementById('loginBtn');
const app = document.getElementById('app');
const logoutBtn = document.getElementById('logoutBtn');
const meNameEl = document.getElementById('meName');
const meEmailEl = document.getElementById('meEmail');
const leftMeName = document.getElementById('leftMeName');
const leftMeEmail = document.getElementById('leftMeEmail');
const adminBadge = document.getElementById('adminBadge');

const friendListEl = document.getElementById('friendList');
const groupListEl = document.getElementById('groupList');
const centerEl = document.getElementById('center');
const requestListEl = document.getElementById('requestList');
const blockedListEl = document.getElementById('blockedList');

const addFriendInput = document.getElementById('addFriendInput');
const sendReqBtn = document.getElementById('sendReqBtn');
const newGroupInput = document.getElementById('newGroupInput');
const createGroupBtn = document.getElementById('createGroupBtn');
const createGroupArea = document.getElementById('createGroupArea');

const watchInput = document.getElementById('watchInput');
const watchBtn = document.getElementById('watchBtn');

/* modal */
const modalMembers = document.getElementById('modalMembers');
const modalMembersBody = document.getElementById('modalMembersBody');
const modalTitle = document.getElementById('modalTitle');
const modalAddInput = document.getElementById('modalAddInput');
const modalAddBtn = document.getElementById('modalAddBtn');
const modalCloseBtn = document.getElementById('modalCloseBtn');

/* ================ AUTH ================ */
loginBtn.onclick = async ()=>{
  try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  catch(e){ alert('ç™»å…¥å¤±æ•—ï¼š'+e.message); console.error(e); }
};
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  // cleanup listeners
  Object.values(unsub).forEach(u=>u && u());
  Object.values(openChats).forEach(o=>o.unsub && o.unsub());
  Object.keys(unsub).forEach(k=>delete unsub[k]);
  Object.keys(openChats).forEach(k=>delete openChats[k]);
  blockedSet.clear();
  // reset UI
  centerEl.innerHTML = '';
  friendListEl.innerHTML = '';
  groupListEl.innerHTML = '';
  requestListEl.innerHTML = '';
  blockedListEl.innerHTML = '';
  loginPage.style.display = 'block';
  app.style.display = 'none';
};

auth.onAuthStateChanged(async user=>{
  if(!user){ loginPage.style.display='block'; app.style.display='none'; return; }
  ME = user;
  ME_EMAIL = user.email;
  ME_NAME = user.displayName || ME_EMAIL.split('@')[0];
  isAdmin = (ME_EMAIL === SUPER_ADMIN);
  // ensure profile doc exists
  await db.collection('users').doc(ME_EMAIL).set({name:ME_NAME,email:ME_EMAIL,updatedAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  // UI
  loginPage.style.display='none';
  app.style.display='block';
  meNameEl.textContent = ME_NAME;
  meEmailEl.textContent = ME_EMAIL;
  leftMeName.textContent = ME_NAME;
  leftMeEmail.textContent = ME_EMAIL;
  adminBadge.style.display = isAdmin ? 'block' : 'none';

  // hide create group area for non-admin
  createGroupArea.style.display = isAdmin ? 'block' : 'none';

  setupListeners();
});

/* ============== LISTENERS SETUP ============== */
function setupListeners(){
  if(!unsub.friends){
    unsub.friends = db.collection('users').doc(ME_EMAIL).collection('friends').onSnapshot(snap=>renderFriends(snap), e=>console.error('friends snap err',e));
  }
  if(!unsub.requestsIn){
    unsub.requestsIn = db.collection('users').doc(ME_EMAIL).collection('requests').where('status','==','pending').onSnapshot(snap=>renderRequests(snap), e=>console.error(e));
  }
  if(!unsub.blocked){
    unsub.blocked = db.collection('users').doc(ME_EMAIL).collection('blocked').onSnapshot(snap=>renderBlocked(snap), e=>console.error(e));
  }
  if(!unsub.groups){
    unsub.groups = db.collection('groups').onSnapshot(snap=>renderGroups(snap), e=>console.error(e));
  }
}

/* ============== RENDER FRIENDS ============== */
function renderFriends(snap){
  friendListEl.innerHTML = '';
  snap.forEach(doc=>{
    const email = doc.id;
    const data = doc.data() || {};
    const item = document.createElement('div'); item.className='listItem';
    const left = document.createElement('div'); left.className='name'; left.textContent = data.name || email;
    const right = document.createElement('div');
    const chatBtn = document.createElement('button'); chatBtn.textContent='èŠå¤©'; chatBtn.className='memberBtn';
    chatBtn.onclick = (e)=>{ e.stopPropagation(); openPrivateChat(email, data.name||email); };
    const delBtn = document.createElement('button'); delBtn.textContent='åˆªé™¤'; delBtn.className='memberBtn danger';
    delBtn.onclick = async (e)=>{ e.stopPropagation(); if(!confirm('ç¢ºå®šåˆªé™¤å¥½å‹ï¼Ÿ')) return; await db.collection('users').doc(ME_EMAIL).collection('friends').doc(email).delete().catch(()=>null); await db.collection('users').doc(email).collection('friends').doc(ME_EMAIL).delete().catch(()=>null); };
    const blockBtn = document.createElement('button'); blockBtn.textContent='å°é–'; blockBtn.className='memberBtn';
    blockBtn.onclick = async (e)=>{ e.stopPropagation(); await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(email).set({email,at: firebase.firestore.FieldValue.serverTimestamp()}); alert('å·²å°é– '+email); };
    right.appendChild(chatBtn); right.appendChild(delBtn); right.appendChild(blockBtn);
    item.appendChild(left); item.appendChild(right);
    item.onclick = ()=> openPrivateChat(email, data.name||email);
    friendListEl.appendChild(item);
  });
}

/* ============== REQUESTS ============== */
function renderRequests(snap){
  requestListEl.innerHTML = '';
  snap.forEach(doc=>{
    const data = doc.data(); const id = doc.id;
    const div = document.createElement('div'); div.className='requestItem';
    const left = document.createElement('div'); left.textContent = data.from;
    const right = document.createElement('div');
    const accept = document.createElement('button'); accept.textContent='åŒæ„'; accept.className='memberBtn';
    accept.onclick = async ()=>{ await db.collection('users').doc(ME_EMAIL).collection('friends').doc(data.from).set({email:data.from}); await db.collection('users').doc(data.from).collection('friends').doc(ME_EMAIL).set({email:ME_EMAIL}); await db.collection('users').doc(ME_EMAIL).collection('requests').doc(id).update({status:'accepted',acceptedAt: firebase.firestore.FieldValue.serverTimestamp()}); alert('å·²æ¥å—å¥½å‹'); };
    const reject = document.createElement('button'); reject.textContent='æ‹’çµ•'; reject.className='memberBtn danger';
    reject.onclick = async ()=>{ await db.collection('users').doc(ME_EMAIL).collection('requests').doc(id).update({status:'rejected'}); };
    right.appendChild(accept); right.appendChild(reject);
    div.appendChild(left); div.appendChild(right);
    requestListEl.appendChild(div);
  });
}

/* ============== BLOCKED ============== */
function renderBlocked(snap){
  blockedListEl.innerHTML = ''; blockedSet.clear();
  snap.forEach(doc=>{
    const email = doc.id;
    blockedSet.add(email);
    const row = document.createElement('div'); row.className='listItem';
    row.textContent = email;
    const unb = document.createElement('button'); unb.textContent='è§£é™¤å°é–'; unb.className='memberBtn';
    unb.onclick = async (e)=>{ e.stopPropagation(); await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(email).delete().catch(()=>null); };
    row.appendChild(unb);
    blockedListEl.appendChild(row);
  });
}

/* ============== GROUPS ============== */
function renderGroups(snap){
  groupListEl.innerHTML = '';
  snap.forEach(doc=>{
    const name = doc.id; const data = doc.data() || {};
    const item = document.createElement('div'); item.className='listItem';
    const left = document.createElement('div'); left.className='name'; left.textContent = name;
    const right = document.createElement('div');
    const open = document.createElement('button'); open.textContent='é–‹å•Ÿ'; open.className='memberBtn';
    open.onclick = ()=> openGroupChat(name);
    const membersBtn = document.createElement('button'); membersBtn.textContent='æˆå“¡'; membersBtn.className='memberBtn';
    membersBtn.onclick = ()=> openMembersModal(name);
    right.appendChild(open); right.appendChild(membersBtn);
    item.appendChild(left); item.appendChild(right);
    groupListEl.appendChild(item);
  });
}

/* create group only if admin */
createGroupBtn.onclick = async ()=>{
  if(!isAdmin) return alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥å»ºç«‹ç¾¤çµ„');
  const name = newGroupInput.value.trim();
  if(!name) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
  // create group with empty members/admins arrays (does NOT add creator automatically per spec)
  await db.collection('groups').doc(name).set({createdBy: ME_EMAIL, members: [], admins: [ME_EMAIL], createdAt: firebase.firestore.FieldValue.serverTimestamp()});
  newGroupInput.value = '';
  alert('ç¾¤çµ„å·²å»ºç«‹ï¼ˆæœªè‡ªå‹•åŠ å…¥ä»»ä½•æˆå“¡ï¼‰');
};

/* ============== MEMBERS MODAL ============== */
let currentModalGroup = null;
function openMembersModal(groupId){
  currentModalGroup = groupId;
  modalMembers.style.display = 'flex';
  modalTitle.textContent = 'ç¾¤çµ„æˆå“¡ â€” ' + groupId;
  modalMembersBody.innerHTML = '<div style="color:#666">è¼‰å…¥ä¸­...</div>';
  db.collection('groups').doc(groupId).get().then(doc=>{
    if(!doc.exists){ modalMembersBody.innerHTML = '<div>æ‰¾ä¸åˆ°è©²ç¾¤çµ„</div>'; return; }
    const data = doc.data();
    const members = data.members || [];
    const admins = data.admins || [];
    modalMembersBody.innerHTML = '';
    members.forEach(m=>{
      const row = document.createElement('div'); row.className='row';
      const left = document.createElement('div'); left.textContent = m + (admins.includes(m)?' (ç®¡ç†å“¡)':'');
      const right = document.createElement('div');
      const amIAdmin = (admins.includes(ME_EMAIL) || isAdmin || data.createdBy === ME_EMAIL);
      if(amIAdmin && m !== ME_EMAIL){
        const kick = document.createElement('button'); kick.textContent='è¸¢å‡º'; kick.className='memberBtn danger';
        kick.onclick = async ()=>{ if(!confirm('ç¢ºå®šè¸¢å‡º '+m+'ï¼Ÿ')) return; await db.collection('groups').doc(groupId).update({members: firebase.firestore.FieldValue.arrayRemove(m)}); openMembersModal(groupId); };
        right.appendChild(kick);
      }
      if(m === ME_EMAIL){
        const leave = document.createElement('button'); leave.textContent='é€€å‡º'; leave.className='memberBtn';
        leave.onclick = async ()=>{ if(!confirm('ç¢ºå®šé€€å‡ºç¾¤çµ„ï¼Ÿ')) return; await db.collection('groups').doc(groupId).update({members: firebase.firestore.FieldValue.arrayRemove(ME_EMAIL)}); modalMembers.style.display='none'; };
        right.appendChild(leave);
      }
      row.appendChild(left); row.appendChild(right);
      modalMembersBody.appendChild(row);
    });
  }).catch(e=>{ modalMembersBody.innerHTML = '<div>è¼‰å…¥å¤±æ•—</div>'; console.error(e); });
}
modalCloseBtn.onclick = ()=>{ modalMembers.style.display='none'; currentModalGroup = null; };
modalAddBtn.onclick = async ()=>{
  const email = modalAddInput.value.trim();
  if(!email) return alert('è«‹è¼¸å…¥ Gmail');
  if(!currentModalGroup) return alert('æœªé¸æ“‡ç¾¤çµ„');
  const gdoc = await db.collection('groups').doc(currentModalGroup).get();
  if(!gdoc.exists) return alert('æ‰¾ä¸åˆ°è©²ç¾¤çµ„');
  const data = gdoc.data(); const admins = data.admins || [];
  const canAdd = (admins.includes(ME_EMAIL) || isAdmin || data.createdBy === ME_EMAIL);
  if(!canAdd) return alert('æ‚¨æ²’æœ‰æ¬Šé™åŠ å…¥æˆå“¡ï¼ˆç¾¤çµ„ç®¡ç†å“¡å¯åŠ å…¥ï¼‰');
  await db.collection('groups').doc(currentModalGroup).update({members: firebase.firestore.FieldValue.arrayUnion(email)});
  modalAddInput.value = '';
  openMembersModal(currentModalGroup);
  alert('å·²åŠ å…¥ '+email);
};

/* ============== CHAT WINDOWS ============== */
function openPrivateChat(otherEmail, displayName){
  const roomId = [ME_EMAIL, otherEmail].sort().join('_');
  openChatWindow(roomId, displayName, false);
}
function openGroupChat(groupName){
  openChatWindow(groupName, groupName, false);
}

function openChatWindow(roomId, title, readonly=false){
  if(openChats[roomId]) {
    // bring to front
    const el = openChats[roomId].el; el.parentElement.prepend(el); return;
  }
  // DOM
  const chat = document.createElement('div'); chat.className='chatWindow';
  const head = document.createElement('div'); head.className='chatHead';
  head.innerHTML = `<div style="font-weight:700">${title}</div><div><button class="memberBtn">é—œé–‰</button></div>`;
  const msgs = document.createElement('div'); msgs.className='chatMessages';
  const inputRow = document.createElement('div'); inputRow.className='chatInput';
  const ta = document.createElement('textarea'); ta.placeholder='è¼¸å…¥è¨Šæ¯...(Shift+Enter æ›è¡Œ)'; ta.style.resize='none';
  const sendBtn = document.createElement('button'); sendBtn.textContent='é€å‡º';
  inputRow.appendChild(ta); inputRow.appendChild(sendBtn);
  chat.appendChild(head); chat.appendChild(msgs); chat.appendChild(inputRow);
  centerEl.prepend(chat);

  head.querySelector('button').onclick = ()=>{ chat.remove(); const o=openChats[roomId]; if(o && o.unsub) o.unsub(); delete openChats[roomId]; };

  const ref = db.collection('messages').doc(roomId).collection('chats').orderBy('time','desc').limit(100);
  const unsubRef = ref.onSnapshot(async snap=>{
    msgs.innerHTML = '';
    const docs = snap.docs.slice().reverse();
    for(const d of docs){
      const v = d.data();
      if(blockedSet.has(v.from)) continue;
      const bubble = document.createElement('div'); bubble.className='bubble';
      bubble.textContent = `${v.from}: ${v.text}`;
      // if admin, add delete btn
      if(isAdmin){
        const del = document.createElement('button'); del.textContent='åˆªé™¤'; del.className='memberBtn danger'; del.style.marginLeft='8px';
        del.onclick = async (e)=>{ e.stopPropagation(); if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å‰‡è¨Šæ¯ï¼Ÿ')) return; await d.ref.delete().catch(err=>alert('åˆªé™¤å¤±æ•—ï¼š'+err.message)); };
        bubble.appendChild(del);
      }
      msgs.appendChild(bubble);
    }
    msgs.scrollTop = msgs.scrollHeight;
  }, err=>{ msgs.innerHTML = '<div style="color:#c00">è¼‰å…¥èŠå¤©å¤±æ•—</div>'; console.error(err); });
  openChats[roomId] = {unsub:unsubRef, el:chat};

  sendBtn.onclick = async ()=>{
    const text = ta.value.trim(); if(!text) return;
    if(roomId.includes('_')){
      const parts = roomId.split('_'); const other = parts[0] === ME_EMAIL ? parts[1] : parts[0];
      if(blockedSet.has(other)) return alert('ä½ å·²å°é–å°æ–¹ï¼Œç„¡æ³•ç™¼è¨Šæ¯');
      try{
        const otherBlocked = await db.collection('users').doc(other).collection('blocked').doc(ME_EMAIL).get();
        if(otherBlocked.exists) return alert('å°æ–¹å·²å°é–ä½ ï¼Œç„¡æ³•ç™¼è¨Šæ¯');
      }catch(e){ console.warn('æª¢æŸ¥å°æ–¹å°é–å¤±æ•—', e); }
    }
    await db.collection('messages').doc(roomId).collection('chats').add({from: ME_EMAIL, text, time: firebase.firestore.FieldValue.serverTimestamp()});
    ta.value = '';
  };

  ta.addEventListener('keydown', e=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

  // if readonly or admin opened as watch => hide input
  if(readonly){
    inputRow.style.display = 'none';
  }
}

/* ============== SEND FRIEND REQUEST ============== */
sendReqBtn.onclick = async ()=>{
  const to = addFriendInput.value.trim();
  if(!to) return alert('è«‹è¼¸å…¥å°æ–¹ Gmail');
  if(to === ME_EMAIL) return alert('ä¸èƒ½åŠ è‡ªå·±');
  try{
    await db.collection('users').doc(to).set({email:to},{merge:true});
    await db.collection('users').doc(to).collection('requests').add({from:ME_EMAIL,status:'pending',time: firebase.firestore.FieldValue.serverTimestamp()});
    addFriendInput.value = '';
    alert('å¥½å‹è«‹æ±‚å·²é€å‡º');
  }catch(e){ alert('é€å‡ºå¤±æ•—ï¼š'+e.message); console.error(e); }
};

/* ============== WATCH (admin only) ============== */
watchBtn.onclick = ()=>{
  if(!isAdmin) return alert('åƒ…é™æœ€é«˜ç®¡ç†å“¡ä½¿ç”¨');
  const v = watchInput.value.trim();
  if(!v || !v.includes('_')) return alert('æ ¼å¼ï¼šemailA_emailB');
  openChatWindow(v, 'ç›£çœ‹: '+v, true);
  // hide input row if present
  const o = openChats[v];
  if(o && o.el){ const inputEl = o.el.querySelector('.chatInput'); if(inputEl) inputEl.style.display='none'; }
};

/* ============== CLEANUP ============== */
window.addEventListener('beforeunload', ()=>{
  Object.values(unsub).forEach(u=>u && u());
  Object.values(openChats).forEach(c=>c.unsub && c.unsub());
});
</script>
</body>
</html>
