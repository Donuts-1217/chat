<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ v3 (å®Œæ•´åŠŸèƒ½ç‰ˆ)</title>

<!-- Firebase compatibility SDKs for single-file use -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- Load Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --bg:#0f1724; --panel:#111827; --muted:#9ca3af; --accent:#5865f2; --accent-2:#2ecc71; --danger:#ef4444;
  --card:#0b1020; --hover:#1f2937;
}
*{box-sizing:border-box;font-family:Inter, "Noto Sans TC", "å¾®è»Ÿæ­£é»‘é«”", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
body{margin:0;background:linear-gradient(180deg,#071025 0%, #071223 100%);color:#e6eef8; height: 100vh; overflow: hidden;}
a{color:inherit}
.center{display:flex;justify-content:center;align-items:center} /* ä¿æŒé€™å€‹é¡åˆ¥ä¾›å…¶ä»–çµ„ä»¶ä½¿ç”¨ */

/* App Layout */
#app-container{
  display:flex;
  height:100vh;
  max-width:1400px;
  margin:0 auto;
}

/* Sidebar (Left Panel) */
#sidebar{
  width:300px; /* Wider sidebar for more controls */
  min-width:300px;
  background-color:var(--panel);
  padding:16px 12px;
  border-right:1px solid #1f2937;
  display:flex;
  flex-direction:column;
}
.sidebar-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  transition:background-color 0.2s, transform 0.1s;
  margin-bottom:4px;
}
.sidebar-item:hover{
  background-color:var(--hover);
  transform: translateY(-1px);
}
.sidebar-item.active{
  background-color:var(--accent);
  box-shadow: 0 2px 5px rgba(88, 101, 242, 0.3);
}
.sidebar-item.active:hover{
  background-color:var(--accent);
}
.message-avatar{
  width:36px;
  height:36px;
  border-radius:9999px;
  background-color:var(--accent);
  flex-shrink:0;
  font-weight:700;
  font-size:0.9rem;
}
.chat-avatar-lg { width: 50px; height: 50px; font-size: 1.5rem; }

/* Chat Area (Right Panel) */
#chat-area{
  flex-grow:1;
  background-color:var(--bg);
  display:flex;
  flex-direction:column;
}

/* Chat Header */
.chat-header{
  padding:12px 16px;
  background-color:var(--panel);
  border-bottom:1px solid #1f2937;
  font-size:1.25rem;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.chat-header button{
  padding:6px 12px;
  border-radius:6px;
  font-size:0.875rem;
  transition:background-color 0.2s;
}

/* Message List */
.message-list{
  flex-grow:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.message-list::-webkit-scrollbar { width: 8px; }
.message-list::-webkit-scrollbar-thumb { background-color: #374151; border-radius: 4px; }
.message-list::-webkit-scrollbar-track { background-color: #1f2937; }

/* Message Item */
.message-item{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.message-content{
  flex-grow:1;
}
.message-meta{
  display:flex;
  align-items:baseline;
  gap:8px;
  font-size:0.875rem;
  color:var(--muted);
  margin-bottom:2px;
}
.message-meta .username{
  color:#e6eef8;
  font-weight:600;
  font-size:1rem;
}
.message-text{
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.5;
}

/* Chat Input */
.chat-input-container{
  padding:16px;
  background-color:var(--panel);
  border-top:1px solid #1f2937;
}
.chat-input-box{
  background-color:var(--card);
  border-radius:12px;
  display:flex;
  align-items:flex-end;
  overflow:hidden;
}
.chat-input-box textarea{
  flex-grow:1;
  background:transparent;
  border:none;
  outline:none;
  padding:12px 16px;
  resize:none;
  color:inherit;
  min-height:48px;
  max-height:150px;
}
.chat-input-box button{
  padding:12px 16px;
  background-color:var(--accent);
  color:white;
  font-weight:600;
  border:none;
  outline:none;
  cursor:pointer;
  transition:background-color 0.2s;
  min-height:48px;
}
.chat-input-box button:hover{
  background-color:#4752c4;
}

/* Tab Controls */
.tab-btn {
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s;
  font-weight: 600;
  color: var(--muted);
}
.tab-btn.active {
  background-color: var(--accent);
  color: white;
}
.tab-btn:not(.active):hover {
  background-color: var(--hover);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #sidebar {
    width: 100%;
    min-width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid #1f2937;
  }
  #app-container {
    flex-direction: column;
  }
  #chat-area {
    height: calc(100vh - 200px); /* Adjust based on collapsed sidebar height */
  }
}
</style>
</head>
<body class="center">

<!-- Message Box Modal (for errors/alerts/confirmations) -->
<div id="message-box" class="center fixed inset-0 bg-black/70 z-[2000] hidden">
  <div class="message-box-content bg-panel p-6 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300 transform scale-100">
    <div id="message-box-header" class="text-xl font-bold mb-2 text-accent">æ¨™é¡Œ</div>
    <div id="message-box-body" class="text-white mb-6">å…§å®¹</div>
    <div class="message-box-footer flex justify-end gap-3">
      <button id="message-box-cancel-btn" class="hidden bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition duration-150">å–æ¶ˆ</button>
      <button id="message-box-ok-btn" class="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-150">ç¢ºå®š</button>
    </div>
  </div>
</div>

<!-- Login Screen (Page 1) -->
<div id="login-screen" class="fixed inset-0 bg-bg z-[3000] flex items-center justify-center hidden">
  <div class="login-card bg-panel p-10 rounded-2xl text-center shadow-2xl max-w-md w-11/12">
    <h1 class="text-3xl font-extrabold mb-2 text-accent-2">æ ¡åœ’èŠå¤©å®¤ ğŸ”¥</h1>
    <p class="text-gray-400 mb-6">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥é–‹å§‹èˆ‡æœ‹å‹èŠå¤©ã€‚</p>
    <button id="googleLoginBtn" class="bg-white text-gray-900 px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition duration-200 flex items-center justify-center mx-auto transform hover:scale-[1.02]">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" class="mr-3"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,7.917-11.303,7.917c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238c-2.053,1.383-4.524,2.19-7.219,2.19c-5.202,0-9.619-3.317-11.283-7.746l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.08,5.55l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
      ä½¿ç”¨ Google ç™»å…¥
    </button>
  </div>
</div>

<!-- Main Application Container (Page 2) -->
<div id="app-container" class="hidden">
  
  <!-- Sidebar (Left Panel) -->
  <div id="sidebar">
    <h2 class="text-2xl font-bold mb-4 text-white">ğŸ”¥ èŠå¤©å®¤</h2>
    
    <!-- Tab Controls -->
    <div class="flex gap-1 mb-4 border-b border-gray-700 pb-2">
      <div id="tab-dm" class="tab-btn active" data-tab="dm">ç§èŠ</div>
      <div id="tab-group" class="tab-btn" data-tab="group">ç¾¤çµ„</div>
      <div id="tab-request" class="tab-btn" data-tab="request">è«‹æ±‚ (<span id="request-count">0</span>)</div>
    </div>
    
    <!-- Friend Search Section (Always visible) -->
    <div class="mb-4">
      <input id="friendSearchInput" type="email" placeholder="æœå°‹æˆ–ç™¼é€å¥½å‹è«‹æ±‚ (Email)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm text-white focus:ring-accent focus:border-accent" />
      <button id="sendRequestBtn" class="w-full mt-2 bg-accent hover:bg-blue-600 text-white text-sm font-semibold px-3 py-2 rounded-lg transition duration-150">ç™¼é€è«‹æ±‚</button>
    </div>

    <!-- Content List Container -->
    <div id="content-list-container" class="flex flex-col gap-2 flex-grow overflow-y-auto mb-4">
      <!-- DM List (Active by default) -->
      <div id="dm-list" class="tab-content">
        <p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰é€²è¡Œä¸­çš„ç§èŠ...</p>
      </div>

      <!-- Group List (Hidden by default) -->
      <div id="group-list" class="tab-content hidden">
        <p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰åŠ å…¥ä»»ä½•ç¾¤çµ„...</p>
      </div>

      <!-- Request List (Hidden by default) -->
      <div id="request-list" class="tab-content hidden">
        <p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰å¾…è™•ç†çš„å¥½å‹è«‹æ±‚...</p>
      </div>
    </div>
    
    <!-- Admin & Monitor Controls (Visible only to Admin) -->
    <div id="admin-controls" class="p-3 border border-gray-700 rounded-xl mb-4 bg-gray-800/50 hidden">
      <h3 class="text-sm font-semibold mb-2 text-red-400">ğŸš¨ ç®¡ç†å“¡å°ˆå€</h3>
      <button id="createGroupBtn" class="w-full bg-accent-2 hover:bg-green-600 text-white text-sm px-3 py-2 rounded-lg transition duration-150 mb-2">å»ºç«‹æ–°ç¾¤çµ„</button>
      <div class="flex gap-2 items-center">
        <input id="monitorInput" type="text" placeholder="emailA_emailB ç›£çœ‹" class="flex-grow bg-gray-700 border border-gray-600 rounded-md p-2 text-xs text-white" />
        <button id="monitorBtn" class="bg-red-600 hover:bg-red-500 text-white text-xs font-semibold px-3 py-2 rounded-lg transition duration-150">ç›£çœ‹</button>
      </div>
    </div>

    <!-- User Info Footer -->
    <div id="user-info" class="p-3 bg-gray-800 rounded-xl shadow-inner">
      <div class="flex items-center gap-3">
        <div id="me-avatar" class="center message-avatar bg-accent-2"></div>
        <div class="flex-grow min-w-0">
          <div id="me-email" class="text-sm font-medium truncate">loading...</div>
          <div id="me-role" class="text-xs text-green-400 font-semibold">user</div>
        </div>
        <button id="logoutBtn" class="text-red-400 hover:text-red-300 transition duration-150 p-2 rounded-lg hover:bg-gray-700" title="ç™»å‡º">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Area (Right Panel) -->
  <div id="chat-area">
    <div id="current-chat-header" class="chat-header">
      <div class="flex items-center gap-3">
        <div id="chat-avatar" class="center chat-avatar-lg bg-gray-600">?</div>
        <span id="chat-title">é¸æ“‡ä¸€å€‹èŠå¤©ä¾†é–‹å§‹</span>
      </div>
      <div id="chat-actions" class="flex gap-2">
        <!-- Action buttons (Block/Delete/Group Management) will be inserted here -->
      </div>
    </div>
    
    <!-- Main Chat Content -->
    <div id="current-chat-content" class="flex flex-col flex-grow">
      
      <div id="default-message" class="center flex-col flex-grow text-gray-500 text-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-dots mb-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M10 8h.01"/><path d="M14 8h.01"/><path d="M18 8h.01"/></svg>
        <p>é»æ“Šå·¦å´åˆ—è¡¨ä¸­çš„å¥½å‹æˆ–ç¾¤çµ„å³å¯é–‹å§‹èŠå¤©</p>
      </div>

      <!-- Live Chat Window (Hidden by default) -->
      <div id="live-chat-window" class="flex-col flex-grow hidden">
        <div class="flex-grow flex overflow-hidden">
          
          <!-- Message List -->
          <div id="message-list" class="message-list flex-grow">
            <!-- Messages inserted here -->
          </div>
          
          <!-- Group Member List (Visible only for group chats) -->
          <div id="group-member-list" class="w-1/4 min-w-[200px] border-l border-gray-700 p-4 bg-gray-800/50 hidden overflow-y-auto">
            <h4 class="text-sm font-bold mb-3 text-white">ç¾¤çµ„æˆå“¡ (<span id="member-count">0</span>)</h4>
            <div id="member-list-content" class="flex flex-col gap-2">
              <!-- Members inserted here -->
            </div>
            <div id="group-management-admin" class="mt-4 pt-4 border-t border-gray-700 hidden">
              <h5 class="text-sm font-bold mb-2 text-red-400">ç®¡ç†æˆå“¡</h5>
              <input id="manageMemberEmail" type="email" placeholder="æˆå“¡ Email" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-xs text-white mb-2" />
              <button id="addMemberBtn" class="w-full bg-accent hover:bg-blue-600 text-white text-xs font-semibold px-3 py-2 rounded-lg transition duration-150 mb-1">åŠ å…¥æˆå“¡</button>
              <button id="removeMemberBtn" class="w-full bg-danger hover:bg-red-600 text-white text-xs font-semibold px-3 py-2 rounded-lg transition duration-150">è¸¢å‡ºæˆå“¡</button>
            </div>
          </div>
        </div>

        <div id="chat-input-container" class="chat-input-container">
          <div id="block-info" class="text-sm text-red-400 mb-2 p-2 rounded-lg bg-red-900/30 hidden">
              æ‚¨å·²è¢«å°æ–¹å°é–ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚
          </div>
          <div class="chat-input-box">
            <textarea id="chat-input-textarea" placeholder="è¼¸å…¥è¨Šæ¯... (Enter é€å‡º, Shift+Enter æ›è¡Œ)" rows="1"></textarea>
            <button id="chat-send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
// Global Variables for Firebase configuration provided by the environment
const ADMIN_EMAIL = 'chianghansen0302@gmail.com';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// -----------------------------------------------------------------------
// âš ï¸ ä¿®æ­£: å°‡æ‚¨æä¾›çš„é…ç½®è¨­ç‚ºå„ªå…ˆ fallback
// -----------------------------------------------------------------------
const DEFAULT_FIREBASE_CONFIG = {
    apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
    authDomain: "chat-52c0d.firebaseapp.com",
    projectId: "chat-52c0d",
    storageBucket: "chat-52c0d.firebasestorage.app",
    messagingSenderId: "449329325475",
    appId: "1:449329325475:web:75f255c4055360dc9e6616",
    measurementId: "G-8R8648H53V"
};

const firebaseConfig = (() => {
    try {
        const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const config = JSON.parse(configStr);
        // å¦‚æœç’°å¢ƒé…ç½®ä¸å®Œæ•´ (ä¾‹å¦‚ç¼ºå°‘ apiKey)ï¼Œå‰‡ä½¿ç”¨é è¨­é…ç½®
        if (!config.apiKey) {
            console.warn("Environment Firebase config is missing or invalid. Falling back to default configuration.");
            return DEFAULT_FIREBASE_CONFIG;
        }
        return config;
    } catch (e) {
        console.error("Failed to parse __firebase_config, falling back to default:", e);
        return DEFAULT_FIREBASE_CONFIG;
    }
})();
// -----------------------------------------------------------------------

const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebase App Initialization
let app, db, auth;

// Global state variables
let ME_EMAIL = null;
let ME_ID = null;
let ME_ROLE = 'user';
const unsubs = []; // Array to store firestore unsubscribe functions
let currentRoomId = null;
let currentChatType = null; // 'dm', 'group', or 'monitor'
let currentOtherEmail = null;

// DOM Elements
const loginScreen = document.getElementById('login-screen');
const appContainer = document.getElementById('app-container');
const googleLoginBtn = document.getElementById('googleLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');

// Sidebar Elements
const tabBtns = { dm: document.getElementById('tab-dm'), group: document.getElementById('tab-group'), request: document.getElementById('tab-request') };
const tabContents = { dm: document.getElementById('dm-list'), group: document.getElementById('group-list'), request: document.getElementById('request-list') };
const requestCountEl = document.getElementById('request-count');
const friendSearchInput = document.getElementById('friendSearchInput');
const sendRequestBtn = document.getElementById('sendRequestBtn');
const adminControls = document.getElementById('admin-controls');
const monitorInput = document.getElementById('monitorInput');
const monitorBtn = document.getElementById('monitorBtn');
const createGroupBtn = document.getElementById('createGroupBtn');

// Chat Area Elements
const chatHeader = document.getElementById('chat-title');
const chatAvatar = document.getElementById('chat-avatar');
const chatActions = document.getElementById('chat-actions');
const messageList = document.getElementById('message-list');
const liveChatWindow = document.getElementById('live-chat-window');
const defaultMessage = document.getElementById('default-message');
const chatInputContainer = document.getElementById('chat-input-container');
const chatInputTextarea = document.getElementById('chat-input-textarea');
const chatSendBtn = document.getElementById('chat-send-btn');
const blockInfo = document.getElementById('block-info');
const groupMemberList = document.getElementById('group-member-list');
const memberListContent = document.getElementById('member-list-content');
const memberCountEl = document.getElementById('member-count');
const groupManagementAdmin = document.getElementById('group-management-admin');
const manageMemberEmail = document.getElementById('manageMemberEmail');
const addMemberBtn = document.getElementById('addMemberBtn');
const removeMemberBtn = document.getElementById('removeMemberBtn');

/* ==================== Utility Functions ==================== */

/**
 * Custom function to display error/success messages instead of alert() and confirm().
 * @param {string} title - The title of the message box.
 * @param {string} body - The content of the message.
 * @param {string} type - 'success', 'error', 'info', or 'confirm'.
 * @returns {Promise<boolean>} Resolves with true for OK, false for Cancel (only for 'confirm').
 */
function showMessage(title, body, type = 'info') {
    return new Promise(resolve => {
        const box = document.getElementById('message-box');
        const header = document.getElementById('message-box-header');
        const bodyEl = document.getElementById('message-box-body');
        const okBtn = document.getElementById('message-box-ok-btn');
        const cancelBtn = document.getElementById('message-box-cancel-btn');

        header.textContent = title;
        bodyEl.textContent = body;

        // Apply color based on type
        header.style.color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--accent-2)' : 'var(--accent)';

        // Setup buttons and visibility
        if (type === 'confirm') {
            cancelBtn.classList.remove('hidden');
            okBtn.textContent = 'ç¢ºå®š';
            okBtn.onclick = () => { box.classList.add('hidden'); resolve(true); };
            cancelBtn.onclick = () => { box.classList.add('hidden'); resolve(false); };
        } else {
            cancelBtn.classList.add('hidden');
            okBtn.textContent = 'ç¢ºå®š';
            okBtn.onclick = () => { box.classList.add('hidden'); resolve(true); };
        }

        box.classList.remove('hidden');
    });
}

/**
 * Helper to generate a consistent DM room ID regardless of user order.
 * @param {string} emailA
 * @param {string} emailB
 * @returns {string} The canonical room ID (email_sorted_A + "_" + email_sorted_B)
 */
function getDmRoomId(emailA, emailB) {
    const emails = [emailA.toLowerCase(), emailB.toLowerCase()].sort();
    return emails[0] + "_" + emails[1];
}

/**
 * Creates the HTML for a message item.
 */
function createMessageHtml(message) {
    const fromEmail = message.from || message.sender; // Handle both DM (from) and Group (sender) fields
    const isMe = fromEmail === ME_EMAIL;
    const initial = fromEmail ? fromEmail.charAt(0).toUpperCase() : '?';
    const timestamp = message.time ? new Date(message.time.seconds * 1000).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : 'ç™¼é€ä¸­...';
    
    // Check if I am blocked (Only relevant for DM chats, but keep the check generic)
    // The actual block check for sending happens in setupChatInput
    const isBlockedMessage = message.isBlocked === true; 
    
    return `
        <div class="message-item ${isMe ? 'self-end flex-row-reverse' : ''} ${isBlockedMessage ? 'opacity-50' : ''}">
            <div class="center message-avatar ${isMe ? 'bg-blue-500' : 'bg-green-500'}">
                ${initial}
            </div>
            <div class="message-content ${isMe ? 'text-right' : 'text-left'}">
                <div class="message-meta ${isMe ? 'flex-row-reverse' : ''}">
                    <span class="username">${isMe ? 'æˆ‘' : fromEmail}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-text p-2 rounded-xl max-w-lg ${isMe ? 'bg-blue-600' : 'bg-gray-700'} inline-block shadow-md">
                    ${message.text}
                </div>
            </div>
        </div>
    `;
}

// Global function to clear all active listeners
function clearUnsubs() {
    unsubs.forEach(u => u && u());
    unsubs.length = 0;
}

/* ==================== UI / Tab Management ==================== */

function switchTab(targetTab) {
    ['dm', 'group', 'request'].forEach(tab => {
        const isActive = tab === targetTab;
        tabBtns[tab].classList.toggle('active', isActive);
        tabContents[tab].classList.toggle('hidden', !isActive);
    });
}

// Tab button click listeners
Object.keys(tabBtns).forEach(tab => {
    tabBtns[tab].onclick = () => switchTab(tab);
});

/* ==================== Chat Actions (Block/Delete/Group Management) ==================== */

/**
 * Renders the action buttons (Block/Delete) in the chat header for DMs.
 */
function renderDmActions(otherEmail) {
    chatActions.innerHTML = `
        <button id="blockBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white transition duration-150">å°é–</button>
        <button id="deleteFriendBtn" class="bg-red-600 hover:bg-red-700 text-white transition duration-150">åˆªé™¤å¥½å‹</button>
    `;

    document.getElementById('blockBtn').onclick = () => handleBlockUser(otherEmail);
    document.getElementById('deleteFriendBtn').onclick = () => handleDeleteFriend(otherEmail);
}

/**
 * Renders the group info (currently none) for group chats.
 */
function renderGroupActions() {
    chatActions.innerHTML = ''; // Groups don't need Block/Delete Friend buttons here
    // Toggling the group member list is handled in openChatWindow
}

async function handleBlockUser(otherEmail) {
    const confirmed = await showMessage('ç¢ºèªå°é–', `æ‚¨ç¢ºå®šè¦å°é–ç”¨æˆ¶ ${otherEmail} å—ï¼Ÿå°é–å¾Œæ‚¨å°‡ç„¡æ³•æ”¶åˆ°ä»–çš„è¨Šæ¯ï¼Œä»–ä¹Ÿç„¡æ³•å°æ‚¨ç™¼é€è¨Šæ¯ã€‚`, 'confirm');
    if (!confirmed) return;

    try {
        // Create a document in my block list
        await db.collection('blocks').doc(ME_EMAIL).collection('locked').doc(otherEmail).set({
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showMessage('å°é–æˆåŠŸ', `${otherEmail} å·²è¢«æ‚¨å°é–ã€‚`, 'success');
        
        // Optional: Close the chat window and refresh the DM list
        if (currentOtherEmail === otherEmail) {
            closeChatWindow();
            // User will reappear in DM list but chat is blocked.
        }

    } catch (e) {
        showMessage('æ“ä½œå¤±æ•—', 'å°é–ç”¨æˆ¶å¤±æ•—ã€‚', 'error');
        console.error("Block user error: ", e);
    }
}

async function handleDeleteFriend(otherEmail) {
    const confirmed = await showMessage('ç¢ºèªåˆªé™¤', `æ‚¨ç¢ºå®šè¦åˆªé™¤å¥½å‹ ${otherEmail} å—ï¼Ÿæ‚¨å°‡ç„¡æ³•å†ç§èŠã€‚`, 'confirm');
    if (!confirmed) return;

    try {
        // 1. Delete friend status from my list
        await db.collection('friends').doc(ME_EMAIL).collection('list').doc(otherEmail).delete();
        // 2. Delete friend status from their list (Assuming symmetric friendship)
        await db.collection('friends').doc(otherEmail).collection('list').doc(ME_EMAIL).delete();

        showMessage('åˆªé™¤æˆåŠŸ', `${otherEmail} å·²å¾æ‚¨çš„å¥½å‹åˆ—è¡¨ä¸­åˆªé™¤ã€‚`, 'success');
        
        // Close the chat window and refresh the DM list
        if (currentOtherEmail === otherEmail) {
            closeChatWindow();
        }
    } catch (e) {
        showMessage('æ“ä½œå¤±æ•—', 'åˆªé™¤å¥½å‹å¤±æ•—ã€‚', 'error');
        console.error("Delete friend error: ", e);
    }
}

/* ==================== Core Chat Window Logic ==================== */

/**
 * Closes the currently open chat window and clears its state.
 */
function closeChatWindow() {
    // Unsubscribe previous listener
    clearUnsubs();
    
    // Reset state
    currentRoomId = null;
    currentChatType = null;
    currentOtherEmail = null;

    // Reset UI
    chatHeader.textContent = 'é¸æ“‡ä¸€å€‹èŠå¤©ä¾†é–‹å§‹';
    chatAvatar.textContent = '?';
    chatAvatar.className = 'center chat-avatar-lg bg-gray-600';
    chatActions.innerHTML = '';
    liveChatWindow.classList.add('hidden');
    defaultMessage.classList.remove('hidden');
    groupMemberList.classList.add('hidden');
    Array.from(document.querySelectorAll('.sidebar-item')).forEach(el => el.classList.remove('active'));
}

/**
 * Opens a specific chat window and sets up the listener.
 * @param {string} id - RoomId or GroupId.
 * @param {string} title - The title to display in the chat header.
 * @param {'dm' | 'group' | 'monitor'} type - Type of chat.
 * @param {string | null} otherEmail - The email of the other user (only for DM/Monitor).
 */
function openChatWindow(id, title, type, otherEmail = null) {
    closeChatWindow(); // Close existing chat first
    
    currentRoomId = id;
    currentChatType = type;
    currentOtherEmail = otherEmail;

    // 1. Update Header
    chatHeader.textContent = title;
    chatAvatar.textContent = (title.charAt(0) || '?').toUpperCase();
    chatAvatar.className = `center chat-avatar-lg ${type === 'group' ? 'bg-indigo-600' : type === 'monitor' ? 'bg-red-700' : 'bg-accent'}`;
    
    // 2. Show/Hide Windows
    liveChatWindow.classList.remove('hidden');
    defaultMessage.classList.add('hidden');
    
    // 3. Highlight active item in sidebar
    const activeEl = document.getElementById(`chat-item-${id}`);
    if (activeEl) activeEl.classList.add('active');

    // 4. Setup Chat Actions & Member List
    groupMemberList.classList.add('hidden');
    if (type === 'dm') {
        renderDmActions(otherEmail);
    } else if (type === 'group') {
        renderGroupActions();
        groupMemberList.classList.remove('hidden');
        setupGroupMemberList(id);
    } else if (type === 'monitor') {
        chatActions.innerHTML = `<span class="text-sm font-bold text-red-400">ç®¡ç†å“¡ç›£çœ‹æ¨¡å¼</span>`;
    }

    // 5. Setup chat input area (handles enable/disable based on type/block)
    setupChatInput(otherEmail, id, type);

    // 6. Setup new listener for the chat
    const chatsRef = db.collection('chats').doc(id).collection('messages');
    let q = chatsRef.orderBy('time').limit(type === 'monitor' ? 100 : 50); // Monitor limit 100

    const unsub = q.onSnapshot(snapshot => {
        messageList.innerHTML = ''; // Clear and re-render all for simplicity on large changes
        const fragment = document.createDocumentFragment();
        
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            const message = {
                from: data.from,
                sender: data.sender, // For groups
                text: data.text,
                time: data.time || { seconds: Date.now() / 1000 }
            };

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = createMessageHtml(message);
            fragment.appendChild(tempDiv.firstChild);
        });

        messageList.appendChild(fragment);
        // Scroll to bottom
        messageList.scrollTop = messageList.scrollHeight;
    }, error => {
        console.error("Error listening to messages: ", error);
        showMessage('èŠå¤©éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥è¨Šæ¯ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚', 'error');
    });

    unsubs.push(unsub);
}

/**
 * Sets up the input box and send logic for the current chat.
 */
function setupChatInput(otherEmail, roomId, type) {
    const ta = chatInputTextarea;
    const send = chatSendBtn;

    // Reset Input
    ta.value = '';
    ta.style.height = 'auto';

    // Disable input for monitor
    if (type === 'monitor') {
        ta.disabled = true;
        send.disabled = true;
        chatInputContainer.style.opacity = 0.5;
        blockInfo.classList.add('hidden');
        ta.placeholder = 'ç›£çœ‹æ¨¡å¼ç„¡æ³•ç™¼é€è¨Šæ¯';
        return;
    } else {
        ta.disabled = false;
        send.disabled = false;
        chatInputContainer.style.opacity = 1.0;
        ta.placeholder = 'è¼¸å…¥è¨Šæ¯... (Enter é€å‡º, Shift+Enter æ›è¡Œ)';
    }

    send.onclick = async () => {
        const text = ta.value.trim();
        if (!text) return;

        let collectionName = type === 'dm' ? 'messages' : 'messages'; // Using 'messages' for both DM and Group chats
        let payload = {
            text,
            time: firebase.firestore.FieldValue.serverTimestamp(),
        };

        if (type === 'dm') {
            // DM: Check if I am blocked by the other user
            const blockDocRef = db.collection('blocks').doc(otherEmail).collection('locked').doc(ME_EMAIL);
            const iAmBlocked = await blockDocRef.get();
            
            if (iAmBlocked.exists) {
                blockInfo.classList.remove('hidden');
                showMessage('ç„¡æ³•ç™¼é€', 'æ‚¨å·²è¢«å°æ–¹å°é–ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚', 'error');
                return;
            } else {
                blockInfo.classList.add('hidden');
            }
            payload.from = ME_EMAIL;

        } else if (type === 'group') {
            // Group: Check if I am a member
            const memberDoc = await db.collection('groups').doc(roomId).collection('members').doc(ME_EMAIL).get();
            if (!memberDoc.exists) {
                showMessage('éŒ¯èª¤', 'æ‚¨ä¸æ˜¯æ­¤ç¾¤çµ„çš„æˆå“¡ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯ã€‚', 'error');
                return;
            }
            payload.sender = ME_EMAIL;
        }

        try {
            // Send the message
            await db.collection('chats').doc(roomId).collection('messages').add(payload);
            
            // Update lastChat time for DM list/Group list sorting
            if (type === 'dm') {
                // Update both users' DM list (friend status required)
                await db.collection('friends').doc(ME_EMAIL).collection('list').doc(otherEmail).set({ lastChat: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                await db.collection('friends').doc(otherEmail).collection('list').doc(ME_EMAIL).set({ lastChat: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            } else if (type === 'group') {
                // Update the group last activity time
                await db.collection('groups').doc(roomId).set({ lastChat: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            }

            ta.value = '';
            ta.style.height = 'auto'; // Reset height after sending
        } catch (e) {
            showMessage('ç™¼é€å¤±æ•—', 'è¨Šæ¯ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            console.error("Send message error: ", e);
        }
    };

    // Enter send, Shift+Enter newline
    ta.onkeydown = e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send.click();
        }
    };
    // Auto-resize textarea
    ta.oninput = () => {
        ta.style.height = 'auto';
        ta.style.height = (ta.scrollHeight) + 'px';
    };
}

/* ==================== Friend System Logic ==================== */

sendRequestBtn.onclick = async () => {
    const targetEmail = friendSearchInput.value.trim().toLowerCase();
    if (!targetEmail || targetEmail === ME_EMAIL) {
        return showMessage('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€ã€‚', 'error');
    }

    try {
        // 1. Check if the target user exists (optional but good practice)
        const targetUserDoc = await db.collection('users').doc(targetEmail).get();
        if (!targetUserDoc.exists) {
            return showMessage('éŒ¯èª¤', `ç”¨æˆ¶ ${targetEmail} ä¸å­˜åœ¨æˆ–å°šæœªè¨»å†Šã€‚`, 'error');
        }

        // 2. Check if already friends
        const friendDoc = await db.collection('friends').doc(ME_EMAIL).collection('list').doc(targetEmail).get();
        if (friendDoc.exists) {
            return showMessage('æç¤º', `${targetEmail} å·²ç¶“æ˜¯æ‚¨çš„å¥½å‹ã€‚`, 'info');
        }

        // 3. Send Request: Create a document in the target's incoming requests
        await db.collection('friends').doc(targetEmail).collection('requests').doc(ME_EMAIL).set({
            senderEmail: ME_EMAIL,
            sentAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 4. Record outgoing request (for tracking)
        await db.collection('friends').doc(ME_EMAIL).collection('sent_requests').doc(targetEmail).set({
            recipientEmail: targetEmail,
            sentAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMessage('è«‹æ±‚å·²ç™¼é€', `å¥½å‹è«‹æ±‚å·²æˆåŠŸç™¼é€çµ¦ ${targetEmail}ã€‚`, 'success');
        friendSearchInput.value = '';

    } catch (e) {
        showMessage('ç™¼é€å¤±æ•—', 'ç™¼é€å¥½å‹è«‹æ±‚å¤±æ•—ã€‚', 'error');
        console.error("Send friend request error: ", e);
    }
};

/**
 * Renders the list of friend requests.
 */
function renderRequestList(requests) {
    const listEl = tabContents.request;
    listEl.innerHTML = '';
    requestCountEl.textContent = requests.length;

    if (requests.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰å¾…è™•ç†çš„å¥½å‹è«‹æ±‚...</p>';
        return;
    }

    requests.forEach(req => {
        const item = document.createElement('div');
        item.className = 'sidebar-item flex justify-between items-center bg-gray-700/50 hover:bg-gray-700';
        item.innerHTML = `
            <div class="flex items-center gap-2 min-w-0">
                <div class="center message-avatar bg-red-400">${req.senderEmail.charAt(0).toUpperCase()}</div>
                <span class="truncate">${req.senderEmail}</span>
            </div>
            <div class="flex gap-1">
                <button data-action="accept" data-email="${req.senderEmail}" class="bg-accent-2 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs transition duration-150">æ¥å—</button>
                <button data-action="reject" data-email="${req.senderEmail}" class="bg-danger hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs transition duration-150">æ‹’çµ•</button>
            </div>
        `;
        listEl.appendChild(item);
    });

    listEl.querySelectorAll('button').forEach(btn => {
        btn.onclick = (e) => handleFriendRequestAction(e.target.dataset.action, e.target.dataset.email);
    });
}

/**
 * Handles accepting or rejecting a friend request.
 */
async function handleFriendRequestAction(action, senderEmail) {
    const requestDocRef = db.collection('friends').doc(ME_EMAIL).collection('requests').doc(senderEmail);
    const myFriendListRef = db.collection('friends').doc(ME_EMAIL).collection('list').doc(senderEmail);
    const senderFriendListRef = db.collection('friends').doc(senderEmail).collection('list').doc(ME_EMAIL);
    const senderSentRequestRef = db.collection('friends').doc(senderEmail).collection('sent_requests').doc(ME_EMAIL);

    try {
        if (action === 'accept') {
            // 1. Add to my friend list
            await myFriendListRef.set({
                email: senderEmail,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                roomId: getDmRoomId(ME_EMAIL, senderEmail)
            });
            // 2. Add to sender's friend list (symmetric friendship)
            await senderFriendListRef.set({
                email: ME_EMAIL,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                roomId: getDmRoomId(ME_EMAIL, senderEmail)
            });
            // 3. Delete the request
            await requestDocRef.delete();
            // 4. Delete the sender's outgoing request
            await senderSentRequestRef.delete();

            showMessage('å¥½å‹æˆåŠŸ', `${senderEmail} å·²æˆç‚ºæ‚¨çš„å¥½å‹ï¼`, 'success');
        } else if (action === 'reject') {
            // 1. Delete the request
            await requestDocRef.delete();
            // 2. Delete the sender's outgoing request
            await senderSentRequestRef.delete();
            showMessage('è«‹æ±‚å·²æ‹’çµ•', `å·²æ‹’çµ• ${senderEmail} çš„å¥½å‹è«‹æ±‚ã€‚`, 'info');
        }
    } catch (e) {
        showMessage('æ“ä½œå¤±æ•—', `${action === 'accept' ? 'è™•ç†' : 'æ‹’çµ•'}å¥½å‹è«‹æ±‚å¤±æ•—ã€‚`, 'error');
        console.error(`Handle request ${action} error: `, e);
    }
}

/**
 * Renders the list of accepted DM friends.
 */
function renderDmList(friends) {
    const listEl = tabContents.dm;
    listEl.innerHTML = '';

    if (friends.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰é€²è¡Œä¸­çš„ç§èŠ...</p>';
        return;
    }

    friends.forEach(friend => {
        const otherEmail = friend.email;
        const roomId = friend.roomId;
        const initial = otherEmail.charAt(0).toUpperCase();

        const item = document.createElement('div');
        item.id = `chat-item-${roomId}`;
        item.className = 'sidebar-item';
        item.onclick = () => openChatWindow(roomId, `@ ${otherEmail}`, 'dm', otherEmail);
        
        item.innerHTML = `
            <div class="center message-avatar bg-gray-600">${initial}</div>
            <div class="flex flex-col min-w-0 flex-grow">
                <span class="truncate">${otherEmail}</span>
                <span class="text-xs text-gray-400 truncate">${friend.lastChat ? new Date(friend.lastChat.seconds * 1000).toLocaleTimeString('zh-TW') : 'æ–°å¥½å‹'}</span>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/* ==================== Group System Logic ==================== */

createGroupBtn.onclick = async () => {
    // Re-use showMessage for prompt-like behavior
    const groupName = prompt('è«‹è¼¸å…¥ç¾¤çµ„åç¨±:');
    
    if (typeof groupName !== 'string' || groupName.trim().length < 2) {
        return showMessage('å»ºç«‹å¤±æ•—', 'ç¾¤çµ„åç¨±ç„¡æ•ˆã€‚', 'error');
    }

    try {
        const newGroupRef = await db.collection('groups').add({
            name: groupName.trim(),
            admin: ME_EMAIL,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastChat: firebase.firestore.FieldValue.serverTimestamp(),
            memberCount: 1
        });

        // Add admin as the first member
        await db.collection('groups').doc(newGroupRef.id).collection('members').doc(ME_EMAIL).set({
            email: ME_EMAIL,
            role: 'admin',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage('å»ºç«‹æˆåŠŸ', `ç¾¤çµ„ "${groupName}" å·²å»ºç«‹ï¼`, 'success');
        openChatWindow(newGroupRef.id, `# ${groupName.trim()}`, 'group'); // Open the new group chat

    } catch (e) {
        showMessage('å»ºç«‹å¤±æ•—', 'å»ºç«‹ç¾¤çµ„æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
        console.error("Create group error: ", e);
    }
};

/**
 * Renders the list of joined groups.
 */
function renderGroupList(groups) {
    const listEl = tabContents.group;
    listEl.innerHTML = '';

    if (groups.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 p-2 empty-message">æ²’æœ‰åŠ å…¥ä»»ä½•ç¾¤çµ„...</p>';
        return;
    }

    groups.forEach(group => {
        const groupId = group.id;
        const groupName = group.name;
        const initial = groupName.charAt(0).toUpperCase();

        const item = document.createElement('div');
        item.id = `chat-item-${groupId}`;
        item.className = 'sidebar-item';
        item.onclick = () => openChatWindow(groupId, `# ${groupName}`, 'group', null);
        
        item.innerHTML = `
            <div class="center message-avatar bg-indigo-500">#</div>
            <div class="flex flex-col min-w-0 flex-grow">
                <span class="truncate font-semibold">${groupName}</span>
                <span class="text-xs text-gray-400 truncate">${group.lastChat ? new Date(group.lastChat.seconds * 1000).toLocaleTimeString('zh-TW') : 'æ–°ç¾¤çµ„'}</span>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * Sets up the group member list listener and rendering.
 */
function setupGroupMemberList(groupId) {
    memberListContent.innerHTML = ''; // Clear existing list
    groupManagementAdmin.classList.add('hidden'); // Hide admin controls by default

    // Check if I am the admin for management controls
    db.collection('groups').doc(groupId).collection('members').doc(ME_EMAIL).get()
        .then(doc => {
            const memberRole = doc.exists && doc.data().role === 'admin';
            if (memberRole) {
                groupManagementAdmin.classList.remove('hidden');
                setupGroupMemberManagement(groupId);
            }
        });

    const membersRef = db.collection('groups').doc(groupId).collection('members').orderBy('joinedAt');
    const unsub = membersRef.onSnapshot(snapshot => {
        memberListContent.innerHTML = '';
        const members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        memberCountEl.textContent = members.length;

        members.forEach(member => {
            const isMe = member.email === ME_EMAIL;
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2 p-1 rounded-md bg-gray-700/50';
            item.innerHTML = `
                <div class="center message-avatar w-6 h-6 text-xs ${member.role === 'admin' ? 'bg-red-500' : 'bg-gray-500'}">${member.email.charAt(0).toUpperCase()}</div>
                <span class="text-sm truncate">${member.email}${isMe ? ' (æˆ‘)' : ''}</span>
                ${member.role === 'admin' ? '<span class="text-xs text-red-400 ml-auto">Admin</span>' : ''}
            `;
            memberListContent.appendChild(item);
        });
    }, error => {
        console.error("Error listening to group members: ", error);
    });

    unsubs.push(unsub); // Add to unsubs to be cleared when chat window closes
}

/**
 * Sets up member add/remove functionality (Admin only).
 */
function setupGroupMemberManagement(groupId) {
    addMemberBtn.onclick = async () => {
        const email = manageMemberEmail.value.trim().toLowerCase();
        if (!email || email === ME_EMAIL) return showMessage('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆå“¡ Emailã€‚', 'error');

        const confirmed = await showMessage('ç¢ºèªåŠ å…¥', `ç¢ºå®šè¦å°‡ ${email} åŠ å…¥ç¾¤çµ„å—ï¼Ÿ`, 'confirm');
        if (!confirmed) return;

        try {
            await db.collection('groups').doc(groupId).collection('members').doc(email).set({
                email: email,
                role: 'member',
                joinedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update member count on the main group document
            await db.collection('groups').doc(groupId).update({ memberCount: firebase.firestore.FieldValue.increment(1) });
            
            showMessage('åŠ å…¥æˆåŠŸ', `${email} å·²åŠ å…¥ç¾¤çµ„ã€‚`, 'success');
            manageMemberEmail.value = '';
        } catch (e) {
            showMessage('æ“ä½œå¤±æ•—', 'åŠ å…¥æˆå“¡å¤±æ•—ã€‚', 'error');
            console.error("Add member error: ", e);
        }
    };

    removeMemberBtn.onclick = async () => {
        const email = manageMemberEmail.value.trim().toLowerCase();
        if (!email || email === ME_EMAIL) return showMessage('éŒ¯èª¤', 'ä¸èƒ½è¸¢å‡ºè‡ªå·±ã€‚', 'error');

        const confirmed = await showMessage('ç¢ºèªè¸¢å‡º', `ç¢ºå®šè¦å°‡ ${email} å¾ç¾¤çµ„ä¸­è¸¢å‡ºå—ï¼Ÿ`, 'confirm');
        if (!confirmed) return;

        try {
            await db.collection('groups').doc(groupId).collection('members').doc(email).delete();
             // Update member count on the main group document
            await db.collection('groups').doc(groupId).update({ memberCount: firebase.firestore.FieldValue.increment(-1) });
            
            showMessage('è¸¢å‡ºæˆåŠŸ', `${email} å·²è¢«è¸¢å‡ºç¾¤çµ„ã€‚`, 'success');
            manageMemberEmail.value = '';
        } catch (e) {
            showMessage('æ“ä½œå¤±æ•—', 'è¸¢å‡ºæˆå“¡å¤±æ•—ã€‚', 'error');
            console.error("Remove member error: ", e);
        }
    };
}


/* ==================== Monitor System Logic (Admin Only) ==================== */

monitorBtn.onclick = async () => {
    const v = (monitorInput.value || '').trim().toLowerCase();
    if (!v || v.indexOf('_') === -1) {
        return showMessage('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ç›£çœ‹æ ¼å¼: emailA_emailB', 'error');
    }
    
    if (ME_ROLE !== 'superadmin') {
        return showMessage('æ¬Šé™ä¸è¶³', 'åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹èŠå¤©è¨˜éŒ„ã€‚', 'error');
    }
    
    // The room ID for monitoring is the canonical DM room ID
    const [emailA, emailB] = v.split('_');
    const roomId = getDmRoomId(emailA, emailB);

    // Check if the room exists before opening
    try {
        const roomTest = await db.collection('chats').doc(roomId).collection('messages').limit(1).get();
        if (roomTest.empty) {
            return showMessage('ç›£çœ‹å¤±æ•—', 'æ­¤å…©äººä¹‹é–“å°šæœªæœ‰èŠå¤©è¨˜éŒ„ã€‚', 'error');
        }
    } catch (e) {
        return showMessage('ç›£çœ‹éŒ¯èª¤', 'ç„¡æ³•å­˜å–èŠå¤©ç´€éŒ„ã€‚', 'error');
    }

    // Open the chat in monitor mode
    openChatWindow(roomId, `ğŸš¨ ç›£çœ‹ä¸­: ${v} (é™100ç­†)`, 'monitor', v);
};


/* ==================== Auth and Initialization ==================== */

/**
 * Initializes Firebase, sets up state, and handles authentication.
 */
function initFirebase(token) {
    // âš ï¸ æª¢æŸ¥ Firebase é…ç½®æ˜¯å¦æœ‰æ•ˆ
    if (!firebaseConfig || !firebaseConfig.apiKey) {
        console.error("Firebase Configuration Error: API key is missing.");
        // å¦‚æœé…ç½®ç„¡æ•ˆï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦åœæ­¢åˆå§‹åŒ–
        showMessage('åˆå§‹åŒ–å¤±æ•—', 'Firebase é…ç½®è³‡è¨Šç¼ºå¤± (API Key)ã€‚è«‹ç¢ºèªæ‚¨çš„åŸ·è¡Œç’°å¢ƒæ˜¯å¦æ­£ç¢ºæä¾›äº†é…ç½®ã€‚', 'error');
        // ç¢ºä¿ç™»å…¥ç•«é¢å¯è¦‹
        loginScreen.classList.remove('hidden');
        return;
    }

    try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        db.settings({ merge: true });

        firebase.firestore.setLogLevel('debug');
    } catch (e) {
        console.error("Firebase Init Error: ", e);
        showMessage('åˆå§‹åŒ–å¤±æ•—', 'Firebase æœå‹™ç„¡æ³•åˆå§‹åŒ–ã€‚', 'error');
        return;
    }
    
    // Attempt custom token sign-in if available (provided by canvas environment)
    if (token) {
        auth.signInWithCustomToken(token)
            .catch(async (error) => {
                console.error("Custom token sign-in failed, falling back to Google login:", error);
                auth.signOut(); // Ensure we are signed out before showing Google login
            });
    }

    // Main Auth State Listener (Controls Page 1 / Page 2 switch)
    auth.onAuthStateChanged(async user => {
        if (user && user.email) {
            // User is signed in (Google)
            ME_EMAIL = user.email.toLowerCase();
            ME_ID = user.uid;

            // 1. Check/Set User Role and Profile
            const userDocRef = db.collection('users').doc(ME_EMAIL);
            const userDoc = await userDocRef.get();
            
            // Check for admin/superadmin role (Hardcoded check)
            ME_ROLE = (ME_EMAIL === ADMIN_EMAIL) ? 'superadmin' : (userDoc.exists && userDoc.data().role) ? userDoc.data().role : 'user';

            // Update Firestore profile
            await userDocRef.set({
                email: ME_EMAIL,
                role: ME_ROLE,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            }, { merge: true });
            
            // 2. Update UI
            document.getElementById('me-email').textContent = ME_EMAIL;
            document.getElementById('me-avatar').textContent = ME_EMAIL.charAt(0).toUpperCase();
            document.getElementById('me-role').textContent = ME_ROLE;
            
            // Show admin controls if superadmin
            adminControls.classList.toggle('hidden', ME_ROLE !== 'superadmin');
            
            // ** Show app, hide login (Switch to Page 2) **
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');

            // 3. Setup Sidebar Listeners
            setupSidebarListeners();

        } else {
            // User is signed out or only anonymous
            ME_EMAIL = null;
            ME_ID = null;
            ME_ROLE = 'user';
            
            clearUnsubs(); // Clear all listeners
            closeChatWindow(); // Close any open chat
            adminControls.classList.add('hidden');
            
            // ** Show login, hide app (Switch to Page 1) **
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    });
}

function setupSidebarListeners() {
    clearUnsubs();

    // 1. Friend Requests Listener
    const reqRef = db.collection('friends').doc(ME_EMAIL).collection('requests').orderBy('sentAt', 'desc');
    unsubs.push(reqRef.onSnapshot(snapshot => {
        const requests = snapshot.docs.map(doc => doc.data());
        renderRequestList(requests);
    }, error => console.error("Request listener error:", error)));

    // 2. DM Friends Listener
    const dmRef = db.collection('friends').doc(ME_EMAIL).collection('list').orderBy('lastChat', 'desc');
    unsubs.push(dmRef.onSnapshot(snapshot => {
        const friends = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        renderDmList(friends);
    }, error => console.error("DM friend list error:", error)));

    // 3. Group List Listener (Only groups I am a member of)
    const groupsRef = db.collection('groups');
    unsubs.push(groupsRef.onSnapshot(async () => {
        // --- NOTE: This is an expensive way to check group membership due to Firestore limitations in single-file environments.
        // It fetches all group data and checks membership in client. For real-world use, this needs server-side optimization.
        
        const allGroupDocs = await db.collection('groups').where('memberCount', '>', 0).get();
        const myGroupIds = [];
        
        // Loop through all groups to check if I am a member
        for (const doc of allGroupDocs.docs) {
            // Check subcollection membership
            const memberCheck = await db.collection('groups').doc(doc.id).collection('members').doc(ME_EMAIL).get();
            if (memberCheck.exists) {
                 myGroupIds.push({ id: doc.id, ...doc.data() });
            }
        }
        
        // Final list includes only groups the user is a member of
        renderGroupList(myGroupIds.sort((a, b) => (b.lastChat?.seconds || 0) - (a.lastChat?.seconds || 0)));

    }, error => console.error("Group list error:", error)));
}

/* ============== Google Login Implementation ============== */
googleLoginBtn.onclick = async () => {
    // æª¢æŸ¥ Firebase æ˜¯å¦åˆå§‹åŒ–
    if (!auth) {
        // Call initFirebase again in case it failed the first time but config is now available
        if (!firebaseConfig.apiKey) {
            return showMessage('éŒ¯èª¤', 'Firebase å°šæœªåˆå§‹åŒ–ï¼Œä¸”é…ç½®è³‡è¨Šç¼ºå¤±ï¼Œç„¡æ³•ç™»å…¥ã€‚', 'error');
        }
        // Attempt re-init
        initFirebase(initialAuthToken);
        if (!auth) return; // If re-init failed, stop.
    }
    
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await firebase.auth().signInWithPopup(provider);
        showMessage('ç™»å…¥æˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å…¥ï¼Œæ­¡è¿å›ä¾†ï¼', 'success');
    } catch (error) {
        if (error.code !== 'auth/popup-closed-by-user') {
             showMessage('ç™»å…¥å¤±æ•—', 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
             console.error("Google Sign-in Error: ", error);
        }
    }
};

/* ============== Logout ============== */
logoutBtn.onclick = () => {
    firebase.auth().signOut().then(() => {
        showMessage('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²å®‰å…¨ç™»å‡ºã€‚', 'info');
    }).catch(error => {
        showMessage('ç™»å‡ºå¤±æ•—', 'ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
        console.error("Logout error: ", error);
    });
};

/* ============== initial: start firebase ============== */
window.onload = function() {
    initFirebase(initialAuthToken);
}
</script>
</body>
</html>