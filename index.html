<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆDiscord é¢¨æ ¼ï¼‰</title>

<!-- Firebase compat (ä½¿ç”¨ v9.23.0 ä¿æŒèˆ‡åŸç¨‹å¼ç¢¼ç›¸å®¹æ€§) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f1724; --panel:#111827; --muted:#9ca3af; --accent:#5865f2; --accent-2:#2ecc71; --danger:#ef4444;
  --card:#0b1020;
}
*{box-sizing:border-box;font-family:Inter, "Noto Sans TC", "å¾®è»Ÿæ­£é»‘é«”", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
body{margin:0;background:linear-gradient(180deg,#071025 0%, #071223 100%);color:#e6eef8;height:100vh;display:flex;flex-direction:column;}
a{color:inherit}
.center{display:flex;justify-content:center;align-items:center;}
/* ç™»å…¥ä»‹é¢ */
#login{flex-direction:column;gap:1.5rem;padding:2rem;}
#login h1{color:var(--accent);margin-bottom:0.5rem;}
#login input, #login button{padding:0.75rem;border-radius:0.5rem;border:1px solid var(--panel);font-size:1rem;width:300px;max-width:90%;}
#login input{background:var(--panel);color:white;}
#login button{background:var(--accent);color:white;cursor:pointer;transition:background 0.2s;}
#login button:hover{background:#4b55e8;}
/* ä¸»ä»‹é¢ */
#app{display:none;flex-direction:row;flex-grow:1;min-height:0;overflow:hidden;}
#user-list{width:250px;min-width:200px;background:var(--panel);padding:1rem;display:flex;flex-direction:column;gap:0.5rem;overflow-y:auto;}
.user-item{display:flex;justify-content:space-between;align-items:center;padding:0.5rem;border-radius:0.5rem;cursor:pointer;transition:background 0.2s;border:1px solid transparent;}
.user-item:hover{background:#1f2937;}
.user-item.active{background:var(--accent);border-color:var(--accent);color:white;}
.user-item button{background:var(--danger);color:white;border:none;padding:0.3rem 0.6rem;border-radius:0.3rem;cursor:pointer;font-size:0.8rem;margin-left:0.5rem;}
.user-item button:hover{opacity:0.8;}
.user-item-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-item-role{font-size:0.7rem;color:var(--muted);margin-left:0.5rem;}

#chat-area{flex-grow:1;display:flex;flex-direction:column;min-width:0;background:var(--bg);position:relative;}
#chat-header{padding:1rem;background:var(--panel);border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;align-items:center;z-index:10;}
#chat-header h2{margin:0;font-size:1.2rem;color:var(--accent-2);}
#chat-messages{flex-grow:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:1rem;}
.message{display:flex;flex-direction:column;background:var(--card);padding:0.75rem;border-radius:0.75rem;max-width:90%;}
.message-meta{display:flex;align-items:baseline;margin-bottom:0.25rem;}
.message-from{font-weight:bold;color:var(--accent-2);margin-right:0.5rem;}
.message-time{font-size:0.7rem;color:var(--muted);}
.message-text{line-height:1.4;word-wrap:break-word;white-space:pre-wrap;}

#chat-input-area{padding:1rem;background:var(--panel);display:flex;gap:0.5rem;}
#chat-input-area textarea{flex-grow:1;padding:0.75rem;border-radius:0.5rem;border:1px solid #1f2937;background:var(--card);color:white;resize:none;min-height:40px;max-height:150px;}
#chat-input-area button{background:var(--accent);color:white;border:none;padding:0.75rem 1.25rem;border-radius:0.5rem;cursor:pointer;transition:background 0.2s;}
#chat-input-area button:hover{background:#4b55e8;}

/* è¨Šæ¯æ–¹å¡Šæ¨£å¼ (å–ä»£ alert) */
#message-box {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none; /* é è¨­éš±è— */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#message-content {
  background: var(--panel);
  color: white;
  padding: 2rem;
  border-radius: 1rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
  max-width: 400px;
  width: 90%;
  text-align: center;
}

#message-text {
  margin-bottom: 1.5rem;
  font-size: 1.1rem;
}

#message-close-btn {
  background: var(--accent);
  color: white;
  border: none;
  padding: 0.5rem 1.5rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: background 0.2s;
}

#message-close-btn:hover {
  background: #4b55e8;
}

/* ç›£çœ‹å€åŸŸ */
#monitor-area{margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #1f2937;}
#monitor-area input{padding:0.5rem;border-radius:0.5rem;border:1px solid var(--card);background:var(--card);color:white;width:150px;}
#monitor-area button{background:#3b82f6;margin-left:0.5rem;padding:0.5rem 1rem;}

/* RWD èª¿æ•´ */
@media (max-width: 768px) {
  #user-list{width:100%;height:200px;order:2;overflow-y:scroll;}
  #app{flex-direction:column;}
  #chat-area{order:1;}
}
</style>
</head>
<body>

<div id="login" class="center" style="height:100vh;">
  <h1>æ ¡åœ’èŠå¤©å®¤ç™»å…¥</h1>
  <input type="email" id="email" placeholder="è¼¸å…¥æ‚¨çš„å­¸è™Ÿ@å­¸æ ¡ç¶²åŸŸ.edu" />
  <button id="loginBtn">ç™»å…¥ / è¨»å†Š</button>
</div>

<div id="app">
  <div id="user-list">
    <div style="font-size:1.1rem;font-weight:bold;margin-bottom:1rem;color:var(--accent);">
      ç·šä¸Šä½¿ç”¨è€…
    </div>
    <div id="users">
      <!-- User list items will be inserted here -->
    </div>
    <!-- ç›£çœ‹åŠŸèƒ½ (åƒ…æœ€é«˜ç®¡ç†å“¡å¯è¦‹) -->
    <div id="monitor-area" style="display:none;">
      <div style="font-size:0.9rem;color:var(--muted);margin-bottom:0.5rem;">ç®¡ç†å“¡ç›£çœ‹ (emailA_emailB)</div>
      <input type="text" id="monitorInput" placeholder="emailA_emailB" />
      <button id="monitorBtn">ç›£çœ‹</button>
    </div>
  </div>

  <div id="chat-area" style="display:none;">
    <!-- Chat windows will be opened here dynamically -->
    <div class="center" style="flex-grow:1;color:var(--muted);font-size:1.5rem;">
      è«‹é»é¸å·¦å´ä½¿ç”¨è€…é–‹å§‹èŠå¤©
    </div>
  </div>
</div>

<!-- è‡ªå®šç¾©è¨Šæ¯æ–¹å¡Š (å–ä»£ alert) -->
<div id="message-box">
    <div id="message-content">
        <div id="message-text"></div>
        <button id="message-close-btn">ç¢ºå®š</button>
    </div>
</div>

<script>
/* å…¨åŸŸè®Šæ•¸ */
let ME_EMAIL = null;
let ME_ROLE = 'user';
const openChats = {}; // å„²å­˜å·²é–‹å•Ÿçš„èŠå¤©å®¤ { roomId: { element, unsub, otherUserEmail } }
const unsubs = []; // å„²å­˜æ‰€æœ‰ onSnapshot ç›£è½å™¨

/* DOM å…ƒç´  */
const loginDiv = document.getElementById('login');
const appDiv = document.getElementById('app');
const emailInput = document.getElementById('email');
const loginBtn = document.getElementById('loginBtn');
const usersDiv = document.getElementById('users');
const chatArea = document.getElementById('chat-area');
const monitorArea = document.getElementById('monitor-area');
const monitorInput = document.getElementById('monitorInput');
const monitorBtn = document.getElementById('monitorBtn');
const messageBox = document.getElementById('message-box');
const messageText = document.getElementById('message-text');
const messageCloseBtn = document.getElementById('message-close-btn');

/* è‡ªå®šç¾©è¨Šæ¯é¡¯ç¤ºå‡½æ•¸ (å–ä»£ alert) */
const showMessage = (message) => {
    messageText.textContent = message;
    messageBox.style.display = 'flex';
};

messageCloseBtn.onclick = () => {
    messageBox.style.display = 'none';
};

/* ================ Firebase åˆå§‹åŒ–èˆ‡è¨­å®š ================ */
let app, auth, db;

// â— é—œéµï¼šä½¿ç”¨ç’°å¢ƒæä¾›çš„ `__firebase_config` åˆå§‹åŒ–ã€‚
// â— é€™å€‹é…ç½®åŒ…å«äº†æ‚¨å°ˆæ¡ˆä¸­é—œéµçš„ **API é‡‘é‘° (apiKey)**ï¼Œç”¨æ–¼èˆ‡ Firebase æœå‹™é€²è¡Œé€šè¨Šæˆæ¬Šã€‚
try {
  const firebaseConfig = JSON.parse(__firebase_config);
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth(app);
  db = firebase.firestore(app);

  // è¨­ç½® Firestore æ—¥èªŒç­‰ç´šç‚º Debugï¼Œæ–¹ä¾¿èª¿è©¦
  db.setLogLevel('debug');
} catch (e) {
  console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
  showMessage("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é‡‘é‘°é…ç½®ã€‚");
}

/* ================ ç™»å…¥/é©—è­‰ ================ */
loginBtn.onclick = async () => {
  const email = (emailInput.value || '').trim().toLowerCase();
  if (!email || email.indexOf('@') === -1) {
    return showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€ã€‚');
  }

  try {
    // è¨»å†Šæˆ–ç™»å…¥
    const result = await auth.signInAnonymously();
    const user = result.user;

    // ä½¿ç”¨ email ä½œç‚ºè‡ªå®šç¾© Token çš„è­˜åˆ¥ç¢¼
    await auth.updateCurrentUser({ ...user, email });

    // æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å»ºç«‹
    const userRef = db.collection('users').doc(email);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      // å»ºç«‹æ–°ä½¿ç”¨è€…è³‡æ–™ï¼Œé è¨­è§’è‰²ç‚º user
      await userRef.set({
        email: email,
        role: 'user', // é è¨­è§’è‰²
        online: true,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      // æ›´æ–°ä¸Šç·šç‹€æ…‹
      await userRef.update({
        online: true,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    ME_EMAIL = email;
    await auth.signInWithCustomToken(__initial_auth_token); // ä½¿ç”¨ç’°å¢ƒæä¾›çš„ Auth Token
    
    // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ä»‹é¢
    initApp();

  } catch (error) {
    console.error("ç™»å…¥éŒ¯èª¤:", error);
    showMessage(`ç™»å…¥å¤±æ•—: ${error.message}`);
  }
};

/* ================ æ‡‰ç”¨ç¨‹å¼ä¸»é«” ================ */
async function initApp() {
  loginDiv.style.display = 'none';
  appDiv.style.display = 'flex';
  chatArea.style.display = 'flex';

  // å–å¾—ä¸¦è¨­å®šæˆ‘çš„è§’è‰²
  const meDoc = await db.collection('users').doc(ME_EMAIL).get();
  ME_ROLE = meDoc.exists && meDoc.data().role ? meDoc.data().role : 'user';

  // æœ€é«˜ç®¡ç†å“¡é¡¯ç¤ºç›£çœ‹åŠŸèƒ½
  if (ME_ROLE === 'superadmin') {
    monitorArea.style.display = 'block';
  }

  // ç›£è½æ‰€æœ‰ä½¿ç”¨è€…ç‹€æ…‹ (å³æ™‚æ›´æ–°)
  const usersQuery = db.collection('users').orderBy('lastSeen', 'desc');
  const userUnsub = usersQuery.onSnapshot(snapshot => {
    usersDiv.innerHTML = '';
    snapshot.forEach(doc => {
      const userData = doc.data();
      if (userData.email !== ME_EMAIL) {
        renderUser(userData);
      }
    });
  }, err => {
    console.error("ç›£è½ä½¿ç”¨è€…å¤±æ•—:", err);
  });
  unsubs.push(userUnsub);

  // ç›£è½è‡ªå·±çš„é€£ç·šç‹€æ…‹ï¼Œé›¢ç·šæ™‚è‡ªå‹•æ›´æ–° lastSeen å’Œ online ç‹€æ…‹
  const userRef = db.collection('users').doc(ME_EMAIL);
  db.app.database().ref('.info/connected').on('value', async (snap) => {
    if (snap.val() === false) {
      // ç¢ºä¿é›¢ç·šæ™‚è¨­ç½® online: false
      await userRef.update({ online: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
    } else {
      // ç¢ºä¿é€£ç·šæ™‚è¨­ç½® online: true
      await userRef.update({ online: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
    }
  });

  // åœ¨è¦–çª—é—œé–‰å‰è¨­å®šé›¢ç·šç‹€æ…‹ (é€™æ˜¯ä¸€å€‹æœ€ä½³å˜—è©¦ï¼Œä¸èƒ½ä¿è­‰æˆåŠŸ)
  window.addEventListener('beforeunload', async () => {
    if (ME_EMAIL) {
      await db.collection('users').doc(ME_EMAIL).update({ online: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
    }
  });
}

// æ¸²æŸ“å–®å€‹ä½¿ç”¨è€…åˆ—è¡¨é …
function renderUser(user) {
  const item = document.createElement('div');
  item.className = 'user-item';
  item.innerHTML = `
    <div class="user-item-name">
      ${user.online ? 'ğŸŸ¢' : 'âš«'} ${user.email}
      <span class="user-item-role">(${user.role})</span>
    </div>
    <div>
      <button class="block-btn" data-email="${user.email}" style="background:var(--danger);">å°é–</button>
      <button class="chat-btn" data-email="${user.email}" style="background:var(--accent);">èŠå¤©</button>
    </div>
  `;
  usersDiv.appendChild(item);

  // èŠå¤©æŒ‰éˆ•äº‹ä»¶
  item.querySelector('.chat-btn').onclick = () => {
    openChatWindow(user.email, user.email, false);
  };

  // å°é–æŒ‰éˆ•äº‹ä»¶
  item.querySelector('.block-btn').onclick = async (e) => {
    const other = e.target.dataset.email;
    if (ME_ROLE === 'superadmin') {
      return showMessage('ç®¡ç†å“¡ç„¡æ³•ä½¿ç”¨å°é–åŠŸèƒ½ã€‚');
    }
    const blockRef = db.collection('users').doc(ME_EMAIL).collection('blocked').doc(other);
    try {
      await blockRef.set({ blockedAt: firebase.firestore.FieldValue.serverTimestamp() });
      showMessage(`å·²å°é– ${other}ï¼Œæ‚¨å°‡ä¸æœƒæ”¶åˆ°å°æ–¹çš„è¨Šæ¯ã€‚`);
    } catch (e) {
      console.error("å°é–å¤±æ•—:", e);
      showMessage("å°é–å¤±æ•—ã€‚");
    }
  };
}

/* ================ èŠå¤©è¦–çª—åŠŸèƒ½ ================ */
function getRoomId(emailA, emailB) {
  // æŒ‰ç…§å­—æ¯é †åºæ’åˆ—ï¼Œç¢ºä¿ A_B == B_A
  return [emailA, emailB].sort().join('_');
}

function openChatWindow(otherEmail, title, isMonitor) {
  const roomId = getRoomId(ME_EMAIL, otherEmail);

  if (openChats[roomId]) {
    // å¦‚æœå·²ç¶“é–‹å•Ÿï¼Œå‰‡åˆ‡æ›åˆ°è©²è¦–çª—
    Object.values(openChats).forEach(chat => chat.element.style.display = 'none');
    openChats[roomId].element.style.display = 'flex';
    openChats[roomId].element.querySelector('#chat-messages').scrollTop = openChats[roomId].element.querySelector('#chat-messages').scrollHeight;
    
    // æ›´æ–° active ç‹€æ…‹ (éç›£çœ‹æ¨¡å¼æ‰æ›´æ–° user list)
    if (!isMonitor) {
      document.querySelectorAll('.user-item').forEach(item => {
        if (item.querySelector('.chat-btn')?.dataset.email === otherEmail) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    return;
  }

  // é—œé–‰æ‰€æœ‰å…¶ä»–èŠå¤©å®¤çš„é¡¯ç¤º
  Object.values(openChats).forEach(chat => chat.element.style.display = 'none');
  
  // å»ºç«‹æ–°çš„èŠå¤©å®¤ UI
  const chatWindow = document.createElement('div');
  chatWindow.className = 'chat-window';
  chatWindow.id = `chat-${roomId}`;
  chatWindow.style.cssText = 'flex-grow:1;display:flex;flex-direction:column;min-width:0;';
  chatWindow.innerHTML = `
    <div id="chat-header">
      <h2>${title} ${isMonitor ? '(ç›£çœ‹ä¸­)' : ''}</h2>
      ${!isMonitor ? `
        <button id="close-btn" style="background:var(--danger);color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;">é—œé–‰</button>
      ` : ''}
    </div>
    <div id="chat-messages">
      <!-- è¨Šæ¯å°‡è¼‰å…¥æ­¤è™• -->
    </div>
    <div id="chat-input-area" ${isMonitor ? 'style="display:none;"' : ''}>
      <textarea id="message-text-area" placeholder="è¼¸å…¥è¨Šæ¯... (Enter ç™¼é€, Shift+Enter æ›è¡Œ)"></textarea>
      <button id="send-btn">ç™¼é€</button>
    </div>
  `;
  chatArea.innerHTML = ''; // æ¸…é™¤æç¤ºè¨Šæ¯
  chatArea.appendChild(chatWindow);
  
  const messagesDiv = chatWindow.querySelector('#chat-messages');

  // ç›£è½è¨Šæ¯ (å³æ™‚æ›´æ–°)
  const messagesQuery = db.collection('messages').doc(roomId).collection('chats').orderBy('time', 'asc');
  const unsub = messagesQuery.onSnapshot(snapshot => {
    // å„²å­˜ç•¶å‰æ²å‹•ç‹€æ…‹
    const isScrolledToBottom = messagesDiv.scrollHeight - messagesDiv.clientHeight <= messagesDiv.scrollTop + 1;

    messagesDiv.innerHTML = '';
    snapshot.forEach(doc => {
      renderMessage(messagesDiv, doc.data());
    });

    // å¦‚æœä¹‹å‰åœ¨åº•éƒ¨ï¼Œå‰‡è‡ªå‹•æ²å‹•
    if (isScrolledToBottom) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  }, err => {
    console.error("ç›£è½è¨Šæ¯å¤±æ•—:", err);
  });

  // å„²å­˜ç‹€æ…‹
  openChats[roomId] = {
    element: chatWindow,
    unsub: unsub,
    otherUserEmail: otherEmail
  };
  
  // ç¶å®šç™¼é€äº‹ä»¶ (å¦‚æœä¸æ˜¯ç›£çœ‹æ¨¡å¼)
  if (!isMonitor) {
    setupChatInput(chatWindow, roomId, otherEmail);

    // é—œé–‰æŒ‰éˆ•äº‹ä»¶
    chatWindow.querySelector('#close-btn').onclick = () => {
      unsub(); // åœæ­¢ç›£è½
      chatWindow.remove(); // ç§»é™¤ UI
      delete openChats[roomId]; // å¾è¨˜éŒ„ä¸­ç§»é™¤
      
      // æ¸…é™¤ active ç‹€æ…‹
      document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));

      // é¡¯ç¤ºé è¨­æç¤º
      if (Object.keys(openChats).length === 0) {
        chatArea.innerHTML = `<div class="center" style="flex-grow:1;color:var(--muted);font-size:1.5rem;">è«‹é»é¸å·¦å´ä½¿ç”¨è€…é–‹å§‹èŠå¤©</div>`;
      }
    };
    
    // æ›´æ–° active ç‹€æ…‹
    document.querySelectorAll('.user-item').forEach(item => {
      if (item.querySelector('.chat-btn')?.dataset.email === otherEmail) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
  }

  // ç¬¬ä¸€æ¬¡é–‹å•Ÿæ™‚æ²å‹•åˆ°åº•éƒ¨
  setTimeout(() => {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }, 100);
}

// æ¸²æŸ“å–®æ¢è¨Šæ¯
function renderMessage(container, msg) {
  const message = document.createElement('div');
  message.className = 'message';
  message.style.alignSelf = msg.from === ME_EMAIL ? 'flex-end' : 'flex-start';
  message.style.backgroundColor = msg.from === ME_EMAIL ? '#1a2333' : '#2d3748'; // å€åˆ†è‡ªå·±èˆ‡ä»–äºº

  const timeStr = msg.time ? new Date(msg.time.toDate()).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : 'ç™¼é€ä¸­...';

  message.innerHTML = `
    <div class="message-meta">
      <span class="message-from" style="color:${msg.from === ME_EMAIL ? 'var(--accent)' : 'var(--accent-2)'};">${msg.from}</span>
      <span class="message-time">${timeStr}</span>
    </div>
    <div class="message-text">${msg.text}</div>
  `;
  container.appendChild(message);
}

// è¨­ç½®èŠå¤©å®¤è¼¸å…¥æ¡†å’Œç™¼é€é‚è¼¯
function setupChatInput(chatWindow, roomId, other) {
  const ta = chatWindow.querySelector('#message-text-area');
  const send = chatWindow.querySelector('#send-btn');
  
  send.onclick = async () => {
    const text = (ta.value || '').trim();
    if (!text) return;

    // æª¢æŸ¥æ˜¯å¦è¢«å°æ–¹å°é– (å…ˆå–å¾—å°æ–¹è³‡æ–™)
    const otherDoc = await db.collection('users').doc(other).get();
    if (otherDoc.exists) {
        const iBlocked = await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(other).get();
        if(iBlocked.exists) return showMessage(`æ‚¨å·²å°é– ${other}ï¼Œè«‹å…ˆè§£é™¤å°é–æ‰èƒ½ç™¼é€è¨Šæ¯ã€‚`);

        const isBlocked = await db.collection('users').doc(other).collection('blocked').doc(ME_EMAIL).get();
        if(isBlocked.exists) {
            // å¦‚æœè¢«å°é–ï¼Œä»ç„¶å˜—è©¦ç™¼é€ï¼Œä½†æç¤º
            showMessage(`æ³¨æ„ï¼šæ‚¨å¯èƒ½å·²è¢« ${other} å°é–ã€‚è¨Šæ¯å¯èƒ½ç„¡æ³•é€é”ã€‚`);
        }
    } else {
        showMessage('ä½¿ç”¨è€…è³‡æ–™ä¸å­˜åœ¨ã€‚');
        return;
    }
    
    // ç™¼é€è¨Šæ¯
    await db.collection('messages').doc(roomId).collection('chats').add({
      from: ME_EMAIL,
      text,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
    ta.value = '';
    ta.focus();
  };

  // Enter ç™¼é€, Shift+Enter æ›è¡Œ
  ta.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send.click();
    }
  });
}

/* ============== Monitor (superadmin) ç›£çœ‹åŠŸèƒ½ ============== */
monitorBtn.onclick = async () => {
  const v = (monitorInput.value || '').trim();
  if (!v || v.indexOf('_') === -1) return showMessage('è«‹è¼¸å…¥ emailA_emailB æ ¼å¼çš„èŠå¤©å®¤ IDã€‚');
  
  const meDoc = await db.collection('users').doc(ME_EMAIL).get();
  const role = meDoc.exists && meDoc.data().role ? meDoc.data().role : 'user';
  
  if (role !== 'superadmin') return showMessage('åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹ã€‚');
  
  // å‡è¨­ç›£çœ‹ ID æ˜¯ emailA_emailBï¼Œæˆ‘å€‘éœ€è¦å¾é€™å€‹ ID ä¸­æå–ä¸€å€‹ã€Œå‡è£çš„ã€otherEmail
  const [emailA, emailB] = v.split('_');
  const otherEmail = emailA === ME_EMAIL ? emailB : emailA;

  openChatWindow(otherEmail, 'ç›£çœ‹èŠå¤©å®¤: ' + v, true);
};

/* cleanup: close listeners on unload */
window.addEventListener('beforeunload', () => {
  // ç§»é™¤æ‰€æœ‰ Firebase ç›£è½å™¨
  Object.values(openChats).forEach(o => o.unsub && o.unsub());
  unsubs.forEach(u => u && u());
});

/* ============== initial: show login or app ============== */
(async () => {
  // å˜—è©¦ä½¿ç”¨ç’°å¢ƒæä¾›çš„ Auth Token ç™»å…¥
  if (typeof __initial_auth_token !== 'undefined') {
      try {
          const loginResult = await auth.signInWithCustomToken(__initial_auth_token);
          const user = loginResult.user;
          
          // ç”±æ–¼è‡ªå®šç¾© token é è¨­ç„¡ emailï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹æ©Ÿåˆ¶ä¾†è­˜åˆ¥ç”¨æˆ¶
          // é€™è£¡å‡è¨­å¦‚æœæˆåŠŸç™»å…¥ï¼Œæˆ‘å€‘æ‡‰è¦æ±‚ç”¨æˆ¶è¼¸å…¥ email ä¾†ä½œç‚ºä¸»è¦ ID
          loginDiv.style.display = 'flex';
          appDiv.style.display = 'none';
          showMessage("é¦–æ¬¡ç™»å…¥ï¼Œè«‹è¼¸å…¥æ‚¨çš„ Email (å­¸è™Ÿ@ç¶²åŸŸ) ä½œç‚ºèŠå¤©å®¤ IDã€‚");
      } catch (e) {
          console.error("Custom token ç™»å…¥å¤±æ•—:", e);
          loginDiv.style.display = 'flex';
          appDiv.style.display = 'none';
      }
  } else {
    // å¦‚æœæ²’æœ‰è‡ªå®šç¾© tokenï¼Œä¹Ÿé¡¯ç¤ºç™»å…¥ä»‹é¢
    loginDiv.style.display = 'flex';
    appDiv.style.display = 'none';
  }
})();
</script>
</body>
</html>