<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>🔥 即時聊天室</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* 通用 */
body,html { margin:0; padding:0; font-family:"Noto Sans TC",sans-serif; height:100%; }
.hidden { display:none; }

/* 登入頁面 */
#loginPage { display:flex; justify-content:center; align-items:center; height:100vh; background: linear-gradient(135deg,#4facfe,#00f2fe); flex-direction:column; color:white; }
#loginPage h1 { font-size:48px; margin-bottom:20px; text-shadow:0 2px 6px rgba(0,0,0,0.3); }
#loginBtnLogin { background:#4285F4; border:none; color:white; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:16px; }

/* 主介面 */
#mainPage { display:flex; height:100vh; }

/* 左側 */
.sidebar { width:22%; background:#2f3136; color:white; display:flex; flex-direction:column; padding:15px; box-sizing:border-box; }
.sidebar h3 { margin-top:15px; margin-bottom:5px; font-size:14px; color:#b9bbbe; }
.sidebar ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; }
.sidebar li { padding:8px; cursor:pointer; border-radius:6px; transition:0.2s; }
.sidebar li:hover { background:#40444b; }
.sidebar input, .sidebar button { margin-top:5px; border-radius:6px; border:none; padding:6px; font-size:14px; }

/* 中間聊天 */
.chat-area { flex:1; background:#36393f; display:flex; flex-wrap:wrap; padding:10px; overflow-x:auto; overflow-y:hidden; }
.chat-window { width:320px; background:#40444b; border-radius:10px; margin:5px; display:flex; flex-direction:column; overflow:hidden; }
.chat-header { background:#5865f2; color:white; padding:6px 10px; display:flex; justify-content:space-between; align-items:center; }
.chat-messages { flex:1; background:#2f3136; overflow-y:auto; padding:8px; }
.chat-messages .msg { margin:4px 0; padding:6px 10px; border-radius:6px; background:#5865f2; word-break:break-word; font-size:13px; }
.chat-input { display:flex; border-top:1px solid #40444b; }
.chat-input input { flex:1; padding:6px 10px; border:none; outline:none; background:#40444b; color:white; }
.chat-input button { background:#57f287; color:white; border:none; padding:6px 12px; cursor:pointer; }

/* 右側 */
.rightbar { width:22%; background:#2f3136; color:white; display:flex; flex-direction:column; padding:15px; box-sizing:border-box; }
.rightbar h3 { margin-top:15px; margin-bottom:5px; font-size:14px; color:#b9bbbe; }
.rightbar ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; }
.rightbar li { padding:6px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
.rightbar button { margin-left:5px; border-radius:4px; padding:2px 6px; font-size:12px; cursor:pointer; }

/* 全域公告 */
#broadcastDiv { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:5px; }
#broadcastInput { padding:6px; border-radius:6px; border:none; }
#broadcastBtn { padding:6px 12px; border:none; border-radius:6px; background:#f04747; color:white; cursor:pointer; }
</style>
</head>
<body>

<!-- 登入頁面 -->
<div id="loginPage">
  <h1>🔥 即時聊天室</h1>
  <button id="loginBtnLogin">使用 Google 登入</button>
</div>

<!-- 主介面 -->
<div id="mainPage" class="hidden">
  <!-- 左側 -->
  <div class="sidebar">
    <p>👋 歡迎，<span id="user"></span></p>
    <button id="logoutBtn" style="background:#f04747;color:white;">登出</button>
    <h3>好友清單</h3>
    <ul id="friendList"></ul>
    <input id="addFriendEmail" placeholder="輸入 Gmail">
    <button id="addFriendBtn">送出好友請求</button>
    <h3>群組清單</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="群聊名稱">
    <button id="createGroupBtn">建立群組</button>
  </div>

  <!-- 中間聊天區 -->
  <div class="chat-area" id="chatArea"></div>

  <!-- 右側 -->
  <div class="rightbar">
    <h3>好友請求</h3>
    <ul id="requestList"></ul>
  </div>
</div>

<!-- 全域公告 -->
<div id="broadcastDiv" class="hidden">
  <input id="broadcastInput" placeholder="全域公告">
  <button id="broadcastBtn">廣播</button>
</div>

<script>
// Firebase 初始化
const firebaseConfig = { apiKey:"AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU", authDomain:"chat-52c0d.firebaseapp.com", projectId:"chat-52c0d", storageBucket:"chat-52c0d.appspot.com", messagingSenderId:"449329325475", appId:"1:449329325475:web:75f255c4055360dc9e6616", measurementId:"G-8R8648H53V" };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginPage=document.getElementById("loginPage");
const mainPage=document.getElementById("mainPage");
const loginBtnLogin=document.getElementById("loginBtnLogin");
const logoutBtn=document.getElementById("logoutBtn");
const userSpan=document.getElementById("user");
const friendList=document.getElementById("friendList");
const groupList=document.getElementById("groupList");
const addFriendEmail=document.getElementById("addFriendEmail");
const addFriendBtn=document.getElementById("addFriendBtn");
const createGroupBtn=document.getElementById("createGroupBtn");
const newGroupName=document.getElementById("newGroupName");
const chatArea=document.getElementById("chatArea");
const requestList=document.getElementById("requestList");
const broadcastDiv=document.getElementById("broadcastDiv");
const broadcastInput=document.getElementById("broadcastInput");
const broadcastBtn=document.getElementById("broadcastBtn");

let userEmail="",userName="",userRole="user";
let chatWindows={};
const HIGHEST_ADMIN="chianghansen0302@gmail.com";

// 登入登出
loginBtnLogin.onclick=async()=>{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
logoutBtn.onclick=async()=>{ await auth.signOut(); chatWindows={}; chatArea.innerHTML=""; friendList.innerHTML=""; groupList.innerHTML=""; requestList.innerHTML=""; }

// 權限設定
auth.onAuthStateChanged(async user=>{
  if(user){
    userEmail=user.email; userName=user.displayName;
    loginPage.classList.add("hidden");
    mainPage.classList.remove("hidden");
    userSpan.textContent=`${userName} (${userEmail})`;
    await db.collection("users").doc(userEmail).set({name:userName,email:userEmail,role:"user"},{merge:true});
    if(userEmail===HIGHEST_ADMIN) userRole="highest";
    loadFriends(); loadGroups(); loadRequests();
    if(userRole==="highest") broadcastDiv.classList.remove("hidden");
  }else{ loginPage.classList.remove("hidden"); mainPage.classList.add("hidden"); }
});

// 好友清單
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.data().email;
      li.onclick=()=>openChatWindow([userEmail,doc.data().email].sort().join("_"),doc.data().email);
      friendList.appendChild(li);
    });
  });
}

// 群組清單
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li=document.createElement("li");
      li.textContent=doc.id;
      li.onclick=()=>openChatWindow(doc.id,doc.id);
      groupList.appendChild(li);
    });
  });
}

// 好友請求
addFriendBtn.onclick=async()=>{
  const email=addFriendEmail.value.trim(); if(!email) return alert("請輸入好友 Gmail");
  if(email===userEmail) return alert("不能加自己");
  try{
    await db.collection("users").doc(email).set({email},{merge:true});
    await db.collection("users").doc(email).collection("requests").add({from:userEmail,status:"pending",timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    alert("好友請求已送出"); addFriendEmail.value="";
  }catch(err){ alert("送出好友請求失敗："+err.message); console.error(err);}
};

// 加載好友請求
function loadRequests(){
  db.collection("users").doc(userEmail).collection("requests").where("status","==","pending").onSnapshot(snap=>{
    requestList.innerHTML="";
    snap.forEach(doc=>{
      const data=doc.data();
      const li=document.createElement("li");
      li.textContent=`${data.from} 想加你為好友`;

      const acceptBtn=document.createElement("button");
      acceptBtn.textContent="同意";
      acceptBtn.onclick=async()=>{
        await db.collection("users").doc(userEmail).collection("friends").doc(data.from).set({email:data.from});
        await db.collection("users").doc(data.from).collection("friends").doc(userEmail).set({email:userEmail});
        await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"accepted"});
      };

      const rejectBtn=document.createElement("button");
      rejectBtn.textContent="拒絕";
      rejectBtn.onclick=async()=>{ await db.collection("users").doc(userEmail).collection("requests").doc(doc.id).update({status:"rejected"}); };

      li.appendChild(acceptBtn); li.appendChild(rejectBtn); requestList.appendChild(li);
    });
  });
}

// 建立群組
createGroupBtn.onclick=async()=>{
  if(userRole==="user") return alert("權限不足");
  const name=newGroupName.value.trim(); if(!name) return alert("請輸入群聊名稱");
  await db.collection("groups").doc(name).set({createdBy:userEmail,members:[userEmail]},{merge:true});
  newGroupName.value="";
}

// 開啟聊天窗
function openChatWindow(roomId,title){
  if(chatWindows[roomId]) return;
  const win=document.createElement("div"); win.className="chat-window"; win.id="win_"+roomId;
  const header=document.createElement("div"); header.className="chat-header"; header.innerHTML=`<span>${title}</span><button>X</button>`;
  win.appendChild(header);
  const msgDiv=document.createElement("div"); msgDiv.className="chat-messages"; win.appendChild(msgDiv);
  const inputDiv=document.createElement("div"); inputDiv.className="chat-input";
  const input=document.createElement("input"); input.placeholder="輸入訊息...";
  const btn=document.createElement("button"); btn.textContent="送出";
  inputDiv.appendChild(input); inputDiv.appendChild(btn); win.appendChild(inputDiv);
  chatArea.appendChild(win);

  header.querySelector("button").onclick=()=>{ if(chatWindows[roomId]) chatWindows[roomId](); chatArea.removeChild(win); delete chatWindows[roomId]; }

  const unsub=db.collection("messages").doc(roomId).collection("chats").orderBy("time").onSnapshot(snap=>{
    msgDiv.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      const div=document.createElement("div"); div.className="msg"; div.textContent=`${d.from}: ${d.text}`;
      msgDiv.appendChild(div);
    });
    msgDiv.scrollTop=msgDiv.scrollHeight;
  });

  chatWindows[roomId]=unsub;

  // Enter 發送, Shift+Enter 換行
  input.addEventListener("keydown",async e=>{
    if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); btn.click(); }
  });

  btn.onclick=async()=>{
    const text=input.value.trim(); if(!text) return;
    await db.collection("messages").doc(roomId).collection("chats").add({from:userEmail,text,time:firebase.firestore.FieldValue.serverTimestamp()});
    input.value="";
  }
}

// 全域公告
broadcastBtn.onclick=async()=>{
  const text=broadcastInput.value.trim(); if(!text) return;
  await db.collection("broadcasts").add({from:userEmail,text,time:firebase.firestore.FieldValue.serverTimestamp()});
  broadcastInput.value="";
}

</script>
</body>
</html>
