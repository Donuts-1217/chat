<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ”¥ æ ¡åœ’å³æ™‚èŠå¤©å®¤ï¼ˆæœ€çµ‚æ•´åˆï¼‰</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:"Noto Sans TC","å¾®è»Ÿæ­£é»‘é«”",sans-serif}
body{margin:0;background:#eef3fb;color:#111}
#loginPage{height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column}
#loginBtn{padding:12px 18px;border-radius:10px;border:none;background:#4285f4;color:#fff;cursor:pointer}
#container{display:none;max-width:1200px;margin:18px auto;height:86vh;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #e7eefb;background:#fff}
header .title{font-size:18px;font-weight:700}
header .me{display:flex;align-items:center;gap:12px}
.main{display:flex;height:calc(100% - 64px);}
.left{width:260px;background:#f7fafc;padding:10px;border-right:1px solid #e7eefb;display:flex;flex-direction:column}
.left .meBox{padding:8px;background:#fff;border-radius:8px;border:1px solid #edf3fb;margin-bottom:8px}
.listTitle{font-size:13px;margin:8px 0 6px 0;color:#333}
.list{flex:1;background:#fff;border-radius:8px;border:1px solid #edf3fb;overflow:auto;padding:6px}
.listItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer}
.listItem:hover{background:#f0f6ff}
.controls{display:flex;gap:8px;margin-top:8px}
.center{flex:1;padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto;background:linear-gradient(180deg,#fbfdff,#f7fbff)}
.chatWindow{background:#fff;border-radius:10px;display:flex;flex-direction:column;min-height:140px;max-height:78vh;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.chatHead{background:#5865f2;color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
.chatMessages{padding:12px;overflow:auto;flex:1;background:linear-gradient(180deg,#fff,#f8fbff)}
.bubble{background:#eaf2ff;padding:8px 10px;border-radius:8px;margin-bottom:8px;max-width:80%;word-break:break-word}
.chatInput{display:flex;gap:8px;padding:10px;border-top:1px solid #eef3fb;background:#fff}
.chatInput textarea{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef9;min-height:64px;max-height:160px;resize:none}
.chatInput button{padding:8px 12px;border-radius:8px;border:none;background:#2ecc71;color:#fff;cursor:pointer}
.right{width:300px;background:#f7fafc;padding:10px;border-left:1px solid #e7eefb;display:flex;flex-direction:column}
.smallList{background:#fff;border-radius:8px;border:1px solid #edf3fb;padding:8px;overflow:auto;flex:1}
.requestItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px}
.memberBtn{padding:6px 8px;border-radius:6px;border:none;background:#5865f2;color:#fff;cursor:pointer}
.danger{background:#f44336}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999}
.modal .box{width:90%;max-width:720px;background:#fff;padding:16px;border-radius:8px;max-height:80vh;overflow:auto}
@media(max-width:980px){.left,.right{display:none}.center{padding:8px}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <h1>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆæœ€çµ‚ç‰ˆï¼‰</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
  <p style="color:#666;margin-top:8px">è«‹å…ˆåœ¨ Firebase Console å•Ÿç”¨ Google Sign-inï¼Œä¸¦è²¼ä¸Šè¦å‰‡å¾Œæ¸¬è©¦</p>
</div>

<!-- APP -->
<div id="container">
  <header>
    <div class="title">ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</div>
    <div class="me">
      <div style="text-align:right">
        <div id="meName" style="font-weight:700"></div>
        <div id="meEmail" style="font-size:13px;color:#666"></div>
      </div>
      <div id="adminBadge" style="display:none;background:#ffb300;color:#111;padding:6px;border-radius:6px;font-weight:700;margin-left:12px">ç®¡ç†å“¡</div>
      <button id="logoutBtn" style="margin-left:12px;padding:8px;border-radius:8px;border:none;background:#f44336;color:#fff;cursor:pointer">ç™»å‡º</button>
    </div>
  </header>

  <div class="main">
    <!-- left -->
    <div class="left">
      <div class="meBox">
        <div id="leftMeName" style="font-weight:700"></div>
        <div id="leftMeEmail" style="font-size:13px;color:#666"></div>
      </div>

      <div class="listTitle">å¥½å‹</div>
      <div class="list" id="friendList" aria-label="å¥½å‹æ¸…å–®"></div>

      <div class="controls">
        <input id="addFriendInput" placeholder="è¼¸å…¥ Gmail åŠ å¥½å‹" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef9">
        <button id="sendReqBtn" class="memberBtn">é€å‡º</button>
      </div>

      <div style="margin-top:12px" class="listTitle">ç¾¤çµ„</div>
      <div class="list" id="groupList"></div>

      <!-- å»ºç«‹ç¾¤çµ„æŒ‰éˆ•åªå°ç®¡ç†å“¡é¡¯ç¤º -->
      <div style="margin-top:8px" id="createGroupArea">
        <input id="newGroupInput" placeholder="è¼¸å…¥ç¾¤çµ„åç¨±" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9">
        <div style="display:flex;margin-top:8px;gap:8px">
          <button id="createGroupBtn" class="memberBtn">å»ºç«‹ç¾¤çµ„</button>
        </div>
      </div>
    </div>

    <!-- center -->
    <div class="center" id="center"></div>

    <!-- right -->
    <div class="right">
      <div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h4 style="margin:0">å¥½å‹è«‹æ±‚</h4>
        </div>
        <div class="smallList" id="requestList"></div>
      </div>

      <div style="margin-top:8px">
        <h4 style="margin:0">å°é–æ¸…å–®</h4>
        <div class="smallList" id="blockedList"></div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0">ç¾¤çµ„ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰</h4>
        <input id="groupNameInput" placeholder="ç›®æ¨™ç¾¤çµ„åç¨±">
        <input id="groupEmailInput" placeholder="è¼¸å…¥è¦åŠ å…¥/è¸¢å‡ºçš„ email" style="margin-top:6px">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addToGroupBtn" class="memberBtn">åŠ å…¥æˆå“¡</button>
          <button id="kickFromGroupBtn" class="memberBtn danger">è¸¢å‡ºæˆå“¡</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0">ç›£çœ‹ï¼ˆé«˜éšç®¡ç†å“¡ï¼‰</h4>
        <input id="watchInput" placeholder="æ ¼å¼ï¼šemailA_emailB" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9;margin-top:8px">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="watchBtn" class="memberBtn">ç›£çœ‹</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Members Modal -->
<div id="modalMembers" class="modal"><div class="box">
  <h3 id="modalTitle">ç¾¤çµ„æˆå“¡</h3>
  <div id="modalMembersBody" style="margin-top:8px"></div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button id="modalCloseBtn" style="padding:8px;border-radius:8px">é—œé–‰</button>
  </div>
</div></div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= STATE ================= */
let ME = null;
let ME_EMAIL = "";
let ME_NAME = "";
const SUPER_ADMIN = "chianghansen0302@gmail.com";

/* ================= DOM ================= */
const loginPage = document.getElementById('loginPage');
const loginBtn = document.getElementById('loginBtn');
const appContainer = document.getElementById('container');
const logoutBtn = document.getElementById('logoutBtn');
const meNameEl = document.getElementById('meName');
const meEmailEl = document.getElementById('meEmail');
const leftMeName = document.getElementById('leftMeName');
const leftMeEmail = document.getElementById('leftMeEmail');
const adminBadge = document.getElementById('adminBadge');
const friendListEl = document.getElementById('friendList');
const groupListEl = document.getElementById('groupList');
const centerEl = document.getElementById('center');
const requestListEl = document.getElementById('requestList');
const blockedListEl = document.getElementById('blockedList');

const addFriendInput = document.getElementById('addFriendInput');
const sendReqBtn = document.getElementById('sendReqBtn');
const newGroupInput = document.getElementById('newGroupInput');
const createGroupBtn = document.getElementById('createGroupBtn');

const groupNameInput = document.getElementById('groupNameInput');
const groupEmailInput = document.getElementById('groupEmailInput');
const addToGroupBtn = document.getElementById('addToGroupBtn');
const kickFromGroupBtn = document.getElementById('kickFromGroupBtn');

const watchInput = document.getElementById('watchInput');
const watchBtn = document.getElementById('watchBtn');

const modalMembers = document.getElementById('modalMembers');
const modalMembersBody = document.getElementById('modalMembersBody');
const modalTitle = document.getElementById('modalTitle');
const modalCloseBtn = document.getElementById('modalCloseBtn');

/* ================ AUTH ================ */
loginBtn.onclick = async ()=>{
  try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  catch(e){ alert('ç™»å…¥å¤±æ•—ï¼š'+e.message); console.error(e); }
};
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  location.reload();
};

auth.onAuthStateChanged(async user=>{
  if(!user){ loginPage.style.display='block'; appContainer.style.display='none'; return; }
  ME = user;
  ME_EMAIL = user.email;
  ME_NAME = user.displayName || ME_EMAIL.split('@')[0];

  // è‹¥ users doc ä¸å­˜åœ¨å‰‡å»ºç«‹ä¸¦é è¨­ role:userï¼ˆè‹¥æ˜¯ SUPER_ADMIN å‰‡è¨­å®š superadminï¼‰
  const udoc = db.collection('users').doc(ME_EMAIL);
  const snap = await udoc.get();
  if(!snap.exists){
    const role = (ME_EMAIL === SUPER_ADMIN) ? 'superadmin' : 'user';
    await udoc.set({name:ME_NAME,email:ME_EMAIL,role,createdAt: firebase.firestore.FieldValue.serverTimestamp()});
  }

  // reload UI
  loginPage.style.display='none';
  appContainer.style.display='block';
  meNameEl.textContent = ME_NAME;
  meEmailEl.textContent = ME_EMAIL;
  leftMeName.textContent = ME_NAME;
  leftMeEmail.textContent = ME_EMAIL;

  // show admin badge if role is admin or superadmin
  const doc = await db.collection('users').doc(ME_EMAIL).get();
  const role = (doc.exists && doc.data().role) ? doc.data().role : 'user';
  adminBadge.style.display = (role === 'admin' || role === 'superadmin') ? 'block' : 'none';

  // hide/create group area depending on role
  document.getElementById('createGroupArea').style.display = (role === 'admin' || role === 'superadmin') ? 'block' : 'none';

  setupListeners();
});

/* ============== LISTENERS SETUP ============== */
let unsub = {};
function setupListeners(){
  if(unsub.friends) unsub.friends();
  unsub.friends = db.collection('users').doc(ME_EMAIL).collection('friends').onSnapshot(snap=>renderFriends(snap), e=>console.error('friends',e));

  if(unsub.requestsIn) unsub.requestsIn = db.collection('users').doc(ME_EMAIL).collection('requests').where('status','==','pending').onSnapshot(snap=>renderRequests(snap), e=>console.error('req',e));

  if(unsub.blocked) unsub.blocked = db.collection('users').doc(ME_EMAIL).collection('blocked').onSnapshot(snap=>renderBlocked(snap), e=>console.error('blocked',e));

  if(unsub.groups) unsub.groups = db.collection('groups').onSnapshot(snap=>renderGroups(snap), e=>console.error('groups',e));
}

/* ============== RENDER FRIENDS ============== */
function renderFriends(snap){
  friendListEl.innerHTML = '';
  snap.forEach(doc=>{
    const email = doc.id;
    const data = doc.data() || {};
    const item = document.createElement('div'); item.className='listItem';
    const left = document.createElement('div'); left.className='name'; left.textContent = data.name || email;
    const right = document.createElement('div');

    const chatBtn = document.createElement('button'); chatBtn.textContent='èŠå¤©'; chatBtn.className='memberBtn';
    chatBtn.onclick = (e)=>{ e.stopPropagation(); openPrivateChat(email, data.name||email); };

    const delBtn = document.createElement('button'); delBtn.textContent='åˆªé™¤'; delBtn.className='memberBtn danger';
    delBtn.onclick = async (e)=>{ e.stopPropagation(); if(!confirm('ç¢ºå®šåˆªé™¤å¥½å‹ï¼Ÿ')) return; await db.collection('users').doc(ME_EMAIL).collection('friends').doc(email).delete().catch(()=>null); await db.collection('users').doc(email).collection('friends').doc(ME_EMAIL).delete().catch(()=>null); };

    const blockBtn = document.createElement('button'); blockBtn.textContent='å°é–'; blockBtn.className='memberBtn';
    blockBtn.onclick = async (e)=>{ e.stopPropagation(); await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(email).set({email,at: firebase.firestore.FieldValue.serverTimestamp()}); alert('å·²å°é– '+email); };

    right.appendChild(chatBtn); right.appendChild(delBtn); right.appendChild(blockBtn);
    item.appendChild(left); item.appendChild(right);
    item.onclick = ()=> openPrivateChat(email, data.name||email);
    friendListEl.appendChild(item);
  });
}

/* ============== REQUESTS ============== */
function renderRequests(snap){
  requestListEl.innerHTML = '';
  snap.forEach(doc=>{
    const data = doc.data(); const id = doc.id;
    const div = document.createElement('div'); div.className='requestItem';
    const left = document.createElement('div'); left.textContent = data.from;
    const right = document.createElement('div');
    const accept = document.createElement('button'); accept.textContent='åŒæ„'; accept.className='memberBtn';
    accept.onclick = async ()=>{ await db.collection('users').doc(ME_EMAIL).collection('friends').doc(data.from).set({email:data.from}); await db.collection('users').doc(data.from).collection('friends').doc(ME_EMAIL).set({email:ME_EMAIL}); await db.collection('users').doc(ME_EMAIL).collection('requests').doc(id).update({status:'accepted',acceptedAt: firebase.firestore.FieldValue.serverTimestamp()}); alert('å·²æ¥å—å¥½å‹'); };
    const reject = document.createElement('button'); reject.textContent='æ‹’çµ•'; reject.className='memberBtn danger';
    reject.onclick = async ()=>{ await db.collection('users').doc(ME_EMAIL).collection('requests').doc(id).update({status:'rejected'}); };
    right.appendChild(accept); right.appendChild(reject);
    div.appendChild(left); div.appendChild(right);
    requestListEl.appendChild(div);
  });
}

/* ============== BLOCKED ============== */
function renderBlocked(snap){
  blockedListEl.innerHTML = '';
  snap.forEach(doc=>{
    const email = doc.id;
    const row = document.createElement('div'); row.className='listItem';
    row.textContent = email;
    const unb = document.createElement('button'); unb.textContent='è§£é™¤å°é–'; unb.className='memberBtn';
    unb.onclick = async (e)=>{ e.stopPropagation(); await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(email).delete().catch(()=>null); };
    row.appendChild(unb);
    blockedListEl.appendChild(row);
  });
}

/* ============== GROUPS ============== */
function renderGroups(snap){
  groupListEl.innerHTML = '';
  snap.forEach(doc=>{
    const name = doc.id; const data = doc.data() || {};
    const members = data.members || [];
    // åªé¡¯ç¤ºç•¶å‰ä½¿ç”¨è€…æœ‰è¢«åŠ å…¥çš„ç¾¤çµ„
    if(!members.includes(ME_EMAIL)) return;
    const item = document.createElement('div'); item.className='listItem';
    const left = document.createElement('div'); left.className='name'; left.textContent = name;
    const right = document.createElement('div');
    const open = document.createElement('button'); open.textContent='é–‹å•Ÿ'; open.className='memberBtn';
    open.onclick = ()=> openGroupChat(name);
    const membersBtn = document.createElement('button'); membersBtn.textContent='æˆå“¡'; membersBtn.className='memberBtn';
    membersBtn.onclick = ()=> openMembersModal(name);
    right.appendChild(open); right.appendChild(membersBtn);
    item.appendChild(left); item.appendChild(right);
    groupListEl.appendChild(item);
  });
}

/* create group only if admin */
createGroupBtn.onclick = async ()=>{
  // read role
  const udoc = await db.collection('users').doc(ME_EMAIL).get();
  const role = (udoc.exists && udoc.data().role) ? udoc.data().role : 'user';
  if(!(role === 'admin' || role === 'superadmin')) return alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥å»ºç«‹ç¾¤çµ„');
  const name = newGroupInput.value.trim();
  if(!name) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
  // create group with empty members array (does NOT add creator automatically)
  await db.collection('groups').doc(name).set({createdBy: ME_EMAIL, members: [], admins: [ME_EMAIL], createdAt: firebase.firestore.FieldValue.serverTimestamp()});
  newGroupInput.value = '';
  alert('ç¾¤çµ„å·²å»ºç«‹ï¼ˆæœªè‡ªå‹•åŠ å…¥ä»»ä½•æˆå“¡ï¼‰');
};

/* ============== MEMBERS MODAL ============== */
let currentModalGroup = null;
function openMembersModal(groupId){
  currentModalGroup = groupId;
  modalMembers.style.display = 'flex';
  modalTitle.textContent = 'ç¾¤çµ„æˆå“¡ â€” ' + groupId;
  modalMembersBody.innerHTML = '<div style="color:#666">è¼‰å…¥ä¸­...</div>';
  db.collection('groups').doc(groupId).get().then(doc=>{
    if(!doc.exists){ modalMembersBody.innerHTML = '<div>æ‰¾ä¸åˆ°è©²ç¾¤çµ„</div>'; return; }
    const data = doc.data();
    const members = data.members || [];
    const admins = data.admins || [];
    modalMembersBody.innerHTML = '';
    members.forEach(m=>{
      const row = document.createElement('div'); row.className='row';
      const left = document.createElement('div'); left.textContent = m + (admins.includes(m)?' (ç®¡ç†å“¡)':'');
      const right = document.createElement('div');
      const amIAdmin = (admins.includes(ME_EMAIL) || roleIs(ME_EMAIL,'superadmin'));
      if(amIAdmin && m !== ME_EMAIL){
        const kick = document.createElement('button'); kick.textContent='è¸¢å‡º'; kick.className='memberBtn danger';
        kick.onclick = async ()=>{ if(!confirm('ç¢ºå®šè¸¢å‡º '+m+'ï¼Ÿ')) return; await db.collection('groups').doc(groupId).update({members: firebase.firestore.FieldValue.arrayRemove(m)}); openMembersModal(groupId); };
        right.appendChild(kick);
      }
      if(m === ME_EMAIL){
        const leave = document.createElement('button'); leave.textContent='é€€å‡º'; leave.className='memberBtn';
        leave.onclick = async ()=>{ if(!confirm('ç¢ºå®šé€€å‡ºç¾¤çµ„ï¼Ÿ')) return; await db.collection('groups').doc(groupId).update({members: firebase.firestore.FieldValue.arrayRemove(ME_EMAIL)}); modalMembers.style.display='none'; };
        right.appendChild(leave);
      }
      row.appendChild(left); row.appendChild(right);
      modalMembersBody.appendChild(row);
    });
  }).catch(e=>{ modalMembersBody.innerHTML = '<div>è¼‰å…¥å¤±æ•—</div>'; console.error(e); });
}
modalCloseBtn.onclick = ()=>{ modalMembers.style.display='none'; currentModalGroup = null; };

/* ============== CHAT WINDOWS ============== */
const openChats = {};
function openPrivateChat(otherEmail, displayName){
  const roomId = [ME_EMAIL, otherEmail].sort().join('_');
  openChatWindow(roomId, displayName, false);
}
function openGroupChat(groupName){
  openChatWindow(groupName, groupName, false);
}

function openChatWindow(roomId, title, readonly=false){
  if(openChats[roomId]) {
    const el = openChats[roomId].el; el.parentElement.prepend(el); return;
  }
  // DOM
  const chat = document.createElement('div'); chat.className='chatWindow';
  const head = document.createElement('div'); head.className='chatHead';
  head.innerHTML = `<div style="font-weight:700">${title}</div><div><button class="memberBtn">é—œé–‰</button></div>`;
  const msgs = document.createElement('div'); msgs.className='chatMessages';
  const inputRow = document.createElement('div'); inputRow.className='chatInput';
  const ta = document.createElement('textarea'); ta.placeholder='è¼¸å…¥è¨Šæ¯...(Shift+Enter æ›è¡Œ)';
  const sendBtn = document.createElement('button'); sendBtn.textContent='é€å‡º';
  inputRow.appendChild(ta); inputRow.appendChild(sendBtn);
  chat.appendChild(head); chat.appendChild(msgs); chat.appendChild(inputRow);
  centerEl.prepend(chat);

  head.querySelector('button').onclick = ()=>{ chat.remove(); const o=openChats[roomId]; if(o && o.unsub) o.unsub(); delete openChats[roomId]; };

  const ref = db.collection('messages').doc(roomId).collection('chats').orderBy('time','desc').limit(100);
  const unsubRef = ref.onSnapshot(async snap=>{
    msgs.innerHTML = '';
    const docs = snap.docs.slice().reverse();
    for(const d of docs){
      const v = d.data();
      // simple block check: if you blocked sender, skip
      const blocked = await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(v.from).get();
      if(blocked.exists) continue;
      const bubble = document.createElement('div'); bubble.className='bubble';
      bubble.textContent = `${v.from}: ${v.text}`;
      // admin delete button
      const myRoleDoc = await db.collection('users').doc(ME_EMAIL).get();
      const myRole = myRoleDoc.exists ? myRoleDoc.data().role : 'user';
      if(myRole === 'superadmin' || (existsGroupAdmin(roomId) && await isGroupAdmin(roomId, ME_EMAIL))){
        const del = document.createElement('button'); del.textContent='åˆªé™¤'; del.className='memberBtn danger'; del.style.marginLeft='8px';
        del.onclick = async (e)=>{ e.stopPropagation(); if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å‰‡è¨Šæ¯ï¼Ÿ')) return; await d.ref.delete().catch(err=>alert('åˆªé™¤å¤±æ•—ï¼š'+err.message)); };
        bubble.appendChild(del);
      }
      msgs.appendChild(bubble);
    }
    msgs.scrollTop = msgs.scrollHeight;
  }, err=>{ msgs.innerHTML = '<div style="color:#c00">è¼‰å…¥èŠå¤©å¤±æ•—</div>'; console.error(err); });

  openChats[roomId] = {unsub:unsubRef, el:chat};

  sendBtn.onclick = async ()=>{
    const text = ta.value.trim(); if(!text) return;
    // check private chat blocking
    if(roomId.includes('_')){
      const parts = roomId.split('_'); const other = (parts[0] === ME_EMAIL) ? parts[1] : parts[0];
      const otherBlocked = await db.collection('users').doc(other).collection('blocked').doc(ME_EMAIL).get();
      if(otherBlocked.exists) return alert('å°æ–¹å·²å°é–ä½ ï¼Œç„¡æ³•ç™¼è¨Šæ¯');
      const iBlocked = await db.collection('users').doc(ME_EMAIL).collection('blocked').doc(other).get();
      if(iBlocked.exists) return alert('æ‚¨å·²å°é–å°æ–¹ï¼Œç„¡æ³•ç™¼è¨Šæ¯');
    }
    await db.collection('messages').doc(roomId).collection('chats').add({from: ME_EMAIL, text, time: firebase.firestore.FieldValue.serverTimestamp()});
    ta.value = '';
  };

  ta.addEventListener('keydown', e=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

  // readonly (for watch) -> hide input
  if(readonly) inputRow.style.display = 'none';
}

/* ============== HELPERS ============== */
async function roleIs(email, roleName){
  const d = await db.collection('users').doc(email).get();
  return d.exists && d.data().role === roleName;
}
function existsGroupAdmin(roomId){ /* placeholder for UI; server checks in rules */ return true; }
async function isGroupAdmin(groupId, email){
  const g = await db.collection('groups').doc(groupId).get();
  if(!g.exists) return false;
  const admins = g.data().admins || [];
  return admins.includes(email);
}

/* ============== SEND FRIEND REQUEST ============== */
sendReqBtn.onclick = async ()=>{
  const to = addFriendInput.value.trim();
  if(!to) return alert('è«‹è¼¸å…¥å°æ–¹ Gmail');
  if(to === ME_EMAIL) return alert('ä¸èƒ½åŠ è‡ªå·±');
  try{
    await db.collection('users').doc(to).set({email:to},{merge:true});
    await db.collection('users').doc(to).collection('requests').add({from:ME_EMAIL,status:'pending',time: firebase.firestore.FieldValue.serverTimestamp()});
    addFriendInput.value = '';
    alert('å¥½å‹è«‹æ±‚å·²é€å‡º');
  }catch(e){ alert('é€å‡ºå¤±æ•—ï¼š'+e.message); console.error(e); }
};

/* ============== GROUP ADMIN ACTIONS (admin only) ============== */
addToGroupBtn.onclick = async ()=>{
  // check role
  const myr = await db.collection('users').doc(ME_EMAIL).get();
  const role = myr.exists ? myr.data().role : 'user';
  if(!(role === 'admin' || role === 'superadmin')) return alert('åƒ…ç®¡ç†å“¡å¯åŠ å…¥æˆå“¡');
  const grp = groupNameInput.value.trim();
  const email = groupEmailInput.value.trim();
  if(!grp || !email) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±èˆ‡ email');
  // ensure group exists
  const gdoc = await db.collection('groups').doc(grp).get();
  if(!gdoc.exists) return alert('æ‰¾ä¸åˆ°ç¾¤çµ„');
  await db.collection('groups').doc(grp).update({members: firebase.firestore.FieldValue.arrayUnion(email)});
  alert('å·²åŠ å…¥ '+email+' è‡³ '+grp);
  groupEmailInput.value = '';
};

kickFromGroupBtn.onclick = async ()=>{
  const myr = await db.collection('users').doc(ME_EMAIL).get();
  const role = myr.exists ? myr.data().role : 'user';
  if(!(role === 'admin' || role === 'superadmin')) return alert('åƒ…ç®¡ç†å“¡å¯è¸¢å‡ºæˆå“¡');
  const grp = groupNameInput.value.trim();
  const email = groupEmailInput.value.trim();
  if(!grp || !email) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±èˆ‡ email');
  const gdoc = await db.collection('groups').doc(grp).get();
  if(!gdoc.exists) return alert('æ‰¾ä¸åˆ°ç¾¤çµ„');
  await db.collection('groups').doc(grp).update({members: firebase.firestore.FieldValue.arrayRemove(email)});
  alert('å·²å¾ '+grp+' è¸¢å‡º '+email);
  groupEmailInput.value = '';
};

/* ============== WATCH (superadmin only) ============== */
watchBtn.onclick = async ()=>{
  const roleDoc = await db.collection('users').doc(ME_EMAIL).get();
  const role = roleDoc.exists ? roleDoc.data().role : 'user';
  if(role !== 'superadmin') return alert('åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹');
  const v = watchInput.value.trim();
  if(!v || !v.includes('_')) return alert('æ ¼å¼ï¼šemailA_emailB');
  openChatWindow(v, 'ç›£çœ‹: '+v, true);
};

/* ============== CLEANUP ============== */
window.addEventListener('beforeunload', ()=>{
  Object.values(unsub).forEach(u=>u && u());
  Object.values(openChats).forEach(c=>c.unsub && c.unsub());
});
</script>
</body>
</html>
