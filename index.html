<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å®Œæ•´èŠå¤©å®¤ï¼ˆå«ç¾¤çµ„æˆå“¡ç®¡ç† / å°é– / åˆªé™¤ / ç›£çœ‹ï¼‰</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* --- åŸºæœ¬æ¨£å¼ --- */
:root{--bg:#f2f5fa;--panel:#ffffff;--accent:#2d8cf0;--muted:#6b7280;--ok:#2ecc71;--danger:#f04747;}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans TC", system-ui, Arial;background:var(--bg);color:#111}
.header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.06)}
.header h1{font-size:18px;margin:0}
.container{width:95%;max-width:1400px;margin:18px auto;display:flex;height:78vh;gap:12px}

/* å·¦å´ */
.left{width:260px;background:var(--panel);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:8px;overflow:auto}
.left .section{margin-bottom:8px}
.left h3{margin:6px 0;font-size:14px;color:#333}
.list{flex:1;background:#f8fafc;border-radius:8px;overflow:auto;padding:6px;border:1px solid #e6e8ec}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px;background:#fff;cursor:pointer;border:1px solid #eef2f7}
.item:hover{background:#eef7ff}
.small{font-size:12px;padding:6px 8px;border-radius:6px}

/* ä¸­é–“èŠå¤©å€ */
.center{flex:1;display:flex;flex-direction:column;gap:12px}
.chatgrid{display:flex;flex-wrap:wrap;gap:12px;overflow:auto;padding:6px;height:100%}
.chatbox{width:360px;min-width:300px;height:100%;background:var(--panel);border-radius:10px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(0,0,0,0.06);overflow:hidden}
.chat-head{background:var(--accent);color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center}
.chat-body{flex:1;overflow:auto;padding:10px;background:#f7fafc}
.msg{margin-bottom:8px;padding:8px;border-radius:8px;background:#e8f2ff;word-break:break-word}
.chat-input{display:flex;border-top:1px solid #e6e8ec;padding:8px;background:#fff}
.chat-input textarea{flex:1;min-height:44px;max-height:120px;border-radius:8px;border:1px solid #e6e8ec;padding:8px;font-size:14px;resize:none}
.chat-input button{margin-left:8px;padding:8px 12px;background:var(--ok);color:#fff;border-radius:8px;border:none;cursor:pointer}

/* å³å´ */
.right{width:300px;background:var(--panel);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px;overflow:auto}
.right h3{margin:6px 0;font-size:14px}
.request-item, .member-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:#fff;margin-bottom:6px;border:1px solid #eef2f7}
.btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.btn.danger{background:var(--danger);color:#fff}
.btn.ghost{background:transparent;border:1px solid #e6e8ec}

/* modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:60}
.panel{background:#fff;padding:16px;border-radius:8px;min-width:320px;max-width:720px;max-height:80vh;overflow:auto}
.row{display:flex;gap:8px;align-items:center}

/* tiny */
.note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆå®Œæ•´ç‰ˆï¼‰</h1>
  <div id="headerControls">
    <!-- ç™»å…¥/ç™»å‡ºæŒ‰éˆ•æœƒå‹•æ…‹é¡¯ç¤º -->
    <button id="btnLogin" class="btn primary">ä½¿ç”¨ Google ç™»å…¥</button>
    <button id="btnLogout" class="btn danger" style="display:none">ç™»å‡º</button>
  </div>
</div>

<div class="container" id="appRoot" style="display:none">
  <!-- å·¦å´ï¼šå¥½å‹ / ç¾¤çµ„ -->
  <div class="left">
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="note">ğŸ‘‹</div>
          <div id="meName" style="font-weight:600"></div>
          <div id="meEmail" class="note"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>å¥½å‹æ¸…å–®</h3>
      <div class="list" id="friendList"></div>
      <div style="margin-top:8px">
        <input id="inputAddFriend" placeholder="è¼¸å…¥ Gmail åŠ å¥½å‹" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e8ec"/>
        <div style="margin-top:6px;display:flex;gap:6px">
          <button id="btnSendFriendReq" class="btn primary" style="flex:1">é€å‡ºå¥½å‹è«‹æ±‚</button>
          <button id="btnRefreshFriends" class="btn ghost">é‡æ–°æ•´ç†</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>ç¾¤çµ„æ¸…å–®</h3>
      <div class="list" id="groupList"></div>
      <div style="margin-top:8px">
        <input id="inputGroupName" placeholder="ç¾¤çµ„åç¨±ï¼ˆç®¡ç†å“¡å¯å‰µï¼‰" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e8ec"/>
        <div style="margin-top:6px;display:flex;gap:6px">
          <button id="btnCreateGroup" class="btn primary" style="flex:1">å»ºç«‹ç¾¤çµ„</button>
          <button id="btnRefreshGroups" class="btn ghost">é‡æ–°æ•´ç†</button>
        </div>
        <div class="note" style="margin-top:6px">ç¾¤çµ„ç”±ç®¡ç†å“¡å‰µå»ºï¼Œç®¡ç†å“¡å¯åœ¨æˆå“¡æ¸…å–®è£¡æ‹‰äºº/è¸¢äºº</div>
      </div>
    </div>
  </div>

  <!-- ä¸­å¤®ï¼šå¤šå€‹èŠå¤©çª— -->
  <div class="center" style="flex:1;display:flex;flex-direction:column;">
    <div class="chatgrid" id="chatGrid" style="flex:1"></div>
  </div>

  <!-- å³å´ï¼šè«‹æ±‚ / ç®¡ç† / å…¬å‘Š -->
  <div class="right">
    <h3>å¥½å‹è«‹æ±‚</h3>
    <div id="requests"></div>

    <h3>å°é–åˆ—è¡¨</h3>
    <div id="blocks" class="note">ï¼ˆå°é–å¾Œä½ çœ‹ä¸åˆ°è©²ç”¨æˆ¶è¨Šæ¯ï¼‰</div>
    <div id="blockList"></div>

    <h3>å…¨åŸŸå…¬å‘Šï¼ˆé«˜éšç®¡ç†å“¡ï¼‰</h3>
    <div id="globalAnnouncement" class="note"></div>
    <textarea id="inputAnnouncement" placeholder="è¼¸å…¥å…¬å‘Š" style="width:100%;min-height:60px;padding:8px;border-radius:6px;margin-top:6px;border:1px solid #e6e8ec"></textarea>
    <button id="btnSendAnnouncement" class="btn primary">ç™¼é€å…¬å‘Š</button>

    <h3 style="margin-top:12px">ç›£çœ‹ç§èŠï¼ˆé«˜éšç®¡ç†å“¡ï¼‰</h3>
    <input id="inputWatch" placeholder="æ ¼å¼ï¼šemailA_emailB" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e8ec"/>
    <button id="btnWatch" class="btn primary">ç›£çœ‹ï¼ˆåªè®€ï¼‰</button>
  </div>
</div>

<!-- Modalï¼šæˆå“¡åˆ—è¡¨ -->
<div id="modalMembers" class="modal" style="display:none">
  <div class="panel">
    <h3>æˆå“¡åå–®ï¼š <span id="modalGroupName"></span></h3>
    <div id="modalMemberList" style="margin-top:8px"></div>
    <div style="margin-top:12px" class="row">
      <input id="inputAddMember" placeholder="è¼¸å…¥ Gmail åŠ å…¥ç¾¤çµ„" style="flex:1;padding:8px;border-radius:6px;border:1px solid #e6e8ec"/>
      <button id="btnAddMember" class="btn primary">åŠ å…¥</button>
      <button id="btnCloseMembers" class="btn ghost">é—œé–‰</button>
    </div>
    <div class="note" style="margin-top:8px">ï¼ˆåªæœ‰ç¾¤çµ„ç®¡ç†å“¡æˆ–å¹³å°ç®¡ç†å“¡å¯é€²è¡ŒåŠ äºº/è¸¢äººï¼‰</div>
  </div>
</div>

<script>
/* =========================
   Firebase åˆå§‹åŒ–ï¼ˆè«‹ä¿æŒç›¸åŒ configï¼‰
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   å…¨åŸŸè®Šæ•¸
   ========================= */
const APP = {
  me: null, // firebase user
  role: 'user', // 'user' | 'admin' | 'high' (high = chianghansen0302@gmail.com)
  openChats: {}, // roomId -> {el, unsub}
  BLOCKS: [] // emails I blocked
};

/* =========================
   DOM å…ƒç´ 
   ========================= */
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const appRoot = document.getElementById('appRoot');
const meName = document.getElementById('meName');
const meEmail = document.getElementById('meEmail');
const friendListEl = document.getElementById('friendList');
const groupListEl = document.getElementById('groupList');
const chatGrid = document.getElementById('chatGrid');
const inputAddFriend = document.getElementById('inputAddFriend');
const btnSendFriendReq = document.getElementById('btnSendFriendReq');
const requestsEl = document.getElementById('requests');
const inputGroupName = document.getElementById('inputGroupName');
const btnCreateGroup = document.getElementById('btnCreateGroup');
const btnRefreshFriends = document.getElementById('btnRefreshFriends');
const btnRefreshGroups = document.getElementById('btnRefreshGroups');
const inputAnnouncement = document.getElementById('inputAnnouncement');
const btnSendAnnouncement = document.getElementById('btnSendAnnouncement');
const globalAnnouncement = document.getElementById('globalAnnouncement');
const inputWatch = document.getElementById('inputWatch');
const btnWatch = document.getElementById('btnWatch');
const blockListEl = document.getElementById('blockList');
const btnCloseMembers = document.getElementById('btnCloseMembers');
const modalMembers = document.getElementById('modalMembers');
const modalGroupName = document.getElementById('modalGroupName');
const modalMemberList = document.getElementById('modalMemberList');
const inputAddMember = document.getElementById('inputAddMember');
const btnAddMember = document.getElementById('btnAddMember');

/* =========================
   ç™»å…¥ / ç™»å‡º
   ========================= */
btnLogin.onclick = async () => {
  try {
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  } catch (e) {
    alert('ç™»å…¥å¤±æ•—ï¼š' + e.message);
  }
};
btnLogout.onclick = async () => {
  await auth.signOut();
  location.reload();
};

/* =========================
   ç›£è½ç™»å…¥ç‹€æ…‹
   ========================= */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    // show login
    document.getElementById('btnLogin').style.display = 'inline-block';
    document.getElementById('btnLogout').style.display = 'none';
    document.getElementById('appRoot').style.display = 'none';
    return;
  }
  APP.me = user;
  meName.textContent = user.displayName || '';
  meEmail.textContent = user.email || '';
  document.getElementById('btnLogin').style.display = 'none';
  document.getElementById('btnLogout').style.display = 'inline-block';
  document.getElementById('appRoot').style.display = 'flex';
  // role åˆ¤å®š
  if (user.email === 'chianghansen0302@gmail.com') APP.role = 'high';
  else {
    // ä½ å¯ä»¥æŠŠç®¡ç†å“¡éƒµä»¶æ”¾åœ¨ä¸€å€‹ collection admins è£¡ï¼Œé€™è£¡ç¯„ä¾‹ç°¡åŒ–
    const adminDoc = await db.collection('admins').doc(user.email).get().catch(()=>null);
    if (adminDoc && adminDoc.exists) APP.role = 'admin';
    else APP.role = 'user';
  }
  // å»ºç«‹ users doc
  await db.collection('users').doc(user.email).set({ name: user.displayName, email: user.email, role: APP.role }, { merge: true });

  // è¼‰å…¥è³‡æ–™
  loadBlocks();
  loadFriends();
  loadGroups();
  loadRequests();
  loadGlobalAnnouncement();
});

/* =========================
   BLOCKï¼ˆå°é–ï¼‰ç®¡ç†
   - å­˜åœ¨ users/{me}/blocks/{blockedEmail: true}
   ========================= */
async function loadBlocks() {
  const me = APP.me?.email;
  if (!me) return;
  db.collection('users').doc(me).collection('blocks').onSnapshot(s => {
    APP.BLOCKS = [];
    blockListEl.innerHTML = '';
    s.forEach(doc => {
      APP.BLOCKS.push(doc.id);
      const div = document.createElement('div');
      div.className = 'member-item';
      div.innerHTML = `<div>${doc.id}</div><div>
        <button class="btn" data-email="${doc.id}">è§£é™¤å°é–</button>
      </div>`;
      div.querySelector('button').onclick = async (ev) => {
        await db.collection('users').doc(me).collection('blocks').doc(doc.id).delete();
      };
      blockListEl.appendChild(div);
    });
  });
}

/* =========================
   å¥½å‹ï¼šè¼‰å…¥ / é¡¯ç¤º / æ–°å¢è«‹æ±‚ / åˆªé™¤ / å°é–
   - friends stored (users/{email}/friends/{friendEmail: {email}})
   - requests stored (users/{email}/requests/{autoid})
   ========================= */
function loadFriends() {
  const me = APP.me?.email; if (!me) return;
  db.collection('users').doc(me).collection('friends').onSnapshot(snapshot => {
    friendListEl.innerHTML = '';
    snapshot.forEach(doc => {
      const f = doc.id;
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = `<div style="flex:1">${f}</div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-email="${f}" data-action="chat">èŠå¤©</button>
          <button class="btn" data-email="${f}" data-action="block">å°é–</button>
          <button class="btn danger" data-email="${f}" data-action="del">åˆªé™¤</button>
        </div>`;
      // actions
      item.querySelector('[data-action="chat"]').onclick = () => openPrivateChat(f);
      item.querySelector('[data-action="block"]').onclick = async () => {
        // add to my blocks
        await db.collection('users').doc(me).collection('blocks').doc(f).set({ blockedAt: firebase.firestore.FieldValue.serverTimestamp() });
        alert('å·²å°é– ' + f);
      };
      item.querySelector('[data-action="del"]').onclick = async () => {
        if (!confirm('ç¢ºå®šåˆªé™¤å¥½å‹å—ï¼Ÿ')) return;
        // remove from both sides
        await db.collection('users').doc(me).collection('friends').doc(f).delete().catch(()=>null);
        await db.collection('users').doc(f).collection('friends').doc(me).delete().catch(()=>null);
        alert('å·²åˆªé™¤å¥½å‹');
      };
      friendListEl.appendChild(item);
    });
  });
}

btnSendFriendReq.onclick = async () => {
  const email = inputAddFriend.value.trim();
  if (!email) return alert('è«‹è¼¸å…¥ Gmail');
  if (!APP.me) return alert('è«‹å…ˆç™»å…¥');
  if (email === APP.me.email) return alert('ä¸èƒ½åŠ è‡ªå·±');
  // å»ºç«‹å°æ–¹ user docï¼ˆè‹¥é‚„æ²’ï¼‰ä¸¦æ–°å¢ request
  await db.collection('users').doc(email).set({ email }, { merge: true });
  await db.collection('users').doc(email).collection('requests').add({
    from: APP.me.email, status: 'pending', time: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('å¥½å‹è«‹æ±‚å·²é€å‡º');
  inputAddFriend.value = '';
};

/* =========================
   å¥½å‹è«‹æ±‚ï¼šæ¥å— / æ‹’çµ•ï¼ˆé¡¯ç¤ºåœ¨å³å´ï¼‰
   ========================= */
function loadRequests() {
  const me = APP.me?.email; if (!me) return;
  db.collection('users').doc(me).collection('requests')
    .where('status', '==', 'pending')
    .onSnapshot(snapshot => {
      requestsEl.innerHTML = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'request-item';
        el.innerHTML = `<div>${d.from}</div><div style="display:flex;gap:6px">
          <button class="btn primary">åŒæ„</button>
          <button class="btn ghost">æ‹’çµ•</button>
        </div>`;
        el.querySelector('.primary').onclick = async () => {
          // add both sides as friends
          await db.collection('users').doc(me).collection('friends').doc(d.from).set({ email: d.from });
          await db.collection('users').doc(d.from).collection('friends').doc(me).set({ email: me });
          await db.collection('users').doc(me).collection('requests').doc(doc.id).update({ status: 'accepted' });
        };
        el.querySelector('.ghost').onclick = async () => {
          await db.collection('users').doc(me).collection('requests').doc(doc.id).update({ status: 'rejected' });
        };
        requestsEl.appendChild(el);
      });
    });
}

/* =========================
   ç¾¤çµ„ç®¡ç†ï¼š
   - groups collection: doc id = groupName
   - groups/{groupName} => { createdBy, members: [emails], admins: [emails] }
   - create group (admin / high)
   - open group chat, header has æˆå“¡åå–® æŒ‰éˆ• â†’ å½ˆ modal æˆå“¡æ¸…å–®ï¼Œåœ¨ modal è£¡ç®¡ç† add/kick/exit
   ========================= */
function loadGroups() {
  db.collection('groups').onSnapshot(snapshot => {
    groupListEl.innerHTML = '';
    snapshot.forEach(doc => {
      const groupName = doc.id;
      const data = doc.data() || {};
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<div style="flex:1">${groupName}</div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-name="${groupName}" data-action="open">é–‹å•Ÿ</button>
          <button class="btn" data-name="${groupName}" data-action="members">æˆå“¡</button>
        </div>`;
      el.querySelector('[data-action="open"]').onclick = () => openGroupChat(groupName);
      el.querySelector('[data-action="members"]').onclick = () => openMemberModal(groupName);
      groupListEl.appendChild(el);
    });
  });
}

btnCreateGroup.onclick = async () => {
  if (!APP.me) return alert('è«‹å…ˆç™»å…¥');
  if (APP.role === 'user') return alert('åªæœ‰ç®¡ç†å“¡å¯å‰µå»ºç¾¤çµ„');
  const name = inputGroupName.value.trim();
  if (!name) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
  await db.collection('groups').doc(name).set({ createdBy: APP.me.email, members: [APP.me.email], admins: [APP.me.email] });
  inputGroupName.value = '';
  alert('ç¾¤çµ„å·²å»ºç«‹ï¼š' + name);
};

/* é–‹å•Ÿæˆå“¡ modal */
let currentModalGroup = null;
async function openMemberModal(groupName) {
  currentModalGroup = groupName;
  modalGroupName.textContent = groupName;
  modalMemberList.innerHTML = '';
  modalMembers.style.display = 'flex';

  const gDoc = await db.collection('groups').doc(groupName).get();
  if (!gDoc.exists) {
    modalMemberList.innerHTML = '<div class="note">æ‰¾ä¸åˆ°æ­¤ç¾¤çµ„</div>';
    return;
  }
  const data = gDoc.data();
  const members = data.members || [];
  const admins = data.admins || [];

  // show each member with kick button if permitted
  members.forEach(m => {
    const w = document.createElement('div');
    w.className = 'member-item';
    w.innerHTML = `<div>${m} ${admins.includes(m) ? '(ç®¡ç†å“¡)' : ''}</div><div></div>`;
    const rightDiv = w.querySelector('div:last-child');
    // exit button for self
    if (m === APP.me.email) {
      const btnExit = document.createElement('button');
      btnExit.className = 'btn ghost';
      btnExit.textContent = 'é€€å‡º';
      btnExit.onclick = async () => {
        if (!confirm('ç¢ºå®šè¦é€€å‡ºç¾¤çµ„ï¼Ÿ')) return;
        await db.collection('groups').doc(groupName).update({ members: firebase.firestore.FieldValue.arrayRemove(APP.me.email) });
        alert('å·²é€€å‡ºç¾¤çµ„');
        modalMembers.style.display = 'none';
      };
      rightDiv.appendChild(btnExit);
    }
    // kick button: only group admin or platform high can kick others
    if ((admins.includes(APP.me.email) || APP.role === 'high') && m !== APP.me.email) {
      const btnKick = document.createElement('button');
      btnKick.className = 'btn danger';
      btnKick.textContent = 'è¸¢å‡º';
      btnKick.onclick = async () => {
        if (!confirm('ç¢ºå®šè¦å°‡ ' + m + ' è¸¢å‡ºç¾¤çµ„ï¼Ÿ')) return;
        await db.collection('groups').doc(groupName).update({ members: firebase.firestore.FieldValue.arrayRemove(m) });
        // notify kicked user by system message in group
        await db.collection('messages').doc(groupName).collection('chats').add({
          from: 'ç³»çµ±',
          text: `${m} å·²è¢«è¸¢å‡ºç¾¤çµ„ ${groupName}`,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
      };
      rightDiv.appendChild(btnKick);
    }
    modalMemberList.appendChild(w);
  });
}

/* Modal controls */
btnCloseMembers.onclick = () => { modalMembers.style.display = 'none'; currentModalGroup = null; };
btnAddMember.onclick = async () => {
  if (!currentModalGroup) return;
  const email = inputAddMember.value.trim();
  if (!email) return alert('è«‹è¼¸å…¥è¦åŠ å…¥çš„ Email');
  // only admins or platform high can add
  const gDoc = await db.collection('groups').doc(currentModalGroup).get();
  const data = gDoc.exists ? gDoc.data() : null;
  const admins = data?.admins || [];
  if (!(admins.includes(APP.me.email) || APP.role === 'high')) return alert('ä½ æ²’æœ‰æ¬Šé™åŠ å…¥æˆå“¡');
  // add member
  await db.collection('groups').doc(currentModalGroup).update({ members: firebase.firestore.FieldValue.arrayUnion(email) });
  // notify the added user via a system message (so they see in group chat)
  await db.collection('messages').doc(currentModalGroup).collection('chats').add({
    from: 'ç³»çµ±', text: `${email} è¢«åŠ å…¥ç¾¤çµ„ ${currentModalGroup}`, time: firebase.firestore.FieldValue.serverTimestamp()
  });
  inputAddMember.value = '';
  alert('å·²åŠ å…¥');
};

/* =========================
   èŠå¤©ï¼ˆç§èŠèˆ‡ç¾¤çµ„ï¼‰
   - roomId for private: sorted emails joined by "_"
   - roomId for group: groupName (no underscore rule)
   - messages stored in messages/{roomId}/chats/{autoid}
   - when loading, only last 100 messages (ordered desc limit 100), then reverse for display
   ========================= */
function openChatWindow(roomId, title, isMonitor=false) {
  if (APP.openChats[roomId]) {
    return; // already open
  }
  // create DOM
  const box = document.createElement('div'); box.className = 'chatbox';
  const head = document.createElement('div'); head.className = 'chat-head';
  head.innerHTML = `<div style="font-weight:600">${title}</div><div style="display:flex;gap:6px"></div>`;
  const body = document.createElement('div'); body.className = 'chat-body';
  const inputBar = document.createElement('div'); inputBar.className = 'chat-input';
  const txt = document.createElement('textarea'); txt.placeholder = 'è¼¸å…¥è¨Šæ¯ï¼ˆShift+Enter æ›è¡Œï¼ŒEnter ç™¼é€ï¼‰';
  const sendBtn = document.createElement('button'); sendBtn.textContent = 'é€å‡º'; sendBtn.className = 'btn primary';
  inputBar.appendChild(txt); inputBar.appendChild(sendBtn);

  // add member-list button for groups
  const headerActions = head.querySelector('div:last-child');
  if (roomId.indexOf('_') === -1 && roomId.startsWith('announcement_') === false) {
    // group
    const btnMembers = document.createElement('button'); btnMembers.textContent = 'æˆå“¡åå–®'; btnMembers.className = 'btn ghost';
    btnMembers.onclick = () => openMemberModal(roomId);
    headerActions.appendChild(btnMembers);
  } else if (roomId.startsWith('announcement_')) {
    // announcement window only display announcement, no input
    inputBar.style.display = 'none';
  } else {
    // private: maybe display block/delete buttons in header
    const peer = roomId.split('_').find(e => e !== APP.me.email);
    const btnBlock = document.createElement('button'); btnBlock.className = 'btn ghost'; btnBlock.textContent = 'å°é–';
    btnBlock.onclick = async () => {
      await db.collection('users').doc(APP.me.email).collection('blocks').doc(peer).set({ time: firebase.firestore.FieldValue.serverTimestamp() });
      alert('å·²å°é– ' + peer);
    };
    const btnUnfriend = document.createElement('button'); btnUnfriend.className = 'btn danger'; btnUnfriend.textContent = 'åˆªé™¤å¥½å‹';
    btnUnfriend.onclick = async () => {
      if (!confirm('ç¢ºå®šåˆªé™¤å¥½å‹ï¼Ÿ')) return;
      await db.collection('users').doc(APP.me.email).collection('friends').doc(peer).delete().catch(()=>null);
      await db.collection('users').doc(peer).collection('friends').doc(APP.me.email).delete().catch(()=>null);
      alert('å¥½å‹å·²åˆªé™¤');
    };
    headerActions.appendChild(btnBlock); headerActions.appendChild(btnUnfriend);
  }

  box.appendChild(head); box.appendChild(body); box.appendChild(inputBar);
  chatGrid.appendChild(box);

  // monitor mode: only read
  if (isMonitor) {
    inputBar.style.display = 'none';
  }

  // snapshot listener: last 100 messages
  const ref = db.collection('messages').doc(roomId).collection('chats').orderBy('time', 'desc').limit(100);
  const unsub = ref.onSnapshot(s => {
    // docs are desc, reverse for display
    const docs = s.docs.slice().reverse();
    body.innerHTML = '';
    for (const d of docs) {
      const dat = d.data();
      // skip messages from blocked users
      if (APP.BLOCKS.includes(dat.from)) continue;
      const m = document.createElement('div'); m.className = 'msg';
      m.textContent = `${dat.from}: ${dat.text}`;
      body.appendChild(m);
    }
    body.scrollTop = body.scrollHeight;
  });

  // send message event
  sendBtn.onclick = async () => {
    if (!APP.me) return alert('è«‹å…ˆç™»å…¥');
    // check blocked logic: cannot send to someone who blocked you (for private)
    if (roomId.indexOf('_') !== -1) {
      // private
      const parts = roomId.split('_');
      const other = parts[0] === APP.me.email ? parts[1] : parts[0];
      // check if other blocked me
      const blockedByOther = await db.collection('users').doc(other).collection('blocks').doc(APP.me.email).get().then(d=>d.exists).catch(()=>false);
      if (blockedByOther) return alert('å°æ–¹å°é–ä½ ï¼Œç„¡æ³•å‚³é€ç§è¨Š');
    }
    const text = txt.value.trim();
    if (!text) return;
    await db.collection('messages').doc(roomId).collection('chats').add({
      from: APP.me.email, text, time: firebase.firestore.FieldValue.serverTimestamp()
    });
    txt.value = '';
    // keep only last 100 messages: cleanup older than 100 (server-side rule recommended; client-side best effort)
    // best-effort cleanup: fetch count and delete extras (careful with large data)
    const colRef = db.collection('messages').doc(roomId).collection('chats').orderBy('time','desc').offset(100);
    // Note: offset queries are not efficient; production should use Cloud Function to trim
    // We skip forced trimming here to avoid extra reads in this sample; rely on backend cleanup in production
  };

  // keyboard: Shift+Enter newline, Enter send handled by textarea default behavior with listener
  txt.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // store unsub to close later
  APP.openChats[roomId] = { box, unsub };
}

/* =========================
   æ‰“é–‹ç§äººèŠå¤©ï¼ˆç”±å¥½å‹åˆ—è¡¨ç­‰å‘¼å«ï¼‰
   ========================= */
function openPrivateChat(otherEmail) {
  const roomId = [APP.me.email, otherEmail].sort().join('_');
  openChatWindow(roomId, otherEmail, false);
}

/* =========================
   æ‰“é–‹ç¾¤çµ„èŠå¤©
   ========================= */
function openGroupChat(groupName) {
  openChatWindow(groupName, groupName, false);
}

/* =========================
   å…¨åŸŸå…¬å‘Šï¼šæœ€é«˜ç®¡ç†å“¡æ‰èƒ½ç™¼é€
   - stored in collection 'announcement' doc 'global'
   ========================= */
btnSendAnnouncement = document.getElementById('btnSendAnnouncement');
btnSendAnnouncement.onclick = async () => {
  if (APP.role !== 'high') return alert('åªæœ‰æœ€é«˜ç®¡ç†å“¡å¯ç™¼é€å…¬å‘Š');
  const text = inputAnnouncement.value.trim();
  if (!text) return alert('è«‹è¼¸å…¥å…¬å‘Šå…§å®¹');
  await db.collection('announcement').doc('global').set({ text, time: firebase.firestore.FieldValue.serverTimestamp() });
  inputAnnouncement.value = '';
};

function loadGlobalAnnouncement() {
  db.collection('announcement').doc('global').onSnapshot(doc => {
    if (!doc.exists) {
      globalAnnouncement.textContent = '';
      return;
    }
    globalAnnouncement.textContent = doc.data().text || '';
    // create an announcement chat window (one-off) so people see it in the grid
    // optional: we won't open a chat for each announcement here; it's displayed in right panel
  });
}

/* =========================
   ç›£çœ‹ç§èŠï¼ˆonly highï¼‰
   - ä½¿ç”¨è€…è¼¸å…¥ emailA_emailBï¼ˆæœ¬æ©Ÿæ ¼å¼ï¼‰ï¼Œç³»çµ±æ‰“é–‹åªè®€èŠå¤©è¦–çª—
   ========================= */
btnWatch.onclick = () => {
  if (APP.role !== 'high') return alert('åªæœ‰æœ€é«˜ç®¡ç†å“¡å¯ä½¿ç”¨ç›£çœ‹åŠŸèƒ½');
  const val = inputWatch.value.trim();
  if (!val.includes('_')) return alert('æ ¼å¼éœ€ç‚º emailA_emailB');
  // open as monitor
  openChatWindow(val, `${val}`, true);
};

/* =========================
   è¼‰å…¥ç¾¤çµ„ / å¥½å‹ / è«‹æ±‚ initial triggers
   ========================= */
function loadGroups() { /* stubbed earlier but ensure exists */ }
function loadFriends() { /* stubbed earlier */ }
function loadRequests() { /* stubbed earlier */ }
function loadGlobalAnnouncement() { /* stubbed earlier */ }

/* =========================
   åˆå§‹åŒ–ï¼šæŠŠä¸Šé¢å®£å‘Šçš„loadå‡½å¼ç¶å›
   (å› ç‚ºåœ¨æª”æ¡ˆä¸Šé¢è¼‰å…¥é †åºï¼Œé‡ç¶ä¸€æ¬¡)
   ========================= */
(function hookLoads(){
  window.loadFriends = loadFriends;
  window.loadGroups = loadGroups;
  window.loadRequests = loadRequests;
  window.loadGlobalAnnouncement = loadGlobalAnnouncement;
})();

/* é‡æ–°æ•´ç†æŒ‰éˆ•ï¼ˆå¿«é€Ÿæ‰‹å‹• refreshï¼‰ */
document.getElementById('btnRefreshFriends').onclick = () => loadFriends();
document.getElementById('btnRefreshGroups').onclick = () => loadGroups();

/* =========================
   æœ€å¾Œï¼šç¢ºä¿ UI é¡¯ç¤ºé‚è¼¯
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  // hide app root until login
  document.getElementById('appRoot').style.display = 'none';
  // On auth change will show
});
</script>
</body>
</html>
