<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ ç°¡æ˜“èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
<style>
body { font-family: "Noto Sans TC", sans-serif; background: #f5f5f5; margin: 0; }
#container { width: 95%; max-width: 500px; margin: 40px auto; background: white;
border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
#loginBtn { padding: 10px 20px; background: #4285F4; color: white; border: none; border-radius: 5px; cursor: pointer; }
#chat { display:none; }
#messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 8px; margin-bottom: 10px; background: #fafafa; }
.msg { margin: 4px 0; padding: 5px 8px; background: #e6f0ff; border-radius: 6px; }
input, select, button { padding: 8px; margin: 4px; border-radius: 5px; border: 1px solid #ccc; }
#msgInput { width: 60%; }
#sendBtn { background: #4CAF50; color: white; border: none; cursor: pointer; }
</style>
</head>
<body>
<div id="container">
<h2>ğŸ”¥ Firebase èŠå¤©å®¤</h2>
<button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>

<div id="chat">
<p>ğŸ‘‹ æ­¡è¿ï¼Œ<span id="user"></span></p>

<div>
<select id="mode">
<option value="group">ç¾¤èŠ</option>
<option value="private">ç§èŠ</option>
</select>
<input id="targetEmail" placeholder="ç§èŠå°è±¡ Gmailï¼ˆç¾¤èŠå¯ç•™ç©ºï¼‰">
</div>

<div id="messages"></div>

<input id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯...">
<button id="sendBtn">é€å‡º</button>
</div>
</div>

<script type="module">
// ğŸ”§ Firebase è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById("loginBtn");
const chatDiv = document.getElementById("chat");
const userSpan = document.getElementById("user");
const msgDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const modeSel = document.getElementById("mode");
const targetInput = document.getElementById("targetEmail");

let userEmail = "";
let unsub = null;

// ğŸ”‘ Google ç™»å…¥
loginBtn.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
};

auth.onAuthStateChanged(user => {
  if (user) {
    userEmail = user.email;
    userSpan.textContent = `${user.displayName} (${userEmail})`;
    loginBtn.style.display = "none";
    chatDiv.style.display = "block";
    loadMessages();
  }
});

// ğŸ’¬ èŠå¤©å®¤ ID (ç¾¤èŠ æˆ– ç§èŠ)
function getRoomId() {
  if (modeSel.value === "group") return "group_chat";
  const target = targetInput.value.trim();
  if (!target) return null;
  return [userEmail, target].sort().join("_");
}

// ğŸ“¡ è¼‰å…¥è¨Šæ¯
function loadMessages() {
  if (unsub) unsub();
  const roomId = getRoomId() || "group_chat";
  unsub = db.collection("messages").doc(roomId).collection("chats")
    .orderBy("time")
    .onSnapshot(snap => {
      msgDiv.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "msg";
        div.textContent = `${d.from}: ${d.text}`;
        msgDiv.appendChild(div);
      });
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

// ğŸ“¤ ç™¼é€è¨Šæ¯
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if (!text) return;
  const roomId = getRoomId() || "group_chat";
  await db.collection("messages").doc(roomId).collection("chats").add({
    from: userEmail,
    text,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value = "";
};

modeSel.onchange = loadMessages;
targetInput.oninput = loadMessages;
</script>
</body>
</html>
