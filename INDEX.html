<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Firebase Chat</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <style>
    body { font-family: sans-serif; background: #fafafa; text-align: center; margin: 0; }
    #chat { width: 90%; max-width: 500px; margin: 20px auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
    #messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; margin-bottom: 10px; text-align: left; }
    .msg { padding: 4px; border-bottom: 1px solid #eee; }
    input { padding: 8px; width: 70%; }
    button { padding: 8px; }
  </style>
</head>
<body>
  <h2>🔥 Firebase Chat</h2>
  <button id="login">Google 登入</button>
  <div id="chat" style="display:none;">
    <p>👋 <span id="user"></span></p>
    <select id="mode">
      <option value="group">群聊</option>
      <option value="private">私聊</option>
    </select>
    <input id="target" placeholder="私聊對象 Gmail（群聊留空）">
    <div id="messages"></div>
    <input id="msgInput" placeholder="輸入訊息...">
    <button id="send">送出</button>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
      authDomain: "chat-52c0d.firebaseapp.com",
      projectId: "chat-52c0d",
      storageBucket: "chat-52c0d.firebasestorage.app",
      messagingSenderId: "449329325475",
      appId: "1:449329325475:web:75f255c4055360dc9e6616",
      measurementId: "G-8R8648H53V"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById('login');
    const chatDiv = document.getElementById('chat');
    const userSpan = document.getElementById('user');
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('send');
    const modeSel = document.getElementById('mode');
    const targetInput = document.getElementById('target');

    let userEmail = null;
    let unsub = null;

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        userEmail = user.email;
        userSpan.textContent = user.displayName + " (" + userEmail + ")";
        loginBtn.style.display = "none";
        chatDiv.style.display = "block";
        loadMessages();
      }
    });

    function getRoomId() {
      if (modeSel.value === "group") return "group_chat";
      let target = targetInput.value.trim();
      if (!target) return null;
      return [userEmail, target].sort().join("_");
    }

    function loadMessages() {
      if (unsub) unsub();
      const roomId = getRoomId() || "group_chat";
      unsub = db.collection("messages").doc(roomId).collection("chats")
        .orderBy("time")
        .onSnapshot(snap => {
          messagesDiv.innerHTML = "";
          snap.forEach(doc => {
            const d = doc.data();
            const div = document.createElement("div");
            div.className = "msg";
            div.textContent = `${d.from}: ${d.text}`;
            messagesDiv.appendChild(div);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    }

    sendBtn.onclick = async () => {
      const text = msgInput.value.trim();
      if (!text) return;
      const roomId = getRoomId() || "group_chat";
      await db.collection("messages").doc(roomId).collection("chats").add({
        from: userEmail,
        text,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
      msgInput.value = "";
    };

    modeSel.onchange = loadMessages;
    targetInput.oninput = loadMessages;
  </script>
</body>
</html>
