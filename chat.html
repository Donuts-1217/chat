<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Chat System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "微軟正黑體"; margin:0; padding:0; background:#f2f5fa; }
#sidebar { width:250px; background:#fff; height:100vh; float:left; border-right:1px solid #ccc; padding:10px; overflow-y:auto; }
#chat { margin-left:250px; height:100vh; display:flex; flex-direction:column; }
#messages { flex:1; overflow-y:auto; padding:10px; background:#e9ecef; }
#chatInput { width:100%; height:50px; padding:5px; }
.friend, .group { padding:5px; cursor:pointer; border-bottom:1px solid #eee; }
.friend:hover, .group:hover { background:#f0f0f0; }
.adminPanel, .proPanel { margin-top:20px; padding:10px; background:#f8f9fa; border:1px solid #ccc; }
.stickyNote { font-size:12px; color:#555; }
</style>
</head>
<body>

<div id="sidebar">
  <h3>好友列表</h3>
  <div id="friendList"></div>
  <button id="addFriendBtn">加好友</button>

  <h3>群組列表</h3>
  <div id="groupList"></div>
  <button id="createGroupBtn" style="display:none;">創建群組</button>

  <button id="logoutBtn">登出</button>

  <div id="proPanel" class="proPanel" style="display:none;">
    <h4>Pro功能</h4>
    <button id="editStickyBtn">修改便利貼</button>
  </div>

  <div id="adminPanel" class="adminPanel" style="display:none;">
    <h4>管理員面板</h4>
    <input type="email" id="setProEmail" placeholder="輸入Email設定Pro">
    <button id="setProBtn">設定Pro</button>
  </div>
</div>

<div id="chat">
  <div id="messages"></div>
  <textarea id="chatInput" placeholder="輸入訊息…"></textarea>
  <button id="sendBtn">送出</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, arrayUnion, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const friendListDiv = document.getElementById("friendList");
const groupListDiv = document.getElementById("groupList");
const chatInput = document.getElementById("chatInput");
const messagesDiv = document.getElementById("messages");
const addFriendBtn = document.getElementById("addFriendBtn");
const logoutBtn = document.getElementById("logoutBtn");
const sendBtn = document.getElementById("sendBtn");
const adminPanel = document.getElementById("adminPanel");
const setProEmail = document.getElementById("setProEmail");
const setProBtn = document.getElementById("setProBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const proPanel = document.getElementById("proPanel");
const editStickyBtn = document.getElementById("editStickyBtn");

let currentUser = null;
let currentChatId = null;

// 檢查登入狀態
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser=user;
    showMain();
  } else {
    window.location.href="login.html";
  }
});

// 顯示主頁
async function showMain(){
  const docSnap = await getDoc(doc(db,"Users",currentUser.uid));
  const role = docSnap.data().role;
  if(role==="admin") adminPanel.style.display="block";
  if(role==="pro") proPanel.style.display="block";
  if(role!=="general") createGroupBtn.style.display="block";
  loadFriends();
  loadGroups();
}

// 取得好友列表
async function loadFriends(){
  friendListDiv.innerHTML="";
  const userDoc = await getDoc(doc(db,"Users",currentUser.uid));
  const friends = userDoc.data().friends||[];
  for(let fid of friends){
    const fDoc = await getDoc(doc(db,"Users",fid));
    const fData = fDoc.data();
    const div = document.createElement("div");
    div.className="friend";
    div.innerHTML=fData.nickname + (fData.stickyNote ? `<div class="stickyNote">${fData.stickyNote}</div>` : "");
    div.onclick = ()=> openChat([currentUser.uid,fid].sort().join("-"), fData.nickname);
    friendListDiv.appendChild(div);
  }
}

// 取得群組列表
async function loadGroups(){
  groupListDiv.innerHTML="";
  const qSnap = await getDocs(collection(db,"Groups"));
  qSnap.forEach(docSnap=>{
    const group = docSnap.data();
    if(group.members.includes(currentUser.uid)){
      const div=document.createElement("div");
      div.className="group";
      div.textContent=group.name;
      div.onclick=()=>openChat(docSnap.id, group.name);
      groupListDiv.appendChild(div);
    }
  });
}

// 開啟聊天
function openChat(chatId, chatName){
  currentChatId=chatId;
  messagesDiv.innerHTML="";
  const chatRef = collection(db,"Messages",chatId,"msgs");
  onSnapshot(chatRef, snapshot=>{
    messagesDiv.innerHTML="";
    snapshot.docs.forEach(doc=>{
      const msg = doc.data();
      const div=document.createElement("div");
      div.textContent = msg.senderName + ": " + msg.content;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// 發送訊息
async function sendMessage(){
  if(!currentChatId) return;
  const content = chatInput.value.trim();
  if(!content) return;
  const msgRef = doc(collection(db,"Messages",currentChatId,"msgs"));
  await setDoc(msgRef,{
    sender: currentUser.uid,
    senderName: currentUser.displayName,
    content: content,
    timestamp: Date.now()
  });
  chatInput.value="";
}

// Enter / Shift+Enter
chatInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

// 加好友
addFriendBtn.onclick=async()=>{
  const email = prompt("輸入好友Email");
  if(!email) return;
  const qSnap = await getDocs(collection(db,"Users"));
  let fid=null;
  qSnap.forEach(doc=>{ if(doc.data().email===email) fid=doc.id; });
  if(!fid){ alert("找不到該用戶"); return; }
  await updateDoc(doc(db,"Users",currentUser.uid), { friends: arrayUnion(fid) });
  await updateDoc(doc(db,"Users",fid), { friends: arrayUnion(currentUser.uid) });
  loadFriends();
}

// 創建群組
createGroupBtn.onclick=async()=>{
  const gName = prompt("輸入群組名稱");
  if(!gName) return;
  const gRef = doc(collection(db,"Groups"));
  await setDoc(gRef,{
    name: gName,
    admin: currentUser.uid,
    members: [currentUser.uid],
    createdAt: Date.now()
  });
  loadGroups();
}

// 設定Pro (Admin)
setProBtn.onclick=async()=>{
  const email = setProEmail.value.trim();
  if(!email) return;
  const qSnap = await getDocs(collection(db,"Users"));
  let uid=null;
  qSnap.forEach(doc=>{ if(doc.data().email===email) uid=doc.id; });
  if(!uid){ alert("找不到"); return; }
  await updateDoc(doc(db,"Users",uid), { role:"pro" });
  alert("設定完成");
}

// 修改便利貼 (Pro)
editStickyBtn.onclick=async()=>{
  const note = prompt("輸入便利貼內容");
  if(note===null) return;
  await updateDoc(doc(db,"Users",currentUser.uid), { stickyNote: note });
  loadFriends();
}

// 登出
logoutBtn.onclick=async()=>{ await signOut(auth); window.location.href="login.html"; }

</script>

</body>
</html>
