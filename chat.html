<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ”¥ æ ¡åœ’èŠå¤©å®¤ï¼ˆDiscord é¢¨æ ¼ï¼‰</title>
<!-- Tailwind CSS for modern styling -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --bg:#0f1724; --panel:#111827; --muted:#9ca3af; --accent:#5865f2; --accent-2:#2ecc71; --danger:#ef4444;
    --card:#0b1020; --header-bg: #1e293b;
    --list-hover: rgba(255, 255, 255, 0.05);
    --selected-item: rgba(88, 101, 242, 0.15); /* Light accent background */
  }
  *{
    box-sizing:border-box;
    font-family:'Inter', 'Noto Sans TC', system-ui, -apple-system, sans-serif;
  }
  body{
    margin:0;
    background:linear-gradient(180deg,#071025 0%, #071223 100%);
    color:#e6eef8;
  }
  a{color:inherit}
  .center{
    display:flex;
    align-items:center;
    justify-content:center;
    height:100vh;
    width:100%;
  }

  /* Custom Scrollbar for Dark Theme */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--panel); }
  ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

  /* APP layout */
  #app{
    max-width:1400px;
    margin:18px auto;
    height:calc(100vh - 36px);
    display:flex;
    flex-direction:column;
  }
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 18px;
    background: var(--header-bg);
    border-radius: 12px 12px 0 0;
  }
  .logo{font-weight:800;color:var(--accent);font-size:20px}

  .container{
    display:flex;
    flex: 1;
    gap:12px;
    padding:0 18px 18px 18px;
    background: var(--bg);
    border-radius: 0 0 12px 12px;
  }
  
  /* Sidebar styles */
  .sidebar, .right{
    width:280px;
    background:var(--panel);
    border-radius:12px;
    padding:12px;
    display:flex;
    flex-direction:column;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
  .sidebar .me{
    padding:10px;
    background:rgba(255,255,255,0.06);
    border-radius:8px;
    margin-bottom:8px;
    border-left: 3px solid var(--accent);
  }
  .section-title{font-size:13px;color:var(--muted);margin:12px 0 6px 0; font-weight: 600;}
  .list{flex-shrink: 0; overflow-y: auto; padding:6px; border-radius:8px; background:rgba(255,255,255,0.02)}
  .list-fill { flex: 1; }
  .item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px;
    border-radius:8px;
    margin-bottom:4px;
    cursor:pointer;
    transition: background-color 0.2s;
  }
  .item:hover{background:var(--list-hover)}
  .item.active{background:var(--selected-item); border-left: 2px solid var(--accent);}
  
  /* Chat Window styles */
  .chat-container{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow: hidden;
  }
  .chat-window-wrapper {
    display: flex;
    flex: 1;
    overflow-x: auto;
    gap: 12px;
    padding-bottom: 5px; /* for scrollbar */
  }
  .chat-window{
    min-width: 300px;
    width: 300px;
    max-width: 400px; /* Limit individual chat width */
    height: 100%;
    background:var(--card);
    border-radius:12px;
    box-shadow:0 8px 30px rgba(2,6,23,0.6);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    flex-shrink: 0;
  }
  .chat-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 14px;
    background:linear-gradient(90deg,var(--accent),#6d78ff);
    color:white;
    font-weight:700;
  }
  .chat-body{
    padding:12px;
    overflow-y:auto;
    flex:1;
    background:var(--bg);
    display: flex;
    flex-direction: column;
  }
  .msg-wrapper {
    display: flex;
    margin: 6px 0;
  }
  .msg{
    background:rgba(255,255,255,0.06);
    padding:8px 12px;
    border-radius:18px;
    max-width:85%;
    word-break:break-word;
    color:#e6eef8;
    position: relative;
    font-size: 14px;
    line-height: 1.4;
  }
  .msg .sender-name {
    font-size: 11px;
    font-weight: 600;
    color: #4a71d2;
    margin-bottom: 2px;
    display: block;
  }
  .msg.me{
    background:var(--accent-2); /* Green for me */
    margin-left:auto;
    color: var(--card);
    border-radius: 18px 18px 2px 18px;
  }
  .msg.other {
    margin-right: auto;
    border-radius: 18px 18px 18px 2px;
    background: #27303d;
  }
  .msg .timestamp {
    display: block;
    font-size: 10px;
    color: var(--muted);
    text-align: right;
    margin-top: 4px;
  }
  .msg.me .timestamp {
    color: #0b1020;
  }
  .chat-foot{
    display:flex;
    gap:8px;
    padding:12px;
    background:rgba(255,255,255,0.02);
    align-items:flex-end;
  }
  textarea{
    flex:1;
    min-height:64px;
    max-height:180px;
    padding:10px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.04);
    background:var(--panel);
    color:inherit;
    resize:vertical;
    transition: border-color 0.2s;
  }
  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  /* Utility classes */
  .btn{
    padding:8px 12px;
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
    font-weight: 600;
    transition: background-color 0.2s, box-shadow 0.2s;
  }
  .btn:hover{
    background: #6c78ff;
    box-shadow: 0 2px 5px rgba(88, 101, 242, 0.4);
  }
  .btn.alt{
    background:transparent;
    border:1px solid rgba(255,255,255,0.1);
    color:#e6eef8;
    padding: 6px 10px;
    font-size: 13px;
  }
  .btn.alt:hover{
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
    box-shadow: none;
  }
  .btn.danger{background:var(--danger); border: none;}
  .btn.danger:hover{background: #ff5757;}
  .small{font-size:13px;color:var(--muted)}

  /* Modal styles */
  .custom-modal{
    position:fixed;inset:0;
    display:none;align-items:center;justify-content:center;
    background:rgba(2,6,23,0.8);
    z-index:100;
    backdrop-filter: blur(5px);
  }
  .custom-modal .box{
    width:92%;max-width:400px;
    background:linear-gradient(180deg,#1e293b,#0f172a);
    border-radius:10px;
    padding:20px;
    box-shadow:0 12px 40px rgba(2,6,23,0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  /* responsive */
  @media(max-width:1024px){
    .container{
      flex-direction:column;
      padding:0 10px 10px 10px;
      gap: 10px;
    }
    #app {
      margin: 10px auto;
      height: calc(100vh - 20px);
    }
    .header {
      border-radius: 8px 8px 0 0;
      padding: 10px;
    }
    .sidebar, .right{width:100%; flex-shrink: 0;}
    .sidebar { order: 2; height: 320px; }
    .right { order: 3; }
    .chat-container{ order: 1; flex: 1; }
    .chat-window-wrapper { flex-wrap: wrap; justify-content: center; }
    .chat-window { min-width: 95%; max-width: 95%; height: auto; }
  }
</style>
</head>
<body>

<!-- APP -->
<div id="app" style="display:none">
  <div class="header">
    <div class="logo">ğŸ”¥ æ ¡åœ’èŠå¤©å®¤</div>
    <div class="top-controls flex items-center gap-3">
      <div class="small" id="meInfo"></div>
      <div id="roleBadge" class="px-3 py-1 text-xs font-semibold rounded-full hidden" style="background:var(--accent); color: white;"></div>
      <button id="logoutBtn" class="btn alt">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <!-- left sidebar -->
    <div class="sidebar">
      <div class="me">
        <div id="leftName" class="font-bold text-lg text-white"></div>
        <div id="leftEmail" class="small break-all"></div>
        <div id="userIdDisplay" class="small mt-1 break-all" style="font-size: 10px; color: #5865f2;"></div>
      </div>

      <div class="section-title">ğŸ‘¤ å¥½å‹åˆ—è¡¨</div>
      <div id="friends" class="list list-fill" style="max-height: 25vh;"></div>

      <div class="section-title">ğŸ¤ å¥½å‹è«‹æ±‚</div>
      <div id="requests" class="list" style="max-height:140px;overflow-y:auto"></div>

      <div class="mt-4">
        <input id="addFriendEmail" placeholder="è¼¸å…¥å¥½å‹çš„ Gmail" class="w-full p-2 rounded-lg border-2 border-gray-700 bg-[color:var(--card)] text-white focus:border-[color:var(--accent)] transition" type="email">
        <div class="flex gap-2 mt-2">
          <button id="sendFriendReq" class="btn w-full">ç™¼é€å¥½å‹è«‹æ±‚</button>
        </div>
      </div>

      <div class="section-title">ğŸ‘¥ ç¾¤çµ„åˆ—è¡¨ï¼ˆå·²åŠ å…¥çš„ï¼‰</div>
      <div id="groups" class="list list-fill" style="max-height: 25vh;"></div>

      <div id="createGroupArea" class="mt-4 pt-4 border-t border-gray-700 hidden">
        <div class="section-title text-yellow-400">ç¾¤çµ„å»ºç«‹ï¼ˆç®¡ç†å“¡ï¼‰</div>
        <input id="newGroupName" placeholder="æ–°ç¾¤çµ„åç¨±" class="w-full p-2 rounded-lg border-2 border-gray-700 bg-[color:var(--card)] text-white focus:border-[color:var(--accent)] transition">
        <div class="flex gap-2 mt-2">
          <button id="createGroupBtn" class="btn w-full bg-yellow-600 hover:bg-yellow-700">å»ºç«‹ç¾¤çµ„</button>
        </div>
      </div>
    </div>

    <!-- center chat area -->
    <div class="chat-container">
        <div id="chatWindowWrapper" class="chat-window-wrapper">
            <!-- Chat windows will be appended here -->
        </div>
        <div id="noChatHint" class="center flex-col p-8 bg-[color:var(--panel)] rounded-xl" style="height: 100%; min-height: 300px;">
            <svg class="w-12 h-12 text-[color:var(--accent)] mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            <p class="text-lg font-semibold text-white">æ­¡è¿ä¾†åˆ°æ ¡åœ’èŠå¤©å®¤</p>
            <p class="small">é»é¸å·¦å´å¥½å‹æˆ–ç¾¤çµ„ã€Œç§èŠ / é–‹å•Ÿã€ä»¥é–‹å§‹èŠå¤©</p>
        </div>
    </div>

    <!-- right sidebar -->
    <div class="right">
      <div class="font-bold text-white text-lg border-b pb-2 border-gray-700">âš™ï¸ ç®¡ç†èˆ‡è¨­å®š</div>
      
      <div class="section-title">å°é–æ¸…å–®</div>
      <div id="blocked" class="list list-fill" style="max-height: 15vh;"></div>

      <div id="adminPanel" class="mt-4 pt-4 border-t border-gray-700 hidden">
        <div class="font-bold text-yellow-400 text-lg mb-2">ç¾¤çµ„ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰</div>
        <input id="adminGroupName" placeholder="ç¾¤çµ„åç¨±" class="w-full p-2 rounded-lg border-2 border-gray-700 bg-[color:var(--card)] text-white focus:border-[color:var(--accent)] transition" type="text">
        <input id="adminGroupEmail" placeholder="è¦åŠ å…¥/è¸¢å‡ºçš„ email" class="w-full p-2 rounded-lg border-2 border-gray-700 bg-[color:var(--card)] text-white focus:border-[color:var(--accent)] transition mt-2" type="email">
        <div class="flex gap-2 mt-2">
          <button id="adminAddBtn" class="btn w-1/2">åŠ å…¥æˆå“¡</button>
          <button id="adminKickBtn" class="btn w-1/2 danger">è¸¢å‡ºæˆå“¡</button>
        </div>
      </div>
      
      <div id="monitorPanel" class="mt-4 pt-4 border-t border-gray-700 hidden">
        <div class="font-bold text-red-400 text-lg mb-2">ç›£çœ‹ç§èŠï¼ˆæœ€é«˜ç®¡ç†å“¡ï¼‰</div>
        <input id="monitorInput" placeholder="æ ¼å¼ï¼šemailA_emailB" class="w-full p-2 rounded-lg border-2 border-gray-700 bg-[color:var(--card)] text-white focus:border-red-400 transition" type="text">
        <div class="flex gap-2 mt-2">
          <button id="monitorBtn" class="btn w-full bg-red-600 hover:bg-red-700">ç›£çœ‹èŠå¤©ç´€éŒ„ (é™100ç­†)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Modal for Alerts/Confirms -->
<div id="customModal" class="custom-modal">
  <div class="box">
    <h3 id="modalTitle" class="text-xl font-bold mb-3">è¨Šæ¯</h3>
    <div id="modalBody" class="small mb-4"></div>
    <div id="modalFooter" class="flex justify-end gap-2">
      <!-- Buttons injected here -->
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, orderBy, limit, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";
  
  // setLogLevel('Debug'); // Enable for debugging Firestore in console

  /* ================= Global Variables & Constants ================= */
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  if (Object.keys(firebaseConfig).length === 0) {
    console.error("Firebase config is missing.");
    document.body.innerHTML = '<div class="center text-red-400">Firebase è¨­å®šéºå¤±ï¼Œè«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ã€‚</div>';
  }

  // Firebase Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const SUPER_ADMIN = 'chianghansen0302@gmail.com'; // æœ€é«˜ç®¡ç†å“¡ email

  let ME = null, ME_EMAIL = '', ME_NAME = '', ME_ROLE = 'user';
  let userId = ''; // Firestore user ID (uid)
  const openChats = {}; // roomId -> {el, unsub, isReadonly}

  /* ================= DOM Elements ================= */
  const appEl = document.getElementById('app');
  const logoutBtn = document.getElementById('logoutBtn');
  const meInfo = document.getElementById('meInfo');
  const roleBadge = document.getElementById('roleBadge');
  const leftName = document.getElementById('leftName'), leftEmail = document.getElementById('leftEmail'), userIdDisplay = document.getElementById('userIdDisplay');
  const friendsEl = document.getElementById('friends');
  const requestsEl = document.getElementById('requests');
  const groupsEl = document.getElementById('groups');
  const blockedEl = document.getElementById('blocked');
  const sendFriendReq = document.getElementById('sendFriendReq');
  const addFriendEmail = document.getElementById('addFriendEmail');
  const createGroupArea = document.getElementById('createGroupArea');
  const createGroupBtn = document.getElementById('createGroupBtn');
  const newGroupName = document.getElementById('newGroupName');
  const chatWindowWrapper = document.getElementById('chatWindowWrapper');
  const noChatHint = document.getElementById('noChatHint');
  const adminPanel = document.getElementById('adminPanel');
  const adminAddBtn = document.getElementById('adminAddBtn');
  const adminKickBtn = document.getElementById('adminKickBtn');
  const adminGroupName = document.getElementById('adminGroupName');
  const adminGroupEmail = document.getElementById('adminGroupEmail');
  const monitorPanel = document.getElementById('monitorPanel');
  const monitorInput = document.getElementById('monitorInput');
  const monitorBtn = document.getElementById('monitorBtn');
  const customModal = document.getElementById('customModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalFooter = document.getElementById('modalFooter');

  /* ================= Custom Modal (replaces alert/confirm) ================= */

  /**
   * é¡¯ç¤ºè‡ªå®šç¾©æ¨¡æ…‹è¦–çª—
   * @param {string} title æ¨™é¡Œ
   * @param {string} message è¨Šæ¯å…§å®¹
   * @param {boolean} isConfirm æ˜¯å¦ç‚ºç¢ºèªæ¡†
   * @param {function} onConfirm ç¢ºèªæ™‚çš„å›èª¿å‡½æ•¸
   */
  function showCustomModal(title, message, isConfirm = false, onConfirm = null) {
    modalTitle.textContent = title;
    modalBody.innerHTML = message;
    modalFooter.innerHTML = '';

    const closeBtn = document.createElement('button');
    closeBtn.className = 'btn alt';
    closeBtn.textContent = isConfirm ? 'å–æ¶ˆ' : 'é—œé–‰';
    closeBtn.onclick = () => customModal.style.display = 'none';

    if (isConfirm) {
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'btn danger';
      confirmBtn.textContent = 'ç¢ºèª';
      confirmBtn.onclick = () => {
        customModal.style.display = 'none';
        if (onConfirm) onConfirm();
      };
      modalFooter.appendChild(closeBtn);
      modalFooter.appendChild(confirmBtn);
    } else {
      modalFooter.appendChild(closeBtn);
    }

    customModal.style.display = 'flex';
  }

  /* ================= Firestore Path Helpers ================= */
  const PATH = {
    // å…¬å…±è³‡æ–™: /artifacts/{appId}/public/data/{collection}
    USERS: collection(db, 'artifacts', appId, 'public', 'data', 'users'),
    GROUPS: collection(db, 'artifacts', appId, 'public', 'data', 'groups'),
    MESSAGES: collection(db, 'artifacts', appId, 'public', 'data', 'messages'),
    
    // ç§äººè³‡æ–™: /artifacts/{appId}/users/{userId}/{collection}
    privateUserCollection: (collectionName) => collection(db, 'artifacts', appId, 'users', userId, collectionName)
  };

  /* ================= Auth & Initialisation ================= */
  
  async function authenticate() {
      if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken).catch(e => {
              console.error("Custom token sign-in failed, trying anonymous.", e);
              signInAnonymously(auth);
          });
      } else {
          await signInAnonymously(auth);
      }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user || !user.email) {
      // å¦‚æœæœªé€é Google ç™»å…¥ï¼ˆæ²’æœ‰ emailï¼‰ï¼Œå¼·åˆ¶å›åˆ°ç™»å…¥é 
      if (window.location.href.includes('chat.html')) {
        window.location.href = 'index.html';
      }
      return;
    }
    
    // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
    ME = user;
    ME_EMAIL = user.email;
    ME_NAME = user.displayName || ME_EMAIL.split('@')[0];
    userId = user.uid; // ä½¿ç”¨ uid ä½œç‚ºç§äººè³‡æ–™å¤¾è·¯å¾‘

    // ç¢ºä¿ä½¿ç”¨è€… doc å­˜åœ¨æ–¼ public/data/users
    const userRef = doc(PATH.USERS, ME_EMAIL);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists) {
      ME_ROLE = (ME_EMAIL === SUPER_ADMIN) ? 'superadmin' : 'user';
      await setDoc(userRef, {
        name: ME_NAME,
        email: ME_EMAIL,
        role: ME_ROLE,
        uid: userId,
        createdAt: serverTimestamp()
      });
    } else {
      ME_ROLE = userSnap.data().role || 'user';
    }

    // UI æ›´æ–°
    appEl.style.display = 'flex';
    meInfo.textContent = ME_NAME + ' (' + ME_EMAIL + ')';
    leftName.textContent = ME_NAME;
    leftEmail.textContent = ME_EMAIL;
    userIdDisplay.textContent = `UID: ${userId}`;
    
    const roleText = (ME_ROLE === 'superadmin') ? 'æœ€é«˜ç®¡ç†å“¡' : (ME_ROLE === 'admin' ? 'ç®¡ç†å“¡' : '');
    roleBadge.textContent = roleText;
    roleBadge.classList.toggle('hidden', ME_ROLE === 'user');
    roleBadge.classList.toggle('bg-[color:var(--accent)]', ME_ROLE === 'admin');
    roleBadge.classList.toggle('bg-[color:var(--danger)]', ME_ROLE === 'superadmin');
    
    // ä¾è§’è‰²é¡¯ç¤º/éš±è—ç®¡ç†é¢æ¿
    const isAdmin = ME_ROLE === 'admin' || ME_ROLE === 'superadmin';
    createGroupArea.classList.toggle('hidden', !isAdmin);
    adminPanel.classList.toggle('hidden', !isAdmin);
    monitorPanel.classList.toggle('hidden', ME_ROLE !== 'superadmin');

    // è¨­å®šå¯¦æ™‚ç›£è½å™¨
    setupListeners();
  });

  logoutBtn.onclick = async () => {
    await signOut(auth);
    window.location.href = 'index.html'; // ç™»å‡ºå¾Œè½‰å›ç™»å…¥é 
  };

  // ç¢ºä¿ä¸€é–‹å§‹å°±å˜—è©¦èªè­‰
  authenticate();


  /* ============== Listeners & Render Functions ============== */
  let unsubs = [];
  function setupListeners() {
    // æ¸…ç†èˆŠçš„ç›£è½å™¨
    unsubs.forEach(u => u && u());
    unsubs = [];

    // --- 1. Friends (ç§äººè³‡æ–™: friends) ---
    const friendsRef = PATH.privateUserCollection('friends');
    unsubs.push(onSnapshot(friendsRef, snap => {
      friendsEl.innerHTML = '';
      snap.forEach(doc => {
        const email = doc.id;
        const item = createListItem(email, 'private', () => openPrivateChat(email));
        friendsEl.appendChild(item);
      });
    }, err => console.error('Friends Listener Error:', err)));

    // --- 2. Requests (ç§äººè³‡æ–™: requests) ---
    const reqRef = query(PATH.privateUserCollection('requests'), where('status', '==', 'pending'), orderBy('timestamp', 'desc'));
    unsubs.push(onSnapshot(reqRef, snap => {
      requestsEl.innerHTML = '';
      snap.forEach(docSnap => {
        const data = docSnap.data(), id = docSnap.id;
        requestsEl.appendChild(createRequestItem(id, data.from, docSnap.ref));
      });
    }, err => console.error('Requests Listener Error:', err)));

    // --- 3. Blocked (ç§äººè³‡æ–™: blocked) ---
    const blkRef = PATH.privateUserCollection('blocked');
    unsubs.push(onSnapshot(blkRef, snap => {
      blockedEl.innerHTML = '';
      snap.forEach(docSnap => {
        const email = docSnap.id;
        blockedEl.appendChild(createBlockedItem(email, docSnap.ref));
      });
    }, err => console.error('Blocked Listener Error:', err)));

    // --- 4. Groups (å…¬å…±è³‡æ–™: groups) ---
    unsubs.push(onSnapshot(PATH.GROUPS, snap => {
      groupsEl.innerHTML = '';
      snap.forEach(docSnap => {
        const name = docSnap.id, data = docSnap.data() || {};
        const members = Array.isArray(data.members) ? data.members : [];
        if (!members.includes(ME_EMAIL)) return; // åªé¡¯ç¤ºå·²åŠ å…¥çš„ç¾¤çµ„
        groupsEl.appendChild(createListItem(name, 'group', () => openGroupChat(name), true));
      });
    }, err => console.error('Groups Listener Error:', err)));
  }

  // Helper: Create general list item (Friend/Group)
  function createListItem(name, type, onClick, isGroup = false) {
    const item = document.createElement('div');
    item.className = 'item flex justify-between items-center';
    item.title = name; // for long emails/names on hover
    
    const nameEl = document.createElement('div');
    nameEl.textContent = name;
    
    const actions = document.createElement('div');
    actions.className = 'flex gap-2';

    const mainBtn = document.createElement('button');
    mainBtn.className = 'btn alt';
    mainBtn.textContent = isGroup ? 'é–‹å•Ÿ' : 'ç§èŠ';
    mainBtn.onclick = (e) => { e.stopPropagation(); onClick(); };
    actions.appendChild(mainBtn);

    if (type === 'private') {
      const moreBtn = document.createElement('button');
      moreBtn.className = 'btn alt';
      moreBtn.textContent = 'æ“ä½œ';
      moreBtn.onclick = (e) => { e.stopPropagation(); friendContext(name); };
      actions.appendChild(moreBtn);
    }
    if (isGroup) {
      const memberBtn = document.createElement('button');
      memberBtn.className = 'btn alt';
      memberBtn.textContent = 'æˆå“¡';
      memberBtn.onclick = (e) => { e.stopPropagation(); showGroupMembers(name); };
      actions.appendChild(memberBtn);
    }

    item.appendChild(nameEl);
    item.appendChild(actions);
    item.onclick = onClick;
    return item;
  }
  
  // Helper: Create friend request item
  function createRequestItem(requestId, fromEmail, docRef) {
    const item = document.createElement('div'); item.className='item';
    const left = document.createElement('div'); left.textContent = fromEmail;
    const right = document.createElement('div'); right.className='flex gap-2';

    const accept = document.createElement('button'); accept.className='btn bg-green-600 hover:bg-green-700'; accept.textContent='åŒæ„';
    accept.onclick = () => showCustomModal('ç¢ºèªåŒæ„å¥½å‹è«‹æ±‚', `ç¢ºå®šè¦æ¥å— ${fromEmail} çš„å¥½å‹è«‹æ±‚å—ï¼Ÿ`, true, async () => {
      await setDoc(doc(PATH.privateUserCollection('friends'), fromEmail), { email: fromEmail, name: fromEmail.split('@')[0], addedAt: serverTimestamp() });
      await setDoc(doc(collection(db, 'artifacts', appId, 'users', fromEmail.split('@')[0], 'friends'), ME_EMAIL), { email: ME_EMAIL, name: ME_NAME, addedAt: serverTimestamp() }); // Simplified for other user's path, ideally use other user's UID
      await updateDoc(docRef, { status: 'accepted' });
      showCustomModal('æˆåŠŸ', `å·²åŒæ„ ${fromEmail} çš„å¥½å‹è«‹æ±‚ã€‚`);
    });

    const reject = document.createElement('button'); reject.className='btn alt'; reject.textContent='æ‹’çµ•';
    reject.onclick = () => showCustomModal('ç¢ºèªæ‹’çµ•å¥½å‹è«‹æ±‚', `ç¢ºå®šè¦æ‹’çµ• ${fromEmail} çš„å¥½å‹è«‹æ±‚å—ï¼Ÿ`, true, async () => {
      await updateDoc(docRef, { status: 'rejected' });
      showCustomModal('æˆåŠŸ', `å·²æ‹’çµ• ${fromEmail} çš„å¥½å‹è«‹æ±‚ã€‚`);
    });

    right.appendChild(accept); right.appendChild(reject);
    item.appendChild(left); item.appendChild(right);
    return item;
  }

  // Helper: Create blocked user item
  function createBlockedItem(email, docRef) {
    const item = document.createElement('div'); item.className='item';
    const left = document.createElement('div'); left.textContent = email;
    const right = document.createElement('div');
    const unb = document.createElement('button'); unb.className='btn alt bg-red-800 hover:bg-red-900'; unb.textContent='è§£é™¤å°é–';
    unb.onclick = () => showCustomModal('ç¢ºèªè§£é™¤å°é–', `ç¢ºå®šè¦è§£é™¤å°é– ${email} å—ï¼Ÿ`, true, async () => {
      await deleteDoc(docRef);
      showCustomModal('æˆåŠŸ', `å·²è§£é™¤å°é– ${email}ã€‚`);
    });
    right.appendChild(unb); item.appendChild(left); item.appendChild(right);
    return item;
  }

  /* ============== Friend actions ============== */
  sendFriendReq.onclick = async () => {
    const to = (addFriendEmail.value || '').trim().toLowerCase();
    if (!to || !to.includes('@')) return showCustomModal('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gmail æ ¼å¼ã€‚');
    if (to === ME_EMAIL) return showCustomModal('éŒ¯èª¤', 'ä¸èƒ½åŠ è‡ªå·±ç‚ºå¥½å‹ã€‚');

    try {
      // ç¢ºä¿ç›®æ¨™ email åœ¨ public/data/users ä¸­å­˜åœ¨
      const toUserSnap = await getDoc(doc(PATH.USERS, to));
      if (!toUserSnap.exists) {
        // å¦‚æœä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹ä¸€å€‹ç°¡åŒ–ç‰ˆç”¨æˆ¶ (è®“è«‹æ±‚èƒ½å‚³é€)
        await setDoc(doc(PATH.USERS, to), { email: to, name: to.split('@')[0] }, { merge: true });
      }

      // æª¢æŸ¥æ˜¯å¦å·²æ˜¯å¥½å‹
      const friendSnap = await getDoc(doc(PATH.privateUserCollection('friends'), to));
      if (friendSnap.exists) return showCustomModal('éŒ¯èª¤', `${to} å·²æ˜¯æ‚¨çš„å¥½å‹ã€‚`);

      // æª¢æŸ¥æ˜¯å¦å·²å°é–å°æ–¹æˆ–è¢«å°æ–¹å°é– (å¯å‚³é€è«‹æ±‚ï¼Œä½†èŠå¤©æœƒå—é˜»)
      
      // é€å‡ºè«‹æ±‚
      await addDoc(collection(doc(PATH.USERS, to), 'requests'), {
        from: ME_EMAIL,
        status: 'pending',
        timestamp: serverTimestamp()
      });
      addFriendEmail.value = '';
      showCustomModal('æˆåŠŸ', `å¥½å‹è«‹æ±‚å·²é€å‡ºçµ¦ ${to}ã€‚`);
    } catch (e) {
      showCustomModal('å¤±æ•—', 'ç™¼é€å¥½å‹è«‹æ±‚å¤±æ•—ã€‚' + e.message);
      console.error(e);
    }
  };

  /* context for friend (delete/block) */
  function friendContext(email) {
    const message = `è«‹é¸æ“‡å° ${email} è¦åŸ·è¡Œçš„æ“ä½œï¼š<br>
      <button id="ctxDel" class="btn danger my-1">åˆªé™¤å¥½å‹</button><br>
      <button id="ctxBlock" class="btn bg-gray-600 hover:bg-gray-700 my-1">å°é–ç”¨æˆ¶</button><br>
      <button id="ctxCancel" class="btn alt my-1">å–æ¶ˆ</button>`;

    showCustomModal('å¥½å‹æ“ä½œ', message);

    document.getElementById('ctxDel').onclick = () => showCustomModal('ç¢ºèªåˆªé™¤å¥½å‹', `ç¢ºå®šè¦å°‡ ${email} å¾å¥½å‹æ¸…å–®ä¸­ç§»é™¤å—ï¼Ÿ`, true, async () => {
      await deleteDoc(doc(PATH.privateUserCollection('friends'), email)).catch(() => null);
      // é›™å‘åˆªé™¤ (è·¯å¾‘ç°¡åŒ–è™•ç†)
      // Note: Ideal implementation would use the other user's UID to get their private path, 
      // but here we use a simplified approach as in the original code, using email for their path
      const otherUid = (await getDoc(doc(PATH.USERS, email))).data()?.uid || email.split('@')[0];
      await deleteDoc(doc(collection(db, 'artifacts', appId, 'users', otherUid, 'friends'), ME_EMAIL)).catch(() => null);
      showCustomModal('æˆåŠŸ', `å·²åˆªé™¤å¥½å‹ ${email}ã€‚`);
    });

    document.getElementById('ctxBlock').onclick = () => showCustomModal('ç¢ºèªå°é–', `ç¢ºå®šè¦å°é– ${email} å—ï¼Ÿå°é–å¾Œé›™æ–¹ç„¡æ³•å†å‚³é€è¨Šæ¯ã€‚`, true, async () => {
      await setDoc(doc(PATH.privateUserCollection('blocked'), email), { email, at: serverTimestamp() });
      showCustomModal('æˆåŠŸ', `å·²å°é– ${email}ã€‚`);
    });

    document.getElementById('ctxCancel').onclick = () => customModal.style.display = 'none';
  }

  /* ============== Group: create / admin actions ============== */
  createGroupBtn.onclick = async () => {
    const name = (newGroupName.value || '').trim();
    if (!name) return showCustomModal('éŒ¯èª¤', 'è«‹è¼¸å…¥ç¾¤çµ„åç¨±ã€‚');
    
    // æª¢æŸ¥æ¬Šé™ (å·²åœ¨ auth ç›£è½å™¨ä¸­è™•ç†)
    if (ME_ROLE !== 'admin' && ME_ROLE !== 'superadmin') return showCustomModal('éŒ¯èª¤', 'åªæœ‰ç®¡ç†å“¡å¯ä»¥å»ºç«‹ç¾¤çµ„ã€‚');

    try {
      const groupRef = doc(PATH.GROUPS, name);
      const groupSnap = await getDoc(groupRef);
      if (groupSnap.exists) return showCustomModal('éŒ¯èª¤', 'ç¾¤çµ„åç¨±å·²å­˜åœ¨ã€‚');

      await setDoc(groupRef, {
        createdBy: ME_EMAIL,
        createdAt: serverTimestamp(),
        members: [ME_EMAIL], // ç®¡ç†å“¡è‡ªå·±å»ºç«‹æ™‚è‡ªå‹•åŠ å…¥
        admins: [ME_EMAIL]
      });
      newGroupName.value = '';
      showCustomModal('æˆåŠŸ', `ç¾¤çµ„ã€Œ${name}ã€å·²å»ºç«‹ï¼Œæ‚¨å·²è‡ªå‹•åŠ å…¥ç‚ºæˆå“¡å’Œç®¡ç†å“¡ã€‚`);
    } catch (e) {
      showCustomModal('å¤±æ•—', 'å»ºç«‹ç¾¤çµ„å¤±æ•—ã€‚' + e.message);
      console.error(e);
    }
  };

  adminAddBtn.onclick = async () => {
    const g = (adminGroupName.value || '').trim();
    const email = (adminGroupEmail.value || '').trim().toLowerCase();
    if (!g || !email) return showCustomModal('éŒ¯èª¤', 'è«‹è¼¸å…¥ç¾¤çµ„åèˆ‡è¦åŠ å…¥çš„ emailã€‚');
    if (ME_ROLE !== 'admin' && ME_ROLE !== 'superadmin') return showCustomModal('éŒ¯èª¤', 'åƒ…ç®¡ç†å“¡å¯åŠ å…¥æˆå“¡ã€‚');
    
    try {
      const gdoc = await getDoc(doc(PATH.GROUPS, g));
      if (!gdoc.exists) return showCustomModal('éŒ¯èª¤', 'æ‰¾ä¸åˆ°ç¾¤çµ„ã€‚');
      
      await updateDoc(doc(PATH.GROUPS, g), { members: arrayUnion(email) });
      adminGroupEmail.value = '';
      showCustomModal('æˆåŠŸ', `å·²å°‡ ${email} åŠ å…¥ç¾¤çµ„ã€Œ${g}ã€ã€‚`);
    } catch (e) {
      showCustomModal('å¤±æ•—', 'åŠ å…¥æˆå“¡å¤±æ•—ã€‚' + e.message);
      console.error(e);
    }
  };

  adminKickBtn.onclick = async () => {
    const g = (adminGroupName.value || '').trim();
    const email = (adminGroupEmail.value || '').trim().toLowerCase();
    if (!g || !email) return showCustomModal('éŒ¯èª¤', 'è«‹è¼¸å…¥ç¾¤çµ„åèˆ‡è¦è¸¢å‡ºçš„ emailã€‚');
    if (ME_ROLE !== 'admin' && ME_ROLE !== 'superadmin') return showCustomModal('éŒ¯èª¤', 'åƒ…ç®¡ç†å“¡å¯è¸¢å‡ºæˆå“¡ã€‚');
    if (email === ME_EMAIL) return showCustomModal('éŒ¯èª¤', 'æ‚¨ä¸èƒ½å¾ç®¡ç†é¢æ¿è¸¢å‡ºè‡ªå·±ï¼Œè«‹ä½¿ç”¨ã€Œæˆå“¡ã€æŒ‰éˆ•é€€å‡ºã€‚');

    try {
      const gdoc = await getDoc(doc(PATH.GROUPS, g));
      if (!gdoc.exists) return showCustomModal('éŒ¯èª¤', 'æ‰¾ä¸åˆ°ç¾¤çµ„ã€‚');

      await updateDoc(doc(PATH.GROUPS, g), { members: arrayRemove(email) });
      adminGroupEmail.value = '';
      showCustomModal('æˆåŠŸ', `å·²å°‡ ${email} è¸¢å‡ºç¾¤çµ„ã€Œ${g}ã€ã€‚`);
    } catch (e) {
      showCustomModal('å¤±æ•—', 'è¸¢å‡ºæˆå“¡å¤±æ•—ã€‚' + e.message);
      console.error(e);
    }
  };

  /* show group members modal */
  async function showGroupMembers(groupName) {
    const gRef = doc(PATH.GROUPS, groupName);
    const gdoc = await getDoc(gRef);
    if (!gdoc.exists) return showCustomModal('éŒ¯èª¤', 'æ‰¾ä¸åˆ°ç¾¤çµ„ã€‚');
    
    const data = gdoc.data();
    const members = data.members || [];
    const admins = data.admins || [];
    const myrole = ME_ROLE;
    
    modalTitle.textContent = `æˆå“¡ â€” ${groupName} (å…± ${members.length} äºº)`;
    modalBody.innerHTML = '';
    modalFooter.innerHTML = ''; // Clear default footer
    
    members.forEach(m => {
      const row = document.createElement('div');
      row.className = 'flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0';
      
      const left = document.createElement('div');
      left.textContent = m;
      left.classList.add('break-all');
      if (admins.includes(m)) {
        left.innerHTML += ' <span class="text-xs text-yellow-400">(ç®¡ç†å“¡)</span>';
      }

      const right = document.createElement('div');
      right.className = 'flex gap-2';

      if (m === ME_EMAIL) {
        const leave = document.createElement('button');
        leave.className = 'btn alt bg-red-800 hover:bg-red-900';
        leave.textContent = 'é€€å‡ºç¾¤çµ„';
        leave.onclick = () => showCustomModal('ç¢ºèªé€€å‡º', `ç¢ºå®šè¦é€€å‡ºç¾¤çµ„ã€Œ${groupName}ã€å—ï¼Ÿ`, true, async () => {
          await updateDoc(gRef, { members: arrayRemove(ME_EMAIL) });
          customModal.style.display = 'none'; // é€€å‡ºæˆåŠŸå¾Œé—œé–‰ modal
          // ç¢ºä¿èŠå¤©è¦–çª—ä¹Ÿè¢«é—œé–‰
          if (openChats[groupName]) {
            openChats[groupName].el.remove();
            if (openChats[groupName].unsub) openChats[groupName].unsub();
            delete openChats[groupName];
          }
          showCustomModal('æˆåŠŸ', `å·²æˆåŠŸé€€å‡ºç¾¤çµ„ã€Œ${groupName}ã€ã€‚`);
        });
        right.appendChild(leave);
      } else if (myrole === 'admin' || myrole === 'superadmin') {
        const kick = document.createElement('button');
        kick.className = 'btn danger';
        kick.textContent = 'è¸¢å‡º';
        kick.onclick = () => showCustomModal('ç¢ºèªè¸¢å‡º', `ç¢ºå®šè¦å°‡ ${m} è¸¢å‡ºç¾¤çµ„ã€Œ${groupName}ã€å—ï¼Ÿ`, true, async () => {
          await updateDoc(gRef, { members: arrayRemove(m) });
          showGroupMembers(groupName); // Refresh modal
          showCustomModal('æˆåŠŸ', `å·²å°‡ ${m} è¸¢å‡ºç¾¤çµ„ã€Œ${groupName}ã€ã€‚`); // Secondary success message
        });
        right.appendChild(kick);
      }
      
      row.appendChild(left);
      row.appendChild(right);
      modalBody.appendChild(row);
    });
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'btn alt mt-4';
    closeBtn.textContent = 'é—œé–‰';
    closeBtn.onclick = () => customModal.style.display = 'none';
    modalFooter.appendChild(closeBtn);
    
    customModal.style.display = 'flex';
  }

  /* ============== Chat open/send logic ============== */
  function getPrivateRoomId(emailA, emailB) {
    return [emailA, emailB].sort().join('_');
  }

  function openPrivateChat(otherEmail) {
    const roomId = getPrivateRoomId(ME_EMAIL, otherEmail);
    openChatWindow(roomId, otherEmail, false);
  }

  function openGroupChat(groupName) {
    openChatWindow(groupName, groupName, false);
  }
  
  // Helper to format timestamp
  function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
  }

  async function openChatWindow(roomId, title, isReadonly) {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (openChats[roomId]) { 
      // å°‡ç¾æœ‰è¦–çª—ç§»åˆ°æœ€å‰é¢
      chatWindowWrapper.prepend(openChats[roomId].el); 
      return; 
    }

    noChatHint.style.display = 'none';
    
    // elements
    const card = document.createElement('div'); 
    card.className = 'chat-window';
    card.dataset.roomId = roomId;

    const head = document.createElement('div'); 
    head.className = 'chat-head';
    
    const headTitle = document.createElement('div');
    headTitle.className = 'flex items-center justify-between flex-1';
    headTitle.textContent = title + (isReadonly ? ' (ç›£çœ‹æ¨¡å¼)' : '');
    
    const headActions = document.createElement('div'); 
    headActions.className = 'flex gap-2 items-center';

    const closeBtn = document.createElement('button');
    closeBtn.className = 'btn alt bg-red-600 hover:bg-red-700'; 
    closeBtn.textContent = 'X';
    headActions.appendChild(closeBtn);

    head.appendChild(headTitle);
    head.appendChild(headActions);

    const body = document.createElement('div'); 
    body.className = 'chat-body';
    
    const foot = document.createElement('div'); 
    foot.className = 'chat-foot';
    
    const ta = document.createElement('textarea'); 
    ta.placeholder = isReadonly ? 'åªè®€æ¨¡å¼' : 'Shift+Enter æ›è¡Œï¼ŒEnter é€å‡ºè¨Šæ¯';
    ta.disabled = isReadonly;
    
    const send = document.createElement('button'); 
    send.className = 'btn bg-[color:var(--accent-2)] hover:bg-green-600'; 
    send.textContent = 'ç™¼é€';
    send.disabled = isReadonly;
    
    foot.appendChild(ta); 
    foot.appendChild(send);
    
    card.appendChild(head); 
    card.appendChild(body); 
    card.appendChild(foot);
    
    // å°‡æ–°è¦–çª—åŠ åˆ°æœ€å‰é¢
    chatWindowWrapper.prepend(card);

    // --- Private Chat Actions (Delete/Block) ---
    if (roomId.indexOf('_') !== -1 && !isReadonly) {
      const parts = roomId.split('_'); 
      const other = (parts[0] === ME_EMAIL) ? parts[1] : parts[0];
      
      const delBtn = document.createElement('button'); 
      delBtn.className = 'btn alt'; 
      delBtn.textContent = 'åˆªé™¤å¥½å‹';
      delBtn.onclick = async () => friendContext(other); // Re-use context modal
      
      const blockBtn = document.createElement('button'); 
      blockBtn.className = 'btn alt'; 
      blockBtn.textContent = 'å°é–';
      blockBtn.onclick = async () => friendContext(other);

      headActions.prepend(blockBtn);
      headActions.prepend(delBtn);
    }

    // --- Close Button Logic ---
    closeBtn.onclick = () => { 
      card.remove(); 
      const o = openChats[roomId]; 
      if (o && o.unsub) o.unsub(); 
      delete openChats[roomId];
      
      if (chatWindowWrapper.children.length === 0) {
        noChatHint.style.display = 'flex';
      }
    };

    // --- Message Subscription ---
    const chatRef = collection(doc(PATH.MESSAGES, roomId), 'chats');
    const q = query(chatRef, orderBy('time', 'desc'), limit(100));
    
    const unsub = onSnapshot(q, async snap => {
      // ç²å–å°é–æ¸…å–®
      const bSnap = await getDocs(PATH.privateUserCollection('blocked'));
      const blockedSet = new Set(bSnap.docs.map(d => d.id));
      
      body.innerHTML = '';
      const docs = snap.docs.slice().reverse(); // Re-reverse for correct order
      
      docs.forEach(d => {
        const v = d.data();
        if (blockedSet.has(v.from) && v.from !== ME_EMAIL) return; // éš±è—è¢«å°é–è€…ç™¼é€çš„è¨Šæ¯
        
        const isMe = v.from === ME_EMAIL;
        
        const msgWrapper = document.createElement('div');
        msgWrapper.className = 'msg-wrapper ' + (isMe ? 'justify-end' : 'justify-start');
        
        const m = document.createElement('div'); 
        m.className = 'msg ' + (isMe ? 'me' : 'other');
        
        // é¡¯ç¤ºå¯„ä»¶äººåç¨± (ç§èŠæ™‚ï¼Œåªæœ‰å°æ–¹éœ€è¦é¡¯ç¤º email)
        const sender = (v.from === ME_EMAIL) ? ME_NAME : v.from.split('@')[0];
        if (roomId.indexOf('_') === -1 || !isMe) { // ç¾¤çµ„æˆ–å°æ–¹è¨Šæ¯æ‰é¡¯ç¤ºåç¨±
            m.innerHTML += `<span class="sender-name">${sender}:</span>`;
        }

        const textContent = document.createTextNode(v.text);
        m.appendChild(textContent);
        
        // æ™‚é–“æˆ³
        m.innerHTML += `<span class="timestamp">${formatTimestamp(v.time)}</span>`;
        
        // æœ€é«˜ç®¡ç†å“¡åˆªé™¤æŒ‰éˆ•
        if (ME_ROLE === 'superadmin' && isReadonly) {
          const del = document.createElement('button'); 
          del.className = 'btn alt danger'; 
          del.textContent = 'åˆªé™¤';
          del.style.marginLeft = '8px';
          del.style.marginTop = '4px';
          del.onclick = () => showCustomModal('ç¢ºèªåˆªé™¤è¨Šæ¯', 'ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å‰‡è¨Šæ¯å—ï¼Ÿ', true, async () => { 
            await deleteDoc(d.ref).catch(e => showCustomModal('åˆªé™¤å¤±æ•—', 'åˆªé™¤å¤±æ•—ï¼š' + e.message)); 
          });
          m.appendChild(del);
        }
        
        msgWrapper.appendChild(m);
        body.appendChild(msgWrapper);
      });
      
      // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
      body.scrollTop = body.scrollHeight;
    }, err => console.error('Chat Listener Error:', err));

    openChats[roomId] = { el: card, unsub, isReadonly };

    // --- Send Logic ---
    send.onclick = async () => {
      const text = (ta.value || '').trim();
      if (!text || isReadonly) return;
      
      let canSend = true;
      // Private chat block check
      if (roomId.indexOf('_') !== -1) {
        const parts = roomId.split('_'); 
        const other = (parts[0] === ME_EMAIL) ? parts[1] : parts[0];
        
        // æª¢æŸ¥å°æ–¹æ˜¯å¦å°é–æˆ‘
        const otherBlockSnap = await getDoc(doc(PATH.privateUserCollection('blocked'), other));
        // æª¢æŸ¥æˆ‘æ˜¯å¦å°é–å°æ–¹ (æ­¤è™•ä½¿ç”¨æˆ‘çš„ uid è·¯å¾‘)
        const myBlockSnap = await getDoc(doc(PATH.privateUserCollection('blocked'), other));
        
        if (otherBlockSnap.exists) {
          canSend = false;
          showCustomModal('ç„¡æ³•ç™¼é€', 'å°æ–¹å·²å°é–æ‚¨ï¼Œç„¡æ³•å‚³é€è¨Šæ¯ã€‚');
        } else if (myBlockSnap.exists) {
          canSend = false;
          showCustomModal('ç„¡æ³•ç™¼é€', 'æ‚¨å·²å°é–å°æ–¹ï¼Œç„¡æ³•å‚³é€è¨Šæ¯ã€‚');
        }
      }
      
      if (canSend) {
        await addDoc(chatRef, { from: ME_EMAIL, text, time: serverTimestamp() });
        ta.value = '';
      }
    };

    // Enter send, Shift+Enter newline
    ta.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { 
        e.preventDefault(); 
        send.click(); 
      }
    });
  }

  /* ============== Monitor (superadmin) ============== */
  monitorBtn.onclick = async () => {
    const v = (monitorInput.value || '').trim();
    if (!v || v.indexOf('_') === -1) return showCustomModal('éŒ¯èª¤', 'è«‹è¼¸å…¥æ­£ç¢ºçš„æ ¼å¼ï¼šemailA_emailB');
    if (ME_ROLE !== 'superadmin') return showCustomModal('éŒ¯èª¤', 'åƒ…æœ€é«˜ç®¡ç†å“¡å¯ç›£çœ‹ã€‚');
    
    // ç›£çœ‹çš„ roomId å¿…é ˆæ˜¯æ’åºéçš„ï¼Œä»¥åŒ¹é…ç§èŠçš„ roomId æ ¼å¼
    const [emailA, emailB] = v.split('_').map(e => e.trim().toLowerCase());
    const roomId = getPrivateRoomId(emailA, emailB);

    // æª¢æŸ¥å…©ä½ä½¿ç”¨è€…æ˜¯å¦éƒ½å­˜åœ¨æ–¼ public/data/users
    const snapA = await getDoc(doc(PATH.USERS, emailA));
    const snapB = await getDoc(doc(PATH.USERS, emailB));
    
    if (!snapA.exists || !snapB.exists) {
       return showCustomModal('éŒ¯èª¤', 'ç›£çœ‹çš„é›™æ–¹ email å¿…é ˆç‚ºå·²ç™»å…¥éçš„ç”¨æˆ¶ã€‚');
    }

    openChatWindow(roomId, `[ç›£çœ‹] ${emailA} & ${emailB}`, true);
  };

  /* cleanup: close listeners on unload */
  window.addEventListener('beforeunload', () => {
    Object.values(openChats).forEach(o => o.unsub && o.unsub());
    unsubs.forEach(u => u && u());
  });
</script>
</body>
</html>